# Maintainer: Peter Jung ptr1337 <admin@ptr1337.dev>

pkgname=mold-git
pkgver=v1.4.2_163_gc1bdbe23
pkgrel=1
pkgdesc="A Modern Linker"
arch=(x86_64)
url="https://github.com/rui314/mold"
license=("AGPL3")
# xxhash is bundled
depends=('gcc-libs' 'mimalloc' 'openssl' 'zlib' 'tbb')
makedepends=('git' 'python' 'clang')
source=("mold::git+https://github.com/rui314/mold")
sha256sums=('SKIP')
provides=("mold=$pkgver")
conflicts=("mold")
options=('strip')
reponame="mold"

pkgver() {
    cd "$reponame"
    git describe --long --tags | sed "s/-/_/g"
}

prepare() {

    cd "$reponame"

    # use /usr/lib instead of /usr/libexec
    sed -i "s/libexec/lib/" Makefile
}

build() {

    make \
        -C "$reponame" \
        CXX=g++ \
        CXXFLAGS="-O3 -march=native -fno-semantic-interposition -falign-functions=32 -fipa-pta -flive-range-shrinkage -fno-math-errno -fno-trapping-math -mtls-dialect=gnu2 -feliminate-unused-debug-types -floop-nest-optimize -fgraphite-identity -fcf-protection=none -pipe -flto=auto -floop-parallelize-all -ftree-parallelize-loops=18 -fdevirtualize-at-ltrans -mharden-sls=none -malign-data=cacheline -fno-omit-frame-pointer" \
        CXXFLAGS="$CFLAGS"
        LDFLAGS="-Wl,-O3,--as-needed,-Bsymbolic-functions,-flto=auto -fopenmp -Wl,-zcommon-page-size=0x200000 -Wl,-zmax-page-size=0x200000"
        CCLDFLAGS="-Wl,-O3,--as-needed,-Bsymbolic-functions,-flto=auto -fopenmp -Wl,-zcommon-page-size=0x200000 -Wl,-zmax-page-size=0x200000"
        CXXLDFLAGS="-Wl,-O3,--as-needed,-Bsymbolic-functions,-flto=auto -fopenmp -Wl,-zcommon-page-size=0x200000 -Wl,-zmax-page-size=0x200000"
        PREFIX=/usr \
        LTO=1 \
        SYSTEM_MIMALLOC=1 \
        SYSTEM_TBB=1
}

#check() {
#
#    cd "$reponame"
#
#    make \
#        CXX=g++ \
#        CFLAGS="-O3 -march=native -fno-semantic-interposition -falign-functions=32 -fipa-pta -flive-range-shrinkage -fno-math-errno -fno-trapping-math -mtls-dialect=gnu2 -feliminate-unused-debug-types -floop-nest-optimize -fgraphite-identity -fcf-protection=none -pipe -flto=auto -floop-parallelize-all -ftree-parallelize-loops=18 -fdevirtualize-at-ltrans -mharden-sls=none -malign-data=cacheline -fno-omit-frame-pointer -Wl,-zcommon-page-size=0x200000 -Wl,-zmax-page-size=0x200000" \
#        PREFIX=/usr \
#        LTO=1 \
#        SYSTEM_MIMALLOC=1 \
#        SYSTEM_TBB=1 \
#        check
#}

package() {
    make \
        -C "$reponame" \
        CXX=g++ \
        PREFIX=/usr \
        LTO=1 \
        SYSTEM_MIMALLOC=1 \
        SYSTEM_TBB=1 \
        DESTDIR="$pkgdir" \
        install
}
