From 73982f9b2691e4569f418d02ad9dc34ff2a5ed44 Mon Sep 17 00:00:00 2001
From: Georg Lehmann <dadschoorse@gmail.com>
Date: Fri, 12 Jan 2024 11:48:18 +0100
Subject: [PATCH 1/2] radv: sink alu

The stats are decent now that aco has an ILP scheduler.

Totals from 49643 (63.55% of 78112) affected shaders:
MaxWaves: 1481472 -> 1483028 (+0.11%); split: +0.11%, -0.00%
Instrs: 33776193 -> 33755475 (-0.06%); split: -0.17%, +0.11%
CodeSize: 173464236 -> 173406648 (-0.03%); split: -0.13%, +0.10%
VGPRs: 2160148 -> 2148160 (-0.55%); split: -0.60%, +0.04%
SpillSGPRs: 8329 -> 7500 (-9.95%); split: -11.25%, +1.30%
SpillVGPRs: 1376 -> 1253 (-8.94%); split: -9.96%, +1.02%
Scratch: 6293248 -> 6269696 (-0.37%)
Latency: 231154107 -> 231042164 (-0.05%); split: -0.42%, +0.37%
InvThroughput: 36250263 -> 36228403 (-0.06%); split: -0.40%, +0.34%
VClause: 668842 -> 669859 (+0.15%); split: -0.23%, +0.38%
SClause: 1058766 -> 1064205 (+0.51%); split: -0.31%, +0.82%
Copies: 2431326 -> 2413220 (-0.74%); split: -1.35%, +0.61%
Branches: 731189 -> 732039 (+0.12%); split: -0.02%, +0.14%
PreSGPRs: 1799626 -> 1795519 (-0.23%); split: -0.57%, +0.34%
PreVGPRs: 1675818 -> 1668062 (-0.46%); split: -0.50%, +0.04%
---
 src/amd/vulkan/radv_pipeline.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/amd/vulkan/radv_pipeline.c b/src/amd/vulkan/radv_pipeline.c
index 95b6a389b407f..1e97d308f66b6 100644
--- a/src/amd/vulkan/radv_pipeline.c
+++ b/src/amd/vulkan/radv_pipeline.c
@@ -732,7 +732,7 @@ radv_postprocess_nir(struct radv_device *device, const struct radv_graphics_stat
    NIR_PASS(_, stage->nir, nir_opt_dce);
 
    if (!stage->key.optimisations_disabled) {
-      sink_opts |= nir_move_comparisons | nir_move_load_ubo | nir_move_load_ssbo;
+      sink_opts |= nir_move_comparisons | nir_move_load_ubo | nir_move_load_ssbo | nir_move_alu;
       NIR_PASS(_, stage->nir, nir_opt_sink, sink_opts);
 
       nir_move_options move_opts =
-- 
GitLab


From 03f6325de13aedaf7a4900a00207aef9c7dbc73c Mon Sep 17 00:00:00 2001
From: Georg Lehmann <dadschoorse@gmail.com>
Date: Fri, 12 Jan 2024 11:49:30 +0100
Subject: [PATCH 2/2] radv: move alu

The stats are decent now that aco has an ILP scheduler

Totals from 72243 (92.49% of 78112) affected shaders:
MaxWaves: 2195475 -> 2199515 (+0.18%); split: +0.20%, -0.01%
Instrs: 40845021 -> 41033150 (+0.46%); split: -0.12%, +0.58%
CodeSize: 211301872 -> 212009112 (+0.33%); split: -0.12%, +0.46%
VGPRs: 2858536 -> 2845408 (-0.46%); split: -0.58%, +0.13%
SpillSGPRs: 7815 -> 7835 (+0.26%); split: -0.15%, +0.41%
SpillVGPRs: 1253 -> 1197 (-4.47%); split: -4.63%, +0.16%
Scratch: 6269696 -> 6266624 (-0.05%); split: -0.06%, +0.01%
Latency: 261110317 -> 261590744 (+0.18%); split: -0.37%, +0.55%
InvThroughput: 42096803 -> 42038901 (-0.14%); split: -0.35%, +0.21%
VClause: 789167 -> 791508 (+0.30%); split: -0.34%, +0.64%
SClause: 1296073 -> 1298799 (+0.21%); split: -0.76%, +0.97%
Copies: 2708687 -> 2736586 (+1.03%); split: -0.85%, +1.88%
Branches: 789377 -> 789265 (-0.01%); split: -0.03%, +0.01%
PreSGPRs: 2372070 -> 2372546 (+0.02%); split: -0.25%, +0.27%
PreVGPRs: 2145824 -> 2126813 (-0.89%); split: -1.00%, +0.12%
---
 src/amd/compiler/tests/test_d3d11_derivs.cpp | 4 ++--
 src/amd/vulkan/radv_pipeline.c               | 9 +++++++--
 2 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/src/amd/compiler/tests/test_d3d11_derivs.cpp b/src/amd/compiler/tests/test_d3d11_derivs.cpp
index 4bff19aa7d21f..c8d4a699d9132 100644
--- a/src/amd/compiler/tests/test_d3d11_derivs.cpp
+++ b/src/amd/compiler/tests/test_d3d11_derivs.cpp
@@ -476,10 +476,10 @@ BEGIN_TEST(d3d11_derivs.cube_array)
    PipelineBuilder pbld(get_vk_device(GFX10_3));
    pbld.add_vsfs(vs, fs);
 
-   //>> v1: %layer = v_rndne_f32 (kill)%_
    //>> v1: %face = v_cubeid_f32 (kill)%_, (kill)%_, (kill)%_
    //>> v1: %x = v_fmaak_f32 (kill)%_, %_, 0x3fc00000
    //>> v1: %y = v_fmaak_f32 (kill)%_, (kill)%_, 0x3fc00000
+   //>> v1: %layer = v_rndne_f32 (kill)%_
    //>> v1: %face_layer = v_fmamk_f32 (kill)%layer, (kill)%face, 0x41000000
    //>> v3: %vec = p_create_vector (kill)%x, (kill)%y, (kill)%face_layer
    //>> lv3: %wqm = p_start_linear_vgpr (kill)%vec
@@ -490,8 +490,8 @@ BEGIN_TEST(d3d11_derivs.cube_array)
    //>> p_end_linear_vgpr (kill)%wqm
    pbld.print_ir(VK_SHADER_STAGE_FRAGMENT_BIT, "ACO IR");
 
-   //>> v_rndne_f32_e32 v#rl, v#_                                                             ; $_
    //>> v_cubeid_f32 v#rf, v#_, v#_, v#_                                                      ; $_ $_
+   //>> v_rndne_f32_e32 v#rl, v#_                                                             ; $_
    //>> v_fmaak_f32 v#rx, v#_, v#_, 0x3fc00000                                                ; $_ $_
    //>> v_fmaak_f32 v#ry, v#_, v#_, 0x3fc00000                                                ; $_ $_
    //>> v_fmamk_f32 v#rlf, v#rl, 0x41000000, v#rf                                             ; $_ $_
diff --git a/src/amd/vulkan/radv_pipeline.c b/src/amd/vulkan/radv_pipeline.c
index 1e97d308f66b6..b91d4d12c5e46 100644
--- a/src/amd/vulkan/radv_pipeline.c
+++ b/src/amd/vulkan/radv_pipeline.c
@@ -735,9 +735,14 @@ radv_postprocess_nir(struct radv_device *device, const struct radv_graphics_stat
       sink_opts |= nir_move_comparisons | nir_move_load_ubo | nir_move_load_ssbo | nir_move_alu;
       NIR_PASS(_, stage->nir, nir_opt_sink, sink_opts);
 
-      nir_move_options move_opts =
-         nir_move_const_undef | nir_move_load_ubo | nir_move_load_input | nir_move_comparisons | nir_move_copies;
+      nir_move_options move_opts = nir_move_const_undef | nir_move_load_ubo | nir_move_load_input |
+                                   nir_move_comparisons | nir_move_copies | nir_move_alu;
       NIR_PASS(_, stage->nir, nir_opt_move, move_opts);
+
+      /* Run nir_opt_move again to make sure that comparision are as close as possible to the first use to prevent SCC
+       * spilling.
+       */
+      NIR_PASS(_, stage->nir, nir_opt_move, nir_move_comparisons);
    }
 }
 
-- 
GitLab

