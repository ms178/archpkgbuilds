From 34a18e549d1c2a5d0b17bc9471613ceec951af75 Mon Sep 17 00:00:00 2001
From: Pierre-Eric Pelloux-Prayer <pierre-eric.pelloux-prayer@amd.com>
Date: Thu, 30 Jun 2022 09:37:31 +0200
Subject: [PATCH] vulkan/wsi: define pWaitDstStageMask in the blit submission

Otherwise we get a crash in vk_common_QueueSubmit when doing:
   .stageMask   = pSubmits[s].pWaitDstStageMask[i],

cc: mesa-stable
Closes: https://gitlab.freedesktop.org/mesa/mesa/-/issues/6712
---
 src/vulkan/wsi/wsi_common.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/src/vulkan/wsi/wsi_common.c b/src/vulkan/wsi/wsi_common.c
index f3a9361a25cb..906b018973d1 100644
--- a/src/vulkan/wsi/wsi_common.c
+++ b/src/vulkan/wsi/wsi_common.c
@@ -975,8 +975,8 @@ wsi_common_queue_present(const struct wsi_device *wsi,
    VkResult final_result = VK_SUCCESS;
 
    STACK_ARRAY(VkPipelineStageFlags, stage_flags,
-               pPresentInfo->waitSemaphoreCount);
-   for (uint32_t s = 0; s < pPresentInfo->waitSemaphoreCount; s++)
+               MAX2(1, pPresentInfo->waitSemaphoreCount));
+   for (uint32_t s = 0; s < MAX2(1, pPresentInfo->waitSemaphoreCount); s++)
       stage_flags[s] = VK_PIPELINE_STAGE_ALL_COMMANDS_BIT;
 
    const VkPresentRegionsKHR *regions =
@@ -1069,6 +1069,7 @@ wsi_common_queue_present(const struct wsi_device *wsi,
             submit_info.pSignalSemaphores = NULL;
             submit_info.commandBufferCount = 1;
             submit_info.pCommandBuffers = &image->buffer.blit_cmd_buffers[0];
+            submit_info.pWaitDstStageMask = stage_flags;
          }
       }
 
-- 
GitLab

