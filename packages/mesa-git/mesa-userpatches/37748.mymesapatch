From 57d03e4c2989d7df9d2ff64730730b97183bcec2 Mon Sep 17 00:00:00 2001
From: Samuel Pitoiset <samuel.pitoiset@gmail.com>
Date: Tue, 7 Oct 2025 21:18:38 +0200
Subject: [PATCH 1/3] ac/surface: fix host image copies with 96-bits formats

Fixes dEQP-VK.image.host_image_copy.simple.r32g32b32_* with
RADV_PERFTEST=hic on RADV.

Signed-off-by: Samuel Pitoiset <samuel.pitoiset@gmail.com>
---
 src/amd/common/ac_surface.c | 21 +++++++++++++++++----
 1 file changed, 17 insertions(+), 4 deletions(-)

diff --git a/src/amd/common/ac_surface.c b/src/amd/common/ac_surface.c
index 3e572083774b1..b63c50a38b8b1 100644
--- a/src/amd/common/ac_surface.c
+++ b/src/amd/common/ac_surface.c
@@ -4614,15 +4614,28 @@ gfx10_surface_copy_mem_surface(struct ac_addrlib *addrlib, const struct radeon_i
                                const struct ac_surface_copy_region *surf_copy_region,
                                bool surface_is_dst)
 {
+   uint32_t format = bpe_to_format(surf);
+   uint32_t bpe = surf->bpe;
+   uint32_t texel_scale = 1;
+
+   /* Adjust surface info for 96-bits formats because addrlib expects a power
+    * of two.
+    */
+   if (format == ADDR_FMT_32_32_32) {
+      format = ADDR_FMT_32;
+      bpe = 4;
+      texel_scale = 3;
+   }
+
    ADDR2_COPY_MEMSURFACE_INPUT input = {0};
    input.size = sizeof(ADDR2_COPY_MEMSURFACE_INPUT);
    input.swizzleMode = surf->u.gfx9.swizzle_mode;
-   input.format = bpe_to_format(surf);
+   input.format = format;
    input.flags.color = !(surf->flags & RADEON_SURF_Z_OR_SBUFFER);
    input.flags.depth = (surf->flags & RADEON_SURF_ZBUFFER) != 0;
    input.resourceType = (AddrResourceType)surf->u.gfx9.resource_type;
-   input.bpp = surf->bpe * 8;
-   input.unAlignedDims.width = surf_info->width;
+   input.bpp = bpe * 8;
+   input.unAlignedDims.width = surf_info->width * texel_scale;
    input.unAlignedDims.height = surf_info->height;
    input.unAlignedDims.depth = surf->u.gfx9.resource_type == RADEON_RESOURCE_3D ?
                                surf_info->depth :
@@ -4642,7 +4655,7 @@ gfx10_surface_copy_mem_surface(struct ac_addrlib *addrlib, const struct radeon_i
                   surf_copy_region->offset.z :
                   surf_copy_region->base_layer;
    region.mipId = surf_copy_region->level;
-   region.copyDims.width = surf_copy_region->extent.width;
+   region.copyDims.width = surf_copy_region->extent.width * texel_scale;
    region.copyDims.height = surf_copy_region->extent.height;
    region.copyDims.depth = surf->u.gfx9.resource_type == RADEON_RESOURCE_3D ?
                            surf_copy_region->extent.depth :
-- 
GitLab


From 56db3af2a6b866648888a1a902fe75e15da949c6 Mon Sep 17 00:00:00 2001
From: Samuel Pitoiset <samuel.pitoiset@gmail.com>
Date: Tue, 7 Oct 2025 21:41:38 +0200
Subject: [PATCH 2/3] ac/surface: fix host image copies with stencil-only

Signed-off-by: Samuel Pitoiset <samuel.pitoiset@gmail.com>
---
 src/amd/common/ac_surface.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/amd/common/ac_surface.c b/src/amd/common/ac_surface.c
index b63c50a38b8b1..508b2549d747a 100644
--- a/src/amd/common/ac_surface.c
+++ b/src/amd/common/ac_surface.c
@@ -4629,7 +4629,9 @@ gfx10_surface_copy_mem_surface(struct ac_addrlib *addrlib, const struct radeon_i
 
    ADDR2_COPY_MEMSURFACE_INPUT input = {0};
    input.size = sizeof(ADDR2_COPY_MEMSURFACE_INPUT);
-   input.swizzleMode = surf->u.gfx9.swizzle_mode;
+   input.swizzleMode = surf->has_stencil ?
+                       surf->u.gfx9.zs.stencil_swizzle_mode :
+                       surf->u.gfx9.swizzle_mode;
    input.format = format;
    input.flags.color = !(surf->flags & RADEON_SURF_Z_OR_SBUFFER);
    input.flags.depth = (surf->flags & RADEON_SURF_ZBUFFER) != 0;
-- 
GitLab


From d58c67794e02ac11a784a0808f371ed8f3570337 Mon Sep 17 00:00:00 2001
From: Samuel Pitoiset <samuel.pitoiset@gmail.com>
Date: Tue, 7 Oct 2025 21:42:43 +0200
Subject: [PATCH 3/3] radv: allow VK_FORMAT_S8_UINT with host image copy

Depth/stencil formats still need to be properly implemented.

Signed-off-by: Samuel Pitoiset <samuel.pitoiset@gmail.com>
---
 src/amd/vulkan/radv_formats.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/src/amd/vulkan/radv_formats.c b/src/amd/vulkan/radv_formats.c
index bda15796194f2..913b7ac1f4e68 100644
--- a/src/amd/vulkan/radv_formats.c
+++ b/src/amd/vulkan/radv_formats.c
@@ -483,8 +483,9 @@ radv_physical_device_get_format_properties(struct radv_physical_device *pdev, Vk
       buffer = 0;
    }
 
-   /* No depth/stencil support yet due to VKCTS issues. */
-   if (radv_host_image_copy_enabled(pdev) && !vk_format_is_depth_or_stencil(format)) {
+   /* No depth and stencil support yet. */
+   if (radv_host_image_copy_enabled(pdev) &&
+       (format != VK_FORMAT_D32_SFLOAT_S8_UINT && format != VK_FORMAT_D16_UNORM_S8_UINT)) {
       if (linear & VK_FORMAT_FEATURE_2_SAMPLED_IMAGE_BIT)
          linear |= VK_FORMAT_FEATURE_2_HOST_IMAGE_TRANSFER_BIT_EXT;
 
-- 
GitLab

