From bb647091a5da2a13a8fb46550b0c8c3971bf67fe Mon Sep 17 00:00:00 2001
From: Rhys Perry <pendingchaos02@gmail.com>
Date: Fri, 5 Aug 2022 16:34:09 +0100
Subject: [PATCH 1/6] nir/print: support nir_texop_descriptor_amd

Signed-off-by: Rhys Perry <pendingchaos02@gmail.com>
Fixes: 3098000e712 ("nir: add nir_texop_descriptor_amd")
---
 src/compiler/nir/nir_print.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/src/compiler/nir/nir_print.c b/src/compiler/nir/nir_print.c
index 8d5cb3cafeb2..7f2292460add 100644
--- a/src/compiler/nir/nir_print.c
+++ b/src/compiler/nir/nir_print.c
@@ -1244,6 +1244,9 @@ print_tex_instr(nir_tex_instr *instr, print_state *state)
    case nir_texop_fragment_mask_fetch_amd:
       fprintf(fp, "fragment_mask_fetch_amd ");
       break;
+   case nir_texop_descriptor_amd:
+      fprintf(fp, "descriptor_amd ");
+      break;
    default:
       unreachable("Invalid texture operation");
       break;
-- 
GitLab


From d02b5b6f2edfbcd15e83044df769e5cae823ce67 Mon Sep 17 00:00:00 2001
From: Rhys Perry <pendingchaos02@gmail.com>
Date: Fri, 5 Aug 2022 16:35:42 +0100
Subject: [PATCH 2/6] aco: add SCC clobber in build_cube_select

Signed-off-by: Rhys Perry <pendingchaos02@gmail.com>
Cc: mesa-stable
---
 src/amd/compiler/aco_instruction_selection.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/amd/compiler/aco_instruction_selection.cpp b/src/amd/compiler/aco_instruction_selection.cpp
index 15ab9f0143d3..136c499ebfe0 100644
--- a/src/amd/compiler/aco_instruction_selection.cpp
+++ b/src/amd/compiler/aco_instruction_selection.cpp
@@ -9292,7 +9292,7 @@ build_cube_select(isel_context* ctx, Temp ma, Temp id, Temp deriv, Temp* out_ma,
 
    Temp is_ma_z = bld.vopc(aco_opcode::v_cmp_le_f32, bld.def(bld.lm), four, id);
    Temp is_ma_y = bld.vopc(aco_opcode::v_cmp_le_f32, bld.def(bld.lm), two, id);
-   is_ma_y = bld.sop2(Builder::s_andn2, bld.def(bld.lm), is_ma_y, is_ma_z);
+   is_ma_y = bld.sop2(Builder::s_andn2, bld.def(bld.lm), bld.def(s1, scc), is_ma_y, is_ma_z);
    Temp is_not_ma_x =
       bld.sop2(aco_opcode::s_or_b64, bld.def(bld.lm), bld.def(s1, scc), is_ma_z, is_ma_y);
 
-- 
GitLab


From f5d2f6398149f4ea57d33db25de6fc7d1578fb99 Mon Sep 17 00:00:00 2001
From: Rhys Perry <pendingchaos02@gmail.com>
Date: Fri, 5 Aug 2022 16:36:21 +0100
Subject: [PATCH 3/6] ac/nir: handle out-of-bounds LOD for nir_texop_txs

Signed-off-by: Rhys Perry <pendingchaos02@gmail.com>
Fixes: 4f622d62d0d ("ac/nir: add ac_nir_lower_resinfo")
---
 src/amd/common/ac_nir_lower_resinfo.c | 15 ++++++++++-----
 1 file changed, 10 insertions(+), 5 deletions(-)

diff --git a/src/amd/common/ac_nir_lower_resinfo.c b/src/amd/common/ac_nir_lower_resinfo.c
index be5d6a89843e..6e3dce2455ac 100644
--- a/src/amd/common/ac_nir_lower_resinfo.c
+++ b/src/amd/common/ac_nir_lower_resinfo.c
@@ -34,10 +34,12 @@ static nir_ssa_def *get_field(nir_builder *b, nir_ssa_def *desc, unsigned index,
    return nir_ubfe_imm(b, nir_channel(b, desc, index), ffs(mask) - 1, util_bitcount(mask));
 }
 
-static nir_ssa_def *handle_null_desc(nir_builder *b, nir_ssa_def *desc, nir_ssa_def *value)
+static nir_ssa_def *handle_invalid_access(nir_builder *b, nir_ssa_def *desc, nir_ssa_def *value,
+                                          nir_ssa_def *is_invalid)
 {
    nir_ssa_def *is_null = nir_ieq_imm(b, nir_channel(b, desc, 1), 0);
-   return nir_bcsel(b, is_null, nir_imm_int(b, 0), value);
+   is_invalid = is_invalid ? nir_ior(b, is_invalid, is_null) : is_null;
+   return nir_bcsel(b, is_invalid, nir_imm_int(b, 0), value);
 }
 
 static nir_ssa_def *query_samples(nir_builder *b, nir_ssa_def *desc, enum glsl_sampler_dim dim)
@@ -52,7 +54,7 @@ static nir_ssa_def *query_samples(nir_builder *b, nir_ssa_def *desc, enum glsl_s
       samples = nir_imm_int(b, 1);
    }
 
-   return handle_null_desc(b, desc, samples);
+   return handle_invalid_access(b, desc, samples, NULL);
 }
 
 static nir_ssa_def *query_levels(nir_builder *b, nir_ssa_def *desc)
@@ -62,7 +64,7 @@ static nir_ssa_def *query_levels(nir_builder *b, nir_ssa_def *desc)
 
    nir_ssa_def *levels = nir_iadd_imm(b, nir_isub(b, last_level, base_level), 1);
 
-   return handle_null_desc(b, desc, levels);
+   return handle_invalid_access(b, desc, levels, NULL);
 }
 
 static nir_ssa_def *
@@ -142,6 +144,7 @@ lower_query_size(nir_builder *b, nir_ssa_def *desc, nir_src *lod,
    }
 
    /* Minify the dimensions according to base_level + lod. */
+   nir_ssa_def *is_invalid = NULL;
    if (dim != GLSL_SAMPLER_DIM_MS && dim != GLSL_SAMPLER_DIM_RECT) {
       nir_ssa_def *base_level = get_field(b, desc, 3, ~C_00A00C_BASE_LEVEL);
       nir_ssa_def *level = lod ? nir_iadd(b, base_level, lod->ssa) : base_level;
@@ -165,6 +168,8 @@ lower_query_size(nir_builder *b, nir_ssa_def *desc, nir_src *lod,
          if (has_depth)
             depth = nir_umax(b, depth, nir_imm_int(b, 1));
       }
+
+      is_invalid = nir_ult(b, get_field(b, desc, 3, ~C_00A00C_LAST_LEVEL), level);
    }
 
    nir_ssa_def *result = NULL;
@@ -190,7 +195,7 @@ lower_query_size(nir_builder *b, nir_ssa_def *desc, nir_src *lod,
       unreachable("invalid sampler dim");
    }
 
-   return handle_null_desc(b, desc, result);
+   return handle_invalid_access(b, desc, result, is_invalid);
 }
 
 static bool lower_resinfo(nir_builder *b, nir_instr *instr, void *data)
-- 
GitLab


From c8203845e78d47dcaeba6989284749de67602f82 Mon Sep 17 00:00:00 2001
From: Rhys Perry <pendingchaos02@gmail.com>
Date: Fri, 5 Aug 2022 16:34:30 +0100
Subject: [PATCH 4/6] nir/lower_tex: ignore width of cube textures

On AMD hardware, height is faster to access and we're already doing so.

Signed-off-by: Rhys Perry <pendingchaos02@gmail.com>
---
 src/compiler/nir/nir_lower_tex.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/compiler/nir/nir_lower_tex.c b/src/compiler/nir/nir_lower_tex.c
index 9add854736ac..634384fdb413 100644
--- a/src/compiler/nir/nir_lower_tex.c
+++ b/src/compiler/nir/nir_lower_tex.c
@@ -1254,7 +1254,7 @@ nir_lower_txs_cube_array(nir_builder *b, nir_tex_instr *tex)
    assert(tex->dest.is_ssa);
    assert(tex->dest.ssa.num_components == 3);
    nir_ssa_def *size = &tex->dest.ssa;
-   size = nir_vec3(b, nir_channel(b, size, 0),
+   size = nir_vec3(b, nir_channel(b, size, 1),
                       nir_channel(b, size, 1),
                       nir_idiv(b, nir_channel(b, size, 2),
                                   nir_imm_int(b, 6)));
-- 
GitLab


From 0347a284b2d51a06bb806d6ee693d185f6826fda Mon Sep 17 00:00:00 2001
From: Rhys Perry <pendingchaos02@gmail.com>
Date: Fri, 5 Aug 2022 13:50:59 +0100
Subject: [PATCH 5/6] radv: enable ac_nir_lower_resinfo for ACO

fossil-db (navi21):
Totals from 4655 (2.87% of 162293) affected shaders:
MaxWaves: 104190 -> 104674 (+0.46%)
Instrs: 3562924 -> 3656621 (+2.63%); split: -0.00%, +2.63%
CodeSize: 19309688 -> 19756412 (+2.31%); split: -0.00%, +2.31%
VGPRs: 227584 -> 224008 (-1.57%); split: -1.59%, +0.01%
Latency: 44550906 -> 44205387 (-0.78%); split: -1.62%, +0.85%
InvThroughput: 7114237 -> 7017201 (-1.36%); split: -1.42%, +0.05%
VClause: 93786 -> 86823 (-7.42%); split: -7.47%, +0.05%
SClause: 137366 -> 139169 (+1.31%); split: -0.45%, +1.76%
Copies: 214067 -> 240083 (+12.15%); split: -0.02%, +12.17%
Branches: 80487 -> 80489 (+0.00%); split: -0.00%, +0.00%
PreSGPRs: 196744 -> 202975 (+3.17%); split: -0.15%, +3.32%
PreVGPRs: 191053 -> 190150 (-0.47%)

Signed-off-by: Rhys Perry <pendingchaos02@gmail.com>
---
 src/amd/vulkan/radv_nir_apply_pipeline_layout.c | 15 ++++++++++++++-
 src/amd/vulkan/radv_nir_lower_ycbcr_textures.c  |  2 ++
 src/amd/vulkan/radv_pipeline.c                  | 11 ++++++-----
 3 files changed, 22 insertions(+), 6 deletions(-)

diff --git a/src/amd/vulkan/radv_nir_apply_pipeline_layout.c b/src/amd/vulkan/radv_nir_apply_pipeline_layout.c
index b4ab9f62416d..62b884e25989 100644
--- a/src/amd/vulkan/radv_nir_apply_pipeline_layout.c
+++ b/src/amd/vulkan/radv_nir_apply_pipeline_layout.c
@@ -366,7 +366,13 @@ update_image_intrinsic(nir_builder *b, apply_layout_state *state, nir_intrinsic_
    nir_ssa_def *desc = get_sampler_desc(
       b, state, deref, dim == GLSL_SAMPLER_DIM_BUF ? AC_DESC_BUFFER : AC_DESC_IMAGE,
       nir_intrinsic_access(intrin) & ACCESS_NON_UNIFORM, NULL, !is_load);
-   nir_rewrite_image_intrinsic(intrin, desc, true);
+
+   if (intrin->intrinsic == nir_intrinsic_image_deref_descriptor_amd) {
+      nir_ssa_def_rewrite_uses(&intrin->dest.ssa, desc);
+      nir_instr_remove(&intrin->instr);
+   } else {
+      nir_rewrite_image_intrinsic(intrin, desc, true);
+   }
 }
 
 static void
@@ -429,6 +435,7 @@ apply_layout_to_intrin(nir_builder *b, apply_layout_state *state, nir_intrinsic_
    case nir_intrinsic_image_deref_atomic_dec_wrap:
    case nir_intrinsic_image_deref_size:
    case nir_intrinsic_image_deref_samples:
+   case nir_intrinsic_image_deref_descriptor_amd:
       update_image_intrinsic(b, state, intrin);
       break;
    default:
@@ -507,6 +514,12 @@ apply_layout_to_tex(nir_builder *b, apply_layout_state *state, nir_tex_instr *te
       }
    }
 
+   if (tex->op == nir_texop_descriptor_amd) {
+      nir_ssa_def_rewrite_uses(&tex->dest.ssa, image);
+      nir_instr_remove(&tex->instr);
+      return;
+   }
+
    for (unsigned i = 0; i < tex->num_srcs; i++) {
       switch (tex->src[i].src_type) {
       case nir_tex_src_texture_deref:
diff --git a/src/amd/vulkan/radv_nir_lower_ycbcr_textures.c b/src/amd/vulkan/radv_nir_lower_ycbcr_textures.c
index e5a38b23f3ea..931e1e29a85c 100644
--- a/src/amd/vulkan/radv_nir_lower_ycbcr_textures.c
+++ b/src/amd/vulkan/radv_nir_lower_ycbcr_textures.c
@@ -56,6 +56,8 @@ get_texture_size(struct ycbcr_state *state, nir_deref_instr *texture)
    nir_ssa_dest_init(&tex->instr, &tex->dest, nir_tex_instr_dest_size(tex), 32, NULL);
    nir_builder_instr_insert(b, &tex->instr);
 
+   state->builder->shader->info.uses_resource_info_query = true;
+
    return nir_i2f32(b, &tex->dest.ssa);
 }
 
diff --git a/src/amd/vulkan/radv_pipeline.c b/src/amd/vulkan/radv_pipeline.c
index b6758802891d..7442b0c3e1f2 100644
--- a/src/amd/vulkan/radv_pipeline.c
+++ b/src/amd/vulkan/radv_pipeline.c
@@ -4836,6 +4836,12 @@ radv_create_shaders(struct radv_pipeline *pipeline, struct radv_pipeline_layout
             nir_shader_gather_info(stages[i].nir, nir_shader_get_entrypoint(stages[i].nir));
          }
 
+         NIR_PASS(_, stages[i].nir, radv_nir_lower_ycbcr_textures, pipeline_layout);
+
+         if (stages[i].nir->info.uses_resource_info_query)
+            NIR_PASS(_, stages[i].nir, ac_nir_lower_resinfo,
+                     device->physical_device->rad_info.gfx_level);
+
          struct radv_shader_info *info = &stages[i].info;
          if (pipeline->device->physical_device->rad_info.gfx_level >= GFX9) {
             if (i == MESA_SHADER_VERTEX && stages[MESA_SHADER_TESS_CTRL].nir)
@@ -4845,7 +4851,6 @@ radv_create_shaders(struct radv_pipeline *pipeline, struct radv_pipeline_layout
             else if (i == MESA_SHADER_TESS_EVAL && stages[MESA_SHADER_GEOMETRY].nir)
                info = &stages[MESA_SHADER_GEOMETRY].info;
          }
-         NIR_PASS(_, stages[i].nir, radv_nir_lower_ycbcr_textures, pipeline_layout);
          NIR_PASS_V(stages[i].nir, radv_nir_apply_pipeline_layout, device, pipeline_layout, info,
                     &stages[i].args);
 
@@ -4878,10 +4883,6 @@ radv_create_shaders(struct radv_pipeline *pipeline, struct radv_pipeline_layout
          if (lowered_ngg)
             radv_lower_ngg(device, &stages[i], pipeline_key);
 
-         if (radv_use_llvm_for_stage(device, i) &&
-             stages[i].nir->info.uses_resource_info_query)
-            NIR_PASS(_, stages[i].nir, ac_nir_lower_resinfo, device->physical_device->rad_info.gfx_level);
-
          NIR_PASS(_, stages[i].nir, ac_nir_lower_global_access);
          NIR_PASS_V(stages[i].nir, radv_nir_lower_abi, device->physical_device->rad_info.gfx_level,
                     &stages[i].info, &stages[i].args, pipeline_key,
-- 
GitLab


From a55970683363cf1b2f718c65e0904712bd1d26f5 Mon Sep 17 00:00:00 2001
From: Rhys Perry <pendingchaos02@gmail.com>
Date: Fri, 5 Aug 2022 14:11:44 +0100
Subject: [PATCH 6/6] aco: remove dead code for querying image
 size/samples/levels

ac_nir_lower_resinfo() now lowers these.

Signed-off-by: Rhys Perry <pendingchaos02@gmail.com>
---
 .../compiler/aco_instruction_selection.cpp    | 137 ------------------
 1 file changed, 137 deletions(-)

diff --git a/src/amd/compiler/aco_instruction_selection.cpp b/src/amd/compiler/aco_instruction_selection.cpp
index 136c499ebfe0..3b1edfe67614 100644
--- a/src/amd/compiler/aco_instruction_selection.cpp
+++ b/src/amd/compiler/aco_instruction_selection.cpp
@@ -6561,112 +6561,6 @@ visit_image_atomic(isel_context* ctx, nir_intrinsic_instr* instr)
    return;
 }
 
-void
-get_buffer_size(isel_context* ctx, Temp desc, Temp dst)
-{
-   if (ctx->options->gfx_level == GFX8) {
-      /* we only have to divide by 1, 2, 4, 8, 12 or 16 */
-      Builder bld(ctx->program, ctx->block);
-
-      Temp size = emit_extract_vector(ctx, desc, 2, s1);
-
-      Temp size_div3 = bld.vop3(aco_opcode::v_mul_hi_u32, bld.def(v1),
-                                bld.copy(bld.def(v1), Operand::c32(0xaaaaaaabu)), size);
-      size_div3 = bld.sop2(aco_opcode::s_lshr_b32, bld.def(s1), bld.def(s1, scc),
-                           bld.as_uniform(size_div3), Operand::c32(1u));
-
-      Temp stride = emit_extract_vector(ctx, desc, 1, s1);
-      stride = bld.sop2(aco_opcode::s_bfe_u32, bld.def(s1), bld.def(s1, scc), stride,
-                        Operand::c32((5u << 16) | 16u));
-
-      Temp is12 = bld.sopc(aco_opcode::s_cmp_eq_i32, bld.def(s1, scc), stride, Operand::c32(12u));
-      size = bld.sop2(aco_opcode::s_cselect_b32, bld.def(s1), size_div3, size, bld.scc(is12));
-
-      Temp shr_dst = dst.type() == RegType::vgpr ? bld.tmp(s1) : dst;
-      bld.sop2(aco_opcode::s_lshr_b32, Definition(shr_dst), bld.def(s1, scc), size,
-               bld.sop1(aco_opcode::s_ff1_i32_b32, bld.def(s1), stride));
-      if (dst.type() == RegType::vgpr)
-         bld.copy(Definition(dst), shr_dst);
-
-      /* TODO: we can probably calculate this faster with v_skip when stride != 12 */
-   } else {
-      emit_extract_vector(ctx, desc, 2, dst);
-   }
-}
-
-void
-visit_image_size(isel_context* ctx, nir_intrinsic_instr* instr)
-{
-   const enum glsl_sampler_dim dim = nir_intrinsic_image_dim(instr);
-   bool is_array = nir_intrinsic_image_array(instr);
-   Builder bld(ctx->program, ctx->block);
-
-   if (dim == GLSL_SAMPLER_DIM_BUF) {
-      Temp desc = bld.as_uniform(get_ssa_temp(ctx, instr->src[0].ssa));
-      return get_buffer_size(ctx, desc, get_ssa_temp(ctx, &instr->dest.ssa));
-   }
-
-   /* LOD */
-   assert(nir_src_as_uint(instr->src[1]) == 0);
-   std::vector<Temp> lod{bld.copy(bld.def(v1), Operand::zero())};
-
-   /* Resource */
-   Temp resource = bld.as_uniform(get_ssa_temp(ctx, instr->src[0].ssa));
-
-   Temp dst = get_ssa_temp(ctx, &instr->dest.ssa);
-
-   MIMG_instruction* mimg =
-      emit_mimg(bld, aco_opcode::image_get_resinfo, Definition(dst), resource, Operand(s4), lod);
-   uint8_t& dmask = mimg->dmask;
-   mimg->dim = ac_get_image_dim(ctx->options->gfx_level, dim, is_array);
-   mimg->dmask = (1 << instr->dest.ssa.num_components) - 1;
-   mimg->da = is_array;
-
-   if (ctx->options->gfx_level == GFX9 && dim == GLSL_SAMPLER_DIM_1D && is_array) {
-      assert(instr->dest.ssa.num_components == 2);
-      dmask = 0x5;
-   }
-
-   emit_split_vector(ctx, dst, instr->dest.ssa.num_components);
-}
-
-void
-get_image_samples(isel_context* ctx, Definition dst, Temp resource)
-{
-   Builder bld(ctx->program, ctx->block);
-
-   Temp dword3 = emit_extract_vector(ctx, resource, 3, s1);
-   Temp samples_log2 = bld.sop2(aco_opcode::s_bfe_u32, bld.def(s1), bld.def(s1, scc), dword3,
-                                Operand::c32(16u | 4u << 16));
-   Temp samples = bld.sop2(aco_opcode::s_lshl_b32, bld.def(s1), bld.def(s1, scc), Operand::c32(1u),
-                           samples_log2);
-   Temp type = bld.sop2(aco_opcode::s_bfe_u32, bld.def(s1), bld.def(s1, scc), dword3,
-                        Operand::c32(28u | 4u << 16 /* offset=28, width=4 */));
-
-   Operand default_sample = Operand::c32(1u);
-   if (ctx->options->robust_buffer_access) {
-      /* Extract the second dword of the descriptor, if it's
-       * all zero, then it's a null descriptor.
-       */
-      Temp dword1 = emit_extract_vector(ctx, resource, 1, s1);
-      Temp is_non_null_descriptor =
-         bld.sopc(aco_opcode::s_cmp_gt_u32, bld.def(s1, scc), dword1, Operand::zero());
-      default_sample = Operand(is_non_null_descriptor);
-   }
-
-   Temp is_msaa = bld.sopc(aco_opcode::s_cmp_ge_u32, bld.def(s1, scc), type, Operand::c32(14u));
-   bld.sop2(aco_opcode::s_cselect_b32, dst, samples, default_sample, bld.scc(is_msaa));
-}
-
-void
-visit_image_samples(isel_context* ctx, nir_intrinsic_instr* instr)
-{
-   Builder bld(ctx->program, ctx->block);
-   Temp dst = get_ssa_temp(ctx, &instr->dest.ssa);
-   Temp resource = bld.as_uniform(get_ssa_temp(ctx, instr->src[0].ssa));
-   get_image_samples(ctx, Definition(dst), resource);
-}
-
 void
 visit_load_ssbo(isel_context* ctx, nir_intrinsic_instr* instr)
 {
@@ -8442,8 +8336,6 @@ visit_intrinsic(isel_context* ctx, nir_intrinsic_instr* instr)
    case nir_intrinsic_bindless_image_atomic_comp_swap:
    case nir_intrinsic_bindless_image_atomic_fmin:
    case nir_intrinsic_bindless_image_atomic_fmax: visit_image_atomic(ctx, instr); break;
-   case nir_intrinsic_bindless_image_size: visit_image_size(ctx, instr); break;
-   case nir_intrinsic_bindless_image_samples: visit_image_samples(ctx, instr); break;
    case nir_intrinsic_load_ssbo: visit_load_ssbo(ctx, instr); break;
    case nir_intrinsic_store_ssbo: visit_store_ssbo(ctx, instr); break;
    case nir_intrinsic_load_buffer_amd: visit_load_buffer(ctx, instr); break;
@@ -9504,14 +9396,6 @@ visit_tex(isel_context* ctx, nir_tex_instr* instr)
       }
    }
 
-   if (instr->op == nir_texop_txs && instr->sampler_dim == GLSL_SAMPLER_DIM_BUF)
-      return get_buffer_size(ctx, resource, get_ssa_temp(ctx, &instr->dest.ssa));
-
-   if (instr->op == nir_texop_texture_samples) {
-      get_image_samples(ctx, Definition(get_ssa_temp(ctx, &instr->dest.ssa)), resource);
-      return;
-   }
-
    if (has_offset) {
       assert(instr->op != nir_texop_txf);
 
@@ -9669,27 +9553,6 @@ visit_tex(isel_context* ctx, nir_tex_instr* instr)
       tmp_dst = bld.tmp(RegClass::get(RegType::vgpr, bytes));
    }
 
-   if (instr->op == nir_texop_txs || instr->op == nir_texop_query_levels) {
-      if (!has_lod)
-         lod = bld.copy(bld.def(v1), Operand::zero());
-
-      MIMG_instruction* tex = emit_mimg(bld, aco_opcode::image_get_resinfo, Definition(tmp_dst),
-                                        resource, Operand(s4), std::vector<Temp>{lod});
-      if (ctx->options->gfx_level == GFX9 && instr->op == nir_texop_txs &&
-          instr->sampler_dim == GLSL_SAMPLER_DIM_1D && instr->is_array) {
-         tex->dmask = (dmask & 0x1) | ((dmask & 0x2) << 1);
-      } else if (instr->op == nir_texop_query_levels) {
-         tex->dmask = 1 << 3;
-      } else {
-         tex->dmask = dmask;
-      }
-      tex->da = da;
-      tex->dim = dim;
-
-      expand_vector(ctx, tmp_dst, dst, instr->dest.ssa.num_components, dmask);
-      return;
-   }
-
    Temp tg4_compare_cube_wa64 = Temp();
 
    if (tg4_integer_workarounds) {
-- 
GitLab

