From 1fd6a64202928c278d49b45645d23a2a2f3f09bc Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 15 Aug 2023 22:05:23 +0200
Subject: [PATCH] vulkan/wsi/x11: Only open capture_conn when tracing

Opening the connection can also be skipped if no trace modes are
selected.

Closes: https://gitlab.freedesktop.org/mesa/mesa/-/issues/9578
---
 src/vulkan/wsi/wsi_common_x11.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/vulkan/wsi/wsi_common_x11.c b/src/vulkan/wsi/wsi_common_x11.c
index 2dff27afa643c..b7de4fb109595 100644
--- a/src/vulkan/wsi/wsi_common_x11.c
+++ b/src/vulkan/wsi/wsi_common_x11.c
@@ -2652,7 +2652,7 @@ x11_surface_create_swapchain(VkIcdSurfaceBase *icd_surface,
 
 #ifdef XCB_KEYSYMS_AVAILABLE
    VK_FROM_HANDLE(vk_device, vk_device, device);
-   if (vk_device->capture_trace) {
+   if (vk_device->capture_trace && vk_device->physical->instance->trace_mode) {
       chain->capture_conn = xcb_connect(NULL, NULL);
       assert(!xcb_connection_has_error(chain->capture_conn));
 
-- 
GitLab

