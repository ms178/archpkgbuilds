From c649c083583ab280012da3127e927c101f93956f Mon Sep 17 00:00:00 2001
From: Max Lee <endlesspring@google.com>
Date: Wed, 12 Oct 2022 14:41:12 +1100
Subject: [PATCH] drm-shim: add __readlink_chk as identical to readlink

As per Linux Standard Base Core Specification 4.0, __readlink_chk
display value of a symbolic link, with buffer overflow checking.

if size > buflen, __chk_fail() is called, which terminates the
function for buffer overflow.

Signed-off-by: Max Lee <endlesspring@chromium.org>
---
 src/drm-shim/drm_shim.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/src/drm-shim/drm_shim.c b/src/drm-shim/drm_shim.c
index 974013ea586d..8415f52f56ad 100644
--- a/src/drm-shim/drm_shim.c
+++ b/src/drm-shim/drm_shim.c
@@ -638,6 +638,15 @@ readlink(const char *path, char *buf, size_t size)
    return strlen(buf) + 1;
 }
 
+/* Identical to readlink, but with buffer overflow check */
+PUBLIC ssize_t
+__readlink_chk(const char *path, char *buf, size_t size, size_t buflen)
+{
+   if (size > buflen)
+      __chk_fail();
+   return readlink(path, buf, size);
+}
+
 /* Handles libdrm's realpath to figure out what kind of device we have. */
 PUBLIC char *
 realpath(const char *path, char *resolved_path)
-- 
GitLab

