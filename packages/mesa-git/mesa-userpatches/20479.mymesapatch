From a7d39a3aa801a0e1a7c8cbd1d61eaeabcc4d2c75 Mon Sep 17 00:00:00 2001
From: Pierre-Eric Pelloux-Prayer <pierre-eric.pelloux-prayer@amd.com>
Date: Mon, 2 Jan 2023 17:27:41 +0100
Subject: [PATCH] egl: handle NULL loaderPrivate in dri_is_thread_safe

This can happen when a context is created from
loader_dri3_blit_context_get and glthread is enabled.

Closes: https://gitlab.freedesktop.org/mesa/mesa/-/issues/7949
Closes: https://gitlab.freedesktop.org/mesa/mesa/-/issues/7960
Cc: mesa-stable
---
 src/egl/drivers/dri2/egl_dri2.c | 8 ++++++++
 1 file changed, 8 insertions(+)

diff --git a/src/egl/drivers/dri2/egl_dri2.c b/src/egl/drivers/dri2/egl_dri2.c
index 239dc6d9f170..d206de82110e 100644
--- a/src/egl/drivers/dri2/egl_dri2.c
+++ b/src/egl/drivers/dri2/egl_dri2.c
@@ -163,6 +163,14 @@ static GLboolean
 dri_is_thread_safe(void *loaderPrivate)
 {
    struct dri2_egl_surface *dri2_surf = loaderPrivate;
+
+   /* loader_dri3_blit_context_get creates a context with
+    * loaderPrivate being NULL. Enabling glthread for a blitting
+    * context isn't useful so return false.
+    */
+   if (!loaderPrivate)
+      return false;
+
    UNUSED _EGLDisplay *display =  dri2_surf->base.Resource.Display;
 
 #ifdef HAVE_X11_PLATFORM
-- 
GitLab

