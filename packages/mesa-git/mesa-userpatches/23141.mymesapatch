From 711ce980ffaf641e7ca36b655f8227b9ceafad4e Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Fri, 19 May 2023 22:20:21 +0200
Subject: [PATCH] nir/lower_shader_calls: Fix CF insertion with block cursors

The block may be part of the extracted CF list so canonicalize it to
before/after_instr instead.-

cc: mesa-stable
---
 src/compiler/nir/nir_lower_shader_calls.c | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/src/compiler/nir/nir_lower_shader_calls.c b/src/compiler/nir/nir_lower_shader_calls.c
index e93a50c11ed3..3085faf6bcfd 100644
--- a/src/compiler/nir/nir_lower_shader_calls.c
+++ b/src/compiler/nir/nir_lower_shader_calls.c
@@ -1078,6 +1078,21 @@ flatten_resume_if_ladder(nir_builder *b,
    return false;
 
 found_resume:
+   /* If the cursor points to a block, change it to point to an instruction
+    * because the cursor block may be part of the extracted CF list.
+    */
+   if (b->cursor.option == nir_cursor_before_block) {
+      if (exec_list_is_empty(&b->cursor.block->instr_list))
+         nir_nop(b);
+      else
+         b->cursor = nir_before_instr(nir_block_first_instr(b->cursor.block));
+   } else if (b->cursor.option == nir_cursor_after_block) {
+      if (exec_list_is_empty(&b->cursor.block->instr_list))
+         nir_nop(b);
+      else
+         b->cursor = nir_after_instr(nir_block_last_instr(b->cursor.block));
+   }
+
    /* If we got here then we found either the resume node or the resume
     * instruction in this CF list.
     */
-- 
GitLab

