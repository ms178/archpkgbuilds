From 8d19123a583698f85cb5bcdba4e0d9466464cabc Mon Sep 17 00:00:00 2001
From: Nicolas Dufresne <nicolas.dufresne@collabora.com>
Date: Thu, 13 Apr 2023 11:01:46 -0400
Subject: [PATCH] gallium: vl: Fix YUY2 and UYVY format mapping

As implemented in src/gallium/frontends/dri/dri2.c:

static const struct dri2_format_mapping r8g8_r8b8_mapping = {
   DRM_FORMAT_YUYV,
   __DRI_IMAGE_FORMAT_NONE,
   __DRI_IMAGE_COMPONENTS_Y_XUXV,
   PIPE_FORMAT_R8G8_R8B8_UNORM, 2,
   { { 0, 0, 0, __DRI_IMAGE_FORMAT_GR88 },
     { 0, 1, 0, __DRI_IMAGE_FORMAT_ARGB8888 } }
};

static const struct dri2_format_mapping g8r8_b8r8_mapping = {
   DRM_FORMAT_UYVY,
   __DRI_IMAGE_FORMAT_NONE,
   __DRI_IMAGE_COMPONENTS_Y_XUXV,
   PIPE_FORMAT_G8R8_B8R8_UNORM, 2,
   { { 0, 0, 0, __DRI_IMAGE_FORMAT_GR88 },
     { 0, 1, 0, __DRI_IMAGE_FORMAT_ABGR8888 } }
};

YUYV should map to PIPE_FORMAT_R8G8_R8B8_UNORM while UYVY to
PIPE_FORMAT_G8R8_B8R8_UNORM. This is inverted in the video library. This
bug became visible after fixing the swizzling for these formats.

Fixes: dc2119bf3fa ("util/format: Fix wrong colors when importing YUYV and UYVY")
Signed-off-by: Nicolas Dufresne <nicolas.dufresne@collabora.com>
---
 src/gallium/auxiliary/vl/vl_video_buffer.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/gallium/auxiliary/vl/vl_video_buffer.c b/src/gallium/auxiliary/vl/vl_video_buffer.c
index 42479c6de2ef..c7195ce807db 100644
--- a/src/gallium/auxiliary/vl/vl_video_buffer.c
+++ b/src/gallium/auxiliary/vl/vl_video_buffer.c
@@ -63,9 +63,9 @@ vl_get_video_buffer_formats(struct pipe_screen *screen, enum pipe_format format,
       out_format[i] = PIPE_FORMAT_NONE;
 
    if (format == PIPE_FORMAT_YUYV)
-      out_format[0] = PIPE_FORMAT_R8G8_R8B8_UNORM;
-   else if (format == PIPE_FORMAT_UYVY)
       out_format[0] = PIPE_FORMAT_G8R8_B8R8_UNORM;
+   else if (format == PIPE_FORMAT_UYVY)
+      out_format[0] = PIPE_FORMAT_R8G8_R8B8_UNORM;
 }
 
 const unsigned *
-- 
GitLab

