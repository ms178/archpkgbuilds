From 5d07d88c948c5f65c2b90abb9a086edbda46fc53 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 20 Dec 2022 18:26:34 +0100
Subject: [PATCH] nir/lower_shader_calls: Remat derefs before lowering resumes

Closes: #7923
cc: mesa-stable
---
 src/compiler/nir/nir_lower_shader_calls.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/src/compiler/nir/nir_lower_shader_calls.c b/src/compiler/nir/nir_lower_shader_calls.c
index 02c8478c46ba..6d87897ee640 100644
--- a/src/compiler/nir/nir_lower_shader_calls.c
+++ b/src/compiler/nir/nir_lower_shader_calls.c
@@ -1182,6 +1182,8 @@ lower_resume(nir_shader *shader, int call_idx)
    nir_function_impl *impl = nir_shader_get_entrypoint(shader);
    nir_instr *resume_instr = find_resume_instr(impl, call_idx);
 
+   nir_rematerialize_derefs_in_use_blocks_impl(impl);
+
    if (duplicate_loop_bodies(impl, resume_instr)) {
       nir_validate_shader(shader, "after duplicate_loop_bodies in "
                                   "nir_lower_shader_calls");
-- 
GitLab

