From 67f7f241c570398e9ef56de0109d4b2872f20b3e Mon Sep 17 00:00:00 2001
From: Yiwei Zhang <zzyiwei@chromium.org>
Date: Sat, 9 Dec 2023 08:53:09 +0000
Subject: [PATCH] vulkan/wsi/x11: properly set VK_SUBOPTIMAL_KHR for
 SUBOPTIMAL_COPY

Similar to the prior fix, this is again under Xwayland but is with
quite recent version with full zwp_linux_dmabuf_v1 (version 4) support.
Then with the activated DRI3 modifiers code path via Xwayland, we have
started seeing the XCB_PRESENT_COMPLETE_MODE_SUBOPTIMAL_COPY event to
occur when:
1. a new swapchain is created (before acquire, and no present yet)
2. switching from window to fullscreen, which is likely due to the
   pending present from old window size swapchain

There's no such transient event received when switching from fullscreen
to window mode.

Each swapchain is already treated as being independent. So we apply the
same FLIP->COPY/SUBOPTIMAL_COPY trick to avoid the false alarm (because
suboptimal is sticky) from such transient event.

Fixes: 206fe780d50 ("vulkan/wsi/x11: do not inherit last_present_mode")
Signed-off-by: Yiwei Zhang <zzyiwei@chromium.org>
---
 src/vulkan/wsi/wsi_common_x11.c | 6 ++----
 1 file changed, 2 insertions(+), 4 deletions(-)

diff --git a/src/vulkan/wsi/wsi_common_x11.c b/src/vulkan/wsi/wsi_common_x11.c
index 9cfdc6f968374..3ff890be0157b 100644
--- a/src/vulkan/wsi/wsi_common_x11.c
+++ b/src/vulkan/wsi/wsi_common_x11.c
@@ -1285,10 +1285,8 @@ x11_handle_dri3_present_event(struct x11_swapchain *chain,
          break;
 #ifdef HAVE_DRI3_MODIFIERS
       case XCB_PRESENT_COMPLETE_MODE_SUBOPTIMAL_COPY:
-         /* The winsys is now trying to flip directly and cannot due to our
-          * configuration. Request the user reallocate.
-          */
-         result = VK_SUBOPTIMAL_KHR;
+         if (chain->copy_is_suboptimal)
+            result = VK_SUBOPTIMAL_KHR;
          break;
 #endif
       default:
-- 
GitLab

