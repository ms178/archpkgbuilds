From de1065fa4b3de03b259694f1937e432e7a07cae7 Mon Sep 17 00:00:00 2001
From: Georg Lehmann <dadschoorse@gmail.com>
Date: Sat, 4 Nov 2023 11:01:41 +0100
Subject: [PATCH] aco: don't CSE v_permlane across exec

With bc=1 and fi=0 it needs to return 0 for inactive lanes.
---
 src/amd/compiler/aco_opt_value_numbering.cpp | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/src/amd/compiler/aco_opt_value_numbering.cpp b/src/amd/compiler/aco_opt_value_numbering.cpp
index f939466f3cf88..acf032fd1c44a 100644
--- a/src/amd/compiler/aco_opt_value_numbering.cpp
+++ b/src/amd/compiler/aco_opt_value_numbering.cpp
@@ -166,15 +166,17 @@ struct InstrPred {
          }
       }
 
-      if (a->opcode == aco_opcode::v_readfirstlane_b32)
-         return a->pass_flags == b->pass_flags;
-
       if (a->isVALU()) {
          VALU_instruction& aV = a->valu();
          VALU_instruction& bV = b->valu();
          if (aV.abs != bV.abs || aV.neg != bV.neg || aV.clamp != bV.clamp || aV.omod != bV.omod ||
              aV.opsel != bV.opsel || aV.opsel_lo != bV.opsel_lo || aV.opsel_hi != bV.opsel_hi)
             return false;
+
+         if (a->opcode == aco_opcode::v_permlane16_b32 ||
+             a->opcode == aco_opcode::v_permlanex16_b32 ||
+             a->opcode == aco_opcode::v_readfirstlane_b32)
+            return aV.pass_flags == bV.pass_flags;
       }
       if (a->isDPP16()) {
          DPP16_instruction& aDPP = a->dpp16();
-- 
GitLab

