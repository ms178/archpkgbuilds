From 3d47ef06780e6e085422d0a5974ce46608b7a812 Mon Sep 17 00:00:00 2001
From: Adam Jackson <ajax@redhat.com>
Date: Tue, 20 Sep 2022 17:51:42 -0400
Subject: [PATCH 2/5] egl: Formatting fix
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Reviewed-by: Marek Olšák <marek.olsak@amd.com>
---
 src/egl/main/eglapi.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/egl/main/eglapi.c b/src/egl/main/eglapi.c
index e2014e52d2bf..f9d32b92dbd1 100644
--- a/src/egl/main/eglapi.c
+++ b/src/egl/main/eglapi.c
@@ -906,7 +906,7 @@ eglCreateContext(EGLDisplay dpy, EGLConfig config, EGLContext share_list,
 
    if (!share && share_list != EGL_NO_CONTEXT)
       RETURN_EGL_ERROR(disp, EGL_BAD_CONTEXT, EGL_NO_CONTEXT);
-   else if(share && share->Resource.Display != disp) {
+   else if (share && share->Resource.Display != disp) {
       /* From the spec.
        *
        * "An EGL_BAD_MATCH error is generated if an OpenGL or OpenGL ES
-- 
GitLab


From 731be3f247271074942a8df38e3c7cc3bcc1cc2f Mon Sep 17 00:00:00 2001
From: Adam Jackson <ajax@redhat.com>
Date: Tue, 20 Sep 2022 14:55:37 -0400
Subject: [PATCH 3/5] egl: Factor some common terminate cleanup up to common
 code
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

It's a little difficult to see from the diff, but this is effectively
the same calling sequence as before, and more importantly it means the
backend only cleans up backend state rather than needing to call up to
the core.

Reviewed-by: Marek Olšák <marek.olsak@amd.com>
---
 src/egl/drivers/dri2/egl_dri2.c | 4 ----
 src/egl/drivers/wgl/egl_wgl.c   | 4 ----
 src/egl/main/eglapi.c           | 9 ++-------
 src/egl/main/egldisplay.c       | 8 +++++++-
 4 files changed, 9 insertions(+), 16 deletions(-)

diff --git a/src/egl/drivers/dri2/egl_dri2.c b/src/egl/drivers/dri2/egl_dri2.c
index 13d957580f0c..356548e11dc5 100644
--- a/src/egl/drivers/dri2/egl_dri2.c
+++ b/src/egl/drivers/dri2/egl_dri2.c
@@ -1225,7 +1225,6 @@ dri2_display_release(_EGLDisplay *disp)
    if (!p_atomic_dec_zero(&dri2_dpy->ref_count))
       return;
 
-   _eglCleanupDisplay(disp);
    dri2_display_destroy(disp);
 }
 
@@ -1327,9 +1326,6 @@ dri2_egl_surface_free_local_buffers(struct dri2_egl_surface *dri2_surf)
 static EGLBoolean
 dri2_terminate(_EGLDisplay *disp)
 {
-   /* Release all non-current Context/Surfaces. */
-   _eglReleaseDisplayResources(disp);
-
    dri2_display_release(disp);
 
    return EGL_TRUE;
diff --git a/src/egl/drivers/wgl/egl_wgl.c b/src/egl/drivers/wgl/egl_wgl.c
index 9165ae5646fd..f069b450df76 100644
--- a/src/egl/drivers/wgl/egl_wgl.c
+++ b/src/egl/drivers/wgl/egl_wgl.c
@@ -357,7 +357,6 @@ wgl_display_release(_EGLDisplay *disp)
    if (!p_atomic_dec_zero(&wgl_dpy->ref_count))
       return;
 
-   _eglCleanupDisplay(disp);
    wgl_display_destroy(disp);
 }
 
@@ -370,9 +369,6 @@ wgl_display_release(_EGLDisplay *disp)
 static EGLBoolean
 wgl_terminate(_EGLDisplay *disp)
 {
-   /* Release all non-current Context/Surfaces. */
-   _eglReleaseDisplayResources(disp);
-
    wgl_display_release(disp);
 
    return EGL_TRUE;
diff --git a/src/egl/main/eglapi.c b/src/egl/main/eglapi.c
index f9d32b92dbd1..57df75cd7259 100644
--- a/src/egl/main/eglapi.c
+++ b/src/egl/main/eglapi.c
@@ -779,14 +779,9 @@ eglTerminate(EGLDisplay dpy)
       RETURN_EGL_ERROR(NULL, EGL_BAD_DISPLAY, EGL_FALSE);
 
    if (disp->Initialized) {
+      _eglReleaseDisplayResources(disp);
       disp->Driver->Terminate(disp);
-      /* do not reset disp->Driver */
-      disp->ClientAPIsString[0] = 0;
-      disp->Initialized = EGL_FALSE;
-
-      /* Reset blob cache funcs on terminate. */
-      disp->BlobCacheSet = NULL;
-      disp->BlobCacheGet = NULL;
+      _eglCleanupDisplay(disp);
    }
 
    simple_mtx_unlock(&disp->Mutex);
diff --git a/src/egl/main/egldisplay.c b/src/egl/main/egldisplay.c
index 39850e34f7c6..52a910272920 100644
--- a/src/egl/main/egldisplay.c
+++ b/src/egl/main/egldisplay.c
@@ -370,7 +370,13 @@ _eglCleanupDisplay(_EGLDisplay *disp)
       disp->Configs = NULL;
    }
 
-   /* XXX incomplete */
+   /* do not reset disp->Driver */
+   disp->ClientAPIsString[0] = 0;
+   disp->Initialized = EGL_FALSE;
+
+   /* Reset blob cache funcs on terminate. */
+   disp->BlobCacheSet = NULL;
+   disp->BlobCacheGet = NULL;
 }
 
 
-- 
GitLab


From 5c001125d9d1c2be521f630428a0f049b0700fb1 Mon Sep 17 00:00:00 2001
From: Adam Jackson <ajax@redhat.com>
Date: Tue, 20 Sep 2022 17:50:42 -0400
Subject: [PATCH 4/5] egl/dri2: Fix a weird conditional in dri2_make_current
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

It's not valid to get here with no context but with real surfaces.

Reviewed-by: Marek Olšák <marek.olsak@amd.com>
---
 src/egl/drivers/dri2/egl_dri2.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/egl/drivers/dri2/egl_dri2.c b/src/egl/drivers/dri2/egl_dri2.c
index 356548e11dc5..c62e130d6441 100644
--- a/src/egl/drivers/dri2/egl_dri2.c
+++ b/src/egl/drivers/dri2/egl_dri2.c
@@ -1825,7 +1825,7 @@ dri2_make_current(_EGLDisplay *disp, _EGLSurface *dsurf,
    rdraw = (rsurf) ? dri2_dpy->vtbl->get_dri_drawable(rsurf) : NULL;
    cctx = (dri2_ctx) ? dri2_ctx->dri_context : NULL;
 
-   if (cctx || ddraw || rdraw) {
+   if (cctx) {
       if (!dri2_dpy->core->bindContext(cctx, ddraw, rdraw)) {
          _EGLContext *tmp_ctx;
 
-- 
GitLab


From 9f237c0b3953b81efc1f6a7e5ff037e883792dff Mon Sep 17 00:00:00 2001
From: Adam Jackson <ajax@redhat.com>
Date: Thu, 22 Sep 2022 15:15:14 -0400
Subject: [PATCH 5/5] egl: Remove a bogus restriction from eglMakeCurrent
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The comment here is from the EGL_MESA_configless_context era, and maybe
that was true, but EGL_KHR_no_config_context has no such restriction.
The only restriction is that both surfaces be compatible with the
context, but a no-config context is defined to be compatible with any
surface.

Reviewed-by: Marek Olšák <marek.olsak@amd.com>
---
 src/egl/main/eglcontext.c | 5 -----
 1 file changed, 5 deletions(-)

diff --git a/src/egl/main/eglcontext.c b/src/egl/main/eglcontext.c
index aa483a6ff02e..e7b4cd073f23 100644
--- a/src/egl/main/eglcontext.c
+++ b/src/egl/main/eglcontext.c
@@ -785,11 +785,6 @@ _eglCheckMakeCurrent(_EGLContext *ctx, _EGLSurface *draw, _EGLSurface *read)
       /* Otherwise we must be using the EGL_KHR_no_config_context
        * extension */
       assert(disp->Extensions.KHR_no_config_context);
-
-      /* The extension doesn't permit binding draw and read buffers with
-       * differing contexts */
-      if (draw && read && draw->Config != read->Config)
-         return _eglError(EGL_BAD_MATCH, "eglMakeCurrent");
    }
 
    return EGL_TRUE;
-- 
GitLab

