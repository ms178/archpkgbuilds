From 1d06241d1bac40bb79dfb1859d4c5b7eed6fef33 Mon Sep 17 00:00:00 2001
From: Samuel Pitoiset <samuel.pitoiset@gmail.com>
Date: Fri, 21 Apr 2023 15:44:56 +0200
Subject: [PATCH] radv: add the perf counters BO to the preambles BO list

If the submission isn't chained for any reasons, we might end by
submitting the performance counter preambles without a command
buffer that added this BO to its list.

Found by inspection.

Cc: mesa-stable
Signed-off-by: Samuel Pitoiset <samuel.pitoiset@gmail.com>
---
 src/amd/vulkan/radv_queue.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/src/amd/vulkan/radv_queue.c b/src/amd/vulkan/radv_queue.c
index b28797547be6..4ec2e6329d1f 100644
--- a/src/amd/vulkan/radv_queue.c
+++ b/src/amd/vulkan/radv_queue.c
@@ -1482,6 +1482,8 @@ radv_create_perf_counter_lock_cs(struct radv_device *device, unsigned pass, bool
 
    ASSERTED unsigned cdw = radeon_check_space(device->ws, cs, 21);
 
+   radv_cs_add_buffer(device->ws, cs, device->perf_counter_bo);
+
    if (!unlock) {
       uint64_t mutex_va = radv_buffer_get_va(device->perf_counter_bo) + PERF_CTR_BO_LOCK_OFFSET;
       radeon_emit(cs, PKT3(PKT3_ATOMIC_MEM, 7, 0));
-- 
GitLab

