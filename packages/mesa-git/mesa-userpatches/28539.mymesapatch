From 601509dd07711bd73905eae6b5faa52326dc83a6 Mon Sep 17 00:00:00 2001
From: Ganesh Belgur Ramachandra <ganesh.belgurramachandra@amd.com>
Date: Wed, 3 Apr 2024 02:24:58 -0500
Subject: [PATCH] radeonsi: add nir_opt_gcm pass

With GVN enabled, it was too aggressive. There were deqp failures.
Opting for a weaker GVN works better.
---
 src/gallium/drivers/radeonsi/si_shader_nir.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/src/gallium/drivers/radeonsi/si_shader_nir.c b/src/gallium/drivers/radeonsi/si_shader_nir.c
index e525a36c5837f..a2889b3131642 100644
--- a/src/gallium/drivers/radeonsi/si_shader_nir.c
+++ b/src/gallium/drivers/radeonsi/si_shader_nir.c
@@ -110,6 +110,7 @@ void si_nir_opts(struct si_screen *sscreen, struct nir_shader *nir, bool first)
       progress |= lower_alu_to_scalar | lower_phis_to_scalar;
 
       NIR_PASS(progress, nir, nir_opt_cse);
+      NIR_PASS(progress, nir, nir_opt_gcm, false);
       NIR_PASS(progress, nir, nir_opt_peephole_select, 8, true, true);
 
       /* Needed for algebraic lowering */
@@ -172,6 +173,7 @@ void si_nir_late_opts(nir_shader *nir)
       NIR_PASS_V(nir, nir_copy_prop);
       NIR_PASS_V(nir, nir_opt_dce);
       NIR_PASS_V(nir, nir_opt_cse);
+      NIR_PASS_V(nir, nir_opt_gcm, false);
    }
 }
 
-- 
GitLab

