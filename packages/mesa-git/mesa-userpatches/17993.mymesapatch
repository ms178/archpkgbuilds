From 2919c59db8e1fbece4bf7c5cb1852f27961f28c6 Mon Sep 17 00:00:00 2001
From: Mike Blumenkrantz <michael.blumenkrantz@gmail.com>
Date: Wed, 10 Aug 2022 14:43:22 -0400
Subject: [PATCH 1/2] radv: remove stupid conditional from draw path

compilers are now provably smart enough to handle this
---
 src/amd/vulkan/radv_cmd_buffer.c | 12 +++---------
 1 file changed, 3 insertions(+), 9 deletions(-)

diff --git a/src/amd/vulkan/radv_cmd_buffer.c b/src/amd/vulkan/radv_cmd_buffer.c
index 5922eccc3ad3..5671e82f298f 100644
--- a/src/amd/vulkan/radv_cmd_buffer.c
+++ b/src/amd/vulkan/radv_cmd_buffer.c
@@ -6766,16 +6766,10 @@ radv_emit_userdata_vertex(struct radv_cmd_buffer *cmd_buffer, const struct radv_
    const bool uses_baseinstance = state->graphics_pipeline->uses_baseinstance;
    const bool uses_drawid = state->graphics_pipeline->uses_drawid;
 
-   /* this looks very dumb, but it allows the compiler to optimize better and yields
-    * ~3-4% perf increase in drawoverhead
-    */
-   if (vertex_offset != state->last_vertex_offset) {
-      radv_emit_userdata_vertex_internal(cmd_buffer, info, vertex_offset);
-   } else if (uses_drawid && 0 != state->last_drawid) {
+   if (vertex_offset != state->last_vertex_offset ||
+       (uses_drawid && 0 != state->last_drawid) ||
+       (uses_baseinstance && info->first_instance != state->last_first_instance))
       radv_emit_userdata_vertex_internal(cmd_buffer, info, vertex_offset);
-   } else if (uses_baseinstance && info->first_instance != state->last_first_instance) {
-      radv_emit_userdata_vertex_internal(cmd_buffer, info, vertex_offset);
-   }
 }
 
 ALWAYS_INLINE static void
-- 
GitLab


From d1c20194b94846c226505b22a393ff5f8e45b8de Mon Sep 17 00:00:00 2001
From: Mike Blumenkrantz <michael.blumenkrantz@gmail.com>
Date: Wed, 10 Aug 2022 14:43:57 -0400
Subject: [PATCH 2/2] radv: force inlining on another draw function

---
 src/amd/vulkan/radv_cmd_buffer.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/amd/vulkan/radv_cmd_buffer.c b/src/amd/vulkan/radv_cmd_buffer.c
index 5671e82f298f..285239dfb2ee 100644
--- a/src/amd/vulkan/radv_cmd_buffer.c
+++ b/src/amd/vulkan/radv_cmd_buffer.c
@@ -6735,7 +6735,7 @@ radv_cs_emit_dispatch_taskmesh_gfx_packet(struct radv_cmd_buffer *cmd_buffer)
    radeon_emit(cs, V_0287F0_DI_SRC_SEL_AUTO_INDEX);
 }
 
-static inline void
+ALWAYS_INLINE static void
 radv_emit_userdata_vertex_internal(struct radv_cmd_buffer *cmd_buffer,
                                    const struct radv_draw_info *info, const uint32_t vertex_offset)
 {
-- 
GitLab

