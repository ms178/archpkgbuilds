From d914c96da27746a2dfffbc7c4cd81e4a81e8c0e4 Mon Sep 17 00:00:00 2001
From: Pierre-Eric Pelloux-Prayer <pierre-eric.pelloux-prayer@amd.com>
Date: Mon, 30 Oct 2023 16:00:56 +0100
Subject: [PATCH] mesa: use _mesa_set_varying_vp_inputs before building ff frag

Fixed func fragment program depends on ctx->VertexProgram._VaryingInputs so
make sure it's up to date before calling _mesa_get_fixed_func_fragment_program.

Fixes: c97961a855a ("mesa: fix 38% decrease in display list performance of Viewperf2020/NX8_StudioAA")
Closes: https://gitlab.freedesktop.org/mesa/mesa/-/issues/9441
---
 src/mesa/main/state.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/mesa/main/state.c b/src/mesa/main/state.c
index 736b2ae6c2ba4..05736c0c8c1b9 100644
--- a/src/mesa/main/state.c
+++ b/src/mesa/main/state.c
@@ -255,6 +255,13 @@ update_program(struct gl_context *ctx)
       _mesa_reference_program(ctx, &ctx->FragmentProgram._TexEnvProgram,
                               NULL);
    } else {
+      /* filter_fp_input_mask will be called by _mesa_get_fixed_func_fragment_program
+       * (through make_state_key) and its behavior depends on
+       * ctx->VertexProgram._VaryingInputs.
+       */
+      _mesa_set_varying_vp_inputs(ctx, ctx->VertexProgram._VPModeInputFilter &
+                                  ctx->Array._DrawVAO->_EnabledWithMapMode);
+
       /* Use fragment program generated from fixed-function state */
       _mesa_reference_program(ctx, &ctx->FragmentProgram._Current,
                               _mesa_get_fixed_func_fragment_program(ctx));
-- 
GitLab

