From da04bb2fc0cfa40003be003f0c8c3cb83ae7e059 Mon Sep 17 00:00:00 2001
From: Samuel Pitoiset <samuel.pitoiset@gmail.com>
Date: Tue, 9 Apr 2024 16:19:45 +0200
Subject: [PATCH] radv: use canonicalized VA for VM fault reports

Otherwise, the returned VA from vkGetBufferDeviceAddress() or via
VK_EXT_device_address_binding_report doesn't match and applications
would have to mask out.

Cc: mesa-stable
Signed-off-by: Samuel Pitoiset <samuel.pitoiset@gmail.com>
---
 src/amd/vulkan/radv_debug.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/amd/vulkan/radv_debug.c b/src/amd/vulkan/radv_debug.c
index 306cf0a392830..65e9934e62bb1 100644
--- a/src/amd/vulkan/radv_debug.c
+++ b/src/amd/vulkan/radv_debug.c
@@ -1124,7 +1124,7 @@ radv_GetDeviceFaultInfoEXT(VkDevice _device, VkDeviceFaultCountsEXT *pFaultCount
 
    if (vm_fault_occurred) {
       VkDeviceFaultAddressInfoEXT addr_fault_info = {
-         .reportedAddress = fault_info.addr,
+         .reportedAddress = (uint64_t)pdev->info.address32_hi << 32 | fault_info.addr,
          .addressPrecision = 4096, /* 4K page granularity */
       };
 
-- 
GitLab

