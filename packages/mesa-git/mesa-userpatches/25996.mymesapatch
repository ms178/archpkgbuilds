From d8be77f13ec77aceed106cf3749dfcc160e5ecc8 Mon Sep 17 00:00:00 2001
From: Simon Zeni <simon.zeni@collabora.com>
Date: Wed, 1 Nov 2023 16:26:35 -0400
Subject: [PATCH] egl: implement EGL_EXT_query_reset_notification_strategy

Signed-off-by: Simon Zeni <simon.zeni@collabora.com>
---
 src/egl/drivers/dri2/egl_dri2.c | 4 ++++
 src/egl/main/eglapi.c           | 1 +
 src/egl/main/eglcontext.c       | 6 ++++++
 src/egl/main/egldisplay.h       | 1 +
 4 files changed, 12 insertions(+)

diff --git a/src/egl/drivers/dri2/egl_dri2.c b/src/egl/drivers/dri2/egl_dri2.c
index bb75273ead9dd..2b2c98a63c011 100644
--- a/src/egl/drivers/dri2/egl_dri2.c
+++ b/src/egl/drivers/dri2/egl_dri2.c
@@ -893,6 +893,10 @@ dri2_setup_screen(_EGLDisplay *disp)
    disp->Extensions.EXT_create_context_robustness =
       get_screen_param(disp, PIPE_CAP_DEVICE_RESET_STATUS_QUERY);
 
+   if (disp->Extensions.EXT_create_context_robustness) {
+      disp->Extensions.EXT_query_reset_notification_strategy = EGL_TRUE;
+   }
+
    if (dri2_dpy->fence) {
       disp->Extensions.KHR_fence_sync = EGL_TRUE;
       disp->Extensions.KHR_wait_sync = EGL_TRUE;
diff --git a/src/egl/main/eglapi.c b/src/egl/main/eglapi.c
index 88aa6c2ceba06..e955dff1e4a56 100644
--- a/src/egl/main/eglapi.c
+++ b/src/egl/main/eglapi.c
@@ -549,6 +549,7 @@ _eglCreateExtensionsString(_EGLDisplay *disp)
    _EGL_CHECK_EXTENSION(EXT_create_context_robustness);
    _EGL_CHECK_EXTENSION(EXT_image_dma_buf_import);
    _EGL_CHECK_EXTENSION(EXT_image_dma_buf_import_modifiers);
+   _EGL_CHECK_EXTENSION(EXT_query_reset_notification_strategy);
    _EGL_CHECK_EXTENSION(EXT_protected_content);
    _EGL_CHECK_EXTENSION(EXT_protected_surface);
    _EGL_CHECK_EXTENSION(EXT_present_opaque);
diff --git a/src/egl/main/eglcontext.c b/src/egl/main/eglcontext.c
index 5f6f9ada70826..3fd234a8f1d8f 100644
--- a/src/egl/main/eglcontext.c
+++ b/src/egl/main/eglcontext.c
@@ -737,6 +737,12 @@ _eglQueryContext(_EGLContext *c, EGLint attribute, EGLint *value)
          return _eglError(EGL_BAD_ATTRIBUTE, "eglQueryContext");
       *value = c->Protected;
       break;
+   case EGL_CONTEXT_OPENGL_RESET_NOTIFICATION_STRATEGY_EXT:
+      if (!disp->Extensions.EXT_create_context_robustness ||
+            !disp->Extensions.EXT_query_reset_notification_strategy)
+         return _eglError(EGL_BAD_ATTRIBUTE, "eglQueryContext");
+      *value = c->ResetNotificationStrategy;
+      break;
    default:
       return _eglError(EGL_BAD_ATTRIBUTE, "eglQueryContext");
    }
diff --git a/src/egl/main/egldisplay.h b/src/egl/main/egldisplay.h
index 330eb198ecbcd..ed9a1181583ea 100644
--- a/src/egl/main/egldisplay.h
+++ b/src/egl/main/egldisplay.h
@@ -105,6 +105,7 @@ struct _egl_extensions {
    EGLBoolean EXT_create_context_robustness;
    EGLBoolean EXT_image_dma_buf_import;
    EGLBoolean EXT_image_dma_buf_import_modifiers;
+   EGLBoolean EXT_query_reset_notification_strategy;
    EGLBoolean EXT_pixel_format_float;
    EGLBoolean EXT_protected_content;
    EGLBoolean EXT_protected_surface;
-- 
GitLab

