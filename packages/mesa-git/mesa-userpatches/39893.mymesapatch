From 81feba32ad14b84701ec11cce2a39b06d2150f97 Mon Sep 17 00:00:00 2001
From: Adam Jackson <ajax@redhat.com>
Date: Fri, 13 Feb 2026 15:57:00 -0500
Subject: [PATCH] glx: use randr instead of xf86vm for glXGetMscRateOML

xf86vm is ancient and on the server side just reads from randr anyway.
cut out the middleman.

Closes: https://gitlab.freedesktop.org/mesa/mesa/-/issues/3401
---
 meson.build         |  5 ++---
 src/glx/glxcmds.c   | 48 ++++++++++++++++++++++++++++++++++-----------
 src/glx/meson.build |  4 ++--
 3 files changed, 41 insertions(+), 16 deletions(-)

diff --git a/meson.build b/meson.build
index 6ae16a1aa73a..756dfee97813 100644
--- a/meson.build
+++ b/meson.build
@@ -2141,7 +2141,6 @@ dep_xcb_keysyms = null_dep
 dep_xcb_glx = null_dep
 dep_xcb_dri3 = null_dep
 dep_glproto = null_dep
-dep_xxf86vm = null_dep
 dep_xcb_present = null_dep
 dep_xcb_sync = null_dep
 dep_xcb_xfixes = null_dep
@@ -2205,7 +2204,7 @@ if with_platform_x11
   if with_glx == 'dri'
     if with_dri_platform == 'drm'
       if with_glx_direct
-        dep_xxf86vm = dependency('xxf86vm')
+        dep_xlib_xrandr = dependency('xrandr', version : dep_xlib_xrandr_version)
       endif
     endif
   endif
@@ -2316,7 +2315,7 @@ elif with_glx == 'dri'
   if with_dri_platform == 'drm'
     gl_priv_reqs += 'xcb-dri2 >= 1.8'
     if with_glx_direct
-      gl_priv_reqs += 'xxf86vm'
+      gl_priv_reqs += 'xrandr >= 1.3'
     endif
   endif
 endif
diff --git a/src/glx/glxcmds.c b/src/glx/glxcmds.c
index f33af34a7a22..b397b6b76517 100644
--- a/src/glx/glxcmds.c
+++ b/src/glx/glxcmds.c
@@ -23,7 +23,7 @@
 #include "util/u_debug.h"
 #else
 #ifndef GLX_USE_WINDOWSGL
-#include <X11/extensions/xf86vmode.h>
+#include <X11/extensions/Xrandr.h>
 #endif /* GLX_USE_WINDOWSGL */
 #endif
 #endif
@@ -1837,21 +1837,41 @@ __glxGetMscRate(struct glx_screen *psc,
       int32_t * numerator, int32_t * denominator)
 {
 #if !defined(GLX_USE_WINDOWSGL)
-   XF86VidModeModeLine mode_line;
-   int dot_clock;
+   XRRScreenResources *res;
+   XRRCrtcInfo *crtc_info = NULL;
+   XRRModeInfo *mode = NULL;
    int i;
 
-   if (XF86VidModeQueryVersion(psc->dpy, &i, &i) &&
-       XF86VidModeGetModeLine(psc->dpy, psc->scr, &dot_clock, &mode_line)) {
-      unsigned n = dot_clock * 1000;
-      unsigned d = mode_line.vtotal * mode_line.htotal;
+   res = XRRGetScreenResourcesCurrent(psc->dpy, RootWindow(psc->dpy, psc->scr));
+   if (!res)
+      return False;
 
-# define V_INTERLACE 0x010
-# define V_DBLSCAN   0x020
+   /* find the first enabled crtc */
+   for (i = 0; i < res->ncrtc; i++) {
+      crtc_info = XRRGetCrtcInfo(psc->dpy, res, res->crtcs[i]);
+      if (crtc_info && crtc_info->mode) {
+         /* find the mode info */
+         for (int j = 0; j < res->nmode; j++) {
+            if (res->modes[j].id == crtc_info->mode) {
+               mode = &res->modes[j];
+               break;
+            }
+         }
+         break;
+      }
+      if (crtc_info) {
+         XRRFreeCrtcInfo(crtc_info);
+         crtc_info = NULL;
+      }
+   }
 
-      if (mode_line.flags & V_INTERLACE)
+   if (mode) {
+      unsigned n = mode->dotClock;
+      unsigned d = mode->vTotal * mode->hTotal;
+
+      if (mode->modeFlags & RR_Interlace)
          n *= 2;
-      else if (mode_line.flags & V_DBLSCAN)
+      else if (mode->modeFlags & RR_DoubleScan)
          d *= 2;
 
       /* The OML_sync_control spec requires that if the refresh rate is a
@@ -1881,8 +1901,14 @@ __glxGetMscRate(struct glx_screen *psc,
       *numerator = n;
       *denominator = d;
 
+      XRRFreeCrtcInfo(crtc_info);
+      XRRFreeScreenResources(res);
       return True;
    }
+
+   if (crtc_info)
+      XRRFreeCrtcInfo(crtc_info);
+   XRRFreeScreenResources(res);
 #endif
 
    return False;
diff --git a/src/glx/meson.build b/src/glx/meson.build
index 28313f83a783..f26111cf561d 100644
--- a/src/glx/meson.build
+++ b/src/glx/meson.build
@@ -112,7 +112,7 @@ libglx = static_library(
   ],
   dependencies : [
     idep_mesautil, idep_xmlconfig,
-    dep_libdrm, dep_glproto, dep_x11, dep_xext, dep_glvnd, dep_xxf86vm, dep_xshmfence,
+    dep_libdrm, dep_glproto, dep_x11, dep_xext, dep_glvnd, dep_xlib_xrandr, dep_xshmfence,
   ],
 )
 
@@ -127,7 +127,7 @@ libgl = shared_library(
   link_args : [ld_args_bsymbolic, ld_args_gc_sections, extra_ld_args_libgl],
   dependencies : [
     dep_libdrm, dep_dl, dep_m, dep_thread, dep_x11, dep_xcb_glx, dep_xcb,
-    dep_x11_xcb, dep_xext, dep_xxf86vm, dep_xcb_shm, extra_deps_libgl,
+    dep_x11_xcb, dep_xext, dep_xlib_xrandr, dep_xcb_shm, extra_deps_libgl,
   ],
   version : gl_lib_version,
   darwin_versions : '4.0.0',
-- 
GitLab

