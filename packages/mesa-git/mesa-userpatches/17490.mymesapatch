From 554823a6e447ce072bfcdc80cb2994328ee7c47b Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 13:38:42 +0200
Subject: [PATCH 01/21] util/format: Use an explicit length for the descs

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/util/format/u_format_table.py | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/src/util/format/u_format_table.py b/src/util/format/u_format_table.py
index a0943f49d8a5..12d365c7e695 100644
--- a/src/util/format/u_format_table.py
+++ b/src/util/format/u_format_table.py
@@ -198,7 +198,7 @@ def write_format_table(formats):
         print()
 
     print('static const struct util_format_description')
-    print('util_format_descriptions[] = {')
+    print('util_format_descriptions[PIPE_FORMAT_COUNT] = {')
     for format in formats:
         sn = format.short_name()
 
@@ -224,7 +224,7 @@ def write_format_table(formats):
     generate_table_getter("")
 
     print('static const struct util_format_pack_description')
-    print('util_format_pack_descriptions[] = {')
+    print('util_format_pack_descriptions[PIPE_FORMAT_COUNT] = {')
     for format in formats:
         sn = format.short_name()
 
@@ -253,7 +253,7 @@ def write_format_table(formats):
     print()
     generate_table_getter("pack_")
     print('static const struct util_format_unpack_description')
-    print('util_format_unpack_descriptions[] = {')
+    print('util_format_unpack_descriptions[PIPE_FORMAT_COUNT] = {')
     for format in formats:
         sn = format.short_name()
 
@@ -293,7 +293,7 @@ def write_format_table(formats):
 
     generate_table_getter("unpack_")
 
-    print('static const util_format_fetch_rgba_func_ptr util_format_fetch_rgba_table[] = {')
+    print('static const util_format_fetch_rgba_func_ptr util_format_fetch_rgba_table[PIPE_FORMAT_COUNT] = {')
     for format in formats:
         sn = format.short_name()
 
-- 
GitLab


From 9a7af6ab2ffb00ea24c252ebd5e44e767c09eba7 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 13:55:48 +0200
Subject: [PATCH 02/21] util/format: Assert that formats are valid

It should be the responsibility of the driver to
make sure, that "format" is a valid pipe_format.

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/util/format/u_format_table.py | 12 ++++--------
 1 file changed, 4 insertions(+), 8 deletions(-)

diff --git a/src/util/format/u_format_table.py b/src/util/format/u_format_table.py
index 12d365c7e695..cb5d8facf79e 100644
--- a/src/util/format/u_format_table.py
+++ b/src/util/format/u_format_table.py
@@ -176,23 +176,19 @@ def write_format_table(formats):
         suffix = ""
         if type == "unpack_":
             suffix = "_generic"
-        print("const struct util_format_%sdescription *" % type)
+        print("ATTRIBUTE_RETURNS_NONNULL const struct util_format_%sdescription *" % type)
         print("util_format_%sdescription%s(enum pipe_format format)" % (type, suffix))
         print("{")
-        print("   if (format >= ARRAY_SIZE(util_format_%sdescriptions))" % (type))
-        print("      return NULL;")
-        print()
+        print("   assert(format < PIPE_FORMAT_COUNT);")
         print("   return &util_format_%sdescriptions[format];" % (type))
         print("}")
         print()
 
     def generate_function_getter(func):
-        print("util_format_%s_func_ptr" % func)
+        print("ATTRIBUTE_RETURNS_NONNULL util_format_%s_func_ptr" % func)
         print("util_format_%s_func(enum pipe_format format)" % (func))
         print("{")
-        print("   if (format >= ARRAY_SIZE(util_format_%s_table))" % (func))
-        print("      return NULL;")
-        print()
+        print("   assert(format < PIPE_FORMAT_COUNT);")
         print("   return util_format_%s_table[format];" % (func))
         print("}")
         print()
-- 
GitLab


From 6570af27f3f32788da94de66cf1ecf4812839610 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 14:09:21 +0200
Subject: [PATCH 03/21] radv: Remove format desc null checks

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/amd/vulkan/radv_formats.c | 14 ++++++--------
 src/amd/vulkan/radv_image.c   |  1 -
 2 files changed, 6 insertions(+), 9 deletions(-)

diff --git a/src/amd/vulkan/radv_formats.c b/src/amd/vulkan/radv_formats.c
index f9c5614ac3f7..986545286598 100644
--- a/src/amd/vulkan/radv_formats.c
+++ b/src/amd/vulkan/radv_formats.c
@@ -208,8 +208,6 @@ radv_translate_tex_dataformat(VkFormat format, const struct util_format_descript
 
    assert(vk_format_get_plane_count(format) == 1);
 
-   if (!desc)
-      return ~0;
    /* Colorspace (return non-RGB formats directly). */
    switch (desc->colorspace) {
       /* Depth stencil formats */
@@ -522,7 +520,7 @@ radv_is_sampler_format_supported(VkFormat format, bool *linear_sampling)
 {
    const struct util_format_description *desc = vk_format_description(format);
    uint32_t num_format;
-   if (!desc || format == VK_FORMAT_UNDEFINED || format == VK_FORMAT_R64_UINT ||
+   if (format == VK_FORMAT_UNDEFINED || format == VK_FORMAT_R64_UINT ||
        format == VK_FORMAT_R64_SINT)
       return false;
    num_format =
@@ -555,7 +553,7 @@ radv_is_storage_image_format_supported(struct radv_physical_device *physical_dev
 {
    const struct util_format_description *desc = vk_format_description(format);
    unsigned data_format, num_format;
-   if (!desc || format == VK_FORMAT_UNDEFINED)
+   if (format == VK_FORMAT_UNDEFINED)
       return false;
 
    data_format =
@@ -610,7 +608,7 @@ radv_is_buffer_format_supported(VkFormat format, bool *scaled)
 {
    const struct util_format_description *desc = vk_format_description(format);
    unsigned data_format, num_format;
-   if (!desc || format == VK_FORMAT_UNDEFINED)
+   if (format == VK_FORMAT_UNDEFINED)
       return false;
 
    data_format =
@@ -700,7 +698,7 @@ radv_physical_device_get_format_properties(struct radv_physical_device *physical
    bool blendable;
    bool scaled = false;
    /* TODO: implement some software emulation of SUBSAMPLED formats. */
-   if (!desc || vk_format_to_pipe_format(format) == PIPE_FORMAT_NONE ||
+   if (vk_format_to_pipe_format(format) == PIPE_FORMAT_NONE ||
        desc->layout == UTIL_FORMAT_LAYOUT_SUBSAMPLED) {
       out_properties->linearTilingFeatures = linear;
       out_properties->optimalTilingFeatures = tiled;
@@ -1356,7 +1354,7 @@ radv_check_modifier_support(struct radv_physical_device *dev,
    if (info->type != VK_IMAGE_TYPE_2D)
       return VK_ERROR_FORMAT_NOT_SUPPORTED;
 
-   if (!desc || (desc->layout == UTIL_FORMAT_LAYOUT_ETC && dev->emulate_etc2))
+   if (desc->layout == UTIL_FORMAT_LAYOUT_ETC && dev->emulate_etc2)
       return VK_ERROR_FORMAT_NOT_SUPPORTED;
 
    /* We did not add modifiers for sparse textures. */
@@ -1682,7 +1680,7 @@ get_external_image_format_properties(struct radv_physical_device *physical_devic
    VkExternalMemoryHandleTypeFlags compat_flags = 0;
    const struct util_format_description *desc = vk_format_description(pImageFormatInfo->format);
 
-   if (!desc || (desc->layout == UTIL_FORMAT_LAYOUT_ETC && physical_device->emulate_etc2))
+   if (desc->layout == UTIL_FORMAT_LAYOUT_ETC && physical_device->emulate_etc2)
       return;
 
    if (pImageFormatInfo->flags & VK_IMAGE_CREATE_SPARSE_BINDING_BIT)
diff --git a/src/amd/vulkan/radv_image.c b/src/amd/vulkan/radv_image.c
index 2d303bd4e1bc..c837f267a279 100644
--- a/src/amd/vulkan/radv_image.c
+++ b/src/amd/vulkan/radv_image.c
@@ -2104,7 +2104,6 @@ radv_image_view_init(struct radv_image_view *iview, struct radv_device *device,
    if (device->physical_device->emulate_etc2 &&
        vk_format_description(image->vk.format)->layout == UTIL_FORMAT_LAYOUT_ETC) {
       const struct util_format_description *desc = vk_format_description(iview->vk.format);
-      assert(desc);
       if (desc->layout == UTIL_FORMAT_LAYOUT_ETC) {
          iview->plane_id = 1;
          iview->vk.format = etc2_emulation_format(iview->vk.format);
-- 
GitLab


From 73580f6d909dd134c4454f5f248d154b9b241224 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 14:13:07 +0200
Subject: [PATCH 04/21] radv: Use desc->format

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/amd/vulkan/radv_formats.c | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/src/amd/vulkan/radv_formats.c b/src/amd/vulkan/radv_formats.c
index 986545286598..05e4c4fabfec 100644
--- a/src/amd/vulkan/radv_formats.c
+++ b/src/amd/vulkan/radv_formats.c
@@ -698,8 +698,7 @@ radv_physical_device_get_format_properties(struct radv_physical_device *physical
    bool blendable;
    bool scaled = false;
    /* TODO: implement some software emulation of SUBSAMPLED formats. */
-   if (vk_format_to_pipe_format(format) == PIPE_FORMAT_NONE ||
-       desc->layout == UTIL_FORMAT_LAYOUT_SUBSAMPLED) {
+   if (desc->format == PIPE_FORMAT_NONE || desc->layout == UTIL_FORMAT_LAYOUT_SUBSAMPLED) {
       out_properties->linearTilingFeatures = linear;
       out_properties->optimalTilingFeatures = tiled;
       out_properties->bufferFeatures = buffer;
-- 
GitLab


From 820dd07ffd83657f70f2b6a57e26fbeaefd25bcd Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 14:19:52 +0200
Subject: [PATCH 05/21] v3dv: Remove format desc null asserts

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/broadcom/vulkan/v3dv_formats.c | 2 --
 1 file changed, 2 deletions(-)

diff --git a/src/broadcom/vulkan/v3dv_formats.c b/src/broadcom/vulkan/v3dv_formats.c
index da497c364086..657bbef0fccc 100644
--- a/src/broadcom/vulkan/v3dv_formats.c
+++ b/src/broadcom/vulkan/v3dv_formats.c
@@ -180,7 +180,6 @@ image_format_features(struct v3dv_physical_device *pdevice,
 
    const struct util_format_description *desc =
       vk_format_description(vk_format);
-   assert(desc);
 
    if (tiling != VK_IMAGE_TILING_LINEAR) {
       if (desc->layout == UTIL_FORMAT_LAYOUT_PLAIN && desc->is_array) {
@@ -226,7 +225,6 @@ buffer_format_features(VkFormat vk_format, const struct v3dv_format *v3dv_format
 
    const struct util_format_description *desc =
       vk_format_description(vk_format);
-   assert(desc);
 
    VkFormatFeatureFlags2KHR flags = 0;
    if (desc->layout == UTIL_FORMAT_LAYOUT_PLAIN &&
-- 
GitLab


From 3b3f903e052b7b9ca5e897efa4b8069079587372 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 14:25:03 +0200
Subject: [PATCH 06/21] turnip: Remove format desc null assert

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/freedreno/vulkan/tu_clear_blit.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/freedreno/vulkan/tu_clear_blit.c b/src/freedreno/vulkan/tu_clear_blit.c
index 3e8120c25e20..8bed7f5a412b 100644
--- a/src/freedreno/vulkan/tu_clear_blit.c
+++ b/src/freedreno/vulkan/tu_clear_blit.c
@@ -112,8 +112,8 @@ r2d_clear_value(struct tu_cs *cs, enum pipe_format format, const VkClearValue *v
       const struct util_format_description *desc = util_format_description(format);
       enum a6xx_2d_ifmt ifmt = format_to_ifmt(format);
 
-      assert(desc && (desc->layout == UTIL_FORMAT_LAYOUT_PLAIN ||
-                      format == PIPE_FORMAT_R11G11B10_FLOAT));
+      assert(desc->layout == UTIL_FORMAT_LAYOUT_PLAIN ||
+             format == PIPE_FORMAT_R11G11B10_FLOAT);
 
       for (unsigned i = 0; i < desc->nr_channels; i++) {
          const struct util_format_channel_description *ch = &desc->channel[i];
-- 
GitLab


From f579c0a1aca1d73ce591ca07675c7bd9bd3d6493 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 14:38:35 +0200
Subject: [PATCH 07/21] gallivm: Remove format desc null checks

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/gallium/auxiliary/gallivm/lp_bld_sample_soa.c | 15 ++++++---------
 1 file changed, 6 insertions(+), 9 deletions(-)

diff --git a/src/gallium/auxiliary/gallivm/lp_bld_sample_soa.c b/src/gallium/auxiliary/gallivm/lp_bld_sample_soa.c
index e8429ff82756..626934aa86a9 100644
--- a/src/gallium/auxiliary/gallivm/lp_bld_sample_soa.c
+++ b/src/gallium/auxiliary/gallivm/lp_bld_sample_soa.c
@@ -3258,7 +3258,6 @@ static struct lp_type
 lp_build_texel_type(struct lp_type texel_type,
                     const struct util_format_description *format_desc)
 {
-   assert(format_desc != NULL);
    /* always using the first channel hopefully should be safe,
     * if not things WILL break in other places anyway.
     */
@@ -3384,8 +3383,6 @@ lp_build_sample_soa_code(struct gallivm_state *gallivm,
    bld.format_desc = util_format_description(static_texture_state->format);
    bld.dims = dims;
 
-   assert(bld.format_desc);
-
    if (gallivm_perf & GALLIVM_PERF_NO_QUAD_LOD || op_is_lodq) {
       bld.no_quad_lod = TRUE;
    }
@@ -4000,7 +3997,7 @@ lp_build_sample_gen_func(struct gallivm_state *gallivm,
    if (dynamic_state->cache_ptr) {
       const struct util_format_description *format_desc;
       format_desc = util_format_description(static_texture_state->format);
-      if (format_desc && format_desc->layout == UTIL_FORMAT_LAYOUT_S3TC) {
+      if (format_desc->layout == UTIL_FORMAT_LAYOUT_S3TC) {
          need_cache = TRUE;
       }
    }
@@ -4129,7 +4126,7 @@ lp_build_sample_soa_func(struct gallivm_state *gallivm,
    if (dynamic_state->cache_ptr) {
       const struct util_format_description *format_desc;
       format_desc = util_format_description(static_texture_state->format);
-      if (format_desc && format_desc->layout == UTIL_FORMAT_LAYOUT_S3TC) {
+      if (format_desc->layout == UTIL_FORMAT_LAYOUT_S3TC) {
          need_cache = TRUE;
       }
    }
@@ -4301,9 +4298,9 @@ lp_build_sample_soa(const struct lp_static_texture_state *static_texture_state,
    if (USE_TEX_FUNC_CALL) {
       const struct util_format_description *format_desc =
          util_format_description(static_texture_state->format);
-      const boolean simple_format = !format_desc ||
-                      (util_format_is_rgba8_variant(format_desc) &&
-                       format_desc->colorspace == UTIL_FORMAT_COLORSPACE_RGB);
+      const boolean simple_format =
+         (util_format_is_rgba8_variant(format_desc) &&
+         format_desc->colorspace == UTIL_FORMAT_COLORSPACE_RGB);
       const enum lp_sampler_op_type op_type =
          (params->sample_key & LP_SAMPLER_OP_TYPE_MASK) >>
          LP_SAMPLER_OP_TYPE_SHIFT;
@@ -4313,7 +4310,7 @@ lp_build_sample_soa(const struct lp_static_texture_state *static_texture_state,
              static_texture_state->level_zero_only == TRUE) &&
             static_sampler_state->min_img_filter == static_sampler_state->mag_img_filter);
 
-      use_tex_func = format_desc && !(simple_format && simple_tex);
+      use_tex_func = !(simple_format && simple_tex);
    }
 
    if (use_tex_func) {
-- 
GitLab


From f68fc4cd379cdf2b9e79fd9195302004a8048dde Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 14:42:45 +0200
Subject: [PATCH 08/21] tgsi: Remove format desc null check

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/gallium/auxiliary/tgsi/tgsi_text.c              | 2 +-
 src/gallium/auxiliary/translate/translate_generic.c | 2 --
 2 files changed, 1 insertion(+), 3 deletions(-)

diff --git a/src/gallium/auxiliary/tgsi/tgsi_text.c b/src/gallium/auxiliary/tgsi/tgsi_text.c
index 9779f212cb13..7802f10498d5 100644
--- a/src/gallium/auxiliary/tgsi/tgsi_text.c
+++ b/src/gallium/auxiliary/tgsi/tgsi_text.c
@@ -148,7 +148,7 @@ static int str_match_format(const char **pcur)
    for (unsigned i = 0; i < PIPE_FORMAT_COUNT; i++) {
       const struct util_format_description *desc =
          util_format_description(i);
-      if (desc && str_match_nocase_whole(pcur, desc->name)) {
+      if (str_match_nocase_whole(pcur, desc->name)) {
          return i;
       }
    }
diff --git a/src/gallium/auxiliary/translate/translate_generic.c b/src/gallium/auxiliary/translate/translate_generic.c
index a0c18531caa9..20e2de341210 100644
--- a/src/gallium/auxiliary/translate/translate_generic.c
+++ b/src/gallium/auxiliary/translate/translate_generic.c
@@ -800,8 +800,6 @@ translate_generic_create(const struct translate_key *key)
       const struct util_format_unpack_description *unpack =
          util_format_unpack_description(key->element[i].input_format);
 
-      assert(format_desc);
-
       tg->attrib[i].type = key->element[i].type;
 
       if (format_desc->channel[0].pure_integer) {
-- 
GitLab


From c929f36815162c0a48e66a74763134462c776fc6 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 14:51:14 +0200
Subject: [PATCH 09/21] util: Remove format desc null check

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/gallium/auxiliary/util/u_sampler.c | 13 +++++--------
 1 file changed, 5 insertions(+), 8 deletions(-)

diff --git a/src/gallium/auxiliary/util/u_sampler.c b/src/gallium/auxiliary/util/u_sampler.c
index 2c823d45609c..7c81017f535c 100644
--- a/src/gallium/auxiliary/util/u_sampler.c
+++ b/src/gallium/auxiliary/util/u_sampler.c
@@ -73,14 +73,11 @@ default_template(struct pipe_sampler_view *view,
    if (format != PIPE_FORMAT_A8_UNORM) {
       const struct util_format_description *desc = util_format_description(format);
 
-      assert(desc);
-      if (desc) {
-         if (desc->swizzle[1] == PIPE_SWIZZLE_0) {
-            view->swizzle_g = expand_green_blue;
-         }
-         if (desc->swizzle[2] == PIPE_SWIZZLE_0) {
-            view->swizzle_b = expand_green_blue;
-         }
+      if (desc->swizzle[1] == PIPE_SWIZZLE_0) {
+         view->swizzle_g = expand_green_blue;
+      }
+      if (desc->swizzle[2] == PIPE_SWIZZLE_0) {
+         view->swizzle_b = expand_green_blue;
       }
    }
 }
-- 
GitLab


From f55622573dbb89ca8e4e2375a6237592ff3b7e0e Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 14:54:25 +0200
Subject: [PATCH 10/21] agx: Remove format desc null check

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/gallium/drivers/asahi/agx_pipe.c | 3 ---
 1 file changed, 3 deletions(-)

diff --git a/src/gallium/drivers/asahi/agx_pipe.c b/src/gallium/drivers/asahi/agx_pipe.c
index bc151b0931d5..c065a3a5d1a5 100644
--- a/src/gallium/drivers/asahi/agx_pipe.c
+++ b/src/gallium/drivers/asahi/agx_pipe.c
@@ -1026,9 +1026,6 @@ agx_is_format_supported(struct pipe_screen* pscreen,
 
    format_desc = util_format_description(format);
 
-   if (!format_desc)
-      return false;
-
    if (sample_count > 1)
       return false;
 
-- 
GitLab


From 97c415d5c8001c322769f55d8716599fdbfa67f7 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 14:59:12 +0200
Subject: [PATCH 11/21] etnaviv: Remove format desc null check

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/gallium/drivers/etnaviv/etnaviv_translate.h | 2 --
 1 file changed, 2 deletions(-)

diff --git a/src/gallium/drivers/etnaviv/etnaviv_translate.h b/src/gallium/drivers/etnaviv/etnaviv_translate.h
index f15fa79048ed..42e38a3b0d5f 100644
--- a/src/gallium/drivers/etnaviv/etnaviv_translate.h
+++ b/src/gallium/drivers/etnaviv/etnaviv_translate.h
@@ -276,8 +276,6 @@ static inline uint32_t
 translate_vertex_format_normalize(enum pipe_format fmt)
 {
    const struct util_format_description *desc = util_format_description(fmt);
-   if (!desc)
-      return VIVS_FE_VERTEX_ELEMENT_CONFIG_NORMALIZE_OFF;
 
    /* assumes that normalization of channel 0 holds for all channels;
     * this holds for all vertex formats that we support */
-- 
GitLab


From 69188d6df689c8b8a3a476a5faef5a39b0feb1f1 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 15:10:20 +0200
Subject: [PATCH 12/21] llvmpipe: Remove format desc null checks

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/gallium/drivers/llvmpipe/lp_screen.c      | 2 --
 src/gallium/drivers/llvmpipe/lp_state_fs.c    | 1 -
 src/gallium/drivers/llvmpipe/lp_test_format.c | 3 ---
 3 files changed, 6 deletions(-)

diff --git a/src/gallium/drivers/llvmpipe/lp_screen.c b/src/gallium/drivers/llvmpipe/lp_screen.c
index 15265cfd597c..57f4927538cc 100644
--- a/src/gallium/drivers/llvmpipe/lp_screen.c
+++ b/src/gallium/drivers/llvmpipe/lp_screen.c
@@ -667,8 +667,6 @@ llvmpipe_is_format_supported( struct pipe_screen *_screen,
    const struct util_format_description *format_desc;
 
    format_desc = util_format_description(format);
-   if (!format_desc)
-      return false;
 
    assert(target == PIPE_BUFFER ||
           target == PIPE_TEXTURE_1D ||
diff --git a/src/gallium/drivers/llvmpipe/lp_state_fs.c b/src/gallium/drivers/llvmpipe/lp_state_fs.c
index 506be8dd2e50..ae6c6880470b 100644
--- a/src/gallium/drivers/llvmpipe/lp_state_fs.c
+++ b/src/gallium/drivers/llvmpipe/lp_state_fs.c
@@ -670,7 +670,6 @@ generate_fs_loop(struct gallivm_state *gallivm,
    if (key->depth.enabled ||
        key->stencil[0].enabled) {
       zs_format_desc = util_format_description(key->zsbuf_format);
-      assert(zs_format_desc);
 
       if (shader->info.base.properties[TGSI_PROPERTY_FS_EARLY_DEPTH_STENCIL])
          depth_mode = EARLY_DEPTH_TEST | EARLY_DEPTH_WRITE;
diff --git a/src/gallium/drivers/llvmpipe/lp_test_format.c b/src/gallium/drivers/llvmpipe/lp_test_format.c
index f8013fe2d255..6836253d973d 100644
--- a/src/gallium/drivers/llvmpipe/lp_test_format.c
+++ b/src/gallium/drivers/llvmpipe/lp_test_format.c
@@ -369,9 +369,6 @@ test_all(unsigned verbose, FILE *fp)
          const struct util_format_description *format_desc;
 
          format_desc = util_format_description(format);
-         if (!format_desc) {
-            continue;
-         }
 
          /*
           * TODO: test more
-- 
GitLab


From 01f179e4532ef54f3ee62b4244a868837d7a507d Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 15:12:43 +0200
Subject: [PATCH 13/21] panfrost: Remove format desc null check

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/gallium/drivers/panfrost/pan_screen.c | 3 ---
 1 file changed, 3 deletions(-)

diff --git a/src/gallium/drivers/panfrost/pan_screen.c b/src/gallium/drivers/panfrost/pan_screen.c
index a8f16868c34c..a023d129c2fb 100644
--- a/src/gallium/drivers/panfrost/pan_screen.c
+++ b/src/gallium/drivers/panfrost/pan_screen.c
@@ -541,9 +541,6 @@ panfrost_is_format_supported( struct pipe_screen *screen,
 
         format_desc = util_format_description(format);
 
-        if (!format_desc)
-                return false;
-
         /* MSAA 2x gets rounded up to 4x. MSAA 8x/16x only supported on v5+.
          * TODO: debug MSAA 8x/16x */
 
-- 
GitLab


From 7e9c5eb48373f4226e6dab59cb15cebb11135861 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 15:14:24 +0200
Subject: [PATCH 14/21] r300: Remove format desc null check

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/gallium/drivers/r300/r300_texture.c | 2 --
 1 file changed, 2 deletions(-)

diff --git a/src/gallium/drivers/r300/r300_texture.c b/src/gallium/drivers/r300/r300_texture.c
index f47be75dffe0..df7d1c827c7c 100644
--- a/src/gallium/drivers/r300/r300_texture.c
+++ b/src/gallium/drivers/r300/r300_texture.c
@@ -80,8 +80,6 @@ static unsigned r300_get_endian_swap(enum pipe_format format)
         return R300_SURF_NO_SWAP;
 
     desc = util_format_description(format);
-    if (!desc)
-        return R300_SURF_NO_SWAP;
 
     /* Compressed formats should be in the little endian format. */
     if (desc->block.width != 1 || desc->block.height != 1)
-- 
GitLab


From d13f6168dc075b32e2e86263892f16e897f7c08a Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 15:18:33 +0200
Subject: [PATCH 15/21] r600: Remove format desc null checks

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/gallium/drivers/r600/r600_asm.c          | 5 -----
 src/gallium/drivers/r600/r600_formats.h      | 3 ---
 src/gallium/drivers/r600/r600_state_common.c | 4 ----
 3 files changed, 12 deletions(-)

diff --git a/src/gallium/drivers/r600/r600_asm.c b/src/gallium/drivers/r600/r600_asm.c
index 954af0663079..2a1289a2a123 100644
--- a/src/gallium/drivers/r600/r600_asm.c
+++ b/src/gallium/drivers/r600/r600_asm.c
@@ -2779,11 +2779,6 @@ void *r600_create_vertex_fetch_shader(struct pipe_context *ctx,
 				      &format, &num_format, &format_comp, &endian);
 
 		desc = util_format_description(elements[i].src_format);
-		if (!desc) {
-			r600_bytecode_clear(&bc);
-			R600_ERR("unknown format %d\n", elements[i].src_format);
-			return NULL;
-		}
 
 		if (elements[i].src_offset > 65535) {
 			r600_bytecode_clear(&bc);
diff --git a/src/gallium/drivers/r600/r600_formats.h b/src/gallium/drivers/r600/r600_formats.h
index c5899424c6cf..714bc465e43d 100644
--- a/src/gallium/drivers/r600/r600_formats.h
+++ b/src/gallium/drivers/r600/r600_formats.h
@@ -90,9 +90,6 @@ static inline bool r600_is_buffer_format_supported(enum pipe_format format, bool
 	if (format == PIPE_FORMAT_R11G11B10_FLOAT)
 		return true;
 
-	if (!desc)
-		return false;
-
 	/* Find the first non-VOID channel. */
 	for (i = 0; i < 4; i++) {
 		if (desc->channel[i].type != UTIL_FORMAT_TYPE_VOID)
diff --git a/src/gallium/drivers/r600/r600_state_common.c b/src/gallium/drivers/r600/r600_state_common.c
index c0ff0b8bd87b..f394138a3e86 100644
--- a/src/gallium/drivers/r600/r600_state_common.c
+++ b/src/gallium/drivers/r600/r600_state_common.c
@@ -2787,8 +2787,6 @@ uint32_t r600_translate_texformat(struct pipe_screen *screen,
 		format = PIPE_FORMAT_A4R4_UNORM;
 
 	desc = util_format_description(format);
-	if (!desc)
-		goto out_unknown;
 
 	/* Depth and stencil swizzling is handled separately. */
 	if (desc->colorspace != UTIL_FORMAT_COLORSPACE_ZS) {
@@ -3154,8 +3152,6 @@ uint32_t r600_translate_colorformat(enum amd_gfx_level chip, enum pipe_format fo
 	const struct util_format_description *desc = util_format_description(format);
 	int channel = util_format_get_first_non_void_channel(format);
 	bool is_float;
-	if (!desc)
-		return ~0U;
 
 #define HAS_SIZE(x,y,z,w) \
 	(desc->channel[0].size == (x) && desc->channel[1].size == (y) && \
-- 
GitLab


From 908ed0639c048df36e665bf3005a30b7069dc189 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 15:21:24 +0200
Subject: [PATCH 16/21] radeonsi: Remove format desc null checks

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/gallium/drivers/radeonsi/si_state.c | 7 -------
 1 file changed, 7 deletions(-)

diff --git a/src/gallium/drivers/radeonsi/si_state.c b/src/gallium/drivers/radeonsi/si_state.c
index c16dfa3aa3bb..abf8d6afef80 100644
--- a/src/gallium/drivers/radeonsi/si_state.c
+++ b/src/gallium/drivers/radeonsi/si_state.c
@@ -1647,8 +1647,6 @@ uint32_t si_translate_colorformat(enum amd_gfx_level gfx_level,
                                   enum pipe_format format)
 {
    const struct util_format_description *desc = util_format_description(format);
-   if (!desc)
-      return V_028C70_COLOR_INVALID;
 
 #define HAS_SIZE(x, y, z, w)                                                                       \
    (desc->channel[0].size == (x) && desc->channel[1].size == (y) &&                                \
@@ -2209,9 +2207,6 @@ static bool si_is_sampler_format_supported(struct pipe_screen *screen, enum pipe
    struct si_screen *sscreen = (struct si_screen *)screen;
    const struct util_format_description *desc = util_format_description(format);
 
-   if (!desc)
-      return false;
-
    /* Samplers don't support 64 bits per channel. */
    if (desc->layout == UTIL_FORMAT_LAYOUT_PLAIN &&
        desc->channel[0].size == 64)
@@ -2351,8 +2346,6 @@ static unsigned si_is_vertex_format_supported(struct pipe_screen *screen, enum p
           0);
 
    desc = util_format_description(format);
-   if (!desc)
-      return 0;
 
    /* There are no native 8_8_8 or 16_16_16 data formats, and we currently
     * select 8_8_8_8 and 16_16_16_16 instead. This works reasonably well
-- 
GitLab


From 4a7d95f3c1934fa8f91b7a494e4958a772bc2156 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 15:22:38 +0200
Subject: [PATCH 17/21] softpipe: Remove format desc null check

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/gallium/drivers/softpipe/sp_screen.c | 2 --
 1 file changed, 2 deletions(-)

diff --git a/src/gallium/drivers/softpipe/sp_screen.c b/src/gallium/drivers/softpipe/sp_screen.c
index c0e1df314e21..cc182867b127 100644
--- a/src/gallium/drivers/softpipe/sp_screen.c
+++ b/src/gallium/drivers/softpipe/sp_screen.c
@@ -414,8 +414,6 @@ softpipe_is_format_supported( struct pipe_screen *screen,
       return false;
 
    format_desc = util_format_description(format);
-   if (!format_desc)
-      return false;
 
    if (sample_count > 1)
       return false;
-- 
GitLab


From 8f51440b576258308fd29e5aa99cc727459af365 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 15:30:38 +0200
Subject: [PATCH 18/21] virgl: Remove format desc null checks

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/gallium/drivers/virgl/virgl_screen.c | 4 ----
 1 file changed, 4 deletions(-)

diff --git a/src/gallium/drivers/virgl/virgl_screen.c b/src/gallium/drivers/virgl/virgl_screen.c
index d7f1762352ee..862812c014e5 100644
--- a/src/gallium/drivers/virgl/virgl_screen.c
+++ b/src/gallium/drivers/virgl/virgl_screen.c
@@ -574,8 +574,6 @@ virgl_is_vertex_format_supported(struct pipe_screen *screen,
    int i;
 
    format_desc = util_format_description(format);
-   if (!format_desc)
-      return false;
 
    if (format == PIPE_FORMAT_R11G11B10_FLOAT) {
       int vformat = VIRGL_FORMAT_R11G11B10_FLOAT;
@@ -683,8 +681,6 @@ virgl_is_format_supported( struct pipe_screen *screen,
           target == PIPE_TEXTURE_CUBE_ARRAY);
 
    format_desc = util_format_description(format);
-   if (!format_desc)
-      return false;
 
    if (util_format_is_intensity(format))
       return false;
-- 
GitLab


From 0e0e66c028ffc60f188d284d2f64d677135b92a2 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 15:34:19 +0200
Subject: [PATCH 19/21] pvr: Remove format desc null check

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/imagination/vulkan/pvr_formats.c | 10 +---------
 1 file changed, 1 insertion(+), 9 deletions(-)

diff --git a/src/imagination/vulkan/pvr_formats.c b/src/imagination/vulkan/pvr_formats.c
index d18f169abf80..c7ae23116cbc 100644
--- a/src/imagination/vulkan/pvr_formats.c
+++ b/src/imagination/vulkan/pvr_formats.c
@@ -117,16 +117,8 @@ pvr_get_image_format_features(const struct pvr_format *pvr_format,
 const uint8_t *pvr_get_format_swizzle(VkFormat vk_format)
 {
    const struct util_format_description *vf = vk_format_description(vk_format);
-   static const uint8_t fallback[] = { PIPE_SWIZZLE_X,
-                                       PIPE_SWIZZLE_Y,
-                                       PIPE_SWIZZLE_Z,
-                                       PIPE_SWIZZLE_W };
 
-   if (vf)
-      return vf->swizzle;
-
-   assert(!"Unsupported format");
-   return fallback;
+   return vf->swizzle;
 }
 
 static VkFormatFeatureFlags
-- 
GitLab


From 1741749f20fde1d6d4669c2a8ab1230e99fd63f9 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 15:42:12 +0200
Subject: [PATCH 20/21] util/format: Remove format desc null checks

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/util/format/u_format.c                       | 7 -------
 src/util/tests/format/u_format_compatible_test.c | 6 ------
 2 files changed, 13 deletions(-)

diff --git a/src/util/format/u_format.c b/src/util/format/u_format.c
index 481e3e0a457e..bd989c33f4e6 100644
--- a/src/util/format/u_format.c
+++ b/src/util/format/u_format.c
@@ -100,11 +100,6 @@ util_format_is_float(enum pipe_format format)
    const struct util_format_description *desc = util_format_description(format);
    int i;
 
-   assert(desc);
-   if (!desc) {
-      return FALSE;
-   }
-
    i = util_format_get_first_non_void_channel(format);
    if (i < 0) {
       return FALSE;
@@ -340,8 +335,6 @@ util_get_depth_format_mrd(const struct util_format_description *desc)
    double mrd = 1.0 / ((1 << 24) - 1);
    unsigned depth_channel;
 
-   assert(desc);
-
    /*
     * Some depth formats do not store the depth component in the first
     * channel, detect the format and adjust the depth channel. Get the
diff --git a/src/util/tests/format/u_format_compatible_test.c b/src/util/tests/format/u_format_compatible_test.c
index 6d3ce5efa8ad..46266a6af7fb 100644
--- a/src/util/tests/format/u_format_compatible_test.c
+++ b/src/util/tests/format/u_format_compatible_test.c
@@ -41,16 +41,10 @@ test_all(void)
    for (src_format = 1; src_format < PIPE_FORMAT_COUNT; ++src_format) {
       const struct util_format_description *src_format_desc;
       src_format_desc = util_format_description(src_format);
-      if (!src_format_desc) {
-         continue;
-      }
 
       for (dst_format = 1; dst_format < PIPE_FORMAT_COUNT; ++dst_format) {
 	 const struct util_format_description *dst_format_desc;
 	 dst_format_desc = util_format_description(dst_format);
-	 if (!dst_format_desc) {
-	    continue;
-	 }
 
          if (dst_format == src_format) {
             continue;
-- 
GitLab


From d8283f90d4bf037053ff6d7d7f81c91d1285cb63 Mon Sep 17 00:00:00 2001
From: Konstantin Seurer <konstantin.seurer@gmail.com>
Date: Tue, 12 Jul 2022 15:43:44 +0200
Subject: [PATCH 21/21] gallium/tests: Remove format desc null checks

Signed-off-by: Konstantin Seurer <konstantin.seurer@gmail.com>
---
 src/gallium/tests/unit/translate_test.c | 22 ++++++++++------------
 1 file changed, 10 insertions(+), 12 deletions(-)

diff --git a/src/gallium/tests/unit/translate_test.c b/src/gallium/tests/unit/translate_test.c
index 16e55b231caf..215136b423ef 100644
--- a/src/gallium/tests/unit/translate_test.c
+++ b/src/gallium/tests/unit/translate_test.c
@@ -177,12 +177,11 @@ int main(int argc, char** argv)
       unsigned output_format_size;
       unsigned output_normalized = 0;
 
-      if (!output_format_desc
-            || !fetch_rgba
-            || !output_format_pack->pack_rgba_float
-            || output_format_desc->colorspace != UTIL_FORMAT_COLORSPACE_RGB
-            || output_format_desc->layout != UTIL_FORMAT_LAYOUT_PLAIN
-            || !translate_is_output_format_supported(output_format))
+      if (!fetch_rgba
+          || !output_format_pack->pack_rgba_float
+          || output_format_desc->colorspace != UTIL_FORMAT_COLORSPACE_RGB
+          || output_format_desc->layout != UTIL_FORMAT_LAYOUT_PLAIN
+          || !translate_is_output_format_supported(output_format))
          continue;
 
       for(i = 0; i < output_format_desc->nr_channels; ++i)
@@ -206,12 +205,11 @@ int main(int argc, char** argv)
          unsigned input_normalized = 0;
          boolean input_is_float = FALSE;
 
-         if (!input_format_desc
-               || !fetch_rgba
-               || !input_format_pack->pack_rgba_float
-               || input_format_desc->colorspace != UTIL_FORMAT_COLORSPACE_RGB
-               || input_format_desc->layout != UTIL_FORMAT_LAYOUT_PLAIN
-               || !translate_is_output_format_supported(input_format))
+         if (!fetch_rgba
+             || !input_format_pack->pack_rgba_float
+             || input_format_desc->colorspace != UTIL_FORMAT_COLORSPACE_RGB
+             || input_format_desc->layout != UTIL_FORMAT_LAYOUT_PLAIN
+             || !translate_is_output_format_supported(input_format))
             continue;
 
          input_format_size = util_format_get_stride(input_format, 1);
-- 
GitLab

