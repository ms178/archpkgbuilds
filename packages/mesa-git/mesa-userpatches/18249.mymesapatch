From dbf123af1f351389ae3557a427b8e832c5ababf3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Daniel=20Sch=C3=BCrmann?= <daniel@schuermann.dev>
Date: Wed, 24 Aug 2022 18:05:32 +0200
Subject: [PATCH 1/2] nir/opt_move_discards_to_top: don't schedule
 discard/demote across subgroup operations

Fixes: b447f5049b6d68fd80b7337bc1f7c79b1b1a4765 ('nir: Add a discard optimization pass')
---
 .../nir/nir_opt_move_discards_to_top.c        | 45 +++++++++++++++++--
 1 file changed, 42 insertions(+), 3 deletions(-)

diff --git a/src/compiler/nir/nir_opt_move_discards_to_top.c b/src/compiler/nir/nir_opt_move_discards_to_top.c
index 051e271def3f5..201ccd79eebbd 100644
--- a/src/compiler/nir/nir_opt_move_discards_to_top.c
+++ b/src/compiler/nir/nir_opt_move_discards_to_top.c
@@ -165,10 +165,49 @@ opt_move_discards_to_top_impl(nir_function_impl *impl)
                instr->pass_flags = STOP_PROCESSING_INSTR_FLAG;
                goto break_all;
             }
-
-            if ((intrin->intrinsic == nir_intrinsic_discard_if && consider_discards) ||
-                intrin->intrinsic == nir_intrinsic_demote_if)
+            switch (intrin->intrinsic) {
+            case nir_intrinsic_quad_broadcast:
+            case nir_intrinsic_quad_swap_horizontal:
+            case nir_intrinsic_quad_swap_vertical:
+            case nir_intrinsic_quad_swap_diagonal:
+            case nir_intrinsic_quad_vote_all:
+            case nir_intrinsic_quad_vote_any:
+            case nir_intrinsic_quad_swizzle_amd:
+               consider_discards = false;
+               break;
+            case nir_intrinsic_vote_any:
+            case nir_intrinsic_vote_all:
+            case nir_intrinsic_vote_feq:
+            case nir_intrinsic_vote_ieq:
+            case nir_intrinsic_ballot:
+            case nir_intrinsic_first_invocation:
+            case nir_intrinsic_read_invocation:
+            case nir_intrinsic_read_first_invocation:
+            case nir_intrinsic_elect:
+            case nir_intrinsic_reduce:
+            case nir_intrinsic_inclusive_scan:
+            case nir_intrinsic_exclusive_scan:
+            case nir_intrinsic_shuffle:
+            case nir_intrinsic_shuffle_xor:
+            case nir_intrinsic_shuffle_up:
+            case nir_intrinsic_shuffle_down:
+            case nir_intrinsic_rotate:
+            case nir_intrinsic_masked_swizzle_amd:
+               instr->pass_flags = STOP_PROCESSING_INSTR_FLAG;
+               goto break_all;
+            case nir_intrinsic_discard_if:
+               if (!consider_discards) {
+                  /* assume that a shader either uses discard or demote, but not both */
+                  instr->pass_flags = STOP_PROCESSING_INSTR_FLAG;
+                  goto break_all;
+               }
+            FALLTHROUGH;
+            case nir_intrinsic_demote_if:
                moved = moved || try_move_discard(intrin);
+               break;
+            default:
+               break;
+            }
             continue;
          }
 
-- 
GitLab


From a5e8a88fef47834dde2a226f009977c3ebf7b152 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Daniel=20Sch=C3=BCrmann?= <daniel@schuermann.dev>
Date: Mon, 11 Dec 2023 12:06:04 +0100
Subject: [PATCH 2/2] nir/gather_info: fix enumeration of wide subgroup
 intrinsics

nir_intrinsic_ballot_* are no subgroup operations.
nir_intrinsic_rotate was missing.
nir_intrinsic_mbcnt_amd is not a subgroup operation.
nir_intrinsic_writelane_amd only affects a single invocation.
---
 src/compiler/nir/nir_gather_info.c | 9 +--------
 1 file changed, 1 insertion(+), 8 deletions(-)

diff --git a/src/compiler/nir/nir_gather_info.c b/src/compiler/nir/nir_gather_info.c
index 58d3cda42703e..7796891e21692 100644
--- a/src/compiler/nir/nir_gather_info.c
+++ b/src/compiler/nir/nir_gather_info.c
@@ -750,12 +750,6 @@ gather_intrinsic_info(nir_intrinsic_instr *instr, nir_shader *shader,
    case nir_intrinsic_vote_feq:
    case nir_intrinsic_vote_ieq:
    case nir_intrinsic_ballot:
-   case nir_intrinsic_ballot_bit_count_exclusive:
-   case nir_intrinsic_ballot_bit_count_inclusive:
-   case nir_intrinsic_ballot_bitfield_extract:
-   case nir_intrinsic_ballot_bit_count_reduce:
-   case nir_intrinsic_ballot_find_lsb:
-   case nir_intrinsic_ballot_find_msb:
    case nir_intrinsic_first_invocation:
    case nir_intrinsic_last_invocation:
    case nir_intrinsic_read_invocation:
@@ -768,9 +762,8 @@ gather_intrinsic_info(nir_intrinsic_instr *instr, nir_shader *shader,
    case nir_intrinsic_shuffle_xor:
    case nir_intrinsic_shuffle_up:
    case nir_intrinsic_shuffle_down:
+   case nir_intrinsic_rotate:
    case nir_intrinsic_masked_swizzle_amd:
-   case nir_intrinsic_mbcnt_amd:
-   case nir_intrinsic_write_invocation_amd:
       shader->info.uses_wide_subgroup_intrinsics = true;
 
       if (shader->info.stage == MESA_SHADER_FRAGMENT &&
-- 
GitLab

