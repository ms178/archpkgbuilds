From e143d138338b29fe49e4b81b0e54c4506ff19cf5 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Thu, 3 Nov 2022 10:54:14 +0000
Subject: [PATCH 01/20] math: drop invert_matrix_perpective
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/mesa/math/m_matrix.c | 35 -----------------------------------
 1 file changed, 35 deletions(-)

diff --git a/src/mesa/math/m_matrix.c b/src/mesa/math/m_matrix.c
index 892c92215062..0b288b417ccc 100644
--- a/src/mesa/math/m_matrix.c
+++ b/src/mesa/math/m_matrix.c
@@ -589,34 +589,6 @@ static GLboolean invert_matrix_2d_no_rot( GLmatrix *mat )
    return GL_TRUE;
 }
 
-#if 0
-/* broken */
-static GLboolean invert_matrix_perspective( GLmatrix *mat )
-{
-   const GLfloat *in = mat->m;
-   GLfloat *out = mat->inv;
-
-   if (MAT(in,2,3) == 0)
-      return GL_FALSE;
-
-   memcpy( out, Identity, sizeof(Identity) );
-
-   MAT(out,0,0) = 1.0F / MAT(in,0,0);
-   MAT(out,1,1) = 1.0F / MAT(in,1,1);
-
-   MAT(out,0,3) = MAT(in,0,2);
-   MAT(out,1,3) = MAT(in,1,2);
-
-   MAT(out,2,2) = 0;
-   MAT(out,2,3) = -1;
-
-   MAT(out,3,2) = 1.0F / MAT(in,2,3);
-   MAT(out,3,3) = MAT(in,2,2) * MAT(out,3,2);
-
-   return GL_TRUE;
-}
-#endif
-
 /**
  * Matrix inversion function pointer type.
  */
@@ -629,14 +601,7 @@ static inv_mat_func inv_mat_tab[7] = {
    invert_matrix_general,
    invert_matrix_identity,
    invert_matrix_3d_no_rot,
-#if 0
-   /* Don't use this function for now - it fails when the projection matrix
-    * is premultiplied by a translation (ala Chromium's tilesort SPU).
-    */
-   invert_matrix_perspective,
-#else
    invert_matrix_general,
-#endif
    invert_matrix_3d,		/* lazy! */
    invert_matrix_2d_no_rot,
    invert_matrix_3d
-- 
GitLab


From e405e66e165b40bcd681ea09e98d4ba1b0f5a04d Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Mon, 31 Oct 2022 22:00:47 +0000
Subject: [PATCH 02/20] gallium/util: Remove dirty flags class
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/gallium/auxiliary/meson.build          |  1 -
 src/gallium/auxiliary/util/u_dirty_flags.h | 32 ----------------------
 2 files changed, 33 deletions(-)
 delete mode 100644 src/gallium/auxiliary/util/u_dirty_flags.h

diff --git a/src/gallium/auxiliary/meson.build b/src/gallium/auxiliary/meson.build
index 8745ee6f3032..a6e1c22b8f3c 100644
--- a/src/gallium/auxiliary/meson.build
+++ b/src/gallium/auxiliary/meson.build
@@ -213,7 +213,6 @@ files_libgallium = files(
   'util/u_debug_flush.h',
   'util/u_debug_image.c',
   'util/u_debug_image.h',
-  'util/u_dirty_flags.h',
   'util/u_dirty_surfaces.h',
   'util/u_draw.c',
   'util/u_draw.h',
diff --git a/src/gallium/auxiliary/util/u_dirty_flags.h b/src/gallium/auxiliary/util/u_dirty_flags.h
deleted file mode 100644
index 40539f0b0ea6..000000000000
--- a/src/gallium/auxiliary/util/u_dirty_flags.h
+++ /dev/null
@@ -1,32 +0,0 @@
-#ifndef U_DIRTY_FLAGS_H
-#define U_DIRTY_FLAGS_H
-
-/* Here's a convenient list of dirty flags to use in a driver.  Either
- * include it directly or use it as a starting point for your own
- * list.
- */
-#define U_NEW_VIEWPORT              0x1
-#define U_NEW_RASTERIZER            0x2
-#define U_NEW_FS                    0x4
-#define U_NEW_FS_CONSTANTS          0x8
-#define U_NEW_FS_SAMPLER_VIEW       0x10
-#define U_NEW_FS_SAMPLER_STATES     0x20
-#define U_NEW_VS                    0x40
-#define U_NEW_VS_CONSTANTS          0x80
-#define U_NEW_VS_SAMPLER_VIEW       0x100
-#define U_NEW_VS_SAMPLER_STATES     0x200
-#define U_NEW_BLEND                 0x400
-#define U_NEW_CLIP                  0x800
-#define U_NEW_SCISSOR               0x1000
-#define U_NEW_POLYGON_STIPPLE       0x2000
-#define U_NEW_FRAMEBUFFER           0x4000
-#define U_NEW_VERTEX_ELEMENTS       0x8000
-#define U_NEW_VERTEX_BUFFER         0x10000
-#define U_NEW_QUERY                 0x20000
-#define U_NEW_DEPTH_STENCIL         0x40000
-#define U_NEW_GS                    0x80000
-#define U_NEW_GS_CONSTANTS          0x100000
-#define U_NEW_GS_SAMPLER_VIEW       0x200000
-#define U_NEW_GS_SAMPLER_STATES     0x400000
-
-#endif
-- 
GitLab


From d73a72b27c7d3fbb2368d518737de8ccc263b7a6 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Mon, 31 Oct 2022 22:02:54 +0000
Subject: [PATCH 03/20] gallium/util: Remove dirty surfaces class
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/gallium/auxiliary/meson.build             |   1 -
 src/gallium/auxiliary/util/u_dirty_surfaces.h | 119 ------------------
 2 files changed, 120 deletions(-)
 delete mode 100644 src/gallium/auxiliary/util/u_dirty_surfaces.h

diff --git a/src/gallium/auxiliary/meson.build b/src/gallium/auxiliary/meson.build
index a6e1c22b8f3c..598e7cf799e7 100644
--- a/src/gallium/auxiliary/meson.build
+++ b/src/gallium/auxiliary/meson.build
@@ -213,7 +213,6 @@ files_libgallium = files(
   'util/u_debug_flush.h',
   'util/u_debug_image.c',
   'util/u_debug_image.h',
-  'util/u_dirty_surfaces.h',
   'util/u_draw.c',
   'util/u_draw.h',
   'util/u_draw_quad.c',
diff --git a/src/gallium/auxiliary/util/u_dirty_surfaces.h b/src/gallium/auxiliary/util/u_dirty_surfaces.h
deleted file mode 100644
index 9913a8bd2998..000000000000
--- a/src/gallium/auxiliary/util/u_dirty_surfaces.h
+++ /dev/null
@@ -1,119 +0,0 @@
-/**************************************************************************
- *
- * Copyright 2010 Luca Barbieri
- *
- * Permission is hereby granted, free of charge, to any person obtaining
- * a copy of this software and associated documentation files (the
- * "Software"), to deal in the Software without restriction, including
- * without limitation the rights to use, copy, modify, merge, publish,
- * distribute, sublicense, and/or sell copies of the Software, and to
- * permit persons to whom the Software is furnished to do so, subject to
- * the following conditions:
- *
- * The above copyright notice and this permission notice (including the
- * next paragraph) shall be included in all copies or substantial
- * portions of the Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
- * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
- * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
- * IN NO EVENT SHALL THE COPYRIGHT OWNER(S) AND/OR ITS SUPPLIERS BE
- * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
- * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
- * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
- *
- **************************************************************************/
-
-#ifndef U_DIRTY_SURFACES_H_
-#define U_DIRTY_SURFACES_H_
-
-#include "pipe/p_state.h"
-
-#include "util/list.h"
-#include "util/u_math.h"
-
-struct pipe_context;
-
-typedef void (*util_dirty_surface_flush_t) (struct pipe_context *, struct pipe_surface *);
-
-struct util_dirty_surfaces
-{
-   struct list_head dirty_list;
-};
-
-struct util_dirty_surface
-{
-   struct pipe_surface base;
-   struct list_head dirty_list;
-};
-
-static inline void
-util_dirty_surfaces_init(struct util_dirty_surfaces *ds)
-{
-   list_inithead(&ds->dirty_list);
-}
-
-static inline void
-util_dirty_surfaces_use_for_sampling(struct pipe_context *pipe, struct util_dirty_surfaces *dss, util_dirty_surface_flush_t flush)
-{
-   struct list_head *p, *next;
-   for(p = dss->dirty_list.next; p != &dss->dirty_list; p = next)
-   {
-      struct util_dirty_surface *ds = list_entry(p, struct util_dirty_surface, dirty_list);
-      next = p->next;
-
-      flush(pipe, &ds->base);
-   }
-}
-
-static inline void
-util_dirty_surfaces_use_levels_for_sampling(struct pipe_context *pipe, struct util_dirty_surfaces *dss, unsigned first, unsigned last, util_dirty_surface_flush_t flush)
-{
-   struct list_head *p, *next;
-   if(first > last)
-      return;
-   for(p = dss->dirty_list.next; p != &dss->dirty_list; p = next)
-   {
-      struct util_dirty_surface *ds = list_entry(p, struct util_dirty_surface, dirty_list);
-      next = p->next;
-
-      if(ds->base.u.tex.level >= first && ds->base.u.tex.level <= last)
-	 flush(pipe, &ds->base);
-   }
-}
-
-static inline void
-util_dirty_surfaces_use_for_sampling_with(struct pipe_context *pipe, struct util_dirty_surfaces *dss, struct pipe_sampler_view *psv, struct pipe_sampler_state *pss, util_dirty_surface_flush_t flush)
-{
-   if(!list_is_empty(&dss->dirty_list))
-      util_dirty_surfaces_use_levels_for_sampling(pipe, dss, (unsigned)pss->min_lod + psv->u.tex.first_level,
-						  MIN2((unsigned)ceilf(pss->max_lod) + psv->u.tex.first_level, psv->u.tex.last_level), flush);
-}
-
-static inline void
-util_dirty_surface_init(struct util_dirty_surface *ds)
-{
-   list_inithead(&ds->dirty_list);
-}
-
-static inline boolean
-util_dirty_surface_is_dirty(struct util_dirty_surface *ds)
-{
-   return !list_is_empty(&ds->dirty_list);
-}
-
-static inline void
-util_dirty_surface_set_dirty(struct util_dirty_surfaces *dss, struct util_dirty_surface *ds)
-{
-   if(list_is_empty(&ds->dirty_list))
-      list_addtail(&ds->dirty_list, &dss->dirty_list);
-}
-
-static inline void
-util_dirty_surface_set_clean(struct util_dirty_surfaces *dss, struct util_dirty_surface *ds)
-{
-   if(!list_is_empty(&ds->dirty_list))
-      list_delinit(&ds->dirty_list);
-}
-
-#endif
-- 
GitLab


From 2b4e50ec1155d557dd66498f51e086582ae4c80d Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Mon, 31 Oct 2022 22:07:26 +0000
Subject: [PATCH 04/20] gallium/util: Remove linear class
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/gallium/auxiliary/meson.build     |   2 -
 src/gallium/auxiliary/util/u_linear.c | 101 ------------------------
 src/gallium/auxiliary/util/u_linear.h | 106 --------------------------
 3 files changed, 209 deletions(-)
 delete mode 100644 src/gallium/auxiliary/util/u_linear.c
 delete mode 100644 src/gallium/auxiliary/util/u_linear.h

diff --git a/src/gallium/auxiliary/meson.build b/src/gallium/auxiliary/meson.build
index 598e7cf799e7..74b44e007b44 100644
--- a/src/gallium/auxiliary/meson.build
+++ b/src/gallium/auxiliary/meson.build
@@ -234,8 +234,6 @@ files_libgallium = files(
   'util/u_index_modify.c',
   'util/u_index_modify.h',
   'util/u_inlines.h',
-  'util/u_linear.c',
-  'util/u_linear.h',
   'util/u_live_shader_cache.c',
   'util/u_live_shader_cache.h',
   'util/u_log.c',
diff --git a/src/gallium/auxiliary/util/u_linear.c b/src/gallium/auxiliary/util/u_linear.c
deleted file mode 100644
index eed7df966be1..000000000000
--- a/src/gallium/auxiliary/util/u_linear.c
+++ /dev/null
@@ -1,101 +0,0 @@
-/**************************************************************************
- * 
- * Copyright 2009 VMware, Inc.
- * All Rights Reserved.
- * 
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the
- * "Software"), to deal in the Software without restriction, including
- * without limitation the rights to use, copy, modify, merge, publish,
- * distribute, sub license, and/or sell copies of the Software, and to
- * permit persons to whom the Software is furnished to do so, subject to
- * the following conditions:
- * 
- * The above copyright notice and this permission notice (including the
- * next paragraph) shall be included in all copies or substantial portions
- * of the Software.
- * 
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
- * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
- * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT.
- * IN NO EVENT SHALL VMWARE AND/OR ITS SUPPLIERS BE LIABLE FOR
- * ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
- * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
- * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
- * 
- **************************************************************************/
-
-/**
- * Functions for converting tiled data to linear and vice versa.
- */
-
-
-#include "util/u_debug.h"
-#include "u_linear.h"
-
-void
-pipe_linear_to_tile(size_t src_stride, const void *src_ptr,
-		    struct pipe_tile_info *t, void *dst_ptr)
-{
-   unsigned x, y, z;
-   char *ptr;
-   size_t bytes = t->cols * t->block.size;
-   char *dst_ptr2 = (char *) dst_ptr;
-
-   assert(pipe_linear_check_tile(t));
-
-   /* lets write linearly to the tiled buffer */
-   for (y = 0; y < t->tiles_y; y++) {
-      for (x = 0; x < t->tiles_x; x++) {
-	 /* this inner loop could be replace with SSE magic */
-	 ptr = (char*)src_ptr + src_stride * t->rows * y + bytes * x;
-	 for (z = 0; z < t->rows; z++) {
-	    memcpy(dst_ptr2, ptr, bytes);
-	    dst_ptr2 += bytes;
-	    ptr += src_stride;
-	 }
-      }
-   }
-}
-
-void pipe_linear_from_tile(struct pipe_tile_info *t, const void *src_ptr,
-			   size_t dst_stride, void *dst_ptr)
-{
-   unsigned x, y, z;
-   char *ptr;
-   size_t bytes = t->cols * t->block.size;
-   const char *src_ptr2 = (const char *) src_ptr;
-
-   /* lets read linearly from the tiled buffer */
-   for (y = 0; y < t->tiles_y; y++) {
-      for (x = 0; x < t->tiles_x; x++) {
-	 /* this inner loop could be replace with SSE magic */
-	 ptr = (char*)dst_ptr + dst_stride * t->rows * y + bytes * x;
-	 for (z = 0; z < t->rows; z++) {
-	    memcpy(ptr, src_ptr2, bytes);
-	    src_ptr2 += bytes;
-	    ptr += dst_stride;
-	 }
-      }
-   }
-}
-
-void
-pipe_linear_fill_info(struct pipe_tile_info *t,
-		      const struct u_linear_format_block *block,
-		      unsigned tile_width, unsigned tile_height,
-		      unsigned tiles_x, unsigned tiles_y)
-{
-   t->block = *block;
-
-   t->tile.width = tile_width;
-   t->tile.height = tile_height;
-   t->cols = t->tile.width / t->block.width;
-   t->rows = t->tile.height / t->block.height;
-   t->tile.size = t->cols * t->rows * t->block.size;
-
-   t->tiles_x = tiles_x;
-   t->tiles_y = tiles_y;
-   t->stride = t->cols * t->tiles_x * t->block.size;
-   t->size = t->tiles_x * t->tiles_y * t->tile.size;
-}
diff --git a/src/gallium/auxiliary/util/u_linear.h b/src/gallium/auxiliary/util/u_linear.h
deleted file mode 100644
index 87e52a344d4f..000000000000
--- a/src/gallium/auxiliary/util/u_linear.h
+++ /dev/null
@@ -1,106 +0,0 @@
-/**************************************************************************
- * 
- * Copyright 2009 VMware, Inc.
- * All Rights Reserved.
- * 
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the
- * "Software"), to deal in the Software without restriction, including
- * without limitation the rights to use, copy, modify, merge, publish,
- * distribute, sub license, and/or sell copies of the Software, and to
- * permit persons to whom the Software is furnished to do so, subject to
- * the following conditions:
- * 
- * The above copyright notice and this permission notice (including the
- * next paragraph) shall be included in all copies or substantial portions
- * of the Software.
- * 
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
- * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
- * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT.
- * IN NO EVENT SHALL VMWARE AND/OR ITS SUPPLIERS BE LIABLE FOR
- * ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
- * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
- * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
- * 
- **************************************************************************/
-
-/**
- * Functions for converting tiled data to linear and vice versa.
- */
-
-
-#ifndef U_LINEAR_H
-#define U_LINEAR_H
-
-#include "pipe/p_compiler.h"
-#include "pipe/p_format.h"
-
-struct u_linear_format_block
-{
-   /** Block size in bytes */
-   unsigned size;
-   
-   /** Block width in pixels */
-   unsigned width;
-   
-   /** Block height in pixels */
-   unsigned height;
-};
-
-
-struct pipe_tile_info
-{
-   unsigned size;
-   unsigned stride;
-
-   /* The number of tiles */
-   unsigned tiles_x;
-   unsigned tiles_y;
-
-   /* size of each tile expressed in blocks */
-   unsigned cols;
-   unsigned rows;
-
-   /* Describe the tile in pixels */
-   struct u_linear_format_block tile;
-
-   /* Describe each block within the tile */
-   struct u_linear_format_block block;
-};
-
-void pipe_linear_to_tile(size_t src_stride, const void *src_ptr,
-			 struct pipe_tile_info *t, void  *dst_ptr);
-
-void pipe_linear_from_tile(struct pipe_tile_info *t, const void *src_ptr,
-			   size_t dst_stride, void *dst_ptr);
-
-/**
- * Convenience function to fillout a pipe_tile_info struct.
- * @t info to fill out.
- * @block block info about pixel layout
- * @tile_width the width of the tile in pixels
- * @tile_height the height of the tile in pixels
- * @tiles_x number of tiles in x axis
- * @tiles_y number of tiles in y axis
- */
-void pipe_linear_fill_info(struct pipe_tile_info *t,
-			   const struct u_linear_format_block *block,
-			   unsigned tile_width, unsigned tile_height,
-			   unsigned tiles_x, unsigned tiles_y);
-
-static inline boolean pipe_linear_check_tile(const struct pipe_tile_info *t)
-{
-   if (t->tile.size != t->block.size * t->cols * t->rows)
-      return FALSE;
-
-   if (t->stride != t->block.size * t->cols * t->tiles_x)
-      return FALSE;
-
-   if (t->size < t->stride * t->rows * t->tiles_y)
-      return FALSE;
-
-   return TRUE;
-}
-
-#endif /* U_LINEAR_H */
-- 
GitLab


From 99b94486b3d9710ebd2c402a810bc6d8a477fa04 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Mon, 31 Oct 2022 22:10:57 +0000
Subject: [PATCH 05/20] gallium/util: Drop unused translate_prim_restart_ib
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/gallium/auxiliary/util/u_prim_restart.c | 78 ---------------------
 src/gallium/auxiliary/util/u_prim_restart.h |  7 --
 2 files changed, 85 deletions(-)

diff --git a/src/gallium/auxiliary/util/u_prim_restart.c b/src/gallium/auxiliary/util/u_prim_restart.c
index 85ce9f17490c..82fca678885e 100644
--- a/src/gallium/auxiliary/util/u_prim_restart.c
+++ b/src/gallium/auxiliary/util/u_prim_restart.c
@@ -90,84 +90,6 @@ util_translate_prim_restart_data(unsigned index_size,
    }
 }
 
-/**
- * Translate an index buffer for primitive restart.
- * Create a new index buffer which is a copy of the original index buffer
- * except that instances of 'restart_index' are converted to 0xffff or
- * 0xffffffff.
- * Also, index buffers using 1-byte indexes are converted to 2-byte indexes.
- */
-enum pipe_error
-util_translate_prim_restart_ib(struct pipe_context *context,
-                               const struct pipe_draw_info *info,
-                               const struct pipe_draw_indirect_info *indirect_info,
-                               const struct pipe_draw_start_count_bias *draw,
-                               struct pipe_resource **dst_buffer)
-{
-   struct pipe_screen *screen = context->screen;
-   struct pipe_transfer *src_transfer = NULL, *dst_transfer = NULL;
-   void *src_map = NULL, *dst_map = NULL;
-   const unsigned src_index_size = info->index_size;
-   unsigned dst_index_size;
-   DrawElementsIndirectCommand indirect;
-   unsigned count = draw->count;
-   unsigned start = draw->start;
-
-   /* 1-byte indexes are converted to 2-byte indexes, 4-byte stays 4-byte */
-   dst_index_size = MAX2(2, info->index_size);
-   assert(dst_index_size == 2 || dst_index_size == 4);
-
-   if (indirect_info && indirect_info->buffer) {
-      indirect = read_indirect_elements(context, indirect_info);
-      count = indirect.count;
-      start = indirect.firstIndex;
-   }
-
-   /* Create new index buffer */
-   *dst_buffer = pipe_buffer_create(screen, PIPE_BIND_INDEX_BUFFER,
-                                    PIPE_USAGE_STREAM,
-                                    count * dst_index_size);
-   if (!*dst_buffer)
-      goto error;
-
-   /* Map new / dest index buffer */
-   dst_map = pipe_buffer_map(context, *dst_buffer,
-                             PIPE_MAP_WRITE, &dst_transfer);
-   if (!dst_map)
-      goto error;
-
-   if (info->has_user_indices)
-      src_map = (unsigned char*)info->index.user + start * src_index_size;
-   else
-      /* Map original / src index buffer */
-      src_map = pipe_buffer_map_range(context, info->index.resource,
-                                      start * src_index_size,
-                                      count * src_index_size,
-                                      PIPE_MAP_READ,
-                                      &src_transfer);
-   if (!src_map)
-      goto error;
-
-   util_translate_prim_restart_data(src_index_size, src_map, dst_map,
-                                    count, info->restart_index);
-
-   if (src_transfer)
-      pipe_buffer_unmap(context, src_transfer);
-   pipe_buffer_unmap(context, dst_transfer);
-
-   return PIPE_OK;
-
-error:
-   if (src_transfer)
-      pipe_buffer_unmap(context, src_transfer);
-   if (dst_transfer)
-      pipe_buffer_unmap(context, dst_transfer);
-   if (*dst_buffer)
-      pipe_resource_reference(dst_buffer, NULL);
-   return PIPE_ERROR_OUT_OF_MEMORY;
-}
-
-
 /** Helper structs for util_draw_vbo_without_prim_restart() */
 
 struct range_info {
diff --git a/src/gallium/auxiliary/util/u_prim_restart.h b/src/gallium/auxiliary/util/u_prim_restart.h
index eb06b8e77441..45038d468a7b 100644
--- a/src/gallium/auxiliary/util/u_prim_restart.h
+++ b/src/gallium/auxiliary/util/u_prim_restart.h
@@ -46,13 +46,6 @@ util_translate_prim_restart_data(unsigned index_size,
                                  void *src_map, void *dst_map,
                                  unsigned count, unsigned restart_index);
 
-enum pipe_error
-util_translate_prim_restart_ib(struct pipe_context *context,
-                               const struct pipe_draw_info *info,
-                               const struct pipe_draw_indirect_info *indirect,
-                               const struct pipe_draw_start_count_bias *draw,
-                               struct pipe_resource **dst_buffer);
-
 struct pipe_draw_start_count_bias *
 util_prim_restart_convert_to_direct(const void *index_map,
                                     const struct pipe_draw_info *info,
-- 
GitLab


From 83ef8f0361195c609904ca21d28e2769434f4812 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Mon, 31 Oct 2022 22:14:21 +0000
Subject: [PATCH 06/20] gallium/util: drop unused rect_area
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/gallium/auxiliary/util/u_rect.h | 7 -------
 1 file changed, 7 deletions(-)

diff --git a/src/gallium/auxiliary/util/u_rect.h b/src/gallium/auxiliary/util/u_rect.h
index 221d9188730e..e873bbd50149 100644
--- a/src/gallium/auxiliary/util/u_rect.h
+++ b/src/gallium/auxiliary/util/u_rect.h
@@ -72,13 +72,6 @@ u_rect_find_intersection(const struct u_rect *a,
    if (b->y1 > a->y1) b->y1 = a->y1;
 }
 
-
-static inline int
-u_rect_area(const struct u_rect *r)
-{
-   return (r->x1 - r->x0) * (r->y1 - r->y0);
-}
-
 static inline void
 u_rect_possible_intersection(const struct u_rect *a,
                              struct u_rect *b)
-- 
GitLab


From 744144270f39883d929ed01698402558b705b25c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Mon, 31 Oct 2022 22:15:55 +0000
Subject: [PATCH 07/20] gallium/util: drop unused
 sampler_view_default_dx9_template
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/gallium/auxiliary/util/u_sampler.c | 12 ------------
 src/gallium/auxiliary/util/u_sampler.h |  6 ------
 2 files changed, 18 deletions(-)

diff --git a/src/gallium/auxiliary/util/u_sampler.c b/src/gallium/auxiliary/util/u_sampler.c
index 7c81017f535c..d1d747069d23 100644
--- a/src/gallium/auxiliary/util/u_sampler.c
+++ b/src/gallium/auxiliary/util/u_sampler.c
@@ -93,15 +93,3 @@ u_sampler_view_default_template(struct pipe_sampler_view *view,
                     format,
                     PIPE_SWIZZLE_0);
 }
-
-void
-u_sampler_view_default_dx9_template(struct pipe_sampler_view *view,
-                                    const struct pipe_resource *texture,
-                                    enum pipe_format format)
-{
-   /* Expand to (1, 1, 1, 1) */
-   default_template(view,
-                    texture,
-                    format,
-                    PIPE_SWIZZLE_1);
-}
diff --git a/src/gallium/auxiliary/util/u_sampler.h b/src/gallium/auxiliary/util/u_sampler.h
index f3dad7417e0f..2a09dfee4507 100644
--- a/src/gallium/auxiliary/util/u_sampler.h
+++ b/src/gallium/auxiliary/util/u_sampler.h
@@ -44,12 +44,6 @@ u_sampler_view_default_template(struct pipe_sampler_view *view,
                                 const struct pipe_resource *texture,
                                 enum pipe_format format);
 
-void
-u_sampler_view_default_dx9_template(struct pipe_sampler_view *view,
-                                    const struct pipe_resource *texture,
-                                    enum pipe_format format);
-
-
 #ifdef __cplusplus
 } /* extern "C" { */
 #endif
-- 
GitLab


From eb03ac7a5cfbd06bdd1ee826489da3fbd2b1f293 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Mon, 31 Oct 2022 22:19:19 +0000
Subject: [PATCH 08/20] gallium/util: remove unused macros and their functions
 from sse class
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/gallium/auxiliary/util/u_sse.h | 82 ------------------------------
 1 file changed, 82 deletions(-)

diff --git a/src/gallium/auxiliary/util/u_sse.h b/src/gallium/auxiliary/util/u_sse.h
index c257944658fe..091e15fdd6ae 100644
--- a/src/gallium/auxiliary/util/u_sse.h
+++ b/src/gallium/auxiliary/util/u_sse.h
@@ -53,88 +53,6 @@ union m128i {
    uint ui[4];
 };
 
-static inline void u_print_epi8(const char *name, __m128i r)
-{
-   union { __m128i m; ubyte ub[16]; } u;
-   u.m = r;
-
-   debug_printf("%s: "
-                "%02x/"
-                "%02x/"
-                "%02x/"
-                "%02x/"
-                "%02x/"
-                "%02x/"
-                "%02x/"
-                "%02x/"
-                "%02x/"
-                "%02x/"
-                "%02x/"
-                "%02x/"
-                "%02x/"
-                "%02x/"
-                "%02x/"
-                "%02x\n",
-                name,
-                u.ub[0],  u.ub[1],  u.ub[2],  u.ub[3],
-                u.ub[4],  u.ub[5],  u.ub[6],  u.ub[7],
-                u.ub[8],  u.ub[9],  u.ub[10], u.ub[11],
-                u.ub[12], u.ub[13], u.ub[14], u.ub[15]);
-}
-
-static inline void u_print_epi16(const char *name, __m128i r)
-{
-   union { __m128i m; ushort us[8]; } u;
-   u.m = r;
-
-   debug_printf("%s: "
-                "%04x/"
-                "%04x/"
-                "%04x/"
-                "%04x/"
-                "%04x/"
-                "%04x/"
-                "%04x/"
-                "%04x\n",
-                name,
-                u.us[0],  u.us[1],  u.us[2],  u.us[3],
-                u.us[4],  u.us[5],  u.us[6],  u.us[7]);
-}
-
-static inline void u_print_epi32(const char *name, __m128i r)
-{
-   union { __m128i m; uint ui[4]; } u;
-   u.m = r;
-
-   debug_printf("%s: "
-                "%08x/"
-                "%08x/"
-                "%08x/"
-                "%08x\n",
-                name,
-                u.ui[0],  u.ui[1],  u.ui[2],  u.ui[3]);
-}
-
-static inline void u_print_ps(const char *name, __m128 r)
-{
-   union { __m128 m; float f[4]; } u;
-   u.m = r;
-
-   debug_printf("%s: "
-                "%f/"
-                "%f/"
-                "%f/"
-                "%f\n",
-                name,
-                u.f[0],  u.f[1],  u.f[2],  u.f[3]);
-}
-
-
-#define U_DUMP_EPI32(a) u_print_epi32(#a, a)
-#define U_DUMP_EPI16(a) u_print_epi16(#a, a)
-#define U_DUMP_EPI8(a)  u_print_epi8(#a, a)
-#define U_DUMP_PS(a)    u_print_ps(#a, a)
-
 /*
  * Provide an SSE implementation of _mm_mul_epi32() in terms of
  * _mm_mul_epu32().
-- 
GitLab


From 41496f5f54394d7abcccf14a2588f92217215623 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Mon, 31 Oct 2022 22:39:31 +0000
Subject: [PATCH 09/20] util: remove unused half_to_unorm8
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/util/half_float.c | 26 --------------------------
 src/util/half_float.h |  1 -
 2 files changed, 27 deletions(-)

diff --git a/src/util/half_float.c b/src/util/half_float.c
index 606e4b9522ed..0eacf06c5a8e 100644
--- a/src/util/half_float.c
+++ b/src/util/half_float.c
@@ -171,32 +171,6 @@ _mesa_half_to_float_slow(uint16_t val)
    return f32.f;
 }
 
-/**
-  * Convert 0.0 to 0x00, 1.0 to 0xff.
-  * Values outside the range [0.0, 1.0] will give undefined results.
-  */
-uint8_t _mesa_half_to_unorm8(uint16_t val)
-{
-   const int m = val & 0x3ff;
-   const int e = (val >> 10) & 0x1f;
-   ASSERTED const int s = (val >> 15) & 0x1;
-
-   /* v = round_to_nearest(1.mmmmmmmmmm * 2^(e-15) * 255)
-    *   = round_to_nearest((1.mmmmmmmmmm * 255) * 2^(e-15))
-    *   = round_to_nearest((1mmmmmmmmmm * 255) * 2^(e-25))
-    *   = round_to_zero((1mmmmmmmmmm * 255) * 2^(e-25) + 0.5)
-    *   = round_to_zero(((1mmmmmmmmmm * 255) * 2^(e-24) + 1) / 2)
-    *
-    * This happens to give the correct answer for zero/subnormals too
-    */
-   assert(s == 0 && val <= FP16_ONE); /* check 0 <= this <= 1 */
-   /* (implies e <= 15, which means the bit-shifts below are safe) */
-
-   uint32_t v = ((1 << 10) | m) * 255;
-   v = ((v >> (24 - e)) + 1) >> 1;
-   return v;
-}
-
 /**
   * Takes a uint16_t, divides by 65536, converts the infinite-precision
   * result to fp16 with round-to-zero. Used by the ASTC decoder.
diff --git a/src/util/half_float.h b/src/util/half_float.h
index 91d4ebd41f04..eac6aafc9455 100644
--- a/src/util/half_float.h
+++ b/src/util/half_float.h
@@ -44,7 +44,6 @@ extern "C" {
 
 uint16_t _mesa_float_to_half_slow(float val);
 float _mesa_half_to_float_slow(uint16_t val);
-uint8_t _mesa_half_to_unorm8(uint16_t v);
 uint16_t _mesa_uint16_div_64k_to_half(uint16_t v);
 
 /*
-- 
GitLab


From 8ee09ca00f388b78cb6ff18560238c3fc49d86d0 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Tue, 1 Nov 2022 23:54:04 +0000
Subject: [PATCH 10/20] util: remove unused set_random_entry
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/util/set.c | 27 ---------------------------
 src/util/set.h |  4 ----
 2 files changed, 31 deletions(-)

diff --git a/src/util/set.c b/src/util/set.c
index 2a3c16658658..dc8371463003 100644
--- a/src/util/set.c
+++ b/src/util/set.c
@@ -604,33 +604,6 @@ _mesa_set_next_entry(const struct set *ht, struct set_entry *entry)
    return NULL;
 }
 
-struct set_entry *
-_mesa_set_random_entry(struct set *ht,
-                       int (*predicate)(struct set_entry *entry))
-{
-   struct set_entry *entry;
-   uint32_t i = rand() % ht->size;
-
-   if (ht->entries == 0)
-      return NULL;
-
-   for (entry = ht->table + i; entry != ht->table + ht->size; entry++) {
-      if (entry_is_present(entry) &&
-          (!predicate || predicate(entry))) {
-         return entry;
-      }
-   }
-
-   for (entry = ht->table; entry != ht->table + i; entry++) {
-      if (entry_is_present(entry) &&
-          (!predicate || predicate(entry))) {
-         return entry;
-      }
-   }
-
-   return NULL;
-}
-
 /**
  * Helper to create a set with pointer keys.
  */
diff --git a/src/util/set.h b/src/util/set.h
index 36f271fb054d..4af5c0d99fc9 100644
--- a/src/util/set.h
+++ b/src/util/set.h
@@ -114,10 +114,6 @@ _mesa_set_next_entry(const struct set *set, struct set_entry *entry);
 struct set_entry *
 _mesa_set_next_entry_unsafe(const struct set *set, struct set_entry *entry);
 
-struct set_entry *
-_mesa_set_random_entry(struct set *set,
-                       int (*predicate)(struct set_entry *entry));
-
 struct set *
 _mesa_pointer_set_create(void *mem_ctx);
 
-- 
GitLab


From 34d1207276d283d7d9f5aa6a5ebe2845c6b8800b Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Wed, 2 Nov 2022 00:05:00 +0000
Subject: [PATCH 11/20] util: remove unused debug_print_blob
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/util/u_debug.c | 18 ------------------
 src/util/u_debug.h | 12 ------------
 2 files changed, 30 deletions(-)

diff --git a/src/util/u_debug.c b/src/util/u_debug.c
index d34b804be0d8..eeda1011f446 100644
--- a/src/util/u_debug.c
+++ b/src/util/u_debug.c
@@ -100,24 +100,6 @@ debug_disable_win32_error_dialogs(void)
 }
 #endif /* _WIN32 */
 
-
-#ifdef DEBUG
-void
-debug_print_blob(const char *name, const void *blob, unsigned size)
-{
-   const unsigned *ublob = (const unsigned *)blob;
-   unsigned i;
-
-   debug_printf("%s (%d dwords%s)\n", name, size/4,
-                size%4 ? "... plus a few bytes" : "");
-
-   for (i = 0; i < size/4; i++) {
-      debug_printf("%d:\t%08x\n", i, ublob[i]);
-   }
-}
-#endif
-
-
 static bool
 debug_get_option_should_print(void)
 {
diff --git a/src/util/u_debug.h b/src/util/u_debug.h
index 805d79776863..449e7bf59937 100644
--- a/src/util/u_debug.h
+++ b/src/util/u_debug.h
@@ -165,18 +165,6 @@ debug_printf(const char *format, ...)
 #define debug_vprintf(_format, _ap) ((void)0)
 #endif
 
-
-#ifdef DEBUG
-/**
- * Dump a blob in hex to the same place that debug_printf sends its
- * messages.
- */
-void debug_print_blob( const char *name, const void *blob, unsigned size );
-#else
-#define debug_print_blob(_name, _blob, _size) ((void)0)
-#endif
-
-
 #ifdef _WIN32
 /**
  * Disable Win32 interactive error message boxes.
-- 
GitLab


From 00f09a9a46b1ad4a4560a2d2964ba64ab4b1148d Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Wed, 2 Nov 2022 00:06:33 +0000
Subject: [PATCH 12/20] util: remove unused debug_dump_enum_noprefix
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/util/u_debug.c | 24 ------------------------
 src/util/u_debug.h |  6 ------
 2 files changed, 30 deletions(-)

diff --git a/src/util/u_debug.c b/src/util/u_debug.c
index eeda1011f446..773b03a56798 100644
--- a/src/util/u_debug.c
+++ b/src/util/u_debug.c
@@ -338,30 +338,6 @@ debug_dump_enum(const struct debug_named_value *names,
 }
 
 
-const char *
-debug_dump_enum_noprefix(const struct debug_named_value *names,
-                         const char *prefix,
-                         unsigned long value)
-{
-   static char rest[64];
-
-   while (names->name) {
-      if (names->value == value) {
-         const char *name = names->name;
-         while (*name == *prefix) {
-            name++;
-            prefix++;
-         }
-         return name;
-      }
-      ++names;
-   }
-
-   snprintf(rest, sizeof(rest), "0x%08lx", value);
-   return rest;
-}
-
-
 const char *
 debug_dump_flags(const struct debug_named_value *names, unsigned long value)
 {
diff --git a/src/util/u_debug.h b/src/util/u_debug.h
index 449e7bf59937..43cab29429e6 100644
--- a/src/util/u_debug.h
+++ b/src/util/u_debug.h
@@ -321,12 +321,6 @@ const char *
 debug_dump_enum(const struct debug_named_value *names,
                 unsigned long value);
 
-const char *
-debug_dump_enum_noprefix(const struct debug_named_value *names,
-                         const char *prefix,
-                         unsigned long value);
-
-
 /**
  * Convert binary flags value to a string.
  */
-- 
GitLab


From 4ffc40d5d081c38ee344c8ce469dc777d29334c5 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Wed, 2 Nov 2022 00:14:00 +0000
Subject: [PATCH 13/20] util: remove fifo class
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/gallium/drivers/i915/i915_prim_vbuf.c |  1 -
 src/util/meson.build                      |  1 -
 src/util/perf/u_trace.c                   |  1 -
 src/util/u_fifo.h                         | 94 -----------------------
 4 files changed, 97 deletions(-)
 delete mode 100644 src/util/u_fifo.h

diff --git a/src/gallium/drivers/i915/i915_prim_vbuf.c b/src/gallium/drivers/i915/i915_prim_vbuf.c
index fb192264d6ef..5a7fb1a72115 100644
--- a/src/gallium/drivers/i915/i915_prim_vbuf.c
+++ b/src/gallium/drivers/i915/i915_prim_vbuf.c
@@ -40,7 +40,6 @@
 #include "draw/draw_context.h"
 #include "draw/draw_vbuf.h"
 #include "util/u_debug.h"
-#include "util/u_fifo.h"
 #include "util/u_inlines.h"
 #include "util/u_math.h"
 #include "util/u_memory.h"
diff --git a/src/util/meson.build b/src/util/meson.build
index a6e12737b9b2..b7e7a7b203a5 100644
--- a/src/util/meson.build
+++ b/src/util/meson.build
@@ -129,7 +129,6 @@ files_mesa_util = files(
   'u_dl.h',
   'u_dynarray.h',
   'u_endian.h',
-  'u_fifo.h',
   'u_hash_table.c',
   'u_hash_table.h',
   'u_pointer.h',
diff --git a/src/util/perf/u_trace.c b/src/util/perf/u_trace.c
index 11e10b296a2f..276b64a01efd 100644
--- a/src/util/perf/u_trace.c
+++ b/src/util/perf/u_trace.c
@@ -27,7 +27,6 @@
 #include "util/u_call_once.h"
 #include "util/u_debug.h"
 #include "util/u_inlines.h"
-#include "util/u_fifo.h"
 #include "util/u_vector.h"
 
 #include "u_trace.h"
diff --git a/src/util/u_fifo.h b/src/util/u_fifo.h
deleted file mode 100644
index b53a3ddd52d9..000000000000
--- a/src/util/u_fifo.h
+++ /dev/null
@@ -1,94 +0,0 @@
-/**************************************************************************
- *
- * Copyright © 2009 Jakob Bornecrantz
- *
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the "Software"),
- * to deal in the Software without restriction, including without limitation
- * the rights to use, copy, modify, merge, publish, distribute, sublicense,
- * and/or sell copies of the Software, and to permit persons to whom the
- * Software is furnished to do so, subject to the following conditions:
- *
- * The above copyright notice and this permission notice (including the next
- * paragraph) shall be included in all copies or substantial portions of the
- * Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
- * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
- * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
- * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
- * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
- * DEALINGS IN THE SOFTWARE.
- *
- **************************************************************************/
-
-#ifndef U_FIFO_H
-#define U_FIFO_H
-
-#include "util/u_memory.h"
-
-struct util_fifo
-{
-   size_t head;
-   size_t tail;
-   size_t num;
-   size_t size;
-};
-
-static inline struct util_fifo *
-u_fifo_create(size_t size)
-{
-   struct util_fifo *fifo;
-   fifo = MALLOC(sizeof(*fifo) + size * sizeof(void*));
-
-   fifo->head = 0;
-   fifo->tail = 0;
-   fifo->num = 0;
-   fifo->size = size;
-
-   return fifo;
-}
-
-static inline boolean
-u_fifo_add(struct util_fifo *fifo, void *ptr)
-{
-   void **array = (void**)&fifo[1];
-   if (fifo->num >= fifo->size)
-      return FALSE;
-
-   if (++fifo->head >= fifo->size)
-      fifo->head = 0;
-
-   array[fifo->head] = ptr;
-
-   ++fifo->num;
-
-   return TRUE;
-}
-
-static inline boolean
-u_fifo_pop(struct util_fifo *fifo, void **ptr)
-{
-   void **array = (void**)&fifo[1];
-
-   if (!fifo->num)
-      return FALSE;
-
-   if (++fifo->tail >= fifo->size)
-      fifo->tail = 0;
-
-   *ptr = array[fifo->tail];
-
-   --fifo->num;
-
-   return TRUE;
-}
-
-static inline void
-u_fifo_destroy(struct util_fifo *fifo)
-{
-   FREE(fifo);
-}
-
-#endif
-- 
GitLab


From ae8a694be1fb2bc272bdecaed04de25116f1aebf Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Thu, 3 Nov 2022 10:57:36 +0000
Subject: [PATCH 14/20] util: remove unused enter debug exit loggers
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/util/u_debug.c | 41 -----------------------------------------
 src/util/u_debug.h | 38 --------------------------------------
 2 files changed, 79 deletions(-)

diff --git a/src/util/u_debug.c b/src/util/u_debug.c
index 773b03a56798..b0ce238d7df9 100644
--- a/src/util/u_debug.c
+++ b/src/util/u_debug.c
@@ -462,44 +462,3 @@ comma_separated_list_contains(const char *list, const char *s)
 
    return false;
 }
-
-
-#ifdef DEBUG
-int fl_indent = 0;
-const char* fl_function[1024];
-
-int
-debug_funclog_enter(const char* f, UNUSED const int line,
-                    UNUSED const char* file)
-{
-   int i;
-
-   for (i = 0; i < fl_indent; i++)
-      debug_printf("  ");
-   debug_printf("%s\n", f);
-
-   assert(fl_indent < 1023);
-   fl_function[fl_indent++] = f;
-
-   return 0;
-}
-
-void
-debug_funclog_exit(const char* f, UNUSED const int line,
-                   UNUSED const char* file)
-{
-   --fl_indent;
-   assert(fl_indent >= 0);
-   assert(fl_function[fl_indent] == f);
-}
-
-void
-debug_funclog_enter_exit(const char* f, UNUSED const int line,
-                         UNUSED const char* file)
-{
-   int i;
-   for (i = 0; i < fl_indent; i++)
-      debug_printf("  ");
-   debug_printf("%s\n", f);
-}
-#endif
diff --git a/src/util/u_debug.h b/src/util/u_debug.h
index 43cab29429e6..43b2a41e19d1 100644
--- a/src/util/u_debug.h
+++ b/src/util/u_debug.h
@@ -348,44 +348,6 @@ parse_enable_string(const char *debug,
 bool
 comma_separated_list_contains(const char *list, const char *s);
 
-
-/**
- * Function enter exit loggers
- */
-#ifdef DEBUG
-int debug_funclog_enter(const char* f, const int line, const char* file);
-void debug_funclog_exit(const char* f, const int line, const char* file);
-void debug_funclog_enter_exit(const char* f, const int line, const char* file);
-
-#define DEBUG_FUNCLOG_ENTER() \
-   int __debug_decleration_work_around = \
-      debug_funclog_enter(__FUNCTION__, __LINE__, __FILE__)
-#define DEBUG_FUNCLOG_EXIT() \
-   do { \
-      (void)__debug_decleration_work_around; \
-      debug_funclog_exit(__FUNCTION__, __LINE__, __FILE__); \
-      return; \
-   } while(0)
-#define DEBUG_FUNCLOG_EXIT_RET(ret) \
-   do { \
-      (void)__debug_decleration_work_around; \
-      debug_funclog_exit(__FUNCTION__, __LINE__, __FILE__); \
-      return ret; \
-   } while(0)
-#define DEBUG_FUNCLOG_ENTER_EXIT() \
-   debug_funclog_enter_exit(__FUNCTION__, __LINE__, __FILE__)
-
-#else
-#define DEBUG_FUNCLOG_ENTER() \
-   int __debug_decleration_work_around
-#define DEBUG_FUNCLOG_EXIT() \
-   do { (void)__debug_decleration_work_around; return; } while(0)
-#define DEBUG_FUNCLOG_EXIT_RET(ret) \
-   do { (void)__debug_decleration_work_around; return ret; } while(0)
-#define DEBUG_FUNCLOG_ENTER_EXIT()
-#endif
-
-
 /**
  * Get option.
  *
-- 
GitLab


From de9270d51f57b1b5bdbe5080878ba94bf8fccccc Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Thu, 3 Nov 2022 11:05:56 +0000
Subject: [PATCH 15/20] math: remove unused matrix_has_rotation
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/mesa/math/m_matrix.c | 18 ------------------
 src/mesa/math/m_matrix.h |  3 ---
 2 files changed, 21 deletions(-)

diff --git a/src/mesa/math/m_matrix.c b/src/mesa/math/m_matrix.c
index 0b288b417ccc..ca2163497057 100644
--- a/src/mesa/math/m_matrix.c
+++ b/src/mesa/math/m_matrix.c
@@ -1270,24 +1270,6 @@ _math_matrix_is_length_preserving( const GLmatrix *m )
    return TEST_MAT_FLAGS( m, MAT_FLAGS_LENGTH_PRESERVING);
 }
 
-
-/**
- * Test if the given matrix does any rotation.
- * (or perhaps if the upper-left 3x3 is non-identity)
- */
-GLboolean
-_math_matrix_has_rotation( const GLmatrix *m )
-{
-   if (m->flags & (MAT_FLAG_GENERAL |
-                   MAT_FLAG_ROTATION |
-                   MAT_FLAG_GENERAL_3D |
-                   MAT_FLAG_PERSPECTIVE))
-      return GL_TRUE;
-   else
-      return GL_FALSE;
-}
-
-
 GLboolean
 _math_matrix_is_general_scale( const GLmatrix *m )
 {
diff --git a/src/mesa/math/m_matrix.h b/src/mesa/math/m_matrix.h
index b911e8f30215..06d9d0018fec 100644
--- a/src/mesa/math/m_matrix.h
+++ b/src/mesa/math/m_matrix.h
@@ -146,9 +146,6 @@ _math_matrix_print( const GLmatrix *m );
 extern GLboolean
 _math_matrix_is_length_preserving( const GLmatrix *m );
 
-extern GLboolean
-_math_matrix_has_rotation( const GLmatrix *m );
-
 extern GLboolean
 _math_matrix_is_general_scale( const GLmatrix *m );
 
-- 
GitLab


From 4ea532c7d0ab5b0ee6a7f4826a6c81da7d371cf3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Thu, 3 Nov 2022 11:19:44 +0000
Subject: [PATCH 16/20] math: remove unused matrix_is_general_scale
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/mesa/math/m_matrix.c | 7 -------
 1 file changed, 7 deletions(-)

diff --git a/src/mesa/math/m_matrix.c b/src/mesa/math/m_matrix.c
index ca2163497057..66dcc747b87c 100644
--- a/src/mesa/math/m_matrix.c
+++ b/src/mesa/math/m_matrix.c
@@ -1270,13 +1270,6 @@ _math_matrix_is_length_preserving( const GLmatrix *m )
    return TEST_MAT_FLAGS( m, MAT_FLAGS_LENGTH_PRESERVING);
 }
 
-GLboolean
-_math_matrix_is_general_scale( const GLmatrix *m )
-{
-   return (m->flags & MAT_FLAG_GENERAL_SCALE) ? GL_TRUE : GL_FALSE;
-}
-
-
 GLboolean
 _math_matrix_is_dirty( const GLmatrix *m )
 {
-- 
GitLab


From 201e84bd25dfe329781c7b5d92569cedcb4358bf Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Thu, 3 Nov 2022 11:22:41 +0000
Subject: [PATCH 17/20] math: remove unused debug classes
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/mesa/math/m_debug.h       |  36 ---
 src/mesa/math/m_debug_clip.c  | 409 ----------------------------------
 src/mesa/math/m_debug_norm.c  | 383 -------------------------------
 src/mesa/math/m_debug_util.h  | 307 -------------------------
 src/mesa/math/m_debug_xform.c | 338 ----------------------------
 src/mesa/meson.build          |   5 -
 6 files changed, 1478 deletions(-)
 delete mode 100644 src/mesa/math/m_debug.h
 delete mode 100644 src/mesa/math/m_debug_clip.c
 delete mode 100644 src/mesa/math/m_debug_norm.c
 delete mode 100644 src/mesa/math/m_debug_util.h
 delete mode 100644 src/mesa/math/m_debug_xform.c

diff --git a/src/mesa/math/m_debug.h b/src/mesa/math/m_debug.h
deleted file mode 100644
index 6c5488669c98..000000000000
--- a/src/mesa/math/m_debug.h
+++ /dev/null
@@ -1,36 +0,0 @@
-
-/*
- * Mesa 3-D graphics library
- *
- * Copyright (C) 1999-2001  Brian Paul   All Rights Reserved.
- *
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the "Software"),
- * to deal in the Software without restriction, including without limitation
- * the rights to use, copy, modify, merge, publish, distribute, sublicense,
- * and/or sell copies of the Software, and to permit persons to whom the
- * Software is furnished to do so, subject to the following conditions:
- *
- * The above copyright notice and this permission notice shall be included
- * in all copies or substantial portions of the Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
- * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
- * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
- * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
- * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
- * OTHER DEALINGS IN THE SOFTWARE.
- *
- * Authors:
- *    Gareth Hughes
- */
-
-#ifndef __M_DEBUG_H__
-#define __M_DEBUG_H__
-
-extern void _math_test_all_transform_functions( char *description );
-extern void _math_test_all_normal_transform_functions( char *description );
-extern void _math_test_all_cliptest_functions( char *description );
-
-#endif
diff --git a/src/mesa/math/m_debug_clip.c b/src/mesa/math/m_debug_clip.c
deleted file mode 100644
index 9d1883efc741..000000000000
--- a/src/mesa/math/m_debug_clip.c
+++ /dev/null
@@ -1,409 +0,0 @@
-/*
- * Mesa 3-D graphics library
- *
- * Copyright (C) 1999-2005  Brian Paul   All Rights Reserved.
- *
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the "Software"),
- * to deal in the Software without restriction, including without limitation
- * the rights to use, copy, modify, merge, publish, distribute, sublicense,
- * and/or sell copies of the Software, and to permit persons to whom the
- * Software is furnished to do so, subject to the following conditions:
- *
- * The above copyright notice and this permission notice shall be included
- * in all copies or substantial portions of the Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
- * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
- * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
- * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
- * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
- * OTHER DEALINGS IN THE SOFTWARE.
- *
- * Authors:
- *    Gareth Hughes
- */
-
-#include "main/glheader.h"
-#include "main/context.h"
-#include "main/macros.h"
-
-
-#include "m_matrix.h"
-#include "m_xform.h"
-
-#include "m_debug.h"
-#include "m_debug_util.h"
-
-#ifdef __UNIXOS2__
-/* The linker doesn't like empty files */
-static char dummy;
-#endif
-
-#ifdef DEBUG_MATH  /* This code only used for debugging */
-
-static clip_func *clip_tab[2] = {
-   _mesa_clip_tab,
-   _mesa_clip_np_tab
-};
-static char *cnames[2] = {
-   "_mesa_clip_tab",
-   "_mesa_clip_np_tab"
-};
-#ifdef RUN_DEBUG_BENCHMARK
-static char *cstrings[2] = {
-   "clip, perspective divide",
-   "clip, no divide"
-};
-#endif
-
-
-/* =============================================================
- * Reference cliptests
- */
-
-static GLvector4f *ref_cliptest_points4( GLvector4f *clip_vec,
-					 GLvector4f *proj_vec,
-					 GLubyte clipMask[],
-					 GLubyte *orMask,
-					 GLubyte *andMask,
-					 GLboolean viewport_z_clip )
-{
-   const GLuint stride = clip_vec->stride;
-   const GLuint count = clip_vec->count;
-   const GLfloat *from = (GLfloat *)clip_vec->start;
-   GLuint c = 0;
-   GLfloat (*vProj)[4] = (GLfloat (*)[4])proj_vec->start;
-   GLubyte tmpAndMask = *andMask;
-   GLubyte tmpOrMask = *orMask;
-   GLuint i;
-   for ( i = 0 ; i < count ; i++, STRIDE_F(from, stride) ) {
-      const GLfloat cx = from[0];
-      const GLfloat cy = from[1];
-      const GLfloat cz = from[2];
-      const GLfloat cw = from[3];
-      GLubyte mask = 0;
-      if ( -cx + cw < 0 ) mask |= CLIP_RIGHT_BIT;
-      if (  cx + cw < 0 ) mask |= CLIP_LEFT_BIT;
-      if ( -cy + cw < 0 ) mask |= CLIP_TOP_BIT;
-      if (  cy + cw < 0 ) mask |= CLIP_BOTTOM_BIT;
-      if (viewport_z_clip) {
-	 if ( -cz + cw < 0 ) mask |= CLIP_FAR_BIT;
-	 if (  cz + cw < 0 ) mask |= CLIP_NEAR_BIT;
-      }
-      clipMask[i] = mask;
-      if ( mask ) {
-	 c++;
-	 tmpAndMask &= mask;
-	 tmpOrMask |= mask;
-	 vProj[i][0] = 0;
-	 vProj[i][1] = 0;
-	 vProj[i][2] = 0;
-	 vProj[i][3] = 1;
-      } else {
-	 GLfloat oow = 1.0F / cw;
-	 vProj[i][0] = cx * oow;
-	 vProj[i][1] = cy * oow;
-	 vProj[i][2] = cz * oow;
-	 vProj[i][3] = oow;
-      }
-   }
-
-   *orMask = tmpOrMask;
-   *andMask = (GLubyte) (c < count ? 0 : tmpAndMask);
-
-   proj_vec->flags |= VEC_SIZE_4;
-   proj_vec->size = 4;
-   proj_vec->count = clip_vec->count;
-   return proj_vec;
-}
-
-/* Keep these here for now, even though we don't use them...
- */
-static GLvector4f *ref_cliptest_points3( GLvector4f *clip_vec,
-					 GLvector4f *proj_vec,
-					 GLubyte clipMask[],
-					 GLubyte *orMask,
-					 GLubyte *andMask,
-                                         GLboolean viewport_z_clip )
-{
-   const GLuint stride = clip_vec->stride;
-   const GLuint count = clip_vec->count;
-   const GLfloat *from = (GLfloat *)clip_vec->start;
-
-   GLubyte tmpOrMask = *orMask;
-   GLubyte tmpAndMask = *andMask;
-   GLuint i;
-   for ( i = 0 ; i < count ; i++, STRIDE_F(from, stride) ) {
-      const GLfloat cx = from[0], cy = from[1], cz = from[2];
-      GLubyte mask = 0;
-      if ( cx >  1.0 )		mask |= CLIP_RIGHT_BIT;
-      else if ( cx < -1.0 )	mask |= CLIP_LEFT_BIT;
-      if ( cy >  1.0 )		mask |= CLIP_TOP_BIT;
-      else if ( cy < -1.0 )	mask |= CLIP_BOTTOM_BIT;
-      if (viewport_z_clip) {
-         if ( cz >  1.0 )		mask |= CLIP_FAR_BIT;
-         else if ( cz < -1.0 )	mask |= CLIP_NEAR_BIT;
-      }
-      clipMask[i] = mask;
-      tmpOrMask |= mask;
-      tmpAndMask &= mask;
-   }
-
-   *orMask = tmpOrMask;
-   *andMask = tmpAndMask;
-   return clip_vec;
-}
-
-static GLvector4f * ref_cliptest_points2( GLvector4f *clip_vec,
-					  GLvector4f *proj_vec,
-					  GLubyte clipMask[],
-					  GLubyte *orMask,
-					  GLubyte *andMask,
-                                          GLboolean viewport_z_clip )
-{
-   const GLuint stride = clip_vec->stride;
-   const GLuint count = clip_vec->count;
-   const GLfloat *from = (GLfloat *)clip_vec->start;
-
-   GLubyte tmpOrMask = *orMask;
-   GLubyte tmpAndMask = *andMask;
-   GLuint i;
-
-   (void) viewport_z_clip;
-
-   for ( i = 0 ; i < count ; i++, STRIDE_F(from, stride) ) {
-      const GLfloat cx = from[0], cy = from[1];
-      GLubyte mask = 0;
-      if ( cx >  1.0 )		mask |= CLIP_RIGHT_BIT;
-      else if ( cx < -1.0 )	mask |= CLIP_LEFT_BIT;
-      if ( cy >  1.0 )		mask |= CLIP_TOP_BIT;
-      else if ( cy < -1.0 )	mask |= CLIP_BOTTOM_BIT;
-      clipMask[i] = mask;
-      tmpOrMask |= mask;
-      tmpAndMask &= mask;
-   }
-
-   *orMask = tmpOrMask;
-   *andMask = tmpAndMask;
-   return clip_vec;
-}
-
-static clip_func ref_cliptest[5] = {
-   0,
-   0,
-   ref_cliptest_points2,
-   ref_cliptest_points3,
-   ref_cliptest_points4
-};
-
-
-/* =============================================================
- * Cliptest tests
- */
-
-ALIGN16 static GLfloat s[TEST_COUNT][4];
-ALIGN16 static GLfloat d[TEST_COUNT][4];
-ALIGN16 static GLfloat r[TEST_COUNT][4];
-
-
-/**
- * Check if X, Y or Z component of the coordinate is close to W, in terms
- * of the clip test.
- */
-static GLboolean
-xyz_close_to_w(const GLfloat c[4])
-{
-   float k = 0.0001;
-   return (fabs(c[0] - c[3]) < k ||
-           fabs(c[1] - c[3]) < k ||
-           fabs(c[2] - c[3]) < k ||
-           fabs(-c[0] - c[3]) < k ||
-           fabs(-c[1] - c[3]) < k ||
-           fabs(-c[2] - c[3]) < k);
-}
-
-
-
-static int test_cliptest_function( clip_func func, int np,
-				   int psize, long *cycles )
-{
-   GLvector4f source[1], dest[1], ref[1];
-   GLubyte dm[TEST_COUNT], dco, dca;
-   GLubyte rm[TEST_COUNT], rco, rca;
-   int i, j;
-#ifdef  RUN_DEBUG_BENCHMARK
-   int cycle_i;                /* the counter for the benchmarks we run */
-#endif
-   GLboolean viewport_z_clip = GL_TRUE;
-
-   (void) cycles;
-
-   if ( psize > 4 ) {
-      _mesa_problem( NULL, "test_cliptest_function called with psize > 4\n" );
-      return 0;
-   }
-
-   for ( i = 0 ; i < TEST_COUNT ; i++) {
-      ASSIGN_4V( d[i], 0.0, 0.0, 0.0, 1.0 );
-      ASSIGN_4V( s[i], 0.0, 0.0, 0.0, 1.0 );
-      for ( j = 0 ; j < psize ; j++ )
-         s[i][j] = rnd();
-   }
-
-   source->data = (GLfloat(*)[4])s;
-   source->start = (GLfloat *)s;
-   source->count = TEST_COUNT;
-   source->stride = sizeof(s[0]);
-   source->size = 4;
-   source->flags = 0;
-
-   dest->data = (GLfloat(*)[4])d;
-   dest->start = (GLfloat *)d;
-   dest->count = TEST_COUNT;
-   dest->stride = sizeof(float[4]);
-   dest->size = 0;
-   dest->flags = 0;
-
-   ref->data = (GLfloat(*)[4])r;
-   ref->start = (GLfloat *)r;
-   ref->count = TEST_COUNT;
-   ref->stride = sizeof(float[4]);
-   ref->size = 0;
-   ref->flags = 0;
-
-   dco = rco = 0;
-   dca = rca = CLIP_FRUSTUM_BITS;
-
-   ref_cliptest[psize]( source, ref, rm, &rco, &rca, viewport_z_clip );
-
-   if ( mesa_profile ) {
-      BEGIN_RACE( *cycles );
-      func( source, dest, dm, &dco, &dca, viewport_z_clip );
-      END_RACE( *cycles );
-   }
-   else {
-      func( source, dest, dm, &dco, &dca, viewport_z_clip );
-   }
-
-   if ( dco != rco ) {
-      printf( "\n-----------------------------\n" );
-      printf( "dco = 0x%02x   rco = 0x%02x\n", dco, rco );
-      return 0;
-   }
-   if ( dca != rca ) {
-      printf( "\n-----------------------------\n" );
-      printf( "dca = 0x%02x   rca = 0x%02x\n", dca, rca );
-      return 0;
-   }
-   for ( i = 0 ; i < TEST_COUNT ; i++ ) {
-      if ( dm[i] != rm[i] ) {
-         GLfloat *c = source->start;
-         STRIDE_F(c, source->stride * i);
-         if (psize == 4 && xyz_close_to_w(c)) {
-            /* The coordinate is very close to the clip plane.  The clipmask
-             * may vary depending on code path, but that's OK.
-             */
-            continue;
-         }
-	 printf( "\n-----------------------------\n" );
-	 printf( "mask[%d] = 0x%02x   ref mask[%d] = 0x%02x\n", i, dm[i], i,rm[i] );
-         printf(" coord = %f, %f, %f, %f\n",
-                c[0], c[1], c[2], c[3]);
-	 return 0;
-      }
-   }
-
-   /* Only verify output on projected points4 case.  FIXME: Do we need
-    * to test other cases?
-    */
-   if ( np || psize < 4 )
-      return 1;
-
-   for ( i = 0 ; i < TEST_COUNT ; i++ ) {
-      for ( j = 0 ; j < 4 ; j++ ) {
-         if ( significand_match( d[i][j], r[i][j] ) < REQUIRED_PRECISION ) {
-            printf( "\n-----------------------------\n" );
-            printf( "(i = %i, j = %i)  dm = 0x%02x   rm = 0x%02x\n",
-		    i, j, dm[i], rm[i] );
-            printf( "%f \t %f \t [diff = %e - %i bit missed]\n",
-		    d[i][0], r[i][0], r[i][0]-d[i][0],
-		    MAX_PRECISION - significand_match( d[i][0], r[i][0] ) );
-            printf( "%f \t %f \t [diff = %e - %i bit missed]\n",
-		    d[i][1], r[i][1], r[i][1]-d[i][1],
-		    MAX_PRECISION - significand_match( d[i][1], r[i][1] ) );
-            printf( "%f \t %f \t [diff = %e - %i bit missed]\n",
-		    d[i][2], r[i][2], r[i][2]-d[i][2],
-		    MAX_PRECISION - significand_match( d[i][2], r[i][2] ) );
-            printf( "%f \t %f \t [diff = %e - %i bit missed]\n",
-		    d[i][3], r[i][3], r[i][3]-d[i][3],
-		    MAX_PRECISION - significand_match( d[i][3], r[i][3] ) );
-            return 0;
-         }
-      }
-   }
-
-   return 1;
-}
-
-void _math_test_all_cliptest_functions( char *description )
-{
-   int np, psize;
-   long benchmark_tab[2][4];
-   static int first_time = 1;
-
-   if ( first_time ) {
-      first_time = 0;
-      mesa_profile = getenv( "MESA_PROFILE" );
-   }
-
-#ifdef RUN_DEBUG_BENCHMARK
-   if ( mesa_profile ) {
-      if ( !counter_overhead ) {
-	 INIT_COUNTER();
-	 printf( "counter overhead: %ld cycles\n\n", counter_overhead );
-      }
-      printf( "cliptest results after hooking in %s functions:\n", description );
-   }
-#endif
-
-#ifdef RUN_DEBUG_BENCHMARK
-   if ( mesa_profile ) {
-      printf( "\n\t" );
-      for ( psize = 2 ; psize <= 4 ; psize++ ) {
-	 printf( " p%d\t", psize );
-      }
-      printf( "\n--------------------------------------------------------\n\t" );
-   }
-#endif
-
-   for ( np = 0 ; np < 2 ; np++ ) {
-      for ( psize = 2 ; psize <= 4 ; psize++ ) {
-	 clip_func func = clip_tab[np][psize];
-	 long *cycles = &(benchmark_tab[np][psize-1]);
-
-	 if ( test_cliptest_function( func, np, psize, cycles ) == 0 ) {
-	    char buf[100];
-	    sprintf( buf, "%s[%d] failed test (%s)",
-		     cnames[np], psize, description );
-	    _mesa_problem( NULL, "%s", buf );
-	 }
-#ifdef RUN_DEBUG_BENCHMARK
-	 if ( mesa_profile )
-	    printf( " %li\t", benchmark_tab[np][psize-1] );
-#endif
-      }
-#ifdef RUN_DEBUG_BENCHMARK
-      if ( mesa_profile )
-	 printf( " | [%s]\n\t", cstrings[np] );
-#endif
-   }
-#ifdef RUN_DEBUG_BENCHMARK
-   if ( mesa_profile )
-      printf( "\n" );
-#endif
-}
-
-
-#endif /* DEBUG_MATH */
diff --git a/src/mesa/math/m_debug_norm.c b/src/mesa/math/m_debug_norm.c
deleted file mode 100644
index 01eac87e7844..000000000000
--- a/src/mesa/math/m_debug_norm.c
+++ /dev/null
@@ -1,383 +0,0 @@
-
-/*
- * Mesa 3-D graphics library
- *
- * Copyright (C) 1999-2003  Brian Paul   All Rights Reserved.
- *
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the "Software"),
- * to deal in the Software without restriction, including without limitation
- * the rights to use, copy, modify, merge, publish, distribute, sublicense,
- * and/or sell copies of the Software, and to permit persons to whom the
- * Software is furnished to do so, subject to the following conditions:
- *
- * The above copyright notice and this permission notice shall be included
- * in all copies or substantial portions of the Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
- * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
- * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
- * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
- * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
- * OTHER DEALINGS IN THE SOFTWARE.
- *
- * Authors:
- *    Gareth Hughes
- */
-
-#include "main/glheader.h"
-#include "main/context.h"
-#include "main/macros.h"
-
-#include "m_matrix.h"
-#include "m_xform.h"
-
-#include "m_debug.h"
-#include "m_debug_util.h"
-
-#include <math.h>
-
-#ifdef __UNIXOS2__
-/* The linker doesn't like empty files */
-static char dummy;
-#endif
-
-#ifdef DEBUG_MATH  /* This code only used for debugging */
-
-
-static int m_norm_identity[16] = {
-   ONE, NIL, NIL, NIL,
-   NIL, ONE, NIL, NIL,
-   NIL, NIL, ONE, NIL,
-   NIL, NIL, NIL, NIL
-};
-static int m_norm_general[16] = {
-   VAR, VAR, VAR, NIL,
-   VAR, VAR, VAR, NIL,
-   VAR, VAR, VAR, NIL,
-   NIL, NIL, NIL, NIL
-};
-static int m_norm_no_rot[16] = {
-   VAR, NIL, NIL, NIL,
-   NIL, VAR, NIL, NIL,
-   NIL, NIL, VAR, NIL,
-   NIL, NIL, NIL, NIL
-};
-static int *norm_templates[8] = {
-   m_norm_no_rot,
-   m_norm_no_rot,
-   m_norm_no_rot,
-   m_norm_general,
-   m_norm_general,
-   m_norm_general,
-   m_norm_identity,
-   m_norm_identity
-};
-static int norm_types[8] = {
-   NORM_TRANSFORM_NO_ROT,
-   NORM_TRANSFORM_NO_ROT | NORM_RESCALE,
-   NORM_TRANSFORM_NO_ROT | NORM_NORMALIZE,
-   NORM_TRANSFORM,
-   NORM_TRANSFORM | NORM_RESCALE,
-   NORM_TRANSFORM | NORM_NORMALIZE,
-   NORM_RESCALE,
-   NORM_NORMALIZE
-};
-static int norm_scale_types[8] = {               /*  rescale factor          */
-   NIL,                                          /*  NIL disables rescaling  */
-   VAR,
-   NIL,
-   NIL,
-   VAR,
-   NIL,
-   VAR,
-   NIL
-};
-static int norm_normalize_types[8] = {           /*  normalizing ?? (no = 0) */
-   0,
-   0,
-   1,
-   0,
-   0,
-   1,
-   0,
-   1
-};
-static char *norm_strings[8] = {
-   "NORM_TRANSFORM_NO_ROT",
-   "NORM_TRANSFORM_NO_ROT | NORM_RESCALE",
-   "NORM_TRANSFORM_NO_ROT | NORM_NORMALIZE",
-   "NORM_TRANSFORM",
-   "NORM_TRANSFORM | NORM_RESCALE",
-   "NORM_TRANSFORM | NORM_NORMALIZE",
-   "NORM_RESCALE",
-   "NORM_NORMALIZE"
-};
-
-
-/* =============================================================
- * Reference transformations
- */
-
-static void ref_norm_transform_rescale( const GLmatrix *mat,
-					GLfloat scale,
-					const GLvector4f *in,
-					const GLfloat *lengths,
-					GLvector4f *dest )
-{
-   GLuint i;
-   const GLfloat *s = in->start;
-   const GLfloat *m = mat->inv;
-   GLfloat (*out)[4] = (GLfloat (*)[4]) dest->start;
-
-   (void) lengths;
-
-   for ( i = 0 ; i < in->count ; i++ ) {
-      GLfloat t[3];
-
-      TRANSFORM_NORMAL( t, s, m );
-      SCALE_SCALAR_3V( out[i], scale, t );
-
-      s = (GLfloat *)((char *)s + in->stride);
-   }
-}
-
-static void ref_norm_transform_normalize( const GLmatrix *mat,
-					  GLfloat scale,
-					  const GLvector4f *in,
-					  const GLfloat *lengths,
-					  GLvector4f *dest )
-{
-   GLuint i;
-   const GLfloat *s = in->start;
-   const GLfloat *m = mat->inv;
-   GLfloat (*out)[4] = (GLfloat (*)[4]) dest->start;
-
-   for ( i = 0 ; i < in->count ; i++ ) {
-      GLfloat t[3];
-
-      TRANSFORM_NORMAL( t, s, m );
-
-      if ( !lengths ) {
-         GLfloat len = LEN_SQUARED_3FV( t );
-         if ( len > 1e-20 ) {
-	    /* Hmmm, don't know how we could test the precalculated
-	     * length case...
-	     */
-            scale = 1.0f / sqrtf(len);
-	    SCALE_SCALAR_3V( out[i], scale, t );
-         } else {
-            out[i][0] = out[i][1] = out[i][2] = 0;
-         }
-      } else {
-         scale = lengths[i];
-	 SCALE_SCALAR_3V( out[i], scale, t );
-      }
-
-      s = (GLfloat *)((char *)s + in->stride);
-   }
-}
-
-
-/* =============================================================
- * Normal transformation tests
- */
-
-static void init_matrix( GLfloat *m )
-{
-   m[0] = 63.0; m[4] = 43.0; m[ 8] = 29.0; m[12] = 43.0;
-   m[1] = 55.0; m[5] = 17.0; m[ 9] = 31.0; m[13] =  7.0;
-   m[2] = 44.0; m[6] =  9.0; m[10] =  7.0; m[14] =  3.0;
-   m[3] = 11.0; m[7] = 23.0; m[11] = 91.0; m[15] =  9.0;
-}
-
-
-static int test_norm_function( normal_func func, int mtype, long *cycles )
-{
-   GLvector4f source[1], dest[1], dest2[1], ref[1], ref2[1];
-   GLmatrix mat[1];
-   GLfloat s[TEST_COUNT][5], d[TEST_COUNT][4], r[TEST_COUNT][4];
-   GLfloat d2[TEST_COUNT][4], r2[TEST_COUNT][4], length[TEST_COUNT];
-   GLfloat scale;
-   GLfloat *m;
-   int i, j;
-#ifdef  RUN_DEBUG_BENCHMARK
-   int cycle_i;		/* the counter for the benchmarks we run */
-#endif
-
-   (void) cycles;
-
-   mat->m = align_malloc( 16 * sizeof(GLfloat), 16 );
-   mat->inv = m = mat->m;
-
-   init_matrix( m );
-
-   scale = 1.0F + rnd () * norm_scale_types[mtype];
-
-   for ( i = 0 ; i < 4 ; i++ ) {
-      for ( j = 0 ; j < 4 ; j++ ) {
-         switch ( norm_templates[mtype][i * 4 + j] ) {
-         case NIL:
-            m[j * 4 + i] = 0.0;
-            break;
-         case ONE:
-            m[j * 4 + i] = 1.0;
-            break;
-         case NEG:
-            m[j * 4 + i] = -1.0;
-            break;
-         case VAR:
-            break;
-         default:
-            exit(1);
-         }
-      }
-   }
-
-   for ( i = 0 ; i < TEST_COUNT ; i++ ) {
-      ASSIGN_3V( d[i],  0.0, 0.0, 0.0 );
-      ASSIGN_3V( s[i],  0.0, 0.0, 0.0 );
-      ASSIGN_3V( d2[i], 0.0, 0.0, 0.0 );
-      for ( j = 0 ; j < 3 ; j++ )
-         s[i][j] = rnd();
-      length[i] = 1.0f / sqrtf( LEN_SQUARED_3FV( s[i] ) );
-   }
-
-   source->data = (GLfloat(*)[4]) s;
-   source->start = (GLfloat *) s;
-   source->count = TEST_COUNT;
-   source->stride = sizeof(s[0]);
-   source->flags = 0;
-
-   dest->data = d;
-   dest->start = (GLfloat *) d;
-   dest->count = TEST_COUNT;
-   dest->stride = sizeof(float[4]);
-   dest->flags = 0;
-
-   dest2->data = d2;
-   dest2->start = (GLfloat *) d2;
-   dest2->count = TEST_COUNT;
-   dest2->stride = sizeof(float[4]);
-   dest2->flags = 0;
-
-   ref->data = r;
-   ref->start = (GLfloat *) r;
-   ref->count = TEST_COUNT;
-   ref->stride = sizeof(float[4]);
-   ref->flags = 0;
-
-   ref2->data = r2;
-   ref2->start = (GLfloat *) r2;
-   ref2->count = TEST_COUNT;
-   ref2->stride = sizeof(float[4]);
-   ref2->flags = 0;
-
-   if ( norm_normalize_types[mtype] == 0 ) {
-      ref_norm_transform_rescale( mat, scale, source, NULL, ref );
-   } else {
-      ref_norm_transform_normalize( mat, scale, source, NULL, ref );
-      ref_norm_transform_normalize( mat, scale, source, length, ref2 );
-   }
-
-   if ( mesa_profile ) {
-      BEGIN_RACE( *cycles );
-      func( mat, scale, source, NULL, dest );
-      END_RACE( *cycles );
-      func( mat, scale, source, length, dest2 );
-   } else {
-      func( mat, scale, source, NULL, dest );
-      func( mat, scale, source, length, dest2 );
-   }
-
-   for ( i = 0 ; i < TEST_COUNT ; i++ ) {
-      for ( j = 0 ; j < 3 ; j++ ) {
-         if ( significand_match( d[i][j], r[i][j] ) < REQUIRED_PRECISION ) {
-            printf( "-----------------------------\n" );
-            printf( "(i = %i, j = %i)\n", i, j );
-            printf( "%f \t %f \t [ratio = %e - %i bit missed]\n",
-		    d[i][0], r[i][0], r[i][0]/d[i][0],
-		    MAX_PRECISION - significand_match( d[i][0], r[i][0] ) );
-            printf( "%f \t %f \t [ratio = %e - %i bit missed]\n",
-		    d[i][1], r[i][1], r[i][1]/d[i][1],
-		    MAX_PRECISION - significand_match( d[i][1], r[i][1] ) );
-            printf( "%f \t %f \t [ratio = %e - %i bit missed]\n",
-		    d[i][2], r[i][2], r[i][2]/d[i][2],
-		    MAX_PRECISION - significand_match( d[i][2], r[i][2] ) );
-            return 0;
-         }
-
-         if ( norm_normalize_types[mtype] != 0 ) {
-            if ( significand_match( d2[i][j], r2[i][j] ) < REQUIRED_PRECISION ) {
-               printf( "------------------- precalculated length case ------\n" );
-               printf( "(i = %i, j = %i)\n", i, j );
-               printf( "%f \t %f \t [ratio = %e - %i bit missed]\n",
-		       d2[i][0], r2[i][0], r2[i][0]/d2[i][0],
-		       MAX_PRECISION - significand_match( d2[i][0], r2[i][0] ) );
-               printf( "%f \t %f \t [ratio = %e - %i bit missed]\n",
-		       d2[i][1], r2[i][1], r2[i][1]/d2[i][1],
-		       MAX_PRECISION - significand_match( d2[i][1], r2[i][1] ) );
-               printf( "%f \t %f \t [ratio = %e - %i bit missed]\n",
-		       d2[i][2], r2[i][2], r2[i][2]/d2[i][2],
-		       MAX_PRECISION - significand_match( d2[i][2], r2[i][2] ) );
-               return 0;
-            }
-         }
-      }
-   }
-
-   align_free( mat->m );
-   return 1;
-}
-
-void _math_test_all_normal_transform_functions( char *description )
-{
-   int mtype;
-   long benchmark_tab[0xf];
-   static int first_time = 1;
-
-   if ( first_time ) {
-      first_time = 0;
-      mesa_profile = getenv( "MESA_PROFILE" );
-   }
-
-#ifdef RUN_DEBUG_BENCHMARK
-   if ( mesa_profile ) {
-      if ( !counter_overhead ) {
-	 INIT_COUNTER();
-	 printf( "counter overhead: %ld cycles\n\n", counter_overhead );
-      }
-      printf( "normal transform results after hooking in %s functions:\n",
-	      description );
-      printf( "\n-------------------------------------------------------\n" );
-   }
-#endif
-
-   for ( mtype = 0 ; mtype < 8 ; mtype++ ) {
-      normal_func func = _mesa_normal_tab[norm_types[mtype]];
-      long *cycles = &benchmark_tab[mtype];
-
-      if ( test_norm_function( func, mtype, cycles ) == 0 ) {
-	 char buf[100];
-	 sprintf( buf, "_mesa_normal_tab[0][%s] failed test (%s)",
-		  norm_strings[mtype], description );
-	 _mesa_problem( NULL, "%s", buf );
-      }
-
-#ifdef RUN_DEBUG_BENCHMARK
-      if ( mesa_profile ) {
-	 printf( " %li\t", benchmark_tab[mtype] );
-	 printf( " | [%s]\n", norm_strings[mtype] );
-      }
-#endif
-   }
-#ifdef RUN_DEBUG_BENCHMARK
-   if ( mesa_profile ) {
-      printf( "\n" );
-   }
-#endif
-}
-
-
-#endif /* DEBUG_MATH */
diff --git a/src/mesa/math/m_debug_util.h b/src/mesa/math/m_debug_util.h
deleted file mode 100644
index 47fe82903068..000000000000
--- a/src/mesa/math/m_debug_util.h
+++ /dev/null
@@ -1,307 +0,0 @@
-/*
- * Mesa 3-D graphics library
- *
- * Copyright (C) 1999-2004  Brian Paul   All Rights Reserved.
- *
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the "Software"),
- * to deal in the Software without restriction, including without limitation
- * the rights to use, copy, modify, merge, publish, distribute, sublicense,
- * and/or sell copies of the Software, and to permit persons to whom the
- * Software is furnished to do so, subject to the following conditions:
- *
- * The above copyright notice and this permission notice shall be included
- * in all copies or substantial portions of the Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
- * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
- * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
- * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
- * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
- * OTHER DEALINGS IN THE SOFTWARE.
- *
- * Authors:
- *    Gareth Hughes
- */
-
-#ifndef __M_DEBUG_UTIL_H__
-#define __M_DEBUG_UTIL_H__
-
-
-#ifdef DEBUG_MATH  /* This code only used for debugging */
-
-
-#include <math.h>
-
-
-/* Comment this out to deactivate the cycle counter.
- * NOTE: it works only on CPUs which know the 'rdtsc' command (586 or higher)
- * (hope, you don't try to debug Mesa on a 386 ;)
- */
-#if defined(__GNUC__) && \
-    ((defined(__i386__) && defined(USE_X86_ASM)) || \
-     (defined(__sparc__) && defined(USE_SPARC_ASM)))
-#define  RUN_DEBUG_BENCHMARK
-#endif
-
-#define TEST_COUNT		128	/* size of the tested vector array   */
-
-#define REQUIRED_PRECISION	10	/* allow 4 bits to miss              */
-#define MAX_PRECISION		24	/* max. precision possible           */
-
-
-#ifdef  RUN_DEBUG_BENCHMARK
-/* Overhead of profiling counter in cycles.  Automatically adjusted to
- * your machine at run time - counter initialization should give very
- * consistent results.
- */
-extern long counter_overhead;
-
-/* This is the value of the environment variable MESA_PROFILE, and is
- * used to determine if we should benchmark the functions as well as
- * verify their correctness.
- */
-extern char *mesa_profile;
-
-/* Modify the number of tests if you like.
- * We take the minimum of all results, because every error should be
- * positive (time used by other processes, task switches etc).
- * It is assumed that all calculations are done in the cache.
- */
-
-#if defined(__i386__)
-
-#if 1 /* PPro, PII, PIII version */
-
-/* Profiling on the P6 architecture requires a little more work, due to
- * the internal out-of-order execution.  We must perform a serializing
- * 'cpuid' instruction before and after the 'rdtsc' instructions to make
- * sure no other uops are executed when we sample the timestamp counter.
- */
-#define  INIT_COUNTER()							\
-   do {									\
-      int cycle_i;							\
-      counter_overhead = LONG_MAX;					\
-      for ( cycle_i = 0 ; cycle_i < 8 ; cycle_i++ ) {			\
-	 long cycle_tmp1 = 0, cycle_tmp2 = 0;				\
-	 __asm__ __volatile__ ( "push %%ebx       \n"			\
-				"xor %%eax, %%eax \n"			\
-				"cpuid            \n"			\
-				"rdtsc            \n"			\
-				"mov %%eax, %0    \n"			\
-				"xor %%eax, %%eax \n"			\
-				"cpuid            \n"			\
-				"pop %%ebx        \n"			\
-				"push %%ebx       \n"			\
-				"xor %%eax, %%eax \n"			\
-				"cpuid            \n"			\
-				"rdtsc            \n"			\
-				"mov %%eax, %1    \n"			\
-				"xor %%eax, %%eax \n"			\
-				"cpuid            \n"			\
-				"pop %%ebx        \n"			\
-				: "=m" (cycle_tmp1), "=m" (cycle_tmp2)	\
-				: : "eax", "ecx", "edx" );		\
-	 if ( counter_overhead > (cycle_tmp2 - cycle_tmp1) ) {		\
-	    counter_overhead = cycle_tmp2 - cycle_tmp1;			\
-	 }								\
-      }									\
-   } while (0)
-
-#define  BEGIN_RACE(x)							\
-   x = LONG_MAX;							\
-   for ( cycle_i = 0 ; cycle_i < 10 ; cycle_i++ ) {			\
-      long cycle_tmp1 = 0, cycle_tmp2 = 0;				\
-      __asm__ __volatile__ ( "push %%ebx       \n"			\
-			     "xor %%eax, %%eax \n"			\
-			     "cpuid            \n"			\
-			     "rdtsc            \n"			\
-			     "mov %%eax, %0    \n"			\
-			     "xor %%eax, %%eax \n"			\
-			     "cpuid            \n"			\
-			     "pop %%ebx        \n"			\
-			     : "=m" (cycle_tmp1)			\
-			     : : "eax", "ecx", "edx" );
-
-#define END_RACE(x)							\
-      __asm__ __volatile__ ( "push %%ebx       \n"			\
-			     "xor %%eax, %%eax \n"			\
-			     "cpuid            \n"			\
-			     "rdtsc            \n"			\
-			     "mov %%eax, %0    \n"			\
-			     "xor %%eax, %%eax \n"			\
-			     "cpuid            \n"			\
-			     "pop %%ebx        \n"			\
-			     : "=m" (cycle_tmp2)			\
-			     : : "eax", "ecx", "edx" );			\
-      if ( x > (cycle_tmp2 - cycle_tmp1) ) {				\
-	 x = cycle_tmp2 - cycle_tmp1;					\
-      }									\
-   }									\
-   x -= counter_overhead;
-
-#else /* PPlain, PMMX version */
-
-/* To ensure accurate results, we stall the pipelines with the
- * non-pairable 'cdq' instruction.  This ensures all the code being
- * profiled is complete when the 'rdtsc' instruction executes.
- */
-#define  INIT_COUNTER(x)						\
-   do {									\
-      int cycle_i;							\
-      x = LONG_MAX;							\
-      for ( cycle_i = 0 ; cycle_i < 32 ; cycle_i++ ) {			\
-	 long cycle_tmp1, cycle_tmp2, dummy;				\
-	 __asm__ ( "mov %%eax, %0" : "=a" (cycle_tmp1) );		\
-	 __asm__ ( "mov %%eax, %0" : "=a" (cycle_tmp2) );		\
-	 __asm__ ( "cdq" );						\
-	 __asm__ ( "cdq" );						\
-	 __asm__ ( "rdtsc" : "=a" (cycle_tmp1), "=d" (dummy) );		\
-	 __asm__ ( "cdq" );						\
-	 __asm__ ( "cdq" );						\
-	 __asm__ ( "rdtsc" : "=a" (cycle_tmp2), "=d" (dummy) );		\
-	 if ( x > (cycle_tmp2 - cycle_tmp1) )				\
-	    x = cycle_tmp2 - cycle_tmp1;				\
-      }									\
-   } while (0)
-
-#define  BEGIN_RACE(x)							\
-   x = LONG_MAX;							\
-   for ( cycle_i = 0 ; cycle_i < 16 ; cycle_i++ ) {			\
-      long cycle_tmp1, cycle_tmp2, dummy;				\
-      __asm__ ( "mov %%eax, %0" : "=a" (cycle_tmp1) );			\
-      __asm__ ( "mov %%eax, %0" : "=a" (cycle_tmp2) );			\
-      __asm__ ( "cdq" );						\
-      __asm__ ( "cdq" );						\
-      __asm__ ( "rdtsc" : "=a" (cycle_tmp1), "=d" (dummy) );
-
-
-#define END_RACE(x)							\
-      __asm__ ( "cdq" );						\
-      __asm__ ( "cdq" );						\
-      __asm__ ( "rdtsc" : "=a" (cycle_tmp2), "=d" (dummy) );		\
-      if ( x > (cycle_tmp2 - cycle_tmp1) )				\
-	 x = cycle_tmp2 - cycle_tmp1;					\
-   }									\
-   x -= counter_overhead;
-
-#endif
-
-#elif defined(__x86_64__)
-
-#define rdtscll(val) do { \
-     unsigned int a,d; \
-     __asm__ volatile("rdtsc" : "=a" (a), "=d" (d)); \
-     (val) = ((unsigned long)a) | (((unsigned long)d)<<32); \
-} while(0) 
-
-/* Copied from i386 PIII version */
-#define  INIT_COUNTER()							\
-   do {									\
-      int cycle_i;							\
-      counter_overhead = LONG_MAX;					\
-      for ( cycle_i = 0 ; cycle_i < 16 ; cycle_i++ ) {			\
-	 unsigned long cycle_tmp1, cycle_tmp2;        			\
-	 rdtscll(cycle_tmp1);						\
-	 rdtscll(cycle_tmp2);						\
-	 if ( counter_overhead > (cycle_tmp2 - cycle_tmp1) ) {		\
-	    counter_overhead = cycle_tmp2 - cycle_tmp1;			\
-	 }								\
-      }									\
-   } while (0)
-
-
-#define  BEGIN_RACE(x)							\
-   x = LONG_MAX;							\
-   for ( cycle_i = 0 ; cycle_i < 10 ; cycle_i++ ) {			\
-      unsigned long cycle_tmp1, cycle_tmp2;				\
-      rdtscll(cycle_tmp1);
-
-#define END_RACE(x)							\
-      rdtscll(cycle_tmp2);						\
-      if ( x > (cycle_tmp2 - cycle_tmp1) ) {				\
-	 x = cycle_tmp2 - cycle_tmp1;					\
-      }									\
-   }									\
-   x -= counter_overhead;
-
-#elif defined(__sparc__)
-
-#define  INIT_COUNTER()	\
-	 do { counter_overhead = 5; } while(0)
-
-#define  BEGIN_RACE(x)                                                        \
-x = LONG_MAX;                                                                 \
-for (cycle_i = 0; cycle_i <10; cycle_i++) {                                   \
-   register long cycle_tmp1 __asm__("l0");				      \
-   register long cycle_tmp2 __asm__("l1");				      \
-   /* rd %tick, %l0 */							      \
-   __asm__ __volatile__ (".word 0xa1410000" : "=r" (cycle_tmp1));  /*  save timestamp   */
-
-#define END_RACE(x)                                                           \
-   /* rd %tick, %l1 */							      \
-   __asm__ __volatile__ (".word 0xa3410000" : "=r" (cycle_tmp2));	      \
-   if (x > (cycle_tmp2-cycle_tmp1)) x = cycle_tmp2 - cycle_tmp1;              \
-}                                                                             \
-x -= counter_overhead;
-
-#else
-#error Your processor is not supported for RUN_XFORM_BENCHMARK
-#endif
-
-#else
-
-#define BEGIN_RACE(x)
-#define END_RACE(x)
-
-#endif
-
-
-/* =============================================================
- * Helper functions
- */
-
-static GLfloat rnd( void )
-{
-   GLfloat f = (GLfloat)rand() / (GLfloat)RAND_MAX;
-   GLfloat gran = (GLfloat)(1 << 13);
-
-   f = (GLfloat)(GLint)(f * gran) / gran;
-
-   return f * 2.0 - 1.0;
-}
-
-static int significand_match( GLfloat a, GLfloat b )
-{
-   GLfloat d = a - b;
-   int a_ex, b_ex, d_ex;
-
-   if ( d == 0.0F ) {
-      return MAX_PRECISION;   /* Exact match */
-   }
-
-   if ( a == 0.0F || b == 0.0F ) {
-      /* It would probably be better to check if the
-       * non-zero number is denormalized and return
-       * the index of the highest set bit here.
-       */
-      return 0;
-   }
-
-   frexpf( a, &a_ex );
-   frexpf( b, &b_ex );
-   frexpf( d, &d_ex );
-
-   if ( a_ex < b_ex ) {
-      return a_ex - d_ex;
-   } else {
-      return b_ex - d_ex;
-   }
-}
-
-enum { NIL = 0, ONE = 1, NEG = -1, VAR = 2 };
-
-#endif /* DEBUG_MATH */
-
-#endif /* __M_DEBUG_UTIL_H__ */
diff --git a/src/mesa/math/m_debug_xform.c b/src/mesa/math/m_debug_xform.c
deleted file mode 100644
index fe3db9e38c1a..000000000000
--- a/src/mesa/math/m_debug_xform.c
+++ /dev/null
@@ -1,338 +0,0 @@
-/*
- * Mesa 3-D graphics library
- *
- * Copyright (C) 1999-2004  Brian Paul   All Rights Reserved.
- *
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the "Software"),
- * to deal in the Software without restriction, including without limitation
- * the rights to use, copy, modify, merge, publish, distribute, sublicense,
- * and/or sell copies of the Software, and to permit persons to whom the
- * Software is furnished to do so, subject to the following conditions:
- *
- * The above copyright notice and this permission notice shall be included
- * in all copies or substantial portions of the Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
- * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
- * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
- * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
- * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
- * OTHER DEALINGS IN THE SOFTWARE.
- */
-
-/*
- * Updated for P6 architecture by Gareth Hughes.
- */
-
-#include "main/glheader.h"
-#include "main/context.h"
-#include "main/macros.h"
-
-#include "m_matrix.h"
-#include "m_xform.h"
-
-#include "m_debug.h"
-#include "m_debug_util.h"
-
-#ifdef __UNIXOS2__
-/* The linker doesn't like empty files */
-static char dummy;
-#endif
-
-#ifdef DEBUG_MATH  /* This code only used for debugging */
-
-
-/* Overhead of profiling counter in cycles.  Automatically adjusted to
- * your machine at run time - counter initialization should give very
- * consistent results.
- */
-long counter_overhead = 0;
-
-/* This is the value of the environment variable MESA_PROFILE, and is
- * used to determine if we should benchmark the functions as well as
- * verify their correctness.
- */
-char *mesa_profile = NULL;
-
-
-static int m_general[16] = {
-   VAR, VAR, VAR, VAR,
-   VAR, VAR, VAR, VAR,
-   VAR, VAR, VAR, VAR,
-   VAR, VAR, VAR, VAR
-};
-static int m_identity[16] = {
-   ONE, NIL, NIL, NIL,
-   NIL, ONE, NIL, NIL,
-   NIL, NIL, ONE, NIL,
-   NIL, NIL, NIL, ONE
-};
-static int  m_2d[16]  = {
-   VAR, VAR, NIL, VAR,
-   VAR, VAR, NIL, VAR,
-   NIL, NIL, ONE, NIL,
-   NIL, NIL, NIL, ONE
-};
-static int m_2d_no_rot[16] = {
-   VAR, NIL, NIL, VAR,
-   NIL, VAR, NIL, VAR,
-   NIL, NIL, ONE, NIL,
-   NIL, NIL, NIL, ONE
-};
-static int m_3d[16] = {
-   VAR, VAR, VAR, VAR,
-   VAR, VAR, VAR, VAR,
-   VAR, VAR, VAR, VAR,
-   NIL, NIL, NIL, ONE
-};
-static int m_3d_no_rot[16] = {
-   VAR, NIL, NIL, VAR,
-   NIL, VAR, NIL, VAR,
-   NIL, NIL, VAR, VAR,
-   NIL, NIL, NIL, ONE
-};
-static int m_perspective[16] = {
-   VAR, NIL, VAR, NIL,
-   NIL, VAR, VAR, NIL,
-   NIL, NIL, VAR, VAR,
-   NIL, NIL, NEG, NIL
-};
-static int *templates[7] = {
-   m_general,
-   m_identity,
-   m_3d_no_rot,
-   m_perspective,
-   m_2d,
-   m_2d_no_rot,
-   m_3d
-};
-static enum GLmatrixtype mtypes[7] = {
-   MATRIX_GENERAL,
-   MATRIX_IDENTITY,
-   MATRIX_3D_NO_ROT,
-   MATRIX_PERSPECTIVE,
-   MATRIX_2D,
-   MATRIX_2D_NO_ROT,
-   MATRIX_3D
-};
-static char *mstrings[7] = {
-   "MATRIX_GENERAL",
-   "MATRIX_IDENTITY",
-   "MATRIX_3D_NO_ROT",
-   "MATRIX_PERSPECTIVE",
-   "MATRIX_2D",
-   "MATRIX_2D_NO_ROT",
-   "MATRIX_3D"
-};
-
-
-/* =============================================================
- * Reference transformations
- */
-
-static void ref_transform( GLvector4f *dst,
-                           const GLmatrix *mat,
-                           const GLvector4f *src )
-{
-   GLuint i;
-   GLfloat *s = (GLfloat *)src->start;
-   GLfloat (*d)[4] = (GLfloat (*)[4])dst->start;
-   const GLfloat *m = mat->m;
-
-   for ( i = 0 ; i < src->count ; i++ ) {
-      TRANSFORM_POINT( d[i], m, s );
-      s = (GLfloat *)((char *)s + src->stride);
-   }
-}
-
-
-/* =============================================================
- * Vertex transformation tests
- */
-
-static void init_matrix( GLfloat *m )
-{
-   m[0] = 63.0; m[4] = 43.0; m[ 8] = 29.0; m[12] = 43.0;
-   m[1] = 55.0; m[5] = 17.0; m[ 9] = 31.0; m[13] =  7.0;
-   m[2] = 44.0; m[6] =  9.0; m[10] =  7.0; m[14] =  3.0;
-   m[3] = 11.0; m[7] = 23.0; m[11] = 91.0; m[15] =  9.0;
-}
-
-ALIGN16 static GLfloat s[TEST_COUNT][4];
-ALIGN16 static GLfloat d[TEST_COUNT][4];
-ALIGN16 static GLfloat r[TEST_COUNT][4];
-
-static int test_transform_function( transform_func func, int psize,
-				    int mtype, unsigned long *cycles )
-{
-   GLvector4f source[1], dest[1], ref[1];
-   GLmatrix mat[1];
-   GLfloat *m;
-   int i, j;
-#ifdef  RUN_DEBUG_BENCHMARK
-   int cycle_i;                /* the counter for the benchmarks we run */
-#endif
-
-   (void) cycles;
-
-   if ( psize > 4 ) {
-      _mesa_problem( NULL, "test_transform_function called with psize > 4\n" );
-      return 0;
-   }
-
-   mat->m = align_malloc( 16 * sizeof(GLfloat), 16 );
-   mat->type = mtypes[mtype];
-
-   m = mat->m;
-   assert( ((long)m & 15) == 0 );
-
-   init_matrix( m );
-
-   for ( i = 0 ; i < 4 ; i++ ) {
-      for ( j = 0 ; j < 4 ; j++ ) {
-         switch ( templates[mtype][i * 4 + j] ) {
-         case NIL:
-            m[j * 4 + i] = 0.0;
-            break;
-         case ONE:
-            m[j * 4 + i] = 1.0;
-            break;
-         case NEG:
-            m[j * 4 + i] = -1.0;
-            break;
-         case VAR:
-            break;
-         default:
-            assert(0);
-            return 0;
-         }
-      }
-   }
-
-   for ( i = 0 ; i < TEST_COUNT ; i++) {
-      ASSIGN_4V( d[i], 0.0, 0.0, 0.0, 1.0 );
-      ASSIGN_4V( s[i], 0.0, 0.0, 0.0, 1.0 );
-      for ( j = 0 ; j < psize ; j++ )
-         s[i][j] = rnd();
-   }
-
-   source->data = (GLfloat(*)[4])s;
-   source->start = (GLfloat *)s;
-   source->count = TEST_COUNT;
-   source->stride = sizeof(s[0]);
-   source->size = 4;
-   source->flags = 0;
-
-   dest->data = (GLfloat(*)[4])d;
-   dest->start = (GLfloat *)d;
-   dest->count = TEST_COUNT;
-   dest->stride = sizeof(float[4]);
-   dest->size = 0;
-   dest->flags = 0;
-
-   ref->data = (GLfloat(*)[4])r;
-   ref->start = (GLfloat *)r;
-   ref->count = TEST_COUNT;
-   ref->stride = sizeof(float[4]);
-   ref->size = 0;
-   ref->flags = 0;
-
-   ref_transform( ref, mat, source );
-
-   if ( mesa_profile ) {
-      BEGIN_RACE( *cycles );
-      func( dest, mat->m, source );
-      END_RACE( *cycles );
-   }
-   else {
-      func( dest, mat->m, source );
-   }
-
-   for ( i = 0 ; i < TEST_COUNT ; i++ ) {
-      for ( j = 0 ; j < 4 ; j++ ) {
-         if ( significand_match( d[i][j], r[i][j] ) < REQUIRED_PRECISION ) {
-            printf("-----------------------------\n" );
-            printf("(i = %i, j = %i)\n", i, j );
-            printf("%f \t %f \t [diff = %e - %i bit missed]\n",
-		    d[i][0], r[i][0], r[i][0]-d[i][0],
-		    MAX_PRECISION - significand_match( d[i][0], r[i][0] ) );
-            printf("%f \t %f \t [diff = %e - %i bit missed]\n",
-		    d[i][1], r[i][1], r[i][1]-d[i][1],
-		    MAX_PRECISION - significand_match( d[i][1], r[i][1] ) );
-            printf("%f \t %f \t [diff = %e - %i bit missed]\n",
-		    d[i][2], r[i][2], r[i][2]-d[i][2],
-		    MAX_PRECISION - significand_match( d[i][2], r[i][2] ) );
-            printf("%f \t %f \t [diff = %e - %i bit missed]\n",
-		    d[i][3], r[i][3], r[i][3]-d[i][3],
-		    MAX_PRECISION - significand_match( d[i][3], r[i][3] ) );
-            return 0;
-         }
-      }
-   }
-
-   align_free( mat->m );
-   return 1;
-}
-
-void _math_test_all_transform_functions( char *description )
-{
-   int psize, mtype;
-   unsigned long benchmark_tab[4][7];
-   static int first_time = 1;
-
-   if ( first_time ) {
-      first_time = 0;
-      mesa_profile = getenv( "MESA_PROFILE" );
-   }
-
-#ifdef RUN_DEBUG_BENCHMARK
-   if ( mesa_profile ) {
-      if ( !counter_overhead ) {
-	 INIT_COUNTER();
-	 printf("counter overhead: %lu cycles\n\n", counter_overhead );
-      }
-      printf("transform results after hooking in %s functions:\n", description );
-   }
-#endif
-
-#ifdef RUN_DEBUG_BENCHMARK
-   if ( mesa_profile ) {
-      printf("\n" );
-      for ( psize = 1 ; psize <= 4 ; psize++ ) {
-	 printf(" p%d\t", psize );
-      }
-      printf("\n--------------------------------------------------------\n" );
-   }
-#endif
-
-   for ( mtype = 0 ; mtype < 7 ; mtype++ ) {
-      for ( psize = 1 ; psize <= 4 ; psize++ ) {
-	 transform_func func = _mesa_transform_tab[psize][mtypes[mtype]];
-	 unsigned long *cycles = &(benchmark_tab[psize-1][mtype]);
-
-	 if ( test_transform_function( func, psize, mtype, cycles ) == 0 ) {
-	    char buf[100];
-	    sprintf(buf, "_mesa_transform_tab[0][%d][%s] failed test (%s)",
-		    psize, mstrings[mtype], description );
-	    _mesa_problem( NULL, "%s", buf );
-	 }
-#ifdef RUN_DEBUG_BENCHMARK
-	 if ( mesa_profile )
-	    printf(" %li\t", benchmark_tab[psize-1][mtype] );
-#endif
-      }
-#ifdef RUN_DEBUG_BENCHMARK
-      if ( mesa_profile )
-	 printf(" | [%s]\n", mstrings[mtype] );
-#endif
-   }
-#ifdef RUN_DEBUG_BENCHMARK
-   if ( mesa_profile )
-      printf( "\n" );
-#endif
-}
-
-
-#endif /* DEBUG_MATH */
diff --git a/src/mesa/meson.build b/src/mesa/meson.build
index 53ad10e5f165..a5e6ad319fe8 100644
--- a/src/mesa/meson.build
+++ b/src/mesa/meson.build
@@ -255,11 +255,6 @@ files_libmesa = files(
   'main/viewport.c',
   'main/viewport.h',
   'main/es1_conversion.c',
-  'math/m_debug.h',
-  'math/m_debug_clip.c',
-  'math/m_debug_norm.c',
-  'math/m_debug_util.h',
-  'math/m_debug_xform.c',
   'math/m_eval.c',
   'math/m_eval.h',
   'math/m_matrix.c',
-- 
GitLab


From 4a3200153ccbe02a079650dfdb97912ddedd217f Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Thu, 3 Nov 2022 11:37:20 +0000
Subject: [PATCH 18/20] math: remove unused vector4f_*
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/mesa/math/m_vector.c | 27 ---------------------------
 src/mesa/math/m_vector.h |  1 -
 2 files changed, 28 deletions(-)

diff --git a/src/mesa/math/m_vector.c b/src/mesa/math/m_vector.c
index b757f2449851..dbb237f1d83a 100644
--- a/src/mesa/math/m_vector.c
+++ b/src/mesa/math/m_vector.c
@@ -36,33 +36,6 @@
 
 #include "util/u_memory.h"
 
-
-
-/**
- * Given a vector [count][4] of floats, set all the [][elt] values
- * to 0 (if elt = 0, 1, 2) or 1.0 (if elt = 3).
- */
-void
-_mesa_vector4f_clean_elem( GLvector4f *vec, GLuint count, GLuint elt )
-{
-   static const GLubyte elem_bits[4] = {
-      VEC_DIRTY_0,
-      VEC_DIRTY_1,
-      VEC_DIRTY_2,
-      VEC_DIRTY_3
-   };
-   static const GLfloat clean[4] = { 0, 0, 0, 1 };
-   const GLfloat v = clean[elt];
-   GLfloat (*data)[4] = (GLfloat (*)[4])vec->start;
-   GLuint i;
-
-   for (i = 0; i < count; i++)
-      data[i][elt] = v;
-
-   vec->flags &= ~elem_bits[elt];
-}
-
-
 static const GLubyte size_bits[5] = {
    0,
    VEC_SIZE_1,
diff --git a/src/mesa/math/m_vector.h b/src/mesa/math/m_vector.h
index 2065324556bf..dd04ce970bf0 100644
--- a/src/mesa/math/m_vector.h
+++ b/src/mesa/math/m_vector.h
@@ -70,7 +70,6 @@ extern void _mesa_vector4f_alloc( GLvector4f *v, GLbitfield flags,
 			       GLuint count, GLuint alignment );
 extern void _mesa_vector4f_free( GLvector4f *v );
 extern void _mesa_vector4f_print( const GLvector4f *v, const GLubyte *, GLboolean );
-extern void _mesa_vector4f_clean_elem( GLvector4f *vec, GLuint nr, GLuint elt );
 
 
 /**
-- 
GitLab


From ee58b00f1de918d88e2eae44f1b3cf35dac97cc7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Thu, 3 Nov 2022 11:38:41 +0000
Subject: [PATCH 19/20] math: remove vector class
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/mesa/math/m_matrix.c     |   2 -
 src/mesa/math/m_matrix.h     |   6 ++
 src/mesa/math/m_vector.c     | 167 -----------------------------------
 src/mesa/math/m_vector.h     |  84 ------------------
 src/mesa/math/m_vector_asm.h |  57 ------------
 src/mesa/math/m_xform.h      |   1 -
 src/mesa/meson.build         |   2 -
 7 files changed, 6 insertions(+), 313 deletions(-)
 delete mode 100644 src/mesa/math/m_vector.c
 delete mode 100644 src/mesa/math/m_vector.h
 delete mode 100644 src/mesa/math/m_vector_asm.h

diff --git a/src/mesa/math/m_matrix.c b/src/mesa/math/m_matrix.c
index 66dcc747b87c..dedd38edeb6d 100644
--- a/src/mesa/math/m_matrix.c
+++ b/src/mesa/math/m_matrix.c
@@ -39,8 +39,6 @@
 #include "main/errors.h"
 #include "main/glheader.h"
 #include "main/macros.h"
-#define MATH_ASM_PTR_SIZE sizeof(void *)
-#include "math/m_vector_asm.h"
 
 #include "m_matrix.h"
 
diff --git a/src/mesa/math/m_matrix.h b/src/mesa/math/m_matrix.h
index 06d9d0018fec..04ec0ca21e46 100644
--- a/src/mesa/math/m_matrix.h
+++ b/src/mesa/math/m_matrix.h
@@ -54,6 +54,12 @@ extern "C" {
 #define MAT_TZ 14
 /*@}*/
 
+/**
+ * If you add a new field, please add it to the STATIC_ASSERTs in
+ * _math_matrix_set_identity().
+ */
+#define MATRIX_M   0
+#define MATRIX_INV (MATRIX_M + 16 * 4)
 
 /**
  * Different kinds of 4x4 transformation matrices.
diff --git a/src/mesa/math/m_vector.c b/src/mesa/math/m_vector.c
deleted file mode 100644
index dbb237f1d83a..000000000000
--- a/src/mesa/math/m_vector.c
+++ /dev/null
@@ -1,167 +0,0 @@
-/*
- * Mesa 3-D graphics library
- *
- * Copyright (C) 1999-2001  Brian Paul   All Rights Reserved.
- *
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the "Software"),
- * to deal in the Software without restriction, including without limitation
- * the rights to use, copy, modify, merge, publish, distribute, sublicense,
- * and/or sell copies of the Software, and to permit persons to whom the
- * Software is furnished to do so, subject to the following conditions:
- *
- * The above copyright notice and this permission notice shall be included
- * in all copies or substantial portions of the Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
- * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
- * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
- * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
- * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
- * OTHER DEALINGS IN THE SOFTWARE.
- */
-
-/*
- * New (3.1) transformation code written by Keith Whitwell.
- */
-
-#include <stdio.h>
-#include <stddef.h>
-
-#include "main/glheader.h"
-#include "main/macros.h"
-
-#include "m_vector.h"
-
-#include "util/u_memory.h"
-
-static const GLubyte size_bits[5] = {
-   0,
-   VEC_SIZE_1,
-   VEC_SIZE_2,
-   VEC_SIZE_3,
-   VEC_SIZE_4,
-};
-
-
-/**
- * Initialize GLvector objects.
- * \param v  the vector object to initialize.
- * \param flags  bitwise-OR of VEC_* flags
- * \param storage  pointer to storage for the vector's data
- */
-void
-_mesa_vector4f_init( GLvector4f *v, GLbitfield flags, GLfloat (*storage)[4] )
-{
-   STATIC_ASSERT(V4F_DATA == offsetof(GLvector4f, data));
-   STATIC_ASSERT(V4F_START == offsetof(GLvector4f, start));
-   STATIC_ASSERT(V4F_COUNT == offsetof(GLvector4f, count));
-   STATIC_ASSERT(V4F_STRIDE == offsetof(GLvector4f, stride));
-   STATIC_ASSERT(V4F_SIZE == offsetof(GLvector4f, size));
-   STATIC_ASSERT(V4F_FLAGS == offsetof(GLvector4f, flags));
-
-   v->stride = 4 * sizeof(GLfloat);
-   v->size = 2;   /* may change: 2-4 for vertices and 1-4 for texcoords */
-   v->data = storage;
-   v->start = (GLfloat *) storage;
-   v->count = 0;
-   v->flags = size_bits[4] | flags;
-}
-
-
-/**
- * Initialize GLvector objects and allocate storage.
- * \param v  the vector object
- * \param flags  bitwise-OR of VEC_* flags
- * \param count  number of elements to allocate in vector
- * \param alignment  desired memory alignment for the data (in bytes)
- */
-void
-_mesa_vector4f_alloc( GLvector4f *v, GLbitfield flags, GLuint count,
-                      GLuint alignment )
-{
-   v->stride = 4 * sizeof(GLfloat);
-   v->size = 2;
-   v->storage = align_malloc( count * 4 * sizeof(GLfloat), alignment );
-   v->storage_count = count;
-   v->start = (GLfloat *) v->storage;
-   v->data = (GLfloat (*)[4]) v->storage;
-   v->count = 0;
-   v->flags = size_bits[4] | flags | VEC_MALLOC;
-}
-
-
-/**
- * Vector deallocation.  Free whatever memory is pointed to by the
- * vector's storage field if the VEC_MALLOC flag is set.
- * DO NOT free the GLvector object itself, though.
- */
-void
-_mesa_vector4f_free( GLvector4f *v )
-{
-   if (v->flags & VEC_MALLOC) {
-      align_free( v->storage );
-      v->data = NULL;
-      v->start = NULL;
-      v->storage = NULL;
-      v->flags &= ~VEC_MALLOC;
-   }
-}
-
-
-/**
- * For debugging
- */
-void
-_mesa_vector4f_print( const GLvector4f *v, const GLubyte *cullmask,
-                      GLboolean culling )
-{
-   static const GLfloat c[4] = { 0, 0, 0, 1 };
-   static const char *templates[5] = {
-      "%d:\t0, 0, 0, 1\n",
-      "%d:\t%f, 0, 0, 1\n",
-      "%d:\t%f, %f, 0, 1\n",
-      "%d:\t%f, %f, %f, 1\n",
-      "%d:\t%f, %f, %f, %f\n"
-   };
-
-   const char *t = templates[v->size];
-   GLfloat *d = (GLfloat *)v->data;
-   GLuint j, i = 0, count;
-
-   printf("data-start\n");
-   for (; d != v->start; STRIDE_F(d, v->stride), i++)
-      printf(t, i, d[0], d[1], d[2], d[3]);
-
-   printf("start-count(%u)\n", v->count);
-   count = i + v->count;
-
-   if (culling) {
-      for (; i < count; STRIDE_F(d, v->stride), i++)
-	 if (cullmask[i])
-	    printf(t, i, d[0], d[1], d[2], d[3]);
-   }
-   else {
-      for (; i < count; STRIDE_F(d, v->stride), i++)
-	 printf(t, i, d[0], d[1], d[2], d[3]);
-   }
-
-   for (j = v->size; j < 4; j++) {
-      if ((v->flags & (1<<j)) == 0) {
-
-	 printf("checking col %u is clean as advertised ", j);
-
-	 for (i = 0, d = (GLfloat *) v->data;
-	      i < count && d[j] == c[j];
-	      i++, STRIDE_F(d, v->stride)) {
-            /* no-op */
-         }
-
-	 if (i == count)
-	    printf(" --> ok\n");
-	 else
-	    printf(" --> Failed at %u ******\n", i);
-      }
-   }
-}
diff --git a/src/mesa/math/m_vector.h b/src/mesa/math/m_vector.h
deleted file mode 100644
index dd04ce970bf0..000000000000
--- a/src/mesa/math/m_vector.h
+++ /dev/null
@@ -1,84 +0,0 @@
-/*
- * Mesa 3-D graphics library
- *
- * Copyright (C) 1999-2008  Brian Paul   All Rights Reserved.
- *
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the "Software"),
- * to deal in the Software without restriction, including without limitation
- * the rights to use, copy, modify, merge, publish, distribute, sublicense,
- * and/or sell copies of the Software, and to permit persons to whom the
- * Software is furnished to do so, subject to the following conditions:
- *
- * The above copyright notice and this permission notice shall be included
- * in all copies or substantial portions of the Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
- * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
- * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
- * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
- * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
- * OTHER DEALINGS IN THE SOFTWARE.
- */
-
-/*
- * New (3.1) transformation code written by Keith Whitwell.
- */
-
-
-#ifndef _M_VECTOR_H_
-#define _M_VECTOR_H_
-
-#include "main/glheader.h"
-#define MATH_ASM_PTR_SIZE sizeof(void *)
-#include "math/m_vector_asm.h"
-
-#define VEC_MALLOC         0x10 /* storage field points to self-allocated mem*/
-#define VEC_NOT_WRITEABLE  0x40	/* writable elements to hold clipped data */
-#define VEC_BAD_STRIDE     0x100 /* matches tnl's prefered stride */
-
-
-
-
-
-/**
- * Wrap all the information about vectors up in a struct.  Has
- * additional fields compared to the other vectors to help us track
- * different vertex sizes, and whether we need to clean columns out
- * because they contain non-(0,0,0,1) values.
- *
- * The start field is used to reserve data for copied vertices at the
- * end of _mesa_transform_vb, and avoids the need for a multiplication in
- * the transformation routines.
- */
-typedef struct {
-   GLfloat (*data)[4];	/**< may be malloc'd or point to client data */
-   GLfloat *start;	/**< points somewhere inside of GLvector4f::data */
-   GLuint count;	/**< size of the vector (in elements) */
-   GLuint stride;	/**< stride from one element to the next (in bytes) */
-   GLuint size;		/**< 2-4 for vertices and 1-4 for texcoords */
-   GLbitfield flags;	/**< bitmask of VEC_x flags */
-   void *storage;	/**< self-allocated storage */
-   GLuint storage_count; /**< storage size in elements */
-} GLvector4f;
-
-
-extern void _mesa_vector4f_init( GLvector4f *v, GLbitfield flags,
-			      GLfloat (*storage)[4] );
-extern void _mesa_vector4f_alloc( GLvector4f *v, GLbitfield flags,
-			       GLuint count, GLuint alignment );
-extern void _mesa_vector4f_free( GLvector4f *v );
-extern void _mesa_vector4f_print( const GLvector4f *v, const GLubyte *, GLboolean );
-
-
-/**
- * Given vector <v>, return a pointer (cast to <type *> to the <i>-th element.
- *
- * End up doing a lot of slow imuls if not careful.
- */
-#define VEC_ELT( v, type, i ) \
-       ( (type *)  ( ((GLbyte *) ((v)->data)) + (i) * (v)->stride) )
-
-
-#endif
diff --git a/src/mesa/math/m_vector_asm.h b/src/mesa/math/m_vector_asm.h
deleted file mode 100644
index 90de44b0a50f..000000000000
--- a/src/mesa/math/m_vector_asm.h
+++ /dev/null
@@ -1,57 +0,0 @@
-/*
- * Copyright © 2019 Google LLC
- *
- * Permission is hereby granted, free of charge, to any person obtaining a
- * copy of this software and associated documentation files (the "Software"),
- * to deal in the Software without restriction, including without limitation
- * the rights to use, copy, modify, merge, publish, distribute, sublicense,
- * and/or sell copies of the Software, and to permit persons to whom the
- * Software is furnished to do so, subject to the following conditions:
- *
- * The above copyright notice and this permission notice (including the next
- * paragraph) shall be included in all copies or substantial portions of the
- * Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
- * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
- * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
- * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
- * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
- * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
- * IN THE SOFTWARE.
- */
-
-#ifndef _M_VECTOR_ASM_H_
-#define _M_VECTOR_ASM_H_
-
-/* This file is a set of defines usable by the old FF TNL assembly code for
- * referencing GLvector4f and GLmatrix structs.
- */
-
-#define VEC_DIRTY_0        0x1
-#define VEC_DIRTY_1        0x2
-#define VEC_DIRTY_2        0x4
-#define VEC_DIRTY_3        0x8
-
-#define VEC_SIZE_1   VEC_DIRTY_0
-#define VEC_SIZE_2   (VEC_DIRTY_0|VEC_DIRTY_1)
-#define VEC_SIZE_3   (VEC_DIRTY_0|VEC_DIRTY_1|VEC_DIRTY_2)
-#define VEC_SIZE_4   (VEC_DIRTY_0|VEC_DIRTY_1|VEC_DIRTY_2|VEC_DIRTY_3)
-
-/* If you add a new field, please add it to the STATIC_ASSERTs in
- * _mesa_vector4f_init().
- */
-#define V4F_DATA   0
-#define V4F_START  (V4F_DATA + MATH_ASM_PTR_SIZE)
-#define V4F_COUNT  (V4F_START + MATH_ASM_PTR_SIZE)
-#define V4F_STRIDE (V4F_COUNT + 4)
-#define V4F_SIZE   (V4F_STRIDE + 4)
-#define V4F_FLAGS  (V4F_SIZE + 4)
-
-/* If you add a new field, please add it to the STATIC_ASSERTs in
- * _math_matrix_set_identity().
- */
-#define MATRIX_M   0
-#define MATRIX_INV (MATRIX_M + 16 * 4)
-
-#endif /* _M_VECTOR_ASM_H */
diff --git a/src/mesa/math/m_xform.h b/src/mesa/math/m_xform.h
index d3a5c81d648d..1bca0fbbaacd 100644
--- a/src/mesa/math/m_xform.h
+++ b/src/mesa/math/m_xform.h
@@ -30,7 +30,6 @@
 #include "util/compiler.h"
 #include "main/glheader.h"
 #include "math/m_matrix.h"
-#include "math/m_vector.h"
 
 
 extern void
diff --git a/src/mesa/meson.build b/src/mesa/meson.build
index a5e6ad319fe8..8aa70145b807 100644
--- a/src/mesa/meson.build
+++ b/src/mesa/meson.build
@@ -259,8 +259,6 @@ files_libmesa = files(
   'math/m_eval.h',
   'math/m_matrix.c',
   'math/m_matrix.h',
-  'math/m_vector.c',
-  'math/m_vector.h',
   'program/arbprogparse.c',
   'program/arbprogparse.h',
   'program/link_program.cpp',
-- 
GitLab


From 1f3bbd29a9e9275dcffadd742af113be0c664e88 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ant=C3=B3nio=20Monteiro?= <antonio.fmr.monteiro@gmail.com>
Date: Thu, 3 Nov 2022 11:16:38 +0000
Subject: [PATCH 20/20] math: remove unused matrix_print & print_matrix_floats
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: António Monteiro <antonio.fmr.monteiro@gmail.com>
---
 src/mesa/math/m_matrix.c | 58 ----------------------------------------
 src/mesa/math/m_matrix.h |  3 ---
 2 files changed, 61 deletions(-)

diff --git a/src/mesa/math/m_matrix.c b/src/mesa/math/m_matrix.c
index dedd38edeb6d..968ec9cfd22d 100644
--- a/src/mesa/math/m_matrix.c
+++ b/src/mesa/math/m_matrix.c
@@ -115,22 +115,6 @@
 #define TEST_MAT_FLAGS(mat, a)  \
     ((MAT_FLAGS_GEOMETRY & (~(a)) & ((mat)->flags) ) == 0)
 
-
-
-/**
- * Names of the corresponding GLmatrixtype values.
- */
-static const char *types[] = {
-   "MATRIX_GENERAL",
-   "MATRIX_IDENTITY",
-   "MATRIX_3D_NO_ROT",
-   "MATRIX_PERSPECTIVE",
-   "MATRIX_2D",
-   "MATRIX_2D_NO_ROT",
-   "MATRIX_3D"
-};
-
-
 /**
  * Identity matrix.
  */
@@ -271,48 +255,6 @@ _math_matrix_mul_floats( GLmatrix *dest, const GLfloat *m )
 
 /*@}*/
 
-
-/**********************************************************************/
-/** \name Matrix output */
-/*@{*/
-
-/**
- * Print a matrix array.
- *
- * \param m matrix array.
- *
- * Called by _math_matrix_print() to print a matrix or its inverse.
- */
-static void print_matrix_floats( const GLfloat m[16] )
-{
-   int i;
-   for (i=0;i<4;i++) {
-      _mesa_debug(NULL,"\t%f %f %f %f\n", m[i], m[4+i], m[8+i], m[12+i] );
-   }
-}
-
-/**
- * Dumps the contents of a GLmatrix structure.
- *
- * \param m pointer to the GLmatrix structure.
- */
-void
-_math_matrix_print( const GLmatrix *m )
-{
-   GLfloat prod[16];
-
-   _mesa_debug(NULL, "Matrix type: %s, flags: %x\n", types[m->type], m->flags);
-   print_matrix_floats(m->m);
-   _mesa_debug(NULL, "Inverse: \n");
-   print_matrix_floats(m->inv);
-   matmul4(prod, m->m, m->inv);
-   _mesa_debug(NULL, "Mat * Inverse:\n");
-   print_matrix_floats(prod);
-}
-
-/*@}*/
-
-
 /**
  * References an element of 4x4 matrix.
  *
diff --git a/src/mesa/math/m_matrix.h b/src/mesa/math/m_matrix.h
index 04ec0ca21e46..38d68733aff1 100644
--- a/src/mesa/math/m_matrix.h
+++ b/src/mesa/math/m_matrix.h
@@ -146,9 +146,6 @@ _math_matrix_push_copy(GLmatrix *to, GLmatrix *from);
 extern void
 _math_matrix_analyse( GLmatrix *mat );
 
-extern void
-_math_matrix_print( const GLmatrix *m );
-
 extern GLboolean
 _math_matrix_is_length_preserving( const GLmatrix *m );
 
-- 
GitLab

