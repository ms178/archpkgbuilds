From 11df0eee03ea2fe4ae7119fb88d06a30e52f23b6 Mon Sep 17 00:00:00 2001
From: Simon Ser <contact@emersion.fr>
Date: Mon, 12 Jul 2021 00:19:09 +0200
Subject: [PATCH] mesa: expose EXT_sRGB on ES2

This exposes the EXT_sRGB extension [1] for ES2 contexts.

There is an existing bool indicating support for the EXT_sRGB extension,
but the extension was never exposed. This was incorrect because the
EXT_sRGB_write_control requires EXT_sRGB.

[1]: https://www.khronos.org/registry/OpenGL/extensions/EXT/EXT_sRGB.txt

Signed-off-by: Simon Ser <contact@emersion.fr>
---
 src/mesa/main/extensions_table.h | 1 +
 src/mesa/main/fbobject.c         | 3 ++-
 src/mesa/main/glformats.c        | 2 +-
 3 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/mesa/main/extensions_table.h b/src/mesa/main/extensions_table.h
index 307b5d3bc1db..9d9efab2a19b 100644
--- a/src/mesa/main/extensions_table.h
+++ b/src/mesa/main/extensions_table.h
@@ -280,6 +280,7 @@ EXT(EXT_read_format_bgra                    , dummy_true
 EXT(EXT_render_snorm                        , EXT_render_snorm                       ,  x ,  x ,  x,   31, 2014)
 EXT(EXT_rescale_normal                      , dummy_true                             , GLL,  x ,  x ,  x , 1997)
 EXT(EXT_robustness                          , KHR_robustness                         ,  x,   x,   x , ES2, 2011)
+EXT(EXT_sRGB                                , EXT_sRGB                               ,  x ,  x ,  x , ES2, 2011)
 EXT(EXT_sRGB_write_control                  , EXT_framebuffer_sRGB                   ,   x,  x ,  x ,  30, 2013)
 EXT(EXT_secondary_color                     , dummy_true                             , GLL,  x ,  x ,  x , 1999)
 EXT(EXT_semaphore                           , EXT_semaphore                          , GLL, GLC,  x , ES2, 2017)
diff --git a/src/mesa/main/fbobject.c b/src/mesa/main/fbobject.c
index be1d61907a4b..621dd2d02417 100644
--- a/src/mesa/main/fbobject.c
+++ b/src/mesa/main/fbobject.c
@@ -2386,8 +2386,9 @@ _mesa_base_fbo_format(const struct gl_context *ctx, GLenum internalFormat)
       return _mesa_is_desktop_gl(ctx) || _mesa_has_EXT_texture_norm16(ctx)
          ? GL_RGBA : 0;
    case GL_RGB10_A2:
-   case GL_SRGB8_ALPHA8_EXT:
       return _mesa_is_desktop_gl(ctx) || _mesa_is_gles3(ctx) ? GL_RGBA : 0;
+   case GL_SRGB8_ALPHA8_EXT:
+      return (_mesa_is_desktop_gl(ctx) || _mesa_has_EXT_sRGB(ctx)) ? GL_RGBA : 0;
    case GL_STENCIL_INDEX:
    case GL_STENCIL_INDEX1_EXT:
    case GL_STENCIL_INDEX4_EXT:
diff --git a/src/mesa/main/glformats.c b/src/mesa/main/glformats.c
index 068c01855a0d..49476fe53ff2 100644
--- a/src/mesa/main/glformats.c
+++ b/src/mesa/main/glformats.c
@@ -2482,7 +2482,7 @@ _mesa_base_tex_format(const struct gl_context *ctx, GLint internalFormat)
       }
    }
 
-   if (_mesa_has_EXT_texture_sRGB(ctx) || _mesa_is_gles3(ctx)) {
+   if (_mesa_has_EXT_texture_sRGB(ctx) || _mesa_has_EXT_sRGB(ctx)) {
       switch (internalFormat) {
       case GL_SRGB_EXT:
       case GL_SRGB8_EXT:
-- 
GitLab

