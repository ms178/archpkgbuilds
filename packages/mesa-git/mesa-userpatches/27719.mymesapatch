From 61c448e1278accfc7b18d808fef499ea0fe514ed Mon Sep 17 00:00:00 2001
From: Pierre-Eric Pelloux-Prayer <pierre-eric.pelloux-prayer@amd.com>
Date: Tue, 20 Feb 2024 17:46:05 +0100
Subject: [PATCH] egl/wayland: use __DRI_IMAGE_PRIME_LINEAR_BUFFER in
 get_back_bo

Some drivers (radeonsi, iris) relies on this hint to detect DRI_PRIME
blits and implement a special path (eg: SDMA copy for radeonsi).

Reviewed-by: Daniel Stone <daniels@collabora.com>
---
 src/egl/drivers/dri2/platform_wayland.c |  4 ++--
 src/gallium/frontends/dri/dri2.c        | 10 +++++++---
 2 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/src/egl/drivers/dri2/platform_wayland.c b/src/egl/drivers/dri2/platform_wayland.c
index 9ce508225ec4d..4f8cabf005739 100644
--- a/src/egl/drivers/dri2/platform_wayland.c
+++ b/src/egl/drivers/dri2/platform_wayland.c
@@ -1194,8 +1194,8 @@ get_back_bo(struct dri2_egl_surface *dri2_surf)
                   linear_mod, &buffer_fds[0], num_planes, &strides[0],
                   &offsets[0], __DRI_YUV_COLOR_SPACE_UNDEFINED,
                   __DRI_YUV_RANGE_UNDEFINED, __DRI_YUV_CHROMA_SITING_UNDEFINED,
-                  __DRI_YUV_CHROMA_SITING_UNDEFINED, 0, &error,
-                  dri2_surf->back);
+                  __DRI_YUV_CHROMA_SITING_UNDEFINED, __DRI_IMAGE_PRIME_LINEAR_BUFFER,
+                  &error, dri2_surf->back);
 
             for (i = 0; i < num_planes; ++i) {
                if (buffer_fds[i] != -1)
diff --git a/src/gallium/frontends/dri/dri2.c b/src/gallium/frontends/dri/dri2.c
index ad68f3b08c097..5cf8c79c3c5fb 100644
--- a/src/gallium/frontends/dri/dri2.c
+++ b/src/gallium/frontends/dri/dri2.c
@@ -1854,13 +1854,17 @@ dri2_from_dma_bufs3(__DRIscreen *screen,
                     unsigned *error,
                     void *loaderPrivate)
 {
+   unsigned bind = 0;
    __DRIimage *img;
 
+   if (flags & __DRI_IMAGE_PROTECTED_CONTENT_FLAG)
+      bind |= PIPE_BIND_PROTECTED;
+   if (flags & __DRI_IMAGE_PRIME_LINEAR_BUFFER)
+      bind |= PIPE_BIND_PRIME_BLIT_DST;
+
    img = dri2_create_image_from_fd(screen, width, height, fourcc,
                                    modifier, fds, num_fds, strides, offsets,
-                                   (flags & __DRI_IMAGE_PROTECTED_CONTENT_FLAG) ?
-                                      PIPE_BIND_PROTECTED : 0,
-                                   error, loaderPrivate);
+                                   bind, error, loaderPrivate);
    if (img == NULL)
       return NULL;
 
-- 
GitLab

