From 07876de3ebc0a9f8b546136be2a9586d3c18e478 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marek=20Ol=C5=A1=C3=A1k?= <marek.olsak@amd.com>
Date: Sun, 24 Jul 2022 16:06:22 -0400
Subject: [PATCH 1/2] glthread: don't ignore glPushAttrib/glPopAttrib when
 tracking GL_CULL_FACE

Fixes: f4348ef60d51b07 - glthread: don't sync for glIsEnabled with a few enums
---
 src/mesa/main/glthread.h         | 1 +
 src/mesa/main/glthread_marshal.h | 6 ++++++
 2 files changed, 7 insertions(+)

diff --git a/src/mesa/main/glthread.h b/src/mesa/main/glthread.h
index e66708403cde..ae75def0216d 100644
--- a/src/mesa/main/glthread.h
+++ b/src/mesa/main/glthread.h
@@ -129,6 +129,7 @@ struct glthread_attrib_node {
    GLbitfield Mask;
    int ActiveTexture;
    GLenum MatrixMode;
+   bool CullFace;
 };
 
 typedef enum {
diff --git a/src/mesa/main/glthread_marshal.h b/src/mesa/main/glthread_marshal.h
index aac940dc08c0..95d4b20e4d10 100644
--- a/src/mesa/main/glthread_marshal.h
+++ b/src/mesa/main/glthread_marshal.h
@@ -506,6 +506,9 @@ _mesa_glthread_PushAttrib(struct gl_context *ctx, GLbitfield mask)
 
    attr->Mask = mask;
 
+   if (mask & (GL_POLYGON_BIT | GL_ENABLE_BIT))
+      attr->CullFace = ctx->GLThread.CullFace;
+
    if (mask & GL_TEXTURE_BIT)
       attr->ActiveTexture = ctx->GLThread.ActiveTexture;
 
@@ -523,6 +526,9 @@ _mesa_glthread_PopAttrib(struct gl_context *ctx)
       &ctx->GLThread.AttribStack[--ctx->GLThread.AttribStackDepth];
    unsigned mask = attr->Mask;
 
+   if (mask & (GL_POLYGON_BIT | GL_ENABLE_BIT))
+      ctx->GLThread.CullFace = attr->CullFace;
+
    if (mask & GL_TEXTURE_BIT)
       ctx->GLThread.ActiveTexture = attr->ActiveTexture;
 
-- 
GitLab


From f52d7448f173b11aca5bba07cd5c806b663d68c9 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marek=20Ol=C5=A1=C3=A1k?= <marek.olsak@amd.com>
Date: Sun, 24 Jul 2022 16:09:00 -0400
Subject: [PATCH 2/2] glthread: don't sync on IsEnabled(GL_DEPTH_TEST) by
 tracking it in glthread

Discovered with viewperf.
---
 src/mesa/main/glthread.h         |  2 ++
 src/mesa/main/glthread_marshal.h | 14 ++++++++++++++
 2 files changed, 16 insertions(+)

diff --git a/src/mesa/main/glthread.h b/src/mesa/main/glthread.h
index ae75def0216d..ee15d5f48650 100644
--- a/src/mesa/main/glthread.h
+++ b/src/mesa/main/glthread.h
@@ -130,6 +130,7 @@ struct glthread_attrib_node {
    int ActiveTexture;
    GLenum MatrixMode;
    bool CullFace;
+   bool DepthTest;
 };
 
 typedef enum {
@@ -231,6 +232,7 @@ struct glthread_state
    int MatrixStackDepth[M_NUM_MATRIX_STACKS];
 
    /** Enable states. */
+   bool DepthTest;
    bool CullFace;
 
    GLuint CurrentDrawFramebuffer;
diff --git a/src/mesa/main/glthread_marshal.h b/src/mesa/main/glthread_marshal.h
index 95d4b20e4d10..80022c1cea67 100644
--- a/src/mesa/main/glthread_marshal.h
+++ b/src/mesa/main/glthread_marshal.h
@@ -452,6 +452,9 @@ _mesa_glthread_Enable(struct gl_context *ctx, GLenum cap)
    case GL_DEBUG_OUTPUT_SYNCHRONOUS_ARB:
       _mesa_glthread_destroy(ctx, "Enable(DEBUG_OUTPUT_SYNCHRONOUS)");
       break;
+   case GL_DEPTH_TEST:
+      ctx->GLThread.DepthTest = true;
+      break;
    case GL_CULL_FACE:
       ctx->GLThread.CullFace = true;
       break;
@@ -472,6 +475,9 @@ _mesa_glthread_Disable(struct gl_context *ctx, GLenum cap)
    case GL_CULL_FACE:
       ctx->GLThread.CullFace = false;
       break;
+   case GL_DEPTH_TEST:
+      ctx->GLThread.DepthTest = false;
+      break;
    }
 }
 
@@ -481,6 +487,8 @@ _mesa_glthread_IsEnabled(struct gl_context *ctx, GLenum cap)
    switch (cap) {
    case GL_CULL_FACE:
       return ctx->GLThread.CullFace;
+   case GL_DEPTH_TEST:
+      return ctx->GLThread.DepthTest;
    case GL_VERTEX_ARRAY:
       return !!(ctx->GLThread.CurrentVAO->UserEnabled & VERT_BIT_POS);
    case GL_NORMAL_ARRAY:
@@ -509,6 +517,9 @@ _mesa_glthread_PushAttrib(struct gl_context *ctx, GLbitfield mask)
    if (mask & (GL_POLYGON_BIT | GL_ENABLE_BIT))
       attr->CullFace = ctx->GLThread.CullFace;
 
+   if (mask & (GL_DEPTH_BUFFER_BIT | GL_ENABLE_BIT))
+      attr->DepthTest = ctx->GLThread.DepthTest;
+
    if (mask & GL_TEXTURE_BIT)
       attr->ActiveTexture = ctx->GLThread.ActiveTexture;
 
@@ -529,6 +540,9 @@ _mesa_glthread_PopAttrib(struct gl_context *ctx)
    if (mask & (GL_POLYGON_BIT | GL_ENABLE_BIT))
       ctx->GLThread.CullFace = attr->CullFace;
 
+   if (mask & (GL_DEPTH_BUFFER_BIT | GL_ENABLE_BIT))
+      ctx->GLThread.DepthTest = attr->DepthTest;
+
    if (mask & GL_TEXTURE_BIT)
       ctx->GLThread.ActiveTexture = attr->ActiveTexture;
 
-- 
GitLab

