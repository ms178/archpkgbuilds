From 64d157f6f04f38ddf8079fc9d9f0e331945db75a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marek=20Ol=C5=A1=C3=A1k?= <marek.olsak@amd.com>
Date: Mon, 4 Aug 2025 23:51:16 -0400
Subject: [PATCH] dri: fail creating DRI images that exceed hw limits

otherwise random stuff happens

it probably resolves https://gitlab.freedesktop.org/mesa/mesa/-/issues/13652
---
 src/gallium/frontends/dri/dri2.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/src/gallium/frontends/dri/dri2.c b/src/gallium/frontends/dri/dri2.c
index 9e83343359acc..082d38b6c2168 100644
--- a/src/gallium/frontends/dri/dri2.c
+++ b/src/gallium/frontends/dri/dri2.c
@@ -916,6 +916,10 @@ dri_create_image(struct dri_screen *screen,
    if (!pscreen->resource_create_with_modifiers && count > 0)
       return NULL;
 
+   if (width > pscreen->caps.max_texture_2d_size ||
+       height > pscreen->caps.max_texture_2d_size)
+      return NULL;
+
    if (pscreen->is_format_supported(pscreen, map->pipe_format, screen->target,
                                     0, 0, PIPE_BIND_RENDER_TARGET))
       tex_usage |= PIPE_BIND_RENDER_TARGET;
-- 
GitLab

