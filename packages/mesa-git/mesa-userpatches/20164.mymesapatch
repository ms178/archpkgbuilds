From 7952b082f9baad1507f63ef98e1b8410e836f54d Mon Sep 17 00:00:00 2001
From: jheaff1 <jheaff1@outlook.com>
Date: Mon, 5 Dec 2022 17:16:52 +0000
Subject: [PATCH] Add missing dependencies for X11 build

Meson would fail to build unless the required headers were installed on
the host system.
---
 src/gallium/frontends/dri/meson.build | 3 +++
 src/gallium/targets/dri/meson.build   | 2 +-
 src/gbm/meson.build                   | 4 ++++
 src/intel/vulkan/meson.build          | 2 +-
 src/loader/meson.build                | 2 +-
 src/vulkan/util/meson.build           | 3 ++-
 6 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/src/gallium/frontends/dri/meson.build b/src/gallium/frontends/dri/meson.build
index f02aaeb20ca3..7a9350980bd2 100644
--- a/src/gallium/frontends/dri/meson.build
+++ b/src/gallium/frontends/dri/meson.build
@@ -69,6 +69,9 @@ libdri = static_library(
   dependencies : [
     dep_libdrm,
     idep_mesautil,
+    dep_xcb,
+    dep_x11,
+    dep_xlib_xrandr
   ],
 )
 
diff --git a/src/gallium/targets/dri/meson.build b/src/gallium/targets/dri/meson.build
index d0a9b91b5a2f..7b909c2ca565 100644
--- a/src/gallium/targets/dri/meson.build
+++ b/src/gallium/targets/dri/meson.build
@@ -58,7 +58,7 @@ libgallium_dri = shared_library(
     driver_kmsro, driver_v3d, driver_vc4, driver_freedreno, driver_etnaviv,
     driver_tegra, driver_i915, driver_svga, driver_virgl,
     driver_panfrost, driver_iris, driver_lima, driver_zink, driver_d3d12,
-    driver_asahi, driver_crocus
+    driver_asahi, driver_crocus, dep_xcb, dep_x11, dep_xlib_xrandr
   ],
   # Will be deleted during installation, see install_megadrivers.py
   install : true,
diff --git a/src/gbm/meson.build b/src/gbm/meson.build
index df65361aef74..aad9f753683d 100644
--- a/src/gbm/meson.build
+++ b/src/gbm/meson.build
@@ -44,6 +44,10 @@ if with_platform_wayland
   deps_gbm += dep_wayland_server
   incs_gbm += inc_wayland_drm
 endif
+if with_platform_x11
+  deps_gbm += [dep_xcb, dep_x11, dep_xlib_xrandr]
+endif
+ 
 
 libgbm_name = 'gbm'
 
diff --git a/src/intel/vulkan/meson.build b/src/intel/vulkan/meson.build
index b23401156e68..116b5018209a 100644
--- a/src/intel/vulkan/meson.build
+++ b/src/intel/vulkan/meson.build
@@ -136,7 +136,7 @@ foreach g : [['90', ['gfx8_cmd_buffer.c']],
       dep_libdrm, dep_valgrind, idep_nir_headers, idep_genxml,
       idep_vulkan_util_headers, idep_vulkan_wsi_headers,
       idep_vulkan_runtime_headers, idep_intel_driver_ds_headers,
-      idep_grl,
+      idep_grl, dep_x11
     ],
   )
 endforeach
diff --git a/src/loader/meson.build b/src/loader/meson.build
index 6334cb9815cd..0a0939d9b9c9 100644
--- a/src/loader/meson.build
+++ b/src/loader/meson.build
@@ -28,7 +28,7 @@ if with_platform_x11 and with_dri3
     include_directories : [inc_include, inc_src],
     dependencies : [
       dep_libdrm, dep_xcb_dri3, dep_xcb_present, dep_xcb_sync, dep_xshmfence,
-      dep_xcb_xfixes,
+      dep_xcb_xfixes, dep_x11_xcb
     ],
     build_by_default : false,
   )
diff --git a/src/vulkan/util/meson.build b/src/vulkan/util/meson.build
index 8f232fa02e90..4f36b23e37ff 100644
--- a/src/vulkan/util/meson.build
+++ b/src/vulkan/util/meson.build
@@ -105,7 +105,8 @@ libvulkan_util = static_library(
 
 idep_vulkan_util_headers = declare_dependency(
   sources : [vk_dispatch_table[1], vk_enum_to_str[1], vk_extensions[1]],
-  include_directories : include_directories('.')
+  include_directories : include_directories('.'),
+  dependencies : [dep_xcb, dep_x11, dep_xlib_xrandr]
 )
 
 idep_vulkan_util = declare_dependency(
-- 
GitLab

