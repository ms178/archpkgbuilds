From db9aa3a4b8a2fd570b883050175d998d9291a237 Mon Sep 17 00:00:00 2001
From: Rohan Garg <rohan.garg@intel.com>
Date: Fri, 2 Dec 2022 21:09:33 +0530
Subject: [PATCH 1/7] iris: correctly set alignment to next power of two for
 struct size

We're currently aligning the offset to the size of the data structure
itself when the upload manager actually expects a POT. Ideally this
would be the next POT that's greater than the size of the structure.

Fixes: c24a574e6c78 ("iris: Don't allocate a BO per query object")

Signed-off-by: Rohan Garg <rohan.garg@intel.com>
Reviewed-by: Sagar Ghuge <sagar.ghuge@intel.com>
---
 src/gallium/drivers/iris/iris_query.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/gallium/drivers/iris/iris_query.c b/src/gallium/drivers/iris/iris_query.c
index ac7df8fe8214..7a3273c686cd 100644
--- a/src/gallium/drivers/iris/iris_query.c
+++ b/src/gallium/drivers/iris/iris_query.c
@@ -521,7 +521,8 @@ iris_begin_query(struct pipe_context *ctx, struct pipe_query *query)
       size = sizeof(struct iris_query_snapshots);
 
    u_upload_alloc(ice->query_buffer_uploader, 0,
-                  size, size, &q->query_state_ref.offset,
+                  size, util_next_power_of_two(size),
+                  &q->query_state_ref.offset,
                   &q->query_state_ref.res, &ptr);
 
    if (!iris_resource_bo(q->query_state_ref.res))
-- 
GitLab


From 226431b003eaf39ba6e3b2f66e16853bde5e1567 Mon Sep 17 00:00:00 2001
From: Rohan Garg <rohan@garg.io>
Date: Tue, 20 Dec 2022 16:19:24 +0100
Subject: [PATCH 2/7] ac/surface: make sure alignment is a POT
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rohan Garg <rohan@garg.io>
Reviewed-by: Marek Olšák <marek.olsak@amd.com>
---
 src/amd/common/ac_surface.c | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/src/amd/common/ac_surface.c b/src/amd/common/ac_surface.c
index b6b195fb81d8..f20d81d200b9 100644
--- a/src/amd/common/ac_surface.c
+++ b/src/amd/common/ac_surface.c
@@ -1793,11 +1793,14 @@ static int gfx9_compute_miptree(struct ac_addrlib *addrlib, const struct radeon_
    surf->surf_size = out.surfSize;
    surf->surf_alignment_log2 = util_logbase2(out.baseAlign);
 
+   const int linear_alignment =
+      util_next_power_of_two(LINEAR_PITCH_ALIGNMENT / surf->bpe);
+
    if (!compressed && surf->blk_w > 1 && out.pitch == out.pixelPitch &&
        surf->u.gfx9.swizzle_mode == ADDR_SW_LINEAR) {
       /* Adjust surf_pitch to be in elements units not in pixels */
       surf->u.gfx9.surf_pitch = align(surf->u.gfx9.surf_pitch / surf->blk_w,
-                                      LINEAR_PITCH_ALIGNMENT / surf->bpe);
+                                      linear_alignment);
       surf->u.gfx9.epitch =
          MAX2(surf->u.gfx9.epitch, surf->u.gfx9.surf_pitch * surf->blk_w - 1);
       /* The surface is really a surf->bpe bytes per pixel surface even if we
@@ -1810,11 +1813,11 @@ static int gfx9_compute_miptree(struct ac_addrlib *addrlib, const struct radeon_
               (uint64_t)surf->u.gfx9.surf_pitch * out.height * surf->bpe * surf->blk_w);
       surf->surf_size = surf->u.gfx9.surf_slice_size * in->numSlices;
 
-      int alignment = LINEAR_PITCH_ALIGNMENT / surf->bpe;
       for (unsigned i = 0; i < in->numMipLevels; i++) {
          surf->u.gfx9.offset[i] = mip_info[i].offset;
          /* Adjust pitch like we did for surf_pitch */
-         surf->u.gfx9.pitch[i] = align(mip_info[i].pitch / surf->blk_w, alignment);
+         surf->u.gfx9.pitch[i] = align(mip_info[i].pitch / surf->blk_w,
+                                       linear_alignment);
       }
       surf->u.gfx9.base_mip_width = surf->u.gfx9.surf_pitch;
    } else if (in->swizzleMode == ADDR_SW_LINEAR) {
-- 
GitLab


From a4b8a9c6e6971cd94b601470224405280c7babd7 Mon Sep 17 00:00:00 2001
From: Rohan Garg <rohan.garg@intel.com>
Date: Fri, 20 Jan 2023 11:33:16 +0100
Subject: [PATCH 3/7] freedreno: set alignment to next POT
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rohan Garg <rohan.garg@intel.com>
Reviewed-by: Marek Olšák <marek.olsak@amd.com>
---
 src/gallium/drivers/freedreno/a5xx/fd5_emit.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/gallium/drivers/freedreno/a5xx/fd5_emit.c b/src/gallium/drivers/freedreno/a5xx/fd5_emit.c
index 5886645e4978..e0335beca1e1 100644
--- a/src/gallium/drivers/freedreno/a5xx/fd5_emit.c
+++ b/src/gallium/drivers/freedreno/a5xx/fd5_emit.c
@@ -310,8 +310,10 @@ emit_border_color(struct fd_context *ctx, struct fd_ringbuffer *ring) assert_dt
 
    STATIC_ASSERT(sizeof(struct bcolor_entry) == FD5_BORDER_COLOR_SIZE);
 
+   const unsigned int alignment =
+      util_next_power_of_two(FD5_BORDER_COLOR_UPLOAD_SIZE);
    u_upload_alloc(fd5_ctx->border_color_uploader, 0,
-                  FD5_BORDER_COLOR_UPLOAD_SIZE, FD5_BORDER_COLOR_UPLOAD_SIZE,
+                  FD5_BORDER_COLOR_UPLOAD_SIZE, alignment,
                   &off, &fd5_ctx->border_color_buf, &ptr);
 
    entries = ptr;
-- 
GitLab


From 96c871b9ef9d9c8bb128f8c00447571ca3d2abe0 Mon Sep 17 00:00:00 2001
From: Rohan Garg <rohan.garg@intel.com>
Date: Fri, 2 Dec 2022 15:16:25 +0530
Subject: [PATCH 4/7] util: fix ROUND_DOWN_TO alignment type
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Alignments can only be unsigned. Cast alignment to uint64_t to keep MSVC
happy.

Signed-off-by: Rohan Garg <rohan.garg@intel.com>
Reviewed-by: Erik Faye-Lund <erik.faye-lund@collabora.com>
Reviewed-by: Marek Olšák <marek.olsak@amd.com>
---
 src/util/u_math.h | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/util/u_math.h b/src/util/u_math.h
index 64b4c608744a..4c5dac1e251d 100644
--- a/src/util/u_math.h
+++ b/src/util/u_math.h
@@ -681,10 +681,10 @@ ALIGN_NPOT(uintptr_t value, int32_t alignment)
  * \sa ALIGN()
  */
 static inline uint64_t
-ROUND_DOWN_TO(uint64_t value, int32_t alignment)
+ROUND_DOWN_TO(uint64_t value, uint32_t alignment)
 {
    assert(util_is_power_of_two_nonzero(alignment));
-   return ((value) & ~(alignment - 1));
+   return ((value) & ~(uint64_t)(alignment - 1));
 }
 
 /**
-- 
GitLab


From 65f4db021a3688e05359a2c74ff9dba9ebde4e27 Mon Sep 17 00:00:00 2001
From: Rohan Garg <rohan.garg@intel.com>
Date: Fri, 2 Dec 2022 22:30:15 +0530
Subject: [PATCH 5/7] util: migrate alignment functions and macros to use
 ALIGN_POT
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rohan Garg <rohan.garg@intel.com>
Reviewed-by: Erik Faye-Lund <erik.faye-lund@collabora.com>
Reviewed-by: Marek Olšák <marek.olsak@amd.com>
---
 src/util/u_math.h | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/src/util/u_math.h b/src/util/u_math.h
index 4c5dac1e251d..374d32bd338f 100644
--- a/src/util/u_math.h
+++ b/src/util/u_math.h
@@ -49,6 +49,7 @@
 #include "u_endian.h" /* for UTIL_ARCH_BIG_ENDIAN */
 #include "util/detect_cc.h"
 #include "util/detect_arch.h"
+#include "util/macros.h"
 
 #ifdef __HAIKU__
 #include <sys/param.h>
@@ -656,7 +657,7 @@ static inline uintptr_t
 ALIGN(uintptr_t value, int32_t alignment)
 {
    assert(util_is_power_of_two_nonzero(alignment));
-   return (((value) + (alignment) - 1) & ~((alignment) - 1));
+   return ALIGN_POT(value, alignment);
 }
 
 /**
@@ -693,13 +694,15 @@ ROUND_DOWN_TO(uint64_t value, uint32_t alignment)
 static inline int
 align(int value, int alignment)
 {
-   return (value + alignment - 1) & ~(alignment - 1);
+   assert(IS_POT(alignment));
+   return ALIGN_POT(value, alignment);
 }
 
 static inline uint64_t
 align64(uint64_t value, uint64_t alignment)
 {
-   return (value + alignment - 1) & ~(alignment - 1);
+   assert(IS_POT(alignment));
+   return ALIGN_POT(value, (uint64_t)alignment);
 }
 
 /**
-- 
GitLab


From 8c31eae7b6c74f46f6f7c9ba3af3d10005709905 Mon Sep 17 00:00:00 2001
From: Rohan Garg <rohan.garg@intel.com>
Date: Fri, 2 Dec 2022 23:02:26 +0530
Subject: [PATCH 6/7] util: revert back to ALIGN since it moved to util
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rohan Garg <rohan.garg@intel.com>
Reviewed-by: Erik Faye-Lund <erik.faye-lund@collabora.com>
Reviewed-by: Marek Olšák <marek.olsak@amd.com>
---
 src/util/blob.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/src/util/blob.c b/src/util/blob.c
index a42e4a41e753..7f117907410f 100644
--- a/src/util/blob.c
+++ b/src/util/blob.c
@@ -85,7 +85,7 @@ grow_to_fit(struct blob *blob, size_t additional)
 bool
 blob_align(struct blob *blob, size_t alignment)
 {
-   const size_t new_size = align64(blob->size, alignment);
+   const size_t new_size = ALIGN(blob->size, alignment);
 
    if (blob->size < new_size) {
       if (!grow_to_fit(blob, new_size - blob->size))
@@ -102,7 +102,7 @@ blob_align(struct blob *blob, size_t alignment)
 void
 blob_reader_align(struct blob_reader *blob, size_t alignment)
 {
-   blob->current = blob->data + align64(blob->current - blob->data, alignment);
+   blob->current = blob->data + ALIGN(blob->current - blob->data, alignment);
 }
 
 void
@@ -212,7 +212,7 @@ BLOB_WRITE_TYPE(blob_write_uint64, uint64_t)
 BLOB_WRITE_TYPE(blob_write_intptr, intptr_t)
 
 #define ASSERT_ALIGNED(_offset, _align) \
-   assert(align64((_offset), (_align)) == (_offset))
+   assert(ALIGN((_offset), (_align)) == (_offset))
 
 bool
 blob_overwrite_uint8 (struct blob *blob,
-- 
GitLab


From 68c4b9e2a242b037f6109bbdf4b7ab0d5d9d975b Mon Sep 17 00:00:00 2001
From: Rohan Garg <rohan.garg@intel.com>
Date: Thu, 15 Dec 2022 17:52:20 +0100
Subject: [PATCH 7/7] util: move pot functions to use existing macros
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Rohan Garg <rohan.garg@intel.com>
Reviewed-by: Erik Faye-Lund <erik.faye-lund@collabora.com>
Reviewed-by: Marek Olšák <marek.olsak@amd.com>
---
 src/util/bitscan.h | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/src/util/bitscan.h b/src/util/bitscan.h
index 53cbb91e98c9..0e7019a60b1f 100644
--- a/src/util/bitscan.h
+++ b/src/util/bitscan.h
@@ -42,6 +42,8 @@
 #include <popcntintrin.h>
 #endif
 
+#include "macros.h"
+
 #ifdef __cplusplus
 extern "C" {
 #endif
@@ -128,7 +130,7 @@ u_bit_scan64(uint64_t *mask)
 static inline bool
 util_is_power_of_two_or_zero(unsigned v)
 {
-   return (v & (v - 1)) == 0;
+   return IS_POT(v);
 }
 
 /* Determine if an uint64_t value is a power of two.
@@ -139,7 +141,7 @@ util_is_power_of_two_or_zero(unsigned v)
 static inline bool
 util_is_power_of_two_or_zero64(uint64_t v)
 {
-   return (v & (v - 1)) == 0;
+   return IS_POT(v);
 }
 
 /* Determine if an unsigned value is a power of two.
@@ -162,7 +164,7 @@ util_is_power_of_two_nonzero(unsigned v)
 #ifdef __POPCNT__
    return _mm_popcnt_u32(v) == 1;
 #else
-   return v != 0 && (v & (v - 1)) == 0;
+   return v != 0 && IS_POT(v);
 #endif
 }
 
-- 
GitLab

