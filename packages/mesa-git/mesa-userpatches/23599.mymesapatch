From 0fc63cb570d73a7f3233ee22b07f8308e76dd7b0 Mon Sep 17 00:00:00 2001
From: Mike Blumenkrantz <michael.blumenkrantz@gmail.com>
Date: Thu, 8 Jun 2023 10:16:54 -0400
Subject: [PATCH 1/2] vk: make vk_format_map[] public

having to go through a function call for non-planar mappings can be
very slow
---
 src/vulkan/util/vk_format.c | 2 +-
 src/vulkan/util/vk_format.h | 2 ++
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/vulkan/util/vk_format.c b/src/vulkan/util/vk_format.c
index 36fb199bc42cb..7e536bc58a39a 100644
--- a/src/vulkan/util/vk_format.c
+++ b/src/vulkan/util/vk_format.c
@@ -35,7 +35,7 @@
  * Also, missing entries are zero-filled, which happens to be
  * PIPE_FORMAT_NONE.
  */
-static const enum pipe_format vk_format_map[] = {
+const enum pipe_format vk_format_map[] = {
    /* Missing R4G4 */
    [VK_FORMAT_R4G4B4A4_UNORM_PACK16] = PIPE_FORMAT_A4B4G4R4_UNORM,
    [VK_FORMAT_B4G4R4A4_UNORM_PACK16] = PIPE_FORMAT_A4R4G4B4_UNORM,
diff --git a/src/vulkan/util/vk_format.h b/src/vulkan/util/vk_format.h
index 1b9d79fd3eba3..fdd693b380110 100644
--- a/src/vulkan/util/vk_format.h
+++ b/src/vulkan/util/vk_format.h
@@ -33,6 +33,8 @@
 extern "C" {
 #endif
 
+extern const enum pipe_format vk_format_map[];
+
 enum pipe_format
 vk_format_to_pipe_format(enum VkFormat vkformat);
 
-- 
GitLab


From f2e77ff08b0537f2d997505e54c34915812ed55d Mon Sep 17 00:00:00 2001
From: Mike Blumenkrantz <michael.blumenkrantz@gmail.com>
Date: Thu, 8 Jun 2023 10:17:26 -0400
Subject: [PATCH 2/2] radv: directly use vk_format_map for vertex input

this is much faster than calling a non-inline function with
conditionals to index the same array
---
 src/amd/vulkan/radv_cmd_buffer.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/amd/vulkan/radv_cmd_buffer.c b/src/amd/vulkan/radv_cmd_buffer.c
index 3611e018af1c4..03fd1945cc1a9 100644
--- a/src/amd/vulkan/radv_cmd_buffer.c
+++ b/src/amd/vulkan/radv_cmd_buffer.c
@@ -7345,7 +7345,7 @@ radv_CmdSetVertexInputEXT(VkCommandBuffer commandBuffer, uint32_t vertexBindingD
       cmd_buffer->vertex_bindings[attrib->binding].stride = binding->stride;
       vs_state->offsets[loc] = attrib->offset;
 
-      enum pipe_format format = vk_format_to_pipe_format(attrib->format);
+      enum pipe_format format = vk_format_map[attrib->format];
       const struct ac_vtx_format_info *vtx_info = &vtx_info_table[format];
 
       vs_state->formats[loc] = format;
-- 
GitLab

