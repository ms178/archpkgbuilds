From 1daf9de8550f155201277f9fd65c56b1b300c97e Mon Sep 17 00:00:00 2001
From: Julia Tatz <tatz.j@northeastern.edu>
Date: Fri, 2 Jun 2023 00:38:03 -0400
Subject: [PATCH] meson: control using LD Version Scripts

LD version scripts are meant to be used when visibility attributes can't be used*,
and have compat issues with other linkers.
When a symbol in the linker script is missing, LD will ignore it, mold will warn,
and LLD will error

*if only using the global & local sections, as is done in mesa. For specfic version
sections, the `symver` attribute is the replacement, which clang doesn't support yet.
---
 meson.build       | 10 +++++-----
 meson_options.txt |  7 +++++++
 2 files changed, 12 insertions(+), 5 deletions(-)

diff --git a/meson.build b/meson.build
index e48ae49e17cda..5fca5636d7d82 100644
--- a/meson.build
+++ b/meson.build
@@ -1402,13 +1402,13 @@ ld_args_bsymbolic = []
 if cc.links('int main() { return 0; }', args : '-Wl,-Bsymbolic', name : 'Bsymbolic')
   ld_args_bsymbolic += '-Wl,-Bsymbolic'
 endif
-with_ld_version_script = false
-if cc.links('int main() { return 0; }',
+with_ld_version_script = get_option('ld-version-scripts').require(
+  cc.links('int main() { return 0; }',
             args : '-Wl,--version-script=@0@'.format(
               join_paths(meson.current_source_dir(), 'build-support/conftest.map')),
-            name : 'version-script')
-  with_ld_version_script = true
-endif
+            name : 'version-script'),
+  error_message: 'linker does not have `--version-script` support'
+).allowed()
 with_ld_dynamic_list = false
 if cc.links('int main() { return 0; }',
             args : '-Wl,--dynamic-list=@0@'.format(
diff --git a/meson_options.txt b/meson_options.txt
index 384f984ad57f6..e2e280dc87839 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -671,3 +671,10 @@ option (
   value : 'disabled',
   description: 'Enable Intel Xe KMD support.'
 )
+
+option (
+  'ld-version-scripts',
+  type : 'feature',
+  value : 'auto',
+  description: 'Enable using LD Version Scripts.'
+)
-- 
GitLab

