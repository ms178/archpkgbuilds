From 13f3bf00b37265071e3541a1416f1f763324ddb1 Mon Sep 17 00:00:00 2001
From: Georg Lehmann <dadschoorse@gmail.com>
Date: Fri, 8 Jul 2022 19:16:48 +0200
Subject: [PATCH] nir/opt_algebraic: Optimize check for single bit.

Foz-DB Navi21:
Totals from 3239 (2.40% of 134913) affected shaders:
CodeSize: 17426512 -> 17384200 (-0.24%); split: -0.31%, +0.07%
Instrs: 3194264 -> 3185941 (-0.26%); split: -0.28%, +0.02%
Latency: 20498012 -> 20489586 (-0.04%); split: -0.05%, +0.01%
InvThroughput: 3311738 -> 3311942 (+0.01%); split: -0.00%, +0.01%
VClause: 51047 -> 51048 (+0.00%)
SClause: 145810 -> 145930 (+0.08%); split: -0.12%, +0.21%
Copies: 171748 -> 170718 (-0.60%); split: -1.04%, +0.44%
PreSGPRs: 138036 -> 137860 (-0.13%); split: -0.28%, +0.15%
PreVGPRs: 138540 -> 138557 (+0.01%)

Signed-off-by: Georg Lehmann <dadschoorse@gmail.com>
---
 src/compiler/nir/nir_opt_algebraic.py | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/src/compiler/nir/nir_opt_algebraic.py b/src/compiler/nir/nir_opt_algebraic.py
index 9ab8542b0ff5..224f381c7e89 100644
--- a/src/compiler/nir/nir_opt_algebraic.py
+++ b/src/compiler/nir/nir_opt_algebraic.py
@@ -159,6 +159,8 @@ optimizations = [
    (('iadd', ('imul', a, b), ('imul', a, c)), ('imul', a, ('iadd', b, c))),
    (('iand', ('ior', a, b), ('ior', a, c)), ('ior', a, ('iand', b, c))),
    (('ior', ('iand', a, b), ('iand', a, c)), ('iand', a, ('ior', b, c))),
+   (('ieq', ('iand', a, '#b(is_pos_power_of_two)'), b), ('i2b', ('iand', a, b))),
+   (('ine', ('iand', a, '#b(is_pos_power_of_two)'), b), ('ieq', ('iand', a, b), 0)),
    (('~fadd', ('fneg', a), a), 0.0),
    (('iadd', ('ineg', a), a), 0),
    (('iadd', ('ineg', a), ('iadd', a, b)), b),
-- 
GitLab

