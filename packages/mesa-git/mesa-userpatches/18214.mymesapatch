From 5cfb7cbc7fa82bb0b3a8ab4556a4a7ed22aca347 Mon Sep 17 00:00:00 2001
From: Adam Jackson <ajax@redhat.com>
Date: Mon, 22 Aug 2022 15:46:42 -0400
Subject: [PATCH 1/3] egl: Move an error check earlier in EGL_BUFFER_AGE_EXT
 query

I can't think of any good reason to call down to the driver and _then_
check whether your calling context was already bad.

Reviewed-by: Eric Engestrom <eric@igalia.com>
---
 src/egl/main/eglsurface.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/src/egl/main/eglsurface.c b/src/egl/main/eglsurface.c
index 9167b9b7eed0..ae356e8d87b0 100644
--- a/src/egl/main/eglsurface.c
+++ b/src/egl/main/eglsurface.c
@@ -559,14 +559,14 @@ _eglQuerySurface(_EGLDisplay *disp, _EGLSurface *surface,
          return _eglError(EGL_BAD_ATTRIBUTE, "eglQuerySurface");
 
       _EGLContext *ctx = _eglGetCurrentContext();
-      EGLint result = disp->Driver->QueryBufferAge(disp, surface);
-      /* error happened */
-      if (result < 0)
-         return EGL_FALSE;
       if (_eglGetContextHandle(ctx) == EGL_NO_CONTEXT ||
           ctx->DrawSurface != surface)
          return _eglError(EGL_BAD_SURFACE, "eglQuerySurface");
 
+      EGLint result = disp->Driver->QueryBufferAge(disp, surface);
+      if (result < 0)
+         return EGL_FALSE;
+
       *value = result;
       surface->BufferAgeRead = EGL_TRUE;
       break;
-- 
GitLab


From 3a11e2325cdb390c0d5f37970ea22b5624fd3e04 Mon Sep 17 00:00:00 2001
From: Adam Jackson <ajax@redhat.com>
Date: Mon, 22 Aug 2022 17:03:45 -0400
Subject: [PATCH 2/3] wsi/x11: Defer clearing image busy flag for non-shm
 upload

The image is busy until xcb_put_image returns. This isn't a major worry
at the moment since we're doing the PutImage directly from
vkQueuePresent, but if we moved that to a worker thread the race window
would be a lot easier to hit.
---
 src/vulkan/wsi/wsi_common_x11.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/vulkan/wsi/wsi_common_x11.c b/src/vulkan/wsi/wsi_common_x11.c
index 26083b114059..96f74ce9f8e3 100644
--- a/src/vulkan/wsi/wsi_common_x11.c
+++ b/src/vulkan/wsi/wsi_common_x11.c
@@ -1313,7 +1313,6 @@ x11_present_to_x11_sw(struct x11_swapchain *chain, uint32_t image_index,
    int stride_b = image->base.row_pitches[0];
    size_t size = (hdr_len + stride_b * chain->extent.height) >> 2;
    uint64_t max_req_len = xcb_get_maximum_request_length(chain->conn);
-   chain->images[image_index].busy = false;
 
    if (size < max_req_len) {
       cookie = xcb_put_image(chain->conn, XCB_IMAGE_FORMAT_Z_PIXMAP,
@@ -1345,6 +1344,7 @@ x11_present_to_x11_sw(struct x11_swapchain *chain, uint32_t image_index,
       }
    }
 
+   chain->images[image_index].busy = false;
    xcb_flush(chain->conn);
    return x11_swapchain_result(chain, VK_SUCCESS);
 }
-- 
GitLab


From 31de8a6d883ecf281adc420ef8276e928300ae46 Mon Sep 17 00:00:00 2001
From: Adam Jackson <ajax@redhat.com>
Date: Tue, 23 Aug 2022 12:41:35 -0400
Subject: [PATCH 3/3] egl/kopper: Don't add EGL_SWAP_BEHAVIOR_PRESERVED_BIT
 configs

It's strictly inferior to EGL_EXT_buffer_age so apps shouldn't bother to
begin with, and we don't communicate the surface preservation state to
the backend so we don't handle it correctly in any case.

Acked-by: Eric Engestrom <eric@igalia.com>
---
 src/egl/drivers/dri2/platform_x11.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/egl/drivers/dri2/platform_x11.c b/src/egl/drivers/dri2/platform_x11.c
index b6fbd86925e1..eac1661b3fa8 100644
--- a/src/egl/drivers/dri2/platform_x11.c
+++ b/src/egl/drivers/dri2/platform_x11.c
@@ -1498,7 +1498,7 @@ dri2_initialize_x11_swrast(_EGLDisplay *disp)
       disp->Extensions.ANGLE_sync_control_rate = EGL_TRUE;
    }
 
-   if (!dri2_x11_add_configs_for_visuals(dri2_dpy, disp, true))
+   if (!dri2_x11_add_configs_for_visuals(dri2_dpy, disp, !disp->Options.Zink))
       goto cleanup;
 
    /* Fill vtbl last to prevent accidentally calling virtual function during
-- 
GitLab

