From 3c2852dde5d9b751da0c45cc12e6a13d9fea36fa Mon Sep 17 00:00:00 2001
From: "Thomas H.P. Andersen" <phomes@gmail.com>
Date: Mon, 28 Jul 2025 00:57:14 +0200
Subject: [PATCH] anti-lag: pass a proper dataSize
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

dataSize was passed as sizeof(uint64_t)

From spec:
dataSize is the size in bytes of the buffer pointed to by pData.
dataSize must be large enough to contain the result of each query

The NVK driver checks that the dataSize is large enough and hit an assert.

This patch changes dataSize to sizeof(struct query) * num_timestamps.

Reviewed-by: Daniel Sch√ºrmann <daniel@schuermann.dev>
---
 src/vulkan/anti-lag-layer/anti_lag_layer.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/vulkan/anti-lag-layer/anti_lag_layer.c b/src/vulkan/anti-lag-layer/anti_lag_layer.c
index f730ca00f9c93..2b0da0babe3e9 100644
--- a/src/vulkan/anti-lag-layer/anti_lag_layer.c
+++ b/src/vulkan/anti-lag-layer/anti_lag_layer.c
@@ -67,8 +67,10 @@ evaluate_frame(device_context *ctx, frame *frame, bool force_wait)
       while (num_timestamps > 0) {
          /* Retreive timestamp results from this queue. */
          ctx->vtable.GetQueryPoolResults(ctx->device, queue_ctx->queryPool, query_idx,
-                                         num_timestamps, sizeof(uint64_t), &query->begin_gpu_ts,
-                                         sizeof(struct query), query_flags);
+                                         num_timestamps,
+                                         sizeof(struct query) * num_timestamps,
+                                         &query->begin_gpu_ts, sizeof(struct query),
+                                         query_flags);
 
          ringbuffer_lock(queue_ctx->queries);
          for (unsigned j = 0; j < num_timestamps; j++) {
-- 
GitLab

