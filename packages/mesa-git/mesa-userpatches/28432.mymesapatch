From 355eba1937ab8f30bdf5e3bcb01a3ec3fcfd6162 Mon Sep 17 00:00:00 2001
From: Derek Foreman <derek.foreman@collabora.com>
Date: Wed, 27 Mar 2024 12:00:37 -0500
Subject: [PATCH] vulkan/wsi/wayland: Fix use after free

In 7eaceb03921e I called pthread_mutex_unlock() with a member of a freed
structure.

We can unlock as soon as this element is removed from the list it was in,
so just move the unlock to before the free.

Fixes 7eaceb03921e

Signed-off-by: Derek Foreman <derek.foreman@collabora.com>
---
 src/vulkan/wsi/wsi_common_wayland.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/vulkan/wsi/wsi_common_wayland.c b/src/vulkan/wsi/wsi_common_wayland.c
index 6f8fc44c43df5..5da5f3ce41bf9 100644
--- a/src/vulkan/wsi/wsi_common_wayland.c
+++ b/src/vulkan/wsi/wsi_common_wayland.c
@@ -1874,8 +1874,8 @@ wsi_wl_presentation_update_present_id(struct wsi_wl_present_id *id)
       id->chain->present_ids.max_completed = id->present_id;
 
    wl_list_remove(&id->link);
-   vk_free(id->alloc, id);
    pthread_mutex_unlock(&id->chain->present_ids.lock);
+   vk_free(id->alloc, id);
 }
 
 static void
-- 
GitLab

