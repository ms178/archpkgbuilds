From 16e1431add33a7890cefdcf6a92915d5661e5947 Mon Sep 17 00:00:00 2001
From: Turo Lamminen <turo.lamminen@alternativegames.net>
Date: Mon, 22 Jan 2024 14:31:29 +0200
Subject: [PATCH] radv: Optimize memcpy in write_image_descriptor

The size parameter can only take certain values. Make this visible to
the compiler to encourage it to inline the memcpy.

330% gain on vkoverhead test descriptor_16combined_sampler on i5-2500 CPU.
---
 src/amd/vulkan/radv_descriptor_set.c | 22 +++++++++++++++++++++-
 1 file changed, 21 insertions(+), 1 deletion(-)

diff --git a/src/amd/vulkan/radv_descriptor_set.c b/src/amd/vulkan/radv_descriptor_set.c
index e0a4afa1de20d..5ba765b45fa7d 100644
--- a/src/amd/vulkan/radv_descriptor_set.c
+++ b/src/amd/vulkan/radv_descriptor_set.c
@@ -1200,7 +1200,27 @@ write_image_descriptor(unsigned *dst, unsigned size, VkDescriptorType descriptor
    }
    assert(size > 0);
 
-   memcpy(dst, descriptor, size);
+   // Encourage compiler to inline memcpy
+   switch (size) {
+   case 16:
+      memcpy(dst, descriptor, 16);
+      break;
+
+   case 32:
+      memcpy(dst, descriptor, 32);
+      break;
+
+   case 64:
+      memcpy(dst, descriptor, 64);
+      break;
+
+   case 80:
+      memcpy(dst, descriptor, 80);
+      break;
+
+   default:
+      unreachable("Invalid size");
+   }
 }
 
 static ALWAYS_INLINE void
-- 
GitLab

