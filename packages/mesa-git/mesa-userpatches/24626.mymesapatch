From e3d2adc80edd6ef438c5ec074fd2fb52bec961b2 Mon Sep 17 00:00:00 2001
From: David Rosca <nowrep@gmail.com>
Date: Thu, 10 Aug 2023 22:05:12 +0200
Subject: [PATCH] gallium/auxiliary/vl: Set correct csc matrix in
 set_buffer_layer

Shaders used in set_buffer_layer will apply colorspace conversion,
so we need to set correct matrix depending on the input and output
surface formats.
Use BT.601 (default) for YUV to RGB and identity for RGB to RGB.

Reviewed-by: Leo Liu <leo.liu@amd.com>
---
 src/gallium/auxiliary/vl/vl_compositor.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/gallium/auxiliary/vl/vl_compositor.c b/src/gallium/auxiliary/vl/vl_compositor.c
index 108c92c8bdb60..9246be31af35c 100644
--- a/src/gallium/auxiliary/vl/vl_compositor.c
+++ b/src/gallium/auxiliary/vl/vl_compositor.c
@@ -559,6 +559,7 @@ vl_compositor_set_buffer_layer(struct vl_compositor_state *s,
 {
    struct pipe_sampler_view **sampler_views;
    unsigned i;
+   vl_csc_matrix csc_matrix;
 
    assert(s && c && buffer);
 
@@ -615,6 +616,12 @@ vl_compositor_set_buffer_layer(struct vl_compositor_state *s,
       else if (c->pipe_gfx_supported)
          s->layers[layer].fs = c->fs_video_buffer;
    }
+
+   vl_csc_get_matrix(util_format_is_yuv(buffer->buffer_format) ?
+                     VL_CSC_COLOR_STANDARD_BT_601 :
+                     VL_CSC_COLOR_STANDARD_IDENTITY,
+                     NULL, true, &csc_matrix);
+   vl_compositor_set_csc_matrix(s, &csc_matrix, 1.0f, 0.0f);
 }
 
 void
-- 
GitLab

