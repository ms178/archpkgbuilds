From 796dc6f62b820c729abf63775bfa0bbbfb742b11 Mon Sep 17 00:00:00 2001
From: Rhys Perry <pendingchaos02@gmail.com>
Date: Wed, 6 Mar 2024 11:37:27 +0000
Subject: [PATCH] aco: don't pass constant to is_overwritten_since()

Fixes usage of uninitialised value in dead_space/065515347dca4851 and
other dead_space shaders.

Signed-off-by: Rhys Perry <pendingchaos02@gmail.com>
Reviewed-by: Georg Lehmann <dadschoorse@gmail.com>
Fixes: def0c275c460 ("aco: Eliminate SCC copies when possible.")
---
 src/amd/compiler/aco_optimizer_postRA.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/amd/compiler/aco_optimizer_postRA.cpp b/src/amd/compiler/aco_optimizer_postRA.cpp
index 5e24b72eb4720..39bbff4a660ca 100644
--- a/src/amd/compiler/aco_optimizer_postRA.cpp
+++ b/src/amd/compiler/aco_optimizer_postRA.cpp
@@ -524,7 +524,7 @@ try_eliminate_scc_copy(pr_opt_ctx& ctx, aco_ptr<Instruction>& instr)
 
    /* Verify that the operands of the producer instruction haven't been overwritten. */
    for (const Operand& op : producer_instr->operands) {
-      if (is_overwritten_since(ctx, op, producer_idx, true))
+      if (!op.isConstant() && is_overwritten_since(ctx, op, producer_idx, true))
          return;
    }
 
-- 
GitLab

