From f48bee42fea8f147b7ea401c0ca65cbb913bdeec Mon Sep 17 00:00:00 2001
From: Erik Faye-Lund <erik.faye-lund@collabora.com>
Date: Fri, 20 Jan 2023 11:39:27 +0100
Subject: [PATCH] radeonsi: respect smoothing_enabled

When this was last changed, the smoothing_enabled flag seems to have
been forgotten about, breaking line-smoothing (and probably also polygon
smoothing).

Fixes: 4147add280e ("radeonsi: update db_eqaa even if msaa is disabled")
---
 src/amd/ci/radeonsi-raven-fails.txt     | 1 -
 src/amd/ci/radeonsi-stoney-fails.txt    | 1 -
 src/gallium/drivers/radeonsi/si_state.c | 6 ++++--
 3 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/src/amd/ci/radeonsi-raven-fails.txt b/src/amd/ci/radeonsi-raven-fails.txt
index 97629fed0a1d..8630abe1cc26 100644
--- a/src/amd/ci/radeonsi-raven-fails.txt
+++ b/src/amd/ci/radeonsi-raven-fails.txt
@@ -192,5 +192,4 @@ spec@!opengl 1.0@gl-1.0-user-clip-all-planes,Fail
 # https://gitlab.freedesktop.org/mesa/mesa/-/issues/7152
 spec@ext_transform_feedback@builtin-varyings gl_culldistance,Fail
 
-spec@!opengl 1.1@line-smooth-coverage,Fail
 spec@!opengl 1.1@line-smooth-stipple,Fail
diff --git a/src/amd/ci/radeonsi-stoney-fails.txt b/src/amd/ci/radeonsi-stoney-fails.txt
index 772f6a0dcb34..600ab913899a 100644
--- a/src/amd/ci/radeonsi-stoney-fails.txt
+++ b/src/amd/ci/radeonsi-stoney-fails.txt
@@ -237,5 +237,4 @@ spec@khr_texture_compression_astc@sliced-3d-miptree-gl srgb-fp@sRGB decode full
 spec@khr_texture_compression_astc@sliced-3d-miptree-gles srgb-fp,Fail
 spec@khr_texture_compression_astc@sliced-3d-miptree-gles srgb-fp@sRGB decode full precision,Fail
 
-spec@!opengl 1.1@line-smooth-coverage,Fail
 spec@!opengl 1.1@line-smooth-stipple,Fail
diff --git a/src/gallium/drivers/radeonsi/si_state.c b/src/gallium/drivers/radeonsi/si_state.c
index b9a9b8949ed7..9129d4172710 100644
--- a/src/gallium/drivers/radeonsi/si_state.c
+++ b/src/gallium/drivers/radeonsi/si_state.c
@@ -3804,7 +3804,8 @@ static void si_emit_msaa_config(struct si_context *sctx)
    unsigned sc_line_cntl = 0;
    unsigned sc_aa_config = 0;
 
-   if (coverage_samples > 1 && rs->multisample_enable) {
+   if (coverage_samples > 1 && (rs->multisample_enable ||
+                                sctx->smoothing_enabled)) {
       /* distance from the pixel center, indexed by log2(nr_samples) */
       static unsigned max_dist[] = {
          0, /* unused */
@@ -3826,7 +3827,8 @@ static void si_emit_msaa_config(struct si_context *sctx)
                      S_028BE0_COVERED_CENTROID_IS_CENTER(sctx->gfx_level >= GFX10_3);
    }
 
-   if (sctx->framebuffer.nr_samples > 1) {
+   if (sctx->framebuffer.nr_samples > 1 ||
+       sctx->smoothing_enabled) {
       if (sctx->framebuffer.state.zsbuf) {
          z_samples = sctx->framebuffer.state.zsbuf->texture->nr_samples;
          z_samples = MAX2(1, z_samples);
-- 
GitLab

