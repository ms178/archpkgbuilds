From 1b18277056a611df7bf15d4216645e1a6e43d5ea Mon Sep 17 00:00:00 2001
From: Jasber Chen <yipeng.chen@amd.corp-partner.google.com>
Date: Fri, 18 Nov 2022 13:29:33 +0800
Subject: [PATCH] gallium: partially updating RefPicList depends on slice type

problem casused by one frame with multiple slices and different slices type.
Invalid referenced values came from slice P/I would overwrite previous update.
---
 src/gallium/frontends/va/picture_hevc.c | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

diff --git a/src/gallium/frontends/va/picture_hevc.c b/src/gallium/frontends/va/picture_hevc.c
index 881adda03a6b..9bc45e7f19c0 100644
--- a/src/gallium/frontends/va/picture_hevc.c
+++ b/src/gallium/frontends/va/picture_hevc.c
@@ -228,9 +228,17 @@ void vlVaHandleSliceParameterBufferHEVC(vlVaContext *context, vlVaBuffer *buf)
    VASliceParameterBufferHEVC *h265 = buf->data;
 
    assert(buf->size >= sizeof(VASliceParameterBufferHEVC) && buf->num_elements == 1);
-   for (int i = 0 ; i < 2 ; i++) {
-      for (int j = 0 ; j < 15 ; j++)
-         context->desc.h265.RefPicList[i][j] = h265->RefPicList[i][j];
+
+   switch(h265->LongSliceFlags.fields.slice_type)
+   {
+      // Depending on slice_type, only update relevant reference
+      case 0: // HEVC_SLICE_B
+         for (int j = 0 ; j < 15 ; j++)
+            context->desc.h265.RefPicList[1][j] = h265->RefPicList[1][j];
+         // go down
+      case 1: // HEVC_SLICE_P
+         for (int j = 0 ; j < 15 ; j++)
+            context->desc.h265.RefPicList[0][j] = h265->RefPicList[0][j];
    }
    context->desc.h265.UseRefPicList = true;
 
-- 
GitLab

