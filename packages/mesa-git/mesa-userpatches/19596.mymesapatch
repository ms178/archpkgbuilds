From 23eb83094391880ba621ec5f41b6185889af0d5f Mon Sep 17 00:00:00 2001
From: Simon Ser <contact@emersion.fr>
Date: Tue, 8 Nov 2022 15:29:10 +0100
Subject: [PATCH] vulkan/wsi/wayland: fix 24-bit RGB formats

VK_FORMAT_R8G8B8_* and VK_FORMAT_B8G8R8_* are 24-bit formats.
DRM_FORMAT_XBGR8888 and DRM_FORMAT_XRGB8888 aren't suitable to
implement these, since they are 32-bit.

Instead, use DRM_FORMAT_BGR888 and DRM_FORMAT_RGB888, which have
the correct depth.

Signed-off-by: Simon Ser <contact@emersion.fr>
---
 src/vulkan/wsi/wsi_common_wayland.c | 40 ++++++++++++++++-------------
 1 file changed, 22 insertions(+), 18 deletions(-)

diff --git a/src/vulkan/wsi/wsi_common_wayland.c b/src/vulkan/wsi/wsi_common_wayland.c
index 4e3381bcaab9..14f6af758828 100644
--- a/src/vulkan/wsi/wsi_common_wayland.c
+++ b/src/vulkan/wsi/wsi_common_wayland.c
@@ -387,14 +387,6 @@ wsi_wl_display_add_drm_format_modifier(struct wsi_wl_display *display,
     * From Wayland's perspective nothing changes, the difference is just how
     * Vulkan interprets the pixel data. */
    case DRM_FORMAT_XBGR8888:
-      wsi_wl_display_add_vk_format_modifier(display, formats,
-                                            VK_FORMAT_R8G8B8_SRGB,
-                                            WSI_WL_FMT_ALPHA | WSI_WL_FMT_OPAQUE,
-                                            modifier);
-      wsi_wl_display_add_vk_format_modifier(display, formats,
-                                            VK_FORMAT_R8G8B8_UNORM,
-                                            WSI_WL_FMT_ALPHA | WSI_WL_FMT_OPAQUE,
-                                            modifier);
       wsi_wl_display_add_vk_format_modifier(display, formats,
                                             VK_FORMAT_R8G8B8A8_SRGB,
                                             WSI_WL_FMT_OPAQUE, modifier);
@@ -411,14 +403,6 @@ wsi_wl_display_add_drm_format_modifier(struct wsi_wl_display *display,
                                             WSI_WL_FMT_ALPHA, modifier);
       break;
    case DRM_FORMAT_XRGB8888:
-      wsi_wl_display_add_vk_format_modifier(display, formats,
-                                            VK_FORMAT_B8G8R8_SRGB,
-                                            WSI_WL_FMT_ALPHA | WSI_WL_FMT_OPAQUE,
-                                            modifier);
-      wsi_wl_display_add_vk_format_modifier(display, formats,
-                                            VK_FORMAT_B8G8R8_UNORM,
-                                            WSI_WL_FMT_ALPHA | WSI_WL_FMT_OPAQUE,
-                                            modifier);
       wsi_wl_display_add_vk_format_modifier(display, formats,
                                             VK_FORMAT_B8G8R8A8_SRGB,
                                             WSI_WL_FMT_OPAQUE, modifier);
@@ -434,6 +418,26 @@ wsi_wl_display_add_drm_format_modifier(struct wsi_wl_display *display,
                                             VK_FORMAT_B8G8R8A8_UNORM,
                                             WSI_WL_FMT_ALPHA, modifier);
       break;
+   case DRM_FORMAT_BGR888:
+      wsi_wl_display_add_vk_format_modifier(display, formats,
+                                            VK_FORMAT_R8G8B8_SRGB,
+                                            WSI_WL_FMT_ALPHA | WSI_WL_FMT_OPAQUE,
+                                            modifier);
+      wsi_wl_display_add_vk_format_modifier(display, formats,
+                                            VK_FORMAT_R8G8B8_UNORM,
+                                            WSI_WL_FMT_ALPHA | WSI_WL_FMT_OPAQUE,
+                                            modifier);
+      break;
+   case DRM_FORMAT_RGB888:
+      wsi_wl_display_add_vk_format_modifier(display, formats,
+                                            VK_FORMAT_B8G8R8_SRGB,
+                                            WSI_WL_FMT_ALPHA | WSI_WL_FMT_OPAQUE,
+                                            modifier);
+      wsi_wl_display_add_vk_format_modifier(display, formats,
+                                            VK_FORMAT_B8G8R8_UNORM,
+                                            WSI_WL_FMT_ALPHA | WSI_WL_FMT_OPAQUE,
+                                            modifier);
+      break;
    }
 }
 
@@ -494,13 +498,13 @@ wl_drm_format_for_vk_format(VkFormat vk_format, bool alpha)
 #endif
    case VK_FORMAT_R8G8B8_UNORM:
    case VK_FORMAT_R8G8B8_SRGB:
-      return DRM_FORMAT_XBGR8888;
+      return DRM_FORMAT_BGR888;
    case VK_FORMAT_R8G8B8A8_UNORM:
    case VK_FORMAT_R8G8B8A8_SRGB:
       return alpha ? DRM_FORMAT_ABGR8888 : DRM_FORMAT_XBGR8888;
    case VK_FORMAT_B8G8R8_UNORM:
    case VK_FORMAT_B8G8R8_SRGB:
-      return DRM_FORMAT_BGRX8888;
+      return DRM_FORMAT_RGB888;
    case VK_FORMAT_B8G8R8A8_UNORM:
    case VK_FORMAT_B8G8R8A8_SRGB:
       return alpha ? DRM_FORMAT_ARGB8888 : DRM_FORMAT_XRGB8888;
-- 
GitLab

