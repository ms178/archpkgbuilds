From a9b6005ab46a38bff25a3d6a5d6ba3ff905a2442 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marek=20Ol=C5=A1=C3=A1k?= <marek.olsak@amd.com>
Date: Thu, 13 Apr 2023 17:05:57 -0400
Subject: [PATCH 1/2] nir: handle undef in scalar ALU opcode srcs

- Floating-point ALU opcodes are replaced with 0 or the whole opcode is
  replaced with undef based on the new NIR option.
- Integer comparison opcodes are always replaced with undef.
- Other ALU opcodes are replaced with 0.

radeonsi replacing undef with 0:

|     AFFECTED APPS      | Shaders |  SGPRs  |  VGPRs  |SpillSGPR|SpillVGPR|PrivVGPR | Scratch |CodeSize |MaxWaves | Outputs |PatchOuts|
|------------------------|---------|---------|---------|---------|---------|---------|---------|---------|---------|---------|---------|
| divinity               |     1052|   0.02 %|    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
| gimark-0.7.0           |       10|    .    |    .    |    .    |    .    |    .    |    .    |  -0.39 %|    .    |    .    |    .    |
| gtk4                   |       98|    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
| hitman                 |     1413|    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
| metro_2033_redux       |     2670|    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
| ue4_effects_cave       |      290|  -0.48 %|  -0.09 %|    .    |    .    |    .    |    .    |  -0.18 %|   0.10 %|    .    |    .    |
| vp13-catia             |      109|  -2.44 %|    .    |    .    |    .    |    .    |    .    |  -0.14 %|    .    |    .    |    .    |
| vp13-creo              |       26|  -1.35 %|    .    |    .    |    .    |    .    |    .    |  -2.58 %|    .    |    .    |    .    |
| vp20-creo              |       22|  -1.64 %|   0.46 %|    .    |    .    |    .    |    .    |  -2.30 %|  -0.37 %|    .    |    .    |
| vp20-sw                |      296|    .    |    .    |    .    |    .    |    .    |    .    |  -0.21 %|    .    |    .    |    .    |
| wasteland2             |       76|    .    |    .    |    .    |    .    |    .    |    .    |  -0.66 %|    .    |    .    |    .    |
|------------------------|---------|---------|---------|---------|---------|---------|---------|---------|---------|---------|---------|
| All affected shaders   |       93|  -4.86 %|  -0.10 %|    .    |    .    |    .    |    .    |  -1.92 %|   0.30 %|    .    |    .    |

radeonsi replacing undef with 0 excpet FP opcodes are replaced with undef:

|     AFFECTED APPS      | Shaders |  SGPRs  |  VGPRs  |SpillSGPR|SpillVGPR|PrivVGPR | Scratch |CodeSize |MaxWaves | Outputs |PatchOuts|
|------------------------|---------|---------|---------|---------|---------|---------|---------|---------|---------|---------|---------|
| divinity               |     1052|  -0.05 %|  -0.08 %|    .    |    .    |    .    |    .    |  -0.12 %|    .    |    .    |    .    |
| gimark-0.7.0           |       10|  -9.68 %| -13.16 %|    .    |    .    |    .    |    .    | -30.84 %|    .    | -27.27 %|    .    |
| hitman                 |     1413|    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |    .    |
| metro_2033_redux       |     2670|    .    |  -0.04 %|    .    |    .    |    .    |    .    |  -0.03 %|    .    |    .    |    .    |
| ue4_effects_cave       |      290|  -0.48 %|  -0.09 %|    .    |    .    |    .    |    .    |  -0.20 %|   0.10 %|    .    |    .    |
| vp13-catia             |      109|  -4.89 %|  -8.65 %|    .    |    .    |    .    |    .    |  -2.39 %|   6.56 %| -13.82 %|    .    |
| vp13-creo              |       26|  -1.35 %|    .    |    .    |    .    |    .    |    .    |  -2.58 %|    .    |    .    |    .    |
| vp20-creo              |       22|  -1.64 %|   0.46 %|    .    |    .    |    .    |    .    |  -2.30 %|  -0.37 %|    .    |    .    |
| vp20-sw                |      296|    .    |    .    |    .    |    .    |    .    |    .    |  -0.21 %|    .    |    .    |    .    |
| wasteland2             |       76|    .    |    .    |    .    |    .    |    .    |    .    |  -0.66 %|    .    |    .    |    .    |
|------------------------|---------|---------|---------|---------|---------|---------|---------|---------|---------|---------|---------|
| All affected shaders   |       92|  -9.11 %|  -8.51 %|    .    |    .    |    .    |    .    |  -3.21 %|  10.37 %| -12.46 %|    .    |

The viewperf benefit is not realized because of non-conformant viewperf
behavior (the workaround is added too).
---
 src/compiler/nir/nir.h           | 23 ++++++++++
 src/compiler/nir/nir_opt_undef.c | 76 +++++++++++++++++++++++++++++++-
 2 files changed, 98 insertions(+), 1 deletion(-)

diff --git a/src/compiler/nir/nir.h b/src/compiler/nir/nir.h
index 4c3fa21651ab..5fc05e731b92 100644
--- a/src/compiler/nir/nir.h
+++ b/src/compiler/nir/nir.h
@@ -3389,6 +3389,23 @@ typedef enum {
    nir_pack_varying_interp_loc_center         = (1 << 18),
 } nir_pack_varying_options;
 
+typedef enum {
+   /* Convert undef float to 0 in ALU opcode sources.
+    * This is the default behavior.
+    */
+   nir_undef_float_zero,
+
+   /* Replace ALU opcodes sourcing undef with undef.
+    * This generates the best code and eliminates more shader inputs, outputs,
+    * and uniforms at the expense of having less precise behavior, such as
+    * causing "store(NaN + undef)" to be removed.
+    */
+   nir_undef_float_undef,
+
+   /* Don't touch undef float. */
+   nir_undef_float_keep,
+} nir_undef_float_behavior;
+
 /** An instruction filtering callback
  *
  * Returns true if the instruction should be processed and false otherwise.
@@ -3856,6 +3873,12 @@ typedef struct nir_shader_compiler_options {
     *  of adding it to the atomic source
     */
    bool lower_atomic_offset_to_range_base;
+
+   /**
+    * Replace floating-point ALU opcodes consuming undef with zero or undef.
+    * See nir_undef_float_behavior.
+    */
+   nir_undef_float_behavior undef_float_behavior;
 } nir_shader_compiler_options;
 
 typedef struct nir_shader {
diff --git a/src/compiler/nir/nir_opt_undef.c b/src/compiler/nir/nir_opt_undef.c
index effd9d0057a4..7b8f4de525f4 100644
--- a/src/compiler/nir/nir_opt_undef.c
+++ b/src/compiler/nir/nir_opt_undef.c
@@ -189,12 +189,86 @@ opt_undef_pack(nir_builder *b, nir_alu_instr *alu)
    return true;
 }
 
+static bool
+opt_undef_scalar_math_alu(nir_builder *b, nir_alu_instr *alu)
+{
+   if (nir_dest_num_components(alu->dest.dest) != 1)
+      return false;
+
+   unsigned num_srcs = nir_op_infos[alu->op].num_inputs;
+   bool has_undef = false;
+
+   for (unsigned i = 0; i < num_srcs; i++) {
+      if (nir_src_is_undef(alu->src[i].src)) {
+         has_undef = true;
+         break;
+      }
+   }
+
+   if (!has_undef)
+      return false;
+
+   bool replace_with_undef = false;
+
+   switch (alu->op) {
+   case nir_op_ieq:
+   case nir_op_ige:
+   case nir_op_ilt:
+   case nir_op_ine:
+   case nir_op_uge:
+   case nir_op_ult:
+      replace_with_undef = true;
+      break;
+
+   default:
+      if (nir_op_infos[alu->op].output_type & nir_type_float ||
+          nir_op_infos[alu->op].input_types[0] & nir_type_float) {
+         switch (b->shader->options->undef_float_behavior) {
+         case nir_undef_float_zero:
+            break;
+
+         case nir_undef_float_undef:
+            replace_with_undef = true;
+            break;
+
+         case nir_undef_float_keep:
+            return false;
+         }
+      }
+      break;
+   }
+
+   b->cursor = nir_before_instr(&alu->instr);
+
+   if (replace_with_undef) {
+      /* Remove the instruction and replace it with undef. */
+      nir_ssa_def *def = nir_ssa_undef(b, 1, nir_dest_bit_size(alu->dest.dest));
+      nir_ssa_def_rewrite_uses_after(&alu->dest.dest.ssa, def, &alu->instr);
+      nir_instr_remove(&alu->instr);
+   } else {
+      /* Replace undef source operands with 0. */
+      unsigned num_srcs = nir_op_infos[alu->op].num_inputs;
+
+      for (unsigned i = 0; i < num_srcs; i++) {
+         if (nir_src_is_undef(alu->src[i].src)) {
+            nir_ssa_def *zero =
+               nir_imm_zero(b, alu->src[i].src.ssa->num_components,
+                            alu->src[i].src.ssa->bit_size);
+            nir_src_rewrite_ssa(&alu->src[i].src, zero);
+         }
+      }
+   }
+
+   return true;
+}
+
 static bool
 nir_opt_undef_instr(nir_builder *b, nir_instr *instr, void *data)
 {
    if (instr->type == nir_instr_type_alu) {
       nir_alu_instr *alu = nir_instr_as_alu(instr);
-      return opt_undef_csel(alu) || opt_undef_vecN(b, alu) || opt_undef_pack(b, alu);
+      return opt_undef_csel(alu) || opt_undef_vecN(b, alu) ||
+             opt_undef_pack(b, alu) || opt_undef_scalar_math_alu(b, alu);
    } else if (instr->type == nir_instr_type_intrinsic) {
       nir_intrinsic_instr *intrin = nir_instr_as_intrinsic(instr);
       return opt_undef_store(intrin);
-- 
GitLab


From 2db1402dcb60375edfb816a3098216565fdbe1b9 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Marek=20Ol=C5=A1=C3=A1k?= <marek.olsak@amd.com>
Date: Thu, 13 Apr 2023 17:12:21 -0400
Subject: [PATCH 2/2] radeonsi: set NIR option undef_float_behavior

We just need a workaround for viewperf.
---
 src/gallium/drivers/radeonsi/si_debug_options.h | 1 +
 src/gallium/drivers/radeonsi/si_get.c           | 1 +
 src/util/00-mesa-defaults.conf                  | 5 +++++
 3 files changed, 7 insertions(+)

diff --git a/src/gallium/drivers/radeonsi/si_debug_options.h b/src/gallium/drivers/radeonsi/si_debug_options.h
index c90ef1d39aab..ad959b875787 100644
--- a/src/gallium/drivers/radeonsi/si_debug_options.h
+++ b/src/gallium/drivers/radeonsi/si_debug_options.h
@@ -21,6 +21,7 @@ OPT_BOOL(force_use_fma32, false, "Force use fma32 instruction for GPU family new
 OPT_BOOL(dcc_msaa, false, "Enable DCC for MSAA")
 OPT_BOOL(mall_noalloc, false, "Don't use MALL (infinity cache)")
 OPT_BOOL(zerovram, false, "Zero all VRAM allocations")
+OPT_INT(undef_float_behavior, 1 /* nir_undef_float_undef */, "Select the behavior of undef floats in NIR.")
 
 #undef OPT_BOOL
 #undef OPT_INT
diff --git a/src/gallium/drivers/radeonsi/si_get.c b/src/gallium/drivers/radeonsi/si_get.c
index 62508f5b2041..03811b9b550d 100644
--- a/src/gallium/drivers/radeonsi/si_get.c
+++ b/src/gallium/drivers/radeonsi/si_get.c
@@ -1274,6 +1274,7 @@ void si_init_screen_get_functions(struct si_screen *sscreen)
       .support_indirect_inputs = BITFIELD_BIT(MESA_SHADER_TESS_CTRL) |
                                  BITFIELD_BIT(MESA_SHADER_TESS_EVAL),
       .support_indirect_outputs = BITFIELD_BIT(MESA_SHADER_TESS_CTRL),
+      .undef_float_behavior = sscreen->options.undef_float_behavior,
    };
    sscreen->nir_options = nir_options;
 }
diff --git a/src/util/00-mesa-defaults.conf b/src/util/00-mesa-defaults.conf
index f39825cde5d5..9dec00222255 100644
--- a/src/util/00-mesa-defaults.conf
+++ b/src/util/00-mesa-defaults.conf
@@ -938,6 +938,11 @@ TODO: document the other workarounds.
         <application name="SPECviewperf13" executable="viewperf">
             <option name="glthread_nop_check_framebuffer_status" value="true" />
             <option name="radeonsi_sync_compile" value="true" />
+            <!-- Viewperf13/CATIA_car_01 uses uniforms in undef expressions,
+                 which we can't eliminate due to undef because viewperf uses
+                 hardcoded uniform locations and eliminating uniforms changes
+                 the locations of the remaining ones. -->
+            <option name="radeonsi_undef_float_behavior" value="0"/>
         </application>
         <application name="Road Redemption" executable="RoadRedemption.x86_64">
             <option name="radeonsi_clamp_div_by_zero" value="true" />
-- 
GitLab

