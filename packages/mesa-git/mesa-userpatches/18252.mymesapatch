From 9c0c07ee2c4ad44e97dbbbef1e715ba7aeadc8af Mon Sep 17 00:00:00 2001
From: Samuel Pitoiset <samuel.pitoiset@gmail.com>
Date: Thu, 25 Aug 2022 14:27:54 +0200
Subject: [PATCH 1/3] radv: remove bogus assertion about independent set
 layouts with GPL

layout->independent_sets can't be TRUE here.

Signed-off-by: Samuel Pitoiset <samuel.pitoiset@gmail.com>
---
 src/amd/vulkan/radv_pipeline.c | 1 -
 1 file changed, 1 deletion(-)

diff --git a/src/amd/vulkan/radv_pipeline.c b/src/amd/vulkan/radv_pipeline.c
index e153aaadc200..1ecaccaaaeaf 100644
--- a/src/amd/vulkan/radv_pipeline.c
+++ b/src/amd/vulkan/radv_pipeline.c
@@ -1605,7 +1605,6 @@ radv_graphics_pipeline_import_lib(struct radv_graphics_pipeline *pipeline,
       radv_pipeline_layout_add_set(layout, s, lib_layout->set[s].layout);
    }
 
-   assert(layout->independent_sets == lib_layout->independent_sets);
    layout->independent_sets = lib_layout->independent_sets;
    layout->push_constant_size = MAX2(layout->push_constant_size, lib_layout->push_constant_size);
 }
-- 
GitLab


From 418aca29a0ce838cb377811a8806bfe4216bfc4d Mon Sep 17 00:00:00 2001
From: Samuel Pitoiset <samuel.pitoiset@gmail.com>
Date: Thu, 25 Aug 2022 14:30:21 +0200
Subject: [PATCH 2/3] radv: fix missing initialization of the pipeline layout
 when creating a lib

The base object won't be initialized otherwise.

Signed-off-by: Samuel Pitoiset <samuel.pitoiset@gmail.com>
---
 src/amd/vulkan/radv_pipeline.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/src/amd/vulkan/radv_pipeline.c b/src/amd/vulkan/radv_pipeline.c
index 1ecaccaaaeaf..8861aa99fc1f 100644
--- a/src/amd/vulkan/radv_pipeline.c
+++ b/src/amd/vulkan/radv_pipeline.c
@@ -6958,6 +6958,8 @@ radv_graphics_lib_pipeline_init(struct radv_graphics_lib_pipeline *pipeline,
       (pCreateInfo->flags & VK_PIPELINE_CREATE_RETAIN_LINK_TIME_OPTIMIZATION_INFO_BIT_EXT) != 0;
    pipeline->lib_flags = lib_flags;
 
+   radv_pipeline_layout_init(device, pipeline_layout, false);
+
    /* If we have libraries, import them first. */
    if (libs_info) {
       for (uint32_t i = 0; i < libs_info->libraryCount; i++) {
-- 
GitLab


From 237cf176a3862a7e19f4bb6570921f9573a681a9 Mon Sep 17 00:00:00 2001
From: Samuel Pitoiset <samuel.pitoiset@gmail.com>
Date: Thu, 25 Aug 2022 14:33:35 +0200
Subject: [PATCH 3/3] radv: destroy the pipeline layout if creating a library
 failed

It should be properly cleaned.

Signed-off-by: Samuel Pitoiset <samuel.pitoiset@gmail.com>
---
 src/amd/vulkan/radv_pipeline.c | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

diff --git a/src/amd/vulkan/radv_pipeline.c b/src/amd/vulkan/radv_pipeline.c
index 8861aa99fc1f..7ceb4e0c92f0 100644
--- a/src/amd/vulkan/radv_pipeline.c
+++ b/src/amd/vulkan/radv_pipeline.c
@@ -6979,7 +6979,7 @@ radv_graphics_lib_pipeline_init(struct radv_graphics_lib_pipeline *pipeline,
    result = radv_pipeline_import_graphics_info(&pipeline->base, state, pipeline_layout, pCreateInfo,
                                                imported_flags);
    if (result != VK_SUCCESS)
-      return result;
+      goto fail;
 
    radv_pipeline_layout_hash(pipeline_layout);
 
@@ -7004,11 +7004,15 @@ radv_graphics_lib_pipeline_init(struct radv_graphics_lib_pipeline *pipeline,
                                    pCreateInfo->pStages, pCreateInfo->stageCount, flags, NULL,
                                    creation_feedback, NULL, NULL,
                                    &pipeline->base.last_vgt_api_stage);
-      if (result != VK_SUCCESS)
-         return result;
+      if (result != VK_SUCCESS && result != VK_PIPELINE_COMPILE_REQUIRED)
+         goto fail;
    }
 
    return VK_SUCCESS;
+
+fail:
+   radv_pipeline_layout_finish(device, pipeline_layout);
+   return result;
 }
 
 static VkResult
-- 
GitLab

