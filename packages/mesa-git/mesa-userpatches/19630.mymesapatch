From 526b8d612ee5fede703fcdc43213d8518a63892a Mon Sep 17 00:00:00 2001
From: C Stout <cstout@google.com>
Date: Wed, 9 Nov 2022 13:36:15 -0800
Subject: [PATCH] nir: Fix nir validate fail after nir_lower_subgroups

Ensure the memory backing each nir_const_value union is
initialized to prevent memcmp mismatches (validate_const_value
in nir_validate.c)

Closes: #7670
---
 src/compiler/nir/nir_lower_subgroups.c | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/src/compiler/nir/nir_lower_subgroups.c b/src/compiler/nir/nir_lower_subgroups.c
index f54a80ac082c..81d23a2996a4 100644
--- a/src/compiler/nir/nir_lower_subgroups.c
+++ b/src/compiler/nir/nir_lower_subgroups.c
@@ -420,12 +420,14 @@ build_ballot_imm_ishl(nir_builder *b, int64_t val, nir_ssa_def *shift,
     * answer or 0 for the first component (and something similar with the
     * second component). This idea is generalized here for any component count
     */
-   nir_const_value min_shift[4] = { 0 };
+   nir_const_value min_shift[4];
+   memset(min_shift, 0, sizeof(min_shift));
    for (unsigned i = 0; i < options->ballot_components; i++)
       min_shift[i].i32 = i * options->ballot_bit_size;
    nir_ssa_def *min_shift_val = nir_build_imm(b, options->ballot_components, 32, min_shift);
 
-   nir_const_value max_shift[4] = { 0 };
+   nir_const_value max_shift[4];
+   memset(max_shift, 0, sizeof(max_shift));
    for (unsigned i = 0; i < options->ballot_components; i++)
       max_shift[i].i32 = (i + 1) * options->ballot_bit_size;
    nir_ssa_def *max_shift_val = nir_build_imm(b, options->ballot_components, 32, max_shift);
@@ -501,7 +503,8 @@ build_subgroup_mask(nir_builder *b,
     * result if we just follow (2) and then replace the first component with
     * "result". 
     */ 
-   nir_const_value min_idx[4] = { 0 };
+   nir_const_value min_idx[4];
+   memset(min_idx, 0, sizeof(min_idx));
    for (unsigned i = 0; i < options->ballot_components; i++)
       min_idx[i].i32 = i * options->ballot_bit_size;
    nir_ssa_def *min_idx_val = nir_build_imm(b, options->ballot_components, 32, min_idx);
-- 
GitLab

