From f5651afaae554cb5034447f462d4366ccc7eb420 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Daniel=20Sch=C3=BCrmann?= <daniel@schuermann.dev>
Date: Thu, 7 Jul 2022 19:05:43 +0200
Subject: [PATCH] aco: fix assertion in insert_exec_mask

The exec mask might also be of type mask_type_loop.

Fixes: d068eb53e84ca1e44ad96c31dab63476880b3c72 ('aco/insert_exec_mask: optimize top-level transition to exact before demote')
---
 src/amd/compiler/aco_insert_exec_mask.cpp | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/amd/compiler/aco_insert_exec_mask.cpp b/src/amd/compiler/aco_insert_exec_mask.cpp
index e1dd39299108..b216ec79176f 100644
--- a/src/amd/compiler/aco_insert_exec_mask.cpp
+++ b/src/amd/compiler/aco_insert_exec_mask.cpp
@@ -585,7 +585,8 @@ process_instructions(exec_ctx& ctx, Block* block, std::vector<aco_ptr<Instructio
          }
       } else if (instr->opcode == aco_opcode::p_demote_to_helper) {
          /* turn demote into discard_if with only exact masks */
-         assert(ctx.info[block->index].exec[0].second == (mask_type_exact | mask_type_global));
+         assert((ctx.info[block->index].exec[0].second & mask_type_exact) &&
+                (ctx.info[block->index].exec[0].second & mask_type_global));
 
          int num;
          Temp cond, exit_cond;
-- 
GitLab

