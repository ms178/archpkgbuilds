From c2434f2304beb019fff4667beefbf4f8d88e64c5 Mon Sep 17 00:00:00 2001
From: Bas Nieuwenhuizen <bas@basnieuwenhuizen.nl>
Date: Mon, 29 Aug 2022 13:21:59 +0200
Subject: [PATCH] radv: Remove redundant radv_QueuePresentKHR.

Does the same thing as the wsi function.
---
 src/amd/vulkan/layers/radv_sqtt_layer.c | 3 ++-
 src/amd/vulkan/meson.build              | 2 +-
 src/amd/vulkan/radv_wsi.c               | 9 ---------
 src/vulkan/wsi/meson.build              | 4 ++++
 4 files changed, 7 insertions(+), 11 deletions(-)

diff --git a/src/amd/vulkan/layers/radv_sqtt_layer.c b/src/amd/vulkan/layers/radv_sqtt_layer.c
index 917d27ccdfcd..be2094b68ebd 100644
--- a/src/amd/vulkan/layers/radv_sqtt_layer.c
+++ b/src/amd/vulkan/layers/radv_sqtt_layer.c
@@ -22,6 +22,7 @@
  */
 
 #include "vk_common_entrypoints.h"
+#include "wsi_common_entrypoints.h"
 #include "radv_private.h"
 #include "radv_shader.h"
 
@@ -404,7 +405,7 @@ sqtt_QueuePresentKHR(VkQueue _queue, const VkPresentInfoKHR *pPresentInfo)
 {
    VkResult result;
 
-   result = radv_QueuePresentKHR(_queue, pPresentInfo);
+   result = wsi_QueuePresentKHR(_queue, pPresentInfo);
    if (result != VK_SUCCESS)
       return result;
 
diff --git a/src/amd/vulkan/meson.build b/src/amd/vulkan/meson.build
index 0074b323cac1..499719ebf6d2 100644
--- a/src/amd/vulkan/meson.build
+++ b/src/amd/vulkan/meson.build
@@ -177,7 +177,7 @@ libvulkan_radeon = shared_library(
     dep_valgrind, radv_deps, idep_aco,
     idep_mesautil, idep_nir, idep_vulkan_util, idep_vulkan_wsi,
     idep_vulkan_runtime, idep_amdgfxregs_h, idep_xmlconfig,
-    idep_vulkan_common_entrypoints_h
+    idep_vulkan_common_entrypoints_h, idep_vulkan_wsi_entrypoints_h
   ],
   c_args : [no_override_init_args, radv_flags, c_msvc_compat_args],
   cpp_args : [radv_flags, cpp_msvc_compat_args],
diff --git a/src/amd/vulkan/radv_wsi.c b/src/amd/vulkan/radv_wsi.c
index 8d72865ffc84..511d0b80e3d9 100644
--- a/src/amd/vulkan/radv_wsi.c
+++ b/src/amd/vulkan/radv_wsi.c
@@ -113,12 +113,3 @@ radv_finish_wsi(struct radv_physical_device *physical_device)
    physical_device->vk.wsi_device = NULL;
    wsi_device_finish(&physical_device->wsi_device, &physical_device->instance->vk.alloc);
 }
-
-VKAPI_ATTR VkResult VKAPI_CALL
-radv_QueuePresentKHR(VkQueue _queue, const VkPresentInfoKHR *pPresentInfo)
-{
-   RADV_FROM_HANDLE(radv_queue, queue, _queue);
-   return wsi_common_queue_present(&queue->device->physical_device->wsi_device,
-                                   radv_device_to_handle(queue->device), _queue,
-                                   queue->vk.queue_family_index, pPresentInfo);
-}
diff --git a/src/vulkan/wsi/meson.build b/src/vulkan/wsi/meson.build
index fd48474b98fc..75a8025926ed 100644
--- a/src/vulkan/wsi/meson.build
+++ b/src/vulkan/wsi/meson.build
@@ -71,6 +71,10 @@ idep_vulkan_wsi_headers = declare_dependency(
   include_directories : include_directories('.')
 )
 
+idep_vulkan_wsi_entrypoints_h = declare_dependency(
+  sources : [wsi_entrypoints[0]]
+)
+
 # This is likely a bug in the Meson VS backend, as MSVC with ninja works fine.
 # See this discussion here:
 # https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/10506
-- 
GitLab

