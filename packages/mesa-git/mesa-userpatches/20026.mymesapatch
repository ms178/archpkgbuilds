From 84c3d403dc1b3cc0263b201c2a1458dc3c9c826e Mon Sep 17 00:00:00 2001
From: Patrick Lerda <patrick9876@free.fr>
Date: Sun, 27 Nov 2022 14:33:20 +0100
Subject: [PATCH] util/xmlconfig: fix memory leak triggered by duplicates

This change copies the string once.

Direct leak of 196 byte(s) in 14 object(s) allocated from:
    #0 0x7f71598ec7a7 in strdup (/usr/lib64/libasan.so.6+0x5c7a7)
    #1 0x7f70a56ff942 in driParseOptionInfo ../src/util/xmlconfig.c:357
    #2 0x7f70a56f0565 in pipe_loader_load_options ../src/gallium/auxiliary/pipe-loader/pipe_loader.c:126
    #3 0x7f70a56f0565 in pipe_loader_create_screen_vk ../src/gallium/auxiliary/pipe-loader/pipe_loader.c:167

Signed-off-by: Patrick Lerda <patrick9876@free.fr>
---
 src/util/xmlconfig.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/util/xmlconfig.c b/src/util/xmlconfig.c
index 855b869d8b1c..25f90d417865 100644
--- a/src/util/xmlconfig.c
+++ b/src/util/xmlconfig.c
@@ -350,11 +350,12 @@ driParseOptionInfo(driOptionCache *info,
       if (optinfo->name) {
          /* Duplicate options override the value, but the type must match. */
          assert(optinfo->type == opt->info.type);
+      } else {
+         XSTRDUP(optinfo->name, name);
       }
 
       optinfo->type = opt->info.type;
       optinfo->range = opt->info.range;
-      XSTRDUP(optinfo->name, name);
 
       switch (opt->info.type) {
       case DRI_BOOL:
-- 
GitLab

