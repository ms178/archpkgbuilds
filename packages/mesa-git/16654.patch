From ef2479263f1b154eea6b2577fe5cfd0d4466f265 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Timur=20Krist=C3=B3f?= <timur.kristof@gmail.com>
Date: Sun, 22 May 2022 10:56:24 +0200
Subject: [PATCH] radv: Disable predication for supass clear.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

According to the Vulkan spec 21.4 "Conditional Rendering",
only clearing attachments with vkCmdClearAttachments is subject to
conditional rendering.

Subpass clear should always be done even if it happens in a
conditional rendering block.

Cc: mesa-stable
Signed-off-by: Timur Krist√≥f <timur.kristof@gmail.com>
---
 src/amd/vulkan/radv_meta_clear.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/src/amd/vulkan/radv_meta_clear.c b/src/amd/vulkan/radv_meta_clear.c
index 3c374945d43e..abb1b1b3152f 100644
--- a/src/amd/vulkan/radv_meta_clear.c
+++ b/src/amd/vulkan/radv_meta_clear.c
@@ -1995,6 +1995,7 @@ radv_cmd_buffer_clear_subpass(struct radv_cmd_buffer *cmd_buffer)
    struct radv_meta_saved_state saved_state;
    enum radv_cmd_flush_bits pre_flush = 0;
    enum radv_cmd_flush_bits post_flush = 0;
+   bool predicating = cmd_buffer->state.predicating;
 
    if (!radv_subpass_needs_clear(cmd_buffer))
       return;
@@ -2002,6 +2003,13 @@ radv_cmd_buffer_clear_subpass(struct radv_cmd_buffer *cmd_buffer)
    radv_meta_save(&saved_state, cmd_buffer,
                   RADV_META_SAVE_GRAPHICS_PIPELINE | RADV_META_SAVE_CONSTANTS);
 
+   /* According to the Vulkan spec 21.4 "Conditional Rendering",
+    * only clearing attachments with vkCmdClearAttachments is subject to
+    * conditional rendering, and this is not it.
+    * Disable predication for subpass clears.
+    */
+   cmd_buffer->state.predicating = false;
+
    for (uint32_t i = 0; i < cmd_state->subpass->color_count; ++i) {
       uint32_t a = cmd_state->subpass->color_attachments[i].attachment;
 
@@ -2047,6 +2055,7 @@ radv_cmd_buffer_clear_subpass(struct radv_cmd_buffer *cmd_buffer)
    }
 
    radv_meta_restore(&saved_state, cmd_buffer);
+   cmd_buffer->state.predicating = predicating;
    cmd_buffer->state.flush_bits |= post_flush;
 }
 
-- 
GitLab

