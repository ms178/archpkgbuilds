--- surfaceitem_wayland.h.orig	2025-10-07 18:26:30.620371812 +0200
+++ surfaceitem_wayland.h	2025-10-07 18:37:10.671128713 +0200
@@ -9,6 +8,7 @@
 #include "scene/surfaceitem.h"
 
 #include <QTimer>
+#include <optional>
 #include <unordered_map>
 
 namespace KWin
@@ -64,10 +64,27 @@ private:
     {
         DrmDevice *device = nullptr;
         QHash<uint32_t, QList<uint64_t>> formats;
+
+        // Use a proper comparison operator for robust optional checks.
+        bool operator!=(const ScanoutFeedback &other) const
+        {
+            return device != other.device || formats != other.formats;
+        }
     };
     std::optional<ScanoutFeedback> m_scanoutFeedback;
+
+    // OPTIMIZATION: Use std::unordered_map for O(1) average lookup time.
+    // This is critical for performance in applications with many sub-surfaces,
+    // as it is significantly more cache-friendly on modern CPUs than std::map.
     std::unordered_map<SubSurfaceInterface *, std::unique_ptr<SurfaceItemWayland>> m_subsurfaces;
+
     QTimer m_fifoFallbackTimer;
+
+    // OPTIMIZATION: Cache the FIFO fallback timer duration to avoid expensive
+    // 64-bit division and chrono calculations in the per-frame hot path of
+    // handleFramePainted.
+    int m_lastRefreshRate = 0;
+    int m_cachedFifoFallbackMs = 0;
 };
 
 #if KWIN_BUILD_X11
