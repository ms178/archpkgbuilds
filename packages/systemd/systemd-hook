#!/bin/sh
set -e

_chroot_check() {
  if systemd-detect-virt --chroot; then
    echo >&2 "  Skipped: Running in chroot."
    exit 0
  fi
}

_systemd_live() {
  _chroot_check
  if ! systemctl --version &>/dev/null || ! systemd-notify --booted; then
    echo >&2 "  Skipped: Current root is not booted with systemd."
    exit 0
  fi
}

_udevd_live() {
  _systemd_live
  if [ ! -S /run/udev/control ]; then
    echo >&2 "  Skipped: Device manager is not running."
    exit 0
  fi
}

op="${1:?Operation required}"; shift

case "$op" in
  sysusers)
    /usr/bin/systemd-sysusers
    ;;
  tmpfiles)
    /usr/bin/systemd-tmpfiles --create
    ;;
  binfmt)
    _systemd_live
    /usr/lib/systemd/systemd-binfmt
    ;;
  catalog)
    /usr/bin/journalctl --update-catalog
    ;;
  hwdb)
    /usr/bin/systemd-hwdb --usr update
    ;;
  sysctl)
    _systemd_live
    /usr/lib/systemd/systemd-sysctl
    ;;
  daemon-reload-system)
    _systemd_live
    /usr/bin/systemctl --system daemon-reload
    ;;
  daemon-reload-user)
    _systemd_live
    /usr/bin/systemctl reload 'user@*.service' || true
    ;;
  restart-marked)
    _systemd_live
    /usr/bin/systemctl reload-or-restart --marked
    ;;
  udev-reload)
    _udevd_live
    /usr/bin/udevadm control --reload
    if [ ! -e /etc/systemd/do-not-udevadm-trigger-on-update ]; then
      /usr/bin/udevadm trigger --type=subsystems --action=change
      /usr/bin/udevadm trigger --type=devices --action=change
      /usr/bin/udevadm settle
    fi
    ;;
  update)
    touch -c /usr
    ;;
  reload)
    _systemd_live
    /usr/bin/systemctl try-reload-or-restart "$@"
    ;;
  restart)
    _systemd_live
    /usr/bin/systemctl try-restart "$@"
    ;;
  *)
    echo >&2 "  Invalid operation: '$op'"
    exit 1
    ;;
esac

exit 0
