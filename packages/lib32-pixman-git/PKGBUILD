# Maintainer:  Vincent Grande <shoober420@gmail.com>
# Contributor: Jan de Groot <jgc@archlinux.org>
# Contributor: Andreas Radke <andyrtr@archlinux.org>
# Contributor: Alexander Baldeck <alexander@archlinux.org>

pkgname=lib32-pixman-git
pkgver=pixman+0.42.0+3+g4ee322c
pkgrel=1
pkgdesc="The pixel-manipulation library for X and cairo - 32-bit"
arch=(x86_64)
url="https://cgit.freedesktop.org/pixman/"
license=('custom')
provides=(lib32-pixman)
conflicts=(lib32-pixman)
depends=('lib32-glibc')
makedepends=('meson' 'lib32-libpng')
source=(git+https://gitlab.freedesktop.org/pixman/pixman.git clear.patch)
sha1sums=('SKIP')

pkgver() {
    cd pixman
      git describe --tags | sed 's/-/+/g'
    }

prepare() {
    # although removing _build folder in build() function feels more natural,
    # that interferes with the spirit of makepkg --noextract
    if [  -d _build ]; then
        rm -rf _build
    fi

    local src
    for src in "${source[@]}"; do
        src="${src%%::*}"
        src="${src##*/}"
        [[ $src = *.patch ]] || continue
        echo "Applying patch $src..."
        patch --directory="pixman" --forward --strip=1 < "$src"
    done
}

build() {
  export CC="gcc -m32"
  export CXX="g++ -m32"
  export PKG_CONFIG_PATH="/usr/lib32/pkgconfig"
  arch-meson pixman _build \
    --prefix /usr \
    --libdir lib32 \
    -D loongson-mmi=disabled \
    -D a64-neon=disabled \
    -D tests=disabled \
    -D tls=enabled \
    -D b_ndebug=true \
    -D b_pie=false \
    -D c_std=gnu18 \
    -D cpp_std=gnu++2a \
      --buildtype=release \
      --wrap-mode=nofallback \
    -D vmx=disabled \
    -D arm-simd=disabled \
    -D neon=disabled \
    -D iwmmxt=disabled \
    -D mips-dspr2=disabled \
    -D mmx=disabled \
    -D sse2=disabled \
    -D ssse3=disabled \
    -D gtk=disabled
  ninja $NINJAFLAGS -C _build
}

#check() {
#  meson test -C build
#}

package() {
  DESTDIR="$pkgdir" meson install -C _build
  rm -rf "${pkgdir}"/usr/include
  mkdir -p "$pkgdir/usr/share/licenses"
  ln -s $_pkgbasename "$pkgdir/usr/share/licenses/$pkgname"
}

# vim:set et sw=2:
