pkgbase="dbus-broker-git"
pkgname=(
  "dbus-broker-git"
  "dbus-broker-units-git"
)
pkgdesc="Linux D-Bus Message Broker"
pkgver=36.10.gbe28751
pkgrel=1
arch=("x86_64")
options=(!strip)
license=("Apache-2.0")
url="https://github.com/bus1/dbus-broker/wiki"
depends=(
  'audit>=3.0'
  'expat>=2.2'
  'libcap-ng>=0.6'
  'systemd-libs>=230'
)
makedepends=(
  'git'
  'meson>=0.60.0'
  'systemd'
  'python-docutils'
  'llvm'              # Required for BOLT
  'perf'              # Required for profile data collection
)
source=(
  "$pkgbase::git+https://github.com/bus1/dbus-broker"
  "c-dvar-1::git+https://github.com/c-util/c-dvar#branch=v1"
  "c-ini-1::git+https://github.com/c-util/c-ini#branch=v1"
  "c-list-3::git+https://github.com/c-util/c-list#branch=v3"
  "c-rbtree-3::git+https://github.com/c-util/c-rbtree#branch=v3"
  "c-shquote-1::git+https://github.com/c-util/c-shquote#branch=v1"
  "c-stdaux-1::git+https://github.com/c-util/c-stdaux#branch=v1"
  "c-utf8-1::git+https://github.com/c-util/c-utf8#branch=v1"
  "0001-units-Enable-statically.patch"
)
sha256sums=(
  'SKIP'
  'SKIP'
  'SKIP'
  'SKIP'
  'SKIP'
  'SKIP'
  'SKIP'
  'SKIP'
  'SKIP'
)

pkgver() {
  cd "$pkgbase"
  git describe --long --tags | sed 's/^v//;s/-/./g'
}

prepare() {
  cd "$pkgbase"
  local sp
  for sp in {dvar-1,ini-1,list-3,rbtree-3,shquote-1,stdaux-1,utf8-1}; do
    ln -fs "$(realpath --relative-to "subprojects" "$srcdir/c-$sp")" "subprojects/libc$sp"
  done
  patch -Np1 -i "../0001-units-Enable-statically.patch"
}

build() {
  local meson_options=(
    -D audit=true
    -D docs=false
    -D linux-4-17=true
    -D system-console-users=gdm,sddm,lightdm,lxdm
  )

  # Create test script for realistic workload
cat > test-workload.sh << 'EOF'
#!/bin/bash

# Function to simulate various D-Bus operations
run_dbus_tests() {
    # Basic introspection and discovery (valid operations)
    dbus-send --session --dest=org.freedesktop.DBus --type=method_call --print-reply \
        /org/freedesktop/DBus org.freedesktop.DBus.ListNames

    dbus-send --session --dest=org.freedesktop.DBus --type=method_call --print-reply \
        /org/freedesktop/DBus org.freedesktop.DBus.ListActivatableNames

    # Name management with valid well-known name format
    local test_name="org.test.name$(date +%s)"
    dbus-send --session --dest=org.freedesktop.DBus --type=method_call --print-reply \
        /org/freedesktop/DBus org.freedesktop.DBus.RequestName \
        "string:$test_name" uint32:0

    # Valid connection information queries
    dbus-send --session --dest=org.freedesktop.DBus --type=method_call --print-reply \
        /org/freedesktop/DBus org.freedesktop.DBus.GetId

    dbus-send --session --dest=org.freedesktop.DBus --type=method_call --print-reply \
        /org/freedesktop/DBus org.freedesktop.DBus.NameHasOwner \
        string:org.freedesktop.DBus

    # Concurrent valid operations
    (dbus-send --session --dest=org.freedesktop.DBus --type=method_call --print-reply \
        /org/freedesktop/DBus org.freedesktop.DBus.GetConnectionUnixProcessID \
        string:org.freedesktop.DBus) &

    (dbus-send --session --dest=org.freedesktop.DBus --type=method_call --print-reply \
        /org/freedesktop/DBus org.freedesktop.DBus.GetConnectionUnixUser \
        string:org.freedesktop.DBus) &

    # Valid match rule
    dbus-send --session --dest=org.freedesktop.DBus --type=method_call --print-reply \
        /org/freedesktop/DBus org.freedesktop.DBus.AddMatch \
        "string:type='signal',sender='org.freedesktop.DBus'"

    # Release the previously requested name
    dbus-send --session --dest=org.freedesktop.DBus --type=method_call --print-reply \
        /org/freedesktop/DBus org.freedesktop.DBus.ReleaseName \
        "string:$test_name"

    # Wait for background operations
    wait

    # Small delay between iterations
    sleep 0.$(shuf -i 1-5 -n 1)
}

# Run standard test suite first
echo "Running standard test suite..."
meson test -C build-stage1 --print-errorlogs

# Run realistic workload simulation
echo "Running realistic workload simulation..."
for i in {1..50}; do
    echo "Iteration $i/50"
    run_dbus_tests
done
EOF

  chmod +x test-workload.sh

  # Stage 1: Instrumented build for PGO
  export LLVM_PROFILE_FILE="$srcdir/%p.profraw"
  CFLAGS_ORIG="$CFLAGS"
  CXXFLAGS_ORIG="$CXXFLAGS"
  LDFLAGS_ORIG="$LDFLAGS"

  CFLAGS+=" -fprofile-generate -mllvm -vp-counters-per-site=6"
  CXXFLAGS+=" -fprofile-generate -mllvm -vp-counters-per-site=6"
  LDFLAGS+=" -fprofile-generate -mllvm -vp-counters-per-site=6"

  arch-meson "$pkgbase" build-stage1 "${meson_options[@]}" \
    -D b_ndebug=true \
    -D b_pie=false \
    -D c_std=gnu18 \
    -D cpp_std=gnu++2a \
    --buildtype=release \
    -D b_lto=true

  meson compile -C build-stage1

  # Generate PGO profiles using the comprehensive workload
  ./test-workload.sh

  # Merge profraw files
  llvm-profdata merge -output="$srcdir/default.profdata" "$srcdir"/*.profraw

  # Clean up profraw files
  rm -f "$srcdir"/*.profraw

  # Stage 2: Use PGO data and prepare for BOLT
  # Reset flags to original values first
  CFLAGS="$CFLAGS_ORIG"
  CXXFLAGS="$CXXFLAGS_ORIG"
  LDFLAGS="$LDFLAGS_ORIG"

  # Then add new flags
  CFLAGS+=" -fprofile-use=$srcdir/default.profdata"
  CXXFLAGS+=" -fprofile-use=$srcdir/default.profdata"
  LDFLAGS+=" -fprofile-use=$srcdir/default.profdata -Wl,--emit-relocs"

  arch-meson "$pkgbase" build "${meson_options[@]}" \
    -D b_ndebug=true \
    -D b_pie=false \
    -D c_std=gnu18 \
    -D cpp_std=gnu++2a \
    --buildtype=release \
    -D b_lto=true

  meson compile -C build

  # Create directory for profile data
  mkdir -p "$srcdir/bolt_profile"
}

check() {
  cd "$srcdir"

  # Ensure clean perf data
  rm -f perf.data*

  # Run perf record with optimized settings
  if ! perf record --max-size=6G -F 5000 -e cycles:u,cache-misses:u,branch-misses:u -b -- ./test-workload.sh; then
    echo "Error during profile generation"
    return 1
  fi

  # Convert perf data to BOLT profile format with additional checks
  if ! perf2bolt "$srcdir/build/src/dbus-broker" \
    -p perf.data \
    -o "$srcdir/bolt_profile/perf.fdata" \
    --ignore-build-id \
    -w 8; then
    echo "Error during profile conversion"
    return 1
  fi

  # Verify BOLT profile was created and has content
  if [ ! -s "$srcdir/bolt_profile/perf.fdata" ]; then
    echo "Error: BOLT profile is empty or doesn't exist"
    return 1
  fi

  # Create optimized binary directory
  mkdir -p "$srcdir/build/bolt"

  # Run BOLT optimization with verified settings
  if ! llvm-bolt "$srcdir/build/src/dbus-broker" \
    --data "$srcdir/bolt_profile/perf.fdata" \
    --dyno-stats \
    --cu-processing-batch-size=64 \
    --eliminate-unreachable \
    --frame-opt=all \
    --icf=all \
    --jump-tables=aggressive \
    --min-branch-clusters \
    --stoke \
    --sctc-mode=always \
    --plt=all \
    --hot-data \
    --hot-text \
    --frame-opt-rm-stores \
    --peepholes=all \
    --infer-stale-profile=1 \
    --x86-strip-redundant-address-size \
    --indirect-call-promotion=all \
    --reg-reassign \
    --use-aggr-reg-reassign \
    --reorder-blocks=ext-tsp \
    --reorder-functions=cdsort \
    --split-all-cold \
    --split-eh \
    --split-functions \
    --split-strategy=cdsplit \
    -o "$srcdir/build/bolt/dbus-broker.bolt"; then
    echo "Error during BOLT optimization"
    return 1
  fi
}

_pick() {
  local p="$1" f d; shift
  for f; do
    d="$srcdir/$p/${f#$pkgdir/}"
    mkdir -p "$(dirname "$d")"
    mv "$f" "$d"
    rmdir -p --ignore-fail-on-non-empty "$(dirname "$f")"
  done
}

package_dbus-broker-git() {
  depends+=(
    "libaudit.so"
    "libcap-ng.so"
    "libexpat.so"
    "libsystemd.so"
  )
  provides=("dbus-broker")
  conflicts=("dbus-broker")

  # First install all files normally
  meson install -C build --destdir "$pkgdir"

  # Then replace the binary with BOLT-optimized version if it exists
  if [ -f "$srcdir/build/bolt/dbus-broker.bolt" ]; then
    install -Dm755 "$srcdir/build/bolt/dbus-broker.bolt" "$pkgdir"/usr/bin/dbus-broker
  fi

  # Use llvm-strip only on recognized file formats
  find "$pkgdir" -type f \( -name '*.so*' -o -name '*.a' -o -executable \) -print0 | while IFS= read -r -d '' file; do
    if llvm-strip --strip-unneeded "$file" 2>/dev/null || llvm-strip --strip-all "$file" 2>/dev/null; then
      echo "Stripped: $file"
    else
      echo "Skipping: $file (not a valid object file)" >&2
    fi
  done

  _pick unit "$pkgdir"/usr/lib/systemd/{system,user}/dbus.service
}

package_dbus-broker-units-git() {
  pkgdesc+=" - Service units"
  depends=("dbus-broker")
  provides=(
    "dbus-broker-units"
    "dbus-units"
  )
  conflicts=(
    "dbus-broker-units"
    "dbus-daemon-units"
  )
  mv unit/* "$pkgdir"
}

# vim:set sw=2 sts=-1 et:
