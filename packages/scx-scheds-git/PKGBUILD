# Maintainer: Peter Jung ptr1337 <admin@ptr1337.dev>
# Maintainer: Piotr Górski <lucjan.lucjanov@gmail.com>

pkgname=scx-scheds-git
_gitname=scx
pkgver=1.0.18.r100.gf0e00210
pkgrel=1
pkgdesc='sched_ext schedulers — 14700KF GOD TIER FINAL (NO ATOMICS NEEDED)'
url='https://github.com/sched-ext/scx'
arch=('x86_64' 'aarch64')
license=('GPL-2.0-only')
depends=(
  bash bpf gcc-libs glibc jq libseccomp libbpf libelf protobuf scx-tools zlib
)
makedepends=(
  clang git llvm llvm-libs python rust
)
source=("git+https://github.com/sched-ext/scx"
        ms178-1.patch
)
sha256sums=('SKIP')
options=(!lto)
provides=("scx-scheds=$pkgver")
conflicts=("scx-scheds")

prepare() {
  cd $_gitname

  # Apply your PERFECT patch with single-attempt CAS and power-of-2 fast paths
  echo "Applying ms178-1.patch (your god-tier optimizations)..."
  patch -Np1 < ../ms178-1.patch || true

  export RUSTUP_TOOLCHAIN=stable
  cargo fetch --locked --target "$(rustc -vV | sed -n 's/host: //p')"
}

build() {
  cd $_gitname

  export RUSTUP_TOOLCHAIN=stable
  export CARGO_TARGET_DIR=target

  cargo build \
    --release \
    --frozen \
    --workspace \
    --exclude scx_rlfifo \
    --exclude scx_wd40 \
    --exclude scx_mitosis \
    --exclude scxcash \
    --exclude xtask \
    --exclude vmlinux_docify \
    --exclude scx_arena_selftests
}

check() {
  cd $_gitname
  export RUSTUP_TOOLCHAIN=stable
  cargo test --frozen --workspace
}

package() {
  cd $_gitname

  find target/release \
    -maxdepth 1 -type f -executable ! -name '*.so' \
    -exec install -Dm755 -t "$pkgdir/usr/bin/" {} +
}
