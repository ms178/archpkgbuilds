pkgname=openssl
pkgver=3.6.1
pkgrel=3
pkgdesc='The Open Source toolkit for Secure Sockets Layer and Transport Layer Security'
arch=('x86_64')
url='https://www.openssl.org'
license=('Apache-2.0')
depends=('glibc')
makedepends=('perl' 'clang' 'llvm' 'lld')
optdepends=('ca-certificates: trusted CA bundle'
            'perl: c_rehash and some OpenSSL utilities')
replaces=('openssl-perl' 'openssl-doc')
provides=('libcrypto.so=3-64' 'libssl.so=3-64')
backup=('etc/ssl/openssl.cnf')
source=("https://github.com/${pkgname}/${pkgname}/releases/download/${pkgname}-${pkgver}/${pkgname}-${pkgver}.tar.gz"{,.asc}
        'ca-dir.patch')
sha256sums=('83049d042a260e696f62406ac5c08bf706fd84383f945cf21bd61e9ed95c396e'
            'SKIP'
            '0a32d9ca68e8d985ce0bfef6a4c20b46675e06178cc2d0bf6d91bd6865d648b7')
validpgpkeys=('8657ABB260F056B1E5190839D9C4D26D0E604491'
              '7953AC1FBC3DC8B3B292393ED5E9E43F7DF9EE8C'
              'A21FAB74B0088AA361152586B8EF1A6BA9DA2D5C')

_set_llvm_toolchain() {
  export CC=clang
  export CXX=clang++
  export AR=llvm-ar
  export NM=llvm-nm
  export RANLIB=llvm-ranlib
  export STRIP=llvm-strip
  export OBJCOPY=llvm-objcopy
  export OBJDUMP=llvm-objdump
  export READELF=llvm-readelf
  export LDFLAGS+=" -fuse-ld=lld"
}

prepare() {
  cd "$srcdir/$pkgname-$pkgver"

  # set ca dir to /etc/ssl by default
  patch -Np1 -i "$srcdir/ca-dir.patch"
}

build() {
  cd "$srcdir/$pkgname-$pkgver"
  _set_llvm_toolchain

  local _configure_options=(
    --prefix=/usr
    --openssldir=/etc/ssl
    --libdir=lib
    shared
    enable-ktls
    zlib-dynamic
    no-ssl3
    enable-ec_nistp_64_gcc_128
    linux-x86_64
  )

  local _base_cppflags="${CPPFLAGS}"
  local _base_cflags="${CFLAGS} -Wa,--noexecstack"
  local _base_ldflags="${LDFLAGS}"

  local _profdir="$srcdir/llvm-pgo"
  rm -rf "$_profdir"
  mkdir -p "$_profdir/raw"

  # --- Stage 1: LLVM PGO + CS-PGO instrumentation ---
  msg "Starting PGO/CS-PGO instrumentation build..."
  export CPPFLAGS="$_base_cppflags"
  export CFLAGS="$_base_cflags -g3 -fno-omit-frame-pointer \
    -fprofile-instr-generate -fcs-profile-generate -fprofile-correction \
    -mllvm -vp-counters-per-site=50 -mllvm -runtime-counter-relocation \
    -mllvm -enable-value-profiling"
  export LDFLAGS="$_base_ldflags"
  export LLVM_PROFILE_FILE="$_profdir/raw/openssl-%p-%m.profraw"

  ./Configure "${_configure_options[@]}"
  make depend
  make

  msg "Running tests to generate profile data..."
  make test || echo "WARNING: 'make test' failed during profiling; profile data may be incomplete."

  if ! compgen -G "$_profdir/raw/*.profraw" > /dev/null; then
    echo "ERROR: No LLVM profraw files were generated; aborting."
    return 1
  fi

  msg "Merging LLVM PGO profiles..."
  llvm-profdata merge -num-threads="$(nproc)" \
    -output="$_profdir/code.profdata" "$_profdir/raw"/*.profraw

  msg "Merging LLVM CS-PGO profiles..."
  llvm-profdata merge -num-threads="$(nproc)" --cs \
    -output="$_profdir/cs.profdata" "$_profdir/raw"/*.profraw

  if [[ ! -s "$_profdir/code.profdata" || ! -s "$_profdir/cs.profdata" ]]; then
    echo "ERROR: Profile data merge failed; aborting."
    return 1
  fi

  make distclean

  # --- Stage 2: Final optimized build ---
  msg "Starting final optimized build..."
  export CPPFLAGS="$_base_cppflags"
  export CFLAGS="$_base_cflags \
    -fprofile-instr-use=$_profdir/code.profdata \
    -fcs-profile-use=$_profdir/cs.profdata \
    -fprofile-correction"
  export LDFLAGS="$_base_ldflags"
  unset LLVM_PROFILE_FILE

  ./Configure "${_configure_options[@]}"
  make depend
  make

  msg "PGO/CS-PGO build complete."
}

check() {
  cd "$srcdir/$pkgname-$pkgver"
  _set_llvm_toolchain
  msg "Running test suite on the final optimized build..."
  make test
}

package() {
  cd "$srcdir/$pkgname-$pkgver"

  make DESTDIR="$pkgdir" MANDIR=/usr/share/man MANSUFFIX=ssl install_sw install_ssldirs

  install -D -m644 LICENSE.txt "$pkgdir/usr/share/licenses/$pkgname/LICENSE.txt"
}
