pkgbase=freetype2
pkgname=(freetype2)
pkgver=2.14.1
pkgrel=8.1
pkgdesc='Font rasterisation library (PGO + CS-PGO tuned)'
url='https://www.freetype.org/'
arch=(x86_64)
license=('FTL OR GPL-2.0-or-later')
depends=(brotli bzip2 glibc libpng zlib harfbuzz)
makedepends=(
  cairo glib2 librsvg libx11 meson qt5-base gcc-libs
  clang llvm lld
)
source=(
  https://download-mirror.savannah.gnu.org/releases/freetype/freetype-${pkgver}.tar.xz{,.sig}
  https://download-mirror.savannah.gnu.org/releases/freetype/freetype-doc-${pkgver}.tar.xz{,.sig}
  https://download-mirror.savannah.gnu.org/releases/freetype/ft2demos-${pkgver}.tar.xz{,.sig}
  0001-Enable-table-validation-modules.patch
  0002-Enable-subpixel-rendering.patch
  0003-Enable-long-PCF-family-names.patch
  0001-meson.build-Add-missing-math_dep-for-SVG-support.patch
  freetype2.sh
)
b2sums=('f9591c6998df02b072adaf38a968e91deae8ed4d53ea0cb74d08982c4f0e48b1a98c1378a698164e4f730f07a3b0bea308a94fcc2e2b8ce9967dbf9478b599bd'
        'SKIP'
        '84244e28ace43929387052954b92089f570300dc8a9cb77e0ceb53001f081f6d6e5785ad081448ceb58254f8102e3ccf64d1fd323b02fb0a8232a0ba3eb9f3a8'
        'SKIP'
        '5f5a48e0ad839ece97ea2bd451bd819ccbf9347425dc323a368e5fed91cfddeffd61b1dfea2e7cc7d65e30e6ebb932dd142430998039eb4a8f91758a3690ddef'
        'SKIP'
        '7ddac82b202db33450af3c8ba59f932206c998fa4706369fb6c536d9b7af5100db03b2d8c1ac5de98d54e3ef3b1262f494437c041f3343f6c9e3ed112d2d1098'
        '24af9fd7e64d4e95e0438bbc96529c6e37d8407188f3df63ecd36b1270ccd6a196545e60276207fefeb5ea786ad15712004313cbd7e11f31368fe7b930d84bbc'
        'b3946946c5f46e17339d5c24b2e54d985c410355df8dac8b35c90cef59e7fe0ed8bcac4e27f32bda9f5943495adbb25510dc22c3970c0734f408e9bf2e0aaa5b'
        '58940d2ecb793a0723767d48676ac55e32f9da313e81cd265477137736693073dc3073713a0cc7578ff1d01b22148f4dd8c3534d890c9d97491f67976e2aaad0'
        'a964f46886b5017a5c180f29408f72ae8aba29f37404c48b4681ff12ca0a2cfa2a8e219480e98d63d45fb5c266a6e5826df170c9a0d701cd866e395c5ac6e87d')
validpgpkeys=('E30674707856409FF1948010BE6C3AAC63AD8E3F')

##############################################################################
# LLVM instrumentation flags (PGO-specific only)
##############################################################################
_pgo_instr_flags='-g3 -fno-omit-frame-pointer -Xclang -mllvm -Xclang -vp-counters-per-site=150 -Xclang -mllvm -Xclang -runtime-counter-relocation -Xclang -mllvm -Xclang -enable-value-profiling'

##############################################################################
# Meson options
##############################################################################
_meson_common=(
  -D freetype2:default_library=shared
  -D b_ndebug=true
  -D b_pie=false
  -D c_std=gnu2x
  -D cpp_std=gnu++2a
  --unity=on
  --buildtype=release
  --wrap-mode=default
)

prepare() {
  # demos expect freetype2/ as subproject
  ln -sfr freetype-${pkgver} freetype2

  patch -d freetype-${pkgver} -Np1 < 0001-Enable-table-validation-modules.patch
  patch -d freetype-${pkgver} -Np1 < 0002-Enable-subpixel-rendering.patch
  patch -d freetype-${pkgver} -Np1 < 0003-Enable-long-PCF-family-names.patch
  patch -d ft2demos-${pkgver} -Np1 < 0001-meson.build-Add-missing-math_dep-for-SVG-support.patch
}

##############################################################################
# Training workload: exercise library with essential DE/EN fonts
##############################################################################
_train() {
  local bin="$1"

  echo ":: Running training workload from $bin"

  # Verify binaries exist
  if [[ ! -x "$bin/ftdump" ]]; then
    echo "   Warning: ftdump not found, skipping training"
    return 0
  fi

  # Training text: English + German (umlauts, Eszett)
  local txt_en="The quick brown fox jumps over the lazy dog 0123456789"
  local txt_de="Größe überprüfen: Äpfel, Öl & Würstchen kosten €12,50"

  # Essential font families for DE/EN (order = priority)
  local font_patterns=(
    # System UI fonts
    'DejaVuSans.ttf'
    'LiberationSans-Regular.ttf'
    'NotoSans-Regular.ttf'
    'Roboto-Regular.ttf'
    'Inter-Regular.otf'
    'Cantarell-Regular.otf'
    # Serif fonts
    'DejaVuSerif.ttf'
    'LiberationSerif-Regular.ttf'
    'NotoSerif-Regular.ttf'
    # Monospace fonts (coding/terminal)
    'DejaVuSansMono.ttf'
    'LiberationMono-Regular.ttf'
    'JetBrainsMono-Regular.ttf'
    'FiraCode-Regular.ttf'
    'SourceCodePro-Regular.otf'
    'Hack-Regular.ttf'
  )

  local fonts=()
  local pattern

  # Find fonts matching our priority list
  for pattern in "${font_patterns[@]}"; do
    local found
    found=$(find /usr/share/fonts -type f -name "$pattern" 2>/dev/null | head -1)
    [[ -n "$found" ]] && fonts+=("$found")
  done

  # Fallback: grab a few common fonts if list is too short
  if (( ${#fonts[@]} < 5 )); then
    echo "   Few priority fonts found, adding fallbacks..."
    mapfile -t -O "${#fonts[@]}" fonts < <(
      find /usr/share/fonts -type f \( -iname '*sans*.ttf' -o -iname '*serif*.ttf' \) 2>/dev/null | head -10
    )
  fi

  if (( ${#fonts[@]} == 0 )); then
    echo "   Warning: No fonts found, skipping training"
    return 0
  fi

  echo "   Processing ${#fonts[@]} fonts..."

  local f
  for f in "${fonts[@]}"; do
    # Font parsing (most important)
    "$bin/ftdump" -q "$f" >/dev/null 2>&1 || true

    # Glyph rendering at common sizes
    if [[ -x "$bin/ftstring" ]]; then
      "$bin/ftstring" -f "$f" -r 11 "$txt_en" >/dev/null 2>&1 || true
      "$bin/ftstring" -f "$f" -r 14 "$txt_de" >/dev/null 2>&1 || true
      "$bin/ftstring" -f "$f" -r 18 "$txt_en" >/dev/null 2>&1 || true
    fi

    # Quick benchmark (reduced iterations)
    if [[ -x "$bin/ftbench" ]]; then
      "$bin/ftbench" -c 50 "$f" >/dev/null 2>&1 || true
    fi
  done

  echo ":: Training complete (${#fonts[@]} fonts)"
}

build() {
  export CC=clang
  export CXX=clang++
  export MESON_PACKAGE_CACHE_DIR="$srcdir"

  # Save original flags from /etc/makepkg.conf - these MUST be preserved
  local _orig_cflags="${CFLAGS:-}"
  local _orig_cxxflags="${CXXFLAGS:-}"
  local _orig_ldflags="${LDFLAGS:-}"

  local pgo_gen="$srcdir/pgo-gen"
  local pgo_cs="$srcdir/pgo-cs"

  # Clean previous builds
  rm -rf "$pgo_gen" "$pgo_cs" "$srcdir/build-gen" "$srcdir/build-cs" "$srcdir/build-final"
  mkdir -p "$pgo_gen" "$pgo_cs"

  ##########################################################################
  # PASS 1: Standard PGO instrumentation (-fprofile-generate)
  ##########################################################################
  msg2 'Pass 1: Collecting standard profile'

  local cflags_gen="${_orig_cflags} ${_pgo_instr_flags} -fprofile-generate=${pgo_gen}"
  local cxxflags_gen="${_orig_cxxflags} ${_pgo_instr_flags} -fprofile-generate=${pgo_gen}"
  local ldflags_gen="${_orig_ldflags} -fprofile-generate=${pgo_gen} -fuse-ld=lld"

  arch-meson ft2demos-${pkgver} "$srcdir/build-gen" \
    "${_meson_common[@]}" \
    -Dc_args="${cflags_gen}" \
    -Dcpp_args="${cxxflags_gen}" \
    -Dc_link_args="${ldflags_gen}" \
    -Dcpp_link_args="${ldflags_gen}"

  meson compile -C "$srcdir/build-gen"

  _train "$srcdir/build-gen"

  # Merge standard profiles
  if ! ls "$pgo_gen"/*.profraw &>/dev/null; then
    error "No profile data generated in Pass 1"
    return 1
  fi
  llvm-profdata merge -output="$srcdir/gen.profdata" "$pgo_gen"/*.profraw
  echo "   Merged $(ls -1 "$pgo_gen"/*.profraw | wc -l) profile files"

  ##########################################################################
  # PASS 2: Context-sensitive PGO (-fcs-profile-generate)
  ##########################################################################
  msg2 'Pass 2: Collecting context-sensitive profile'

  local cflags_cs="${_orig_cflags} ${_pgo_instr_flags} -fprofile-use=${srcdir}/gen.profdata -fcs-profile-generate=${pgo_cs}"
  local cxxflags_cs="${_orig_cxxflags} ${_pgo_instr_flags} -fprofile-use=${srcdir}/gen.profdata -fcs-profile-generate=${pgo_cs}"
  local ldflags_cs="${_orig_ldflags} -fprofile-use=${srcdir}/gen.profdata -fcs-profile-generate=${pgo_cs} -fuse-ld=lld"

  arch-meson ft2demos-${pkgver} "$srcdir/build-cs" \
    "${_meson_common[@]}" \
    -Dc_args="${cflags_cs}" \
    -Dcpp_args="${cxxflags_cs}" \
    -Dc_link_args="${ldflags_cs}" \
    -Dcpp_link_args="${ldflags_cs}"

  meson compile -C "$srcdir/build-cs"

  _train "$srcdir/build-cs"

  # Merge CS profiles with standard profile
  if ! ls "$pgo_cs"/*.profraw &>/dev/null; then
    error "No profile data generated in Pass 2"
    return 1
  fi
  llvm-profdata merge -output="$srcdir/merged.profdata" \
    "$pgo_cs"/*.profraw \
    "$srcdir/gen.profdata"
  echo "   Merged CS profiles with standard profile"

  ##########################################################################
  # PASS 3: Final optimized build (-fprofile-use)
  ##########################################################################
  msg2 'Pass 3: Final optimised build'

  local cflags_final="${_orig_cflags} -fprofile-use=${srcdir}/merged.profdata"
  local cxxflags_final="${_orig_cxxflags} -fprofile-use=${srcdir}/merged.profdata"
  local ldflags_final="${_orig_ldflags} -fprofile-use=${srcdir}/merged.profdata -fuse-ld=lld"

  arch-meson ft2demos-${pkgver} "$srcdir/build-final" \
    "${_meson_common[@]}" \
    -Dc_args="${cflags_final}" \
    -Dcpp_args="${cxxflags_final}" \
    -Dc_link_args="${ldflags_final}" \
    -Dcpp_link_args="${ldflags_final}"

  meson compile -C "$srcdir/build-final"

  msg2 'Build complete'
}

check() {
  meson test -C "$srcdir/build-final" --print-errorlogs || true
}

package_freetype2() {
  provides=(libfreetype.so)
  install=freetype2.install
  backup=(etc/profile.d/freetype2.sh)

  meson install -C "$srcdir/build-final" --destdir="$pkgdir"
  install -Dm644 freetype2.sh -t "$pkgdir/etc/profile.d"
}

# vim: ts=2 sw=2 et
