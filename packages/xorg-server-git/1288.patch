From ad36ff274de81eb805223969ba19ba1774e3f42c Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Fri, 9 Feb 2024 15:51:04 +0100
Subject: [PATCH 01/15] xnest: Display: fix xallocarray() compiler warning
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Compiler warning:

[7/29] Compiling C object hw/xnest/Xnest.p/Display.c.o
In file included from ../include/misc.h:119,
                 from ../include/screenint.h:50,
                 from ../hw/xnest/Display.c:24:
../hw/xnest/Display.c: In function ‘xnestOpenDisplay’:
../include/os.h:81:32: warning: argument 2 range [2147483648, 4294967295] exceeds maximum object size 2147483647 [-Walloc-size-larger-than=]
   81 | #define xallocarray(num, size) reallocarray(NULL, (num), (size))
      |                                ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
../hw/xnest/Display.c:124:29: note: in expansion of macro ‘xallocarray’
  124 |     xnestDefaultColormaps = xallocarray(xnestNumDefaultColormaps,
      |                             ^~~~~~~~~~~
In file included from ../include/os.h:54:
/usr/include/stdlib.h:582:14: note: in a call to allocation function ‘reallocarray’ declared here
  582 | extern void *reallocarray (void *__ptr, size_t __nmemb, size_t __size)
      |              ^~~~~~~~~~~~

Since we really don't need more than 2^16 colormaps, using uint16_t here
to silence this warning.

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/Display.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/hw/xnest/Display.c b/hw/xnest/Display.c
index e6fa4ba30a..a014aa40da 100644
--- a/hw/xnest/Display.c
+++ b/hw/xnest/Display.c
@@ -41,7 +41,7 @@ XVisualInfo *xnestVisuals;
 int xnestNumVisuals;
 int xnestDefaultVisualIndex;
 Colormap *xnestDefaultColormaps;
-static unsigned int xnestNumDefaultColormaps;
+static uint16_t xnestNumDefaultColormaps;
 int *xnestDepths;
 int xnestNumDepths;
 XPixmapFormatValues *xnestPixmapFormats;
-- 
GitLab


From 0a66d274e0a332ff00fc9a221d1c0d7fa5b0b748 Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Thu, 15 Feb 2024 16:01:57 +0100
Subject: [PATCH 02/15] Xnest: ignore NoExpose event

Sometimes getting NoExpose event from upstream xserver, where
we've got nothing actually to do.

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/Events.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/hw/xnest/Events.c b/hw/xnest/Events.c
index f727557ba2..517ff79982 100644
--- a/hw/xnest/Events.c
+++ b/hw/xnest/Events.c
@@ -208,6 +208,7 @@ xnestCollectEvents(void)
         case MapNotify:
         case ReparentNotify:
         case UnmapNotify:
+        case NoExpose:
             break;
 
         default:
-- 
GitLab


From b206a739cdec2d45d7ae08fbd705bd8013f1d24f Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Thu, 15 Feb 2024 16:04:29 +0100
Subject: [PATCH 03/15] Xnest: print event ID on warning about unhandled
 upstream event

When getting an unhandled event from upstream Xserver, a warning
is printed, but it doesn't tell which one yet. Just printing it's
ID should be good enough for now.

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/Events.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/hw/xnest/Events.c b/hw/xnest/Events.c
index 517ff79982..97a1510655 100644
--- a/hw/xnest/Events.c
+++ b/hw/xnest/Events.c
@@ -212,7 +212,7 @@ xnestCollectEvents(void)
             break;
 
         default:
-            ErrorF("xnest warning: unhandled event\n");
+            ErrorF("xnest warning: unhandled event: %d\n", X.type);
             break;
         }
     }
-- 
GitLab


From 3edce4de1fe0b64daca0e0908f09f6302c26f7be Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Thu, 15 Feb 2024 16:15:02 +0100
Subject: [PATCH 04/15] Xnest: fix resending expose events
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Based on bugzilla report by François Ouellet:
https://bugs.freedesktop.org/show_bug.cgi?id=89

> Expose Events are sent with bad coordinates.  Using xtrace, I see lines like this one :
>
>   000:>:0436: Event Expose(12) window=0x00200023 x=65535 y=65533 width=1 height=3 count=0x0000
>
> and the application in the Xnest ignores it.
>
> If I apply the attached patch, it seems to work fine (for me).

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/Events.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/hw/xnest/Events.c b/hw/xnest/Events.c
index 97a1510655..807696df56 100644
--- a/hw/xnest/Events.c
+++ b/hw/xnest/Events.c
@@ -94,7 +94,7 @@ xnestCollectExposures(void)
 
             RegionInit(&Rgn, &Box, 1);
 
-            miSendExposures(pWin, &Rgn, Box.x2, Box.y2);
+            miSendExposures(pWin, &Rgn, 0, 0);
         }
     }
 }
-- 
GitLab


From 66b34bb43cd1cd1607215c233511450cc5bb0c6b Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Thu, 15 Feb 2024 17:16:56 +0100
Subject: [PATCH 05/15] Xnest: drop obsolete ifdef HAVE_XNEST_CONFIG_H

These files are always compiled w/ HAVE_XNEST_CONFIG_H and always
need to include this file, so the ifdef can be dropped.

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/Args.c     | 2 --
 hw/xnest/Color.c    | 2 --
 hw/xnest/Cursor.c   | 2 --
 hw/xnest/Display.c  | 2 --
 hw/xnest/Events.c   | 2 --
 hw/xnest/Font.c     | 2 --
 hw/xnest/GC.c       | 2 --
 hw/xnest/GCOps.c    | 2 --
 hw/xnest/Handlers.c | 2 --
 hw/xnest/Init.c     | 2 --
 hw/xnest/Keyboard.c | 2 --
 hw/xnest/Pixmap.c   | 2 --
 hw/xnest/Pointer.c  | 2 --
 hw/xnest/Screen.c   | 2 --
 hw/xnest/Visual.c   | 2 --
 hw/xnest/Window.c   | 2 --
 16 files changed, 32 deletions(-)

diff --git a/hw/xnest/Args.c b/hw/xnest/Args.c
index f54dbd6081..fbeb9a3096 100644
--- a/hw/xnest/Args.c
+++ b/hw/xnest/Args.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Color.c b/hw/xnest/Color.c
index 3a9e42203e..c6f5df0b91 100644
--- a/hw/xnest/Color.c
+++ b/hw/xnest/Color.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Cursor.c b/hw/xnest/Cursor.c
index 285e10ebf6..7accf73dcf 100644
--- a/hw/xnest/Cursor.c
+++ b/hw/xnest/Cursor.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Display.c b/hw/xnest/Display.c
index a014aa40da..8987a13f59 100644
--- a/hw/xnest/Display.c
+++ b/hw/xnest/Display.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <string.h>
 #include <errno.h>
diff --git a/hw/xnest/Events.c b/hw/xnest/Events.c
index 807696df56..b5a3b36d76 100644
--- a/hw/xnest/Events.c
+++ b/hw/xnest/Events.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Font.c b/hw/xnest/Font.c
index 192b80f538..564b36ba23 100644
--- a/hw/xnest/Font.c
+++ b/hw/xnest/Font.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xatom.h>
diff --git a/hw/xnest/GC.c b/hw/xnest/GC.c
index ecfa61e39b..2e4b5ae174 100644
--- a/hw/xnest/GC.c
+++ b/hw/xnest/GC.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/GCOps.c b/hw/xnest/GCOps.c
index e1cf9d65f3..3cbe5d65e5 100644
--- a/hw/xnest/GCOps.c
+++ b/hw/xnest/GCOps.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Handlers.c b/hw/xnest/Handlers.c
index 27ea30a835..a06f3f90d3 100644
--- a/hw/xnest/Handlers.c
+++ b/hw/xnest/Handlers.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Init.c b/hw/xnest/Init.c
index 1f18e335bf..23ddf7c03a 100644
--- a/hw/xnest/Init.c
+++ b/hw/xnest/Init.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Keyboard.c b/hw/xnest/Keyboard.c
index 46f257c833..3ce95a0f77 100644
--- a/hw/xnest/Keyboard.c
+++ b/hw/xnest/Keyboard.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #ifdef WIN32
 #include <X11/Xwindows.h>
diff --git a/hw/xnest/Pixmap.c b/hw/xnest/Pixmap.c
index 6514f3b31d..30c030b630 100644
--- a/hw/xnest/Pixmap.c
+++ b/hw/xnest/Pixmap.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Pointer.c b/hw/xnest/Pointer.c
index a2ee90064c..b7cc6e8c2a 100644
--- a/hw/xnest/Pointer.c
+++ b/hw/xnest/Pointer.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Screen.c b/hw/xnest/Screen.c
index ac01c248c2..11b162d8f4 100644
--- a/hw/xnest/Screen.c
+++ b/hw/xnest/Screen.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Visual.c b/hw/xnest/Visual.c
index 11673c44a2..858324b2c5 100644
--- a/hw/xnest/Visual.c
+++ b/hw/xnest/Visual.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Window.c b/hw/xnest/Window.c
index d6f44a25a8..dbfe7b7ab8 100644
--- a/hw/xnest/Window.c
+++ b/hw/xnest/Window.c
@@ -12,9 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#ifdef HAVE_XNEST_CONFIG_H
 #include <xnest-config.h>
-#endif
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
-- 
GitLab


From 1260a72d9546e8807c703f82927b952175a0ee82 Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Thu, 15 Feb 2024 17:59:56 +0100
Subject: [PATCH 06/15] Xnest: tidy up extension blacklisting in miinitext.c

The DDX'es sometimes need to disable certain extensions. Instead of complex
include cascades with ifdef'ed ddx-specific include from dix code, it's
more clean to add some clear and explicit knobs set by the DDX'es individual
meson.build.

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/meson.build |  2 +-
 mi/miinitext.c       | 11 +++++++++--
 2 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/hw/xnest/meson.build b/hw/xnest/meson.build
index 37ac5a6919..36489b1d8f 100644
--- a/hw/xnest/meson.build
+++ b/hw/xnest/meson.build
@@ -33,7 +33,7 @@ executable(
         libxserver_xi_stubs,
         libxserver_xkb_stubs,
     ],
-    c_args: '-DHAVE_XNEST_CONFIG_H',
+    c_args: [ '-DDISABLE_EXT_COMPOSITE', '-DDISABLE_EXT_DPMS', '-DISABLE_EXT_MITSHM' ],
     install: true,
 )
 
diff --git a/mi/miinitext.c b/mi/miinitext.c
index 26c1eb03c3..4d7b591637 100644
--- a/mi/miinitext.c
+++ b/mi/miinitext.c
@@ -91,12 +91,19 @@ SOFTWARE.
 #undef MITSHM
 #endif
 
-#ifdef HAVE_XNEST_CONFIG_H
-#include <xnest-config.h>
+/* some DDXes must explicitly prohibit some extensions */
+#ifdef DISABLE_EXT_COMPOSITE
 #undef COMPOSITE
+#endif
+
+#ifdef DISABLE_EXT_DPMS
 #undef DPMSExtension
 #endif
 
+#ifdef DISABLE_EXT_MITSHM
+#undef MITSHM
+#endif
+
 #include "misc.h"
 #include "extension.h"
 #include "extinit.h"
-- 
GitLab


From 5b6b4a70ab8212438a6400d8bcac59f2c3182db6 Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Thu, 15 Feb 2024 18:57:36 +0100
Subject: [PATCH 07/15] Xnest: drop xnest-config.h

Xnest now is the only consumer of xnest-config.h, but here
dix-config is enough (doesn't use anything from xkb-config.h),
so this file can be dropped now.

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/Args.c         |  2 +-
 hw/xnest/Color.c        |  2 +-
 hw/xnest/Cursor.c       |  2 +-
 hw/xnest/Display.c      |  2 +-
 hw/xnest/Events.c       |  2 +-
 hw/xnest/Font.c         |  2 +-
 hw/xnest/GC.c           |  2 +-
 hw/xnest/GCOps.c        |  2 +-
 hw/xnest/Handlers.c     |  2 +-
 hw/xnest/Init.c         |  2 +-
 hw/xnest/Keyboard.c     |  2 +-
 hw/xnest/Pixmap.c       |  2 +-
 hw/xnest/Pointer.c      |  2 +-
 hw/xnest/Screen.c       |  2 +-
 hw/xnest/Visual.c       |  2 +-
 hw/xnest/Window.c       |  2 +-
 hw/xnest/xnest-config.h | 36 ------------------------------------
 17 files changed, 16 insertions(+), 52 deletions(-)
 delete mode 100644 hw/xnest/xnest-config.h

diff --git a/hw/xnest/Args.c b/hw/xnest/Args.c
index fbeb9a3096..729bf4023e 100644
--- a/hw/xnest/Args.c
+++ b/hw/xnest/Args.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Color.c b/hw/xnest/Color.c
index c6f5df0b91..94cace129c 100644
--- a/hw/xnest/Color.c
+++ b/hw/xnest/Color.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Cursor.c b/hw/xnest/Cursor.c
index 7accf73dcf..8404c91f2f 100644
--- a/hw/xnest/Cursor.c
+++ b/hw/xnest/Cursor.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Display.c b/hw/xnest/Display.c
index 8987a13f59..a92305baec 100644
--- a/hw/xnest/Display.c
+++ b/hw/xnest/Display.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <string.h>
 #include <errno.h>
diff --git a/hw/xnest/Events.c b/hw/xnest/Events.c
index b5a3b36d76..505be3d264 100644
--- a/hw/xnest/Events.c
+++ b/hw/xnest/Events.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Font.c b/hw/xnest/Font.c
index 564b36ba23..cb5ba0fd9e 100644
--- a/hw/xnest/Font.c
+++ b/hw/xnest/Font.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xatom.h>
diff --git a/hw/xnest/GC.c b/hw/xnest/GC.c
index 2e4b5ae174..41c0ffd579 100644
--- a/hw/xnest/GC.c
+++ b/hw/xnest/GC.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/GCOps.c b/hw/xnest/GCOps.c
index 3cbe5d65e5..06dfd380c2 100644
--- a/hw/xnest/GCOps.c
+++ b/hw/xnest/GCOps.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Handlers.c b/hw/xnest/Handlers.c
index a06f3f90d3..7e51333816 100644
--- a/hw/xnest/Handlers.c
+++ b/hw/xnest/Handlers.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Init.c b/hw/xnest/Init.c
index 23ddf7c03a..18841a2740 100644
--- a/hw/xnest/Init.c
+++ b/hw/xnest/Init.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Keyboard.c b/hw/xnest/Keyboard.c
index 3ce95a0f77..1e00c73b4a 100644
--- a/hw/xnest/Keyboard.c
+++ b/hw/xnest/Keyboard.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #ifdef WIN32
 #include <X11/Xwindows.h>
diff --git a/hw/xnest/Pixmap.c b/hw/xnest/Pixmap.c
index 30c030b630..ce20c8a72b 100644
--- a/hw/xnest/Pixmap.c
+++ b/hw/xnest/Pixmap.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Pointer.c b/hw/xnest/Pointer.c
index b7cc6e8c2a..671de15739 100644
--- a/hw/xnest/Pointer.c
+++ b/hw/xnest/Pointer.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Screen.c b/hw/xnest/Screen.c
index 11b162d8f4..f12e78c6c9 100644
--- a/hw/xnest/Screen.c
+++ b/hw/xnest/Screen.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Visual.c b/hw/xnest/Visual.c
index 858324b2c5..f2c1707f46 100644
--- a/hw/xnest/Visual.c
+++ b/hw/xnest/Visual.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/Window.c b/hw/xnest/Window.c
index dbfe7b7ab8..88c4e20d41 100644
--- a/hw/xnest/Window.c
+++ b/hw/xnest/Window.c
@@ -12,7 +12,7 @@ is" without express or implied warranty.
 
 */
 
-#include <xnest-config.h>
+#include <dix-config.h>
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
diff --git a/hw/xnest/xnest-config.h b/hw/xnest/xnest-config.h
deleted file mode 100644
index ef48c580f8..0000000000
--- a/hw/xnest/xnest-config.h
+++ /dev/null
@@ -1,36 +0,0 @@
-/*
- * Copyright 2005 Red Hat Inc., Raleigh, North Carolina.
- *
- * All Rights Reserved.
- *
- * Permission is hereby granted, free of charge, to any person obtaining
- * a copy of this software and associated documentation files (the
- * "Software"), to deal in the Software without restriction, including
- * without limitation on the rights to use, copy, modify, merge,
- * publish, distribute, sublicense, and/or sell copies of the Software,
- * and to permit persons to whom the Software is furnished to do so,
- * subject to the following conditions:
- *
- * The above copyright notice and this permission notice (including the
- * next paragraph) shall be included in all copies or substantial
- * portions of the Software.
- *
- * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
- * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
- * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
- * NON-INFRINGEMENT.  IN NO EVENT SHALL RED HAT AND/OR THEIR SUPPLIERS
- * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
- * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
- * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
- * SOFTWARE.
- */
-
-#ifndef XNEST_CONFIG_H
-#define XNEST_CONFIG_H
-
-#include <dix-config.h>
-#include <xkb-config.h>
-
-#undef MITSHM
-
-#endif                          /* XNEST_CONFIG_H */
-- 
GitLab


From f5ac36b7afe6f588eee899a102118cb660d0680a Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Fri, 16 Feb 2024 16:30:15 +0100
Subject: [PATCH 08/15] Xnest: drop hack for building 32bit server against
 64bit libs

Xnest.h contains a weird historical hack for building 32bit server with 64bit
libraries. It redeclares a bunch of stanard X types (eg. from Xdefs.h) to
32 bit size. Those hacks are ugly to maintain and can easily cause trouble
(eg. if include order gets mixed up). And it's not at all needed anyways.

Those kind of situations are easily solved, in a much more robust way:
just run build the build it in a chroot or container, or do a pretty
boring usual crosscompile.

No need to carry special hacks for things that already done out-of-the-box
by proper tooling / build environment.

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/Color.c    | 42 ----------------------------------
 hw/xnest/Keyboard.c | 17 --------------
 hw/xnest/Xnest.h    | 55 ---------------------------------------------
 3 files changed, 114 deletions(-)

diff --git a/hw/xnest/Color.c b/hw/xnest/Color.c
index 94cace129c..c323e7110b 100644
--- a/hw/xnest/Color.c
+++ b/hw/xnest/Color.c
@@ -213,22 +213,8 @@ xnestSetInstalledColormapWindows(ScreenPtr pScreen)
     if (!xnestSameInstalledColormapWindows(icws.windows, icws.numWindows)) {
         free(xnestOldInstalledColormapWindows);
 
-#ifdef _XSERVER64
-        {
-            int i;
-            Window64 *windows = xallocarray(numWindows, sizeof(Window64));
-
-            for (i = 0; i < numWindows; ++i)
-                windows[i] = icws.windows[i];
-            XSetWMColormapWindows(xnestDisplay,
-                                  xnestDefaultWindows[pScreen->myNum], windows,
-                                  numWindows);
-            free(windows);
-        }
-#else
         XSetWMColormapWindows(xnestDisplay, xnestDefaultWindows[pScreen->myNum],
                               icws.windows, numWindows);
-#endif
 
         xnestOldInstalledColormapWindows = icws.windows;
         xnestNumOldInstalledColormapWindows = icws.numWindows;
@@ -270,19 +256,8 @@ xnestSetScreenSaverColormapWindow(ScreenPtr pScreen)
 {
     free(xnestOldInstalledColormapWindows);
 
-#ifdef _XSERVER64
-    {
-        Window64 window;
-
-        window = xnestScreenSaverWindows[pScreen->myNum];
-        XSetWMColormapWindows(xnestDisplay, xnestDefaultWindows[pScreen->myNum],
-                              &window, 1);
-        xnestScreenSaverWindows[pScreen->myNum] = window;
-    }
-#else
     XSetWMColormapWindows(xnestDisplay, xnestDefaultWindows[pScreen->myNum],
                           &xnestScreenSaverWindows[pScreen->myNum], 1);
-#endif                          /* _XSERVER64 */
 
     xnestOldInstalledColormapWindows = NULL;
     xnestNumOldInstalledColormapWindows = 0;
@@ -385,25 +360,8 @@ void
 xnestStoreColors(ColormapPtr pCmap, int nColors, xColorItem * pColors)
 {
     if (pCmap->pVisual->class & DynamicClass)
-#ifdef _XSERVER64
-    {
-        int i;
-        XColor *pColors64 = xallocarray(nColors, sizeof(XColor));
-
-        for (i = 0; i < nColors; ++i) {
-            pColors64[i].pixel = pColors[i].pixel;
-            pColors64[i].red = pColors[i].red;
-            pColors64[i].green = pColors[i].green;
-            pColors64[i].blue = pColors[i].blue;
-            pColors64[i].flags = pColors[i].flags;
-        }
-        XStoreColors(xnestDisplay, xnestColormap(pCmap), pColors64, nColors);
-        free(pColors64);
-    }
-#else
         XStoreColors(xnestDisplay, xnestColormap(pCmap),
                      (XColor *) pColors, nColors);
-#endif
 }
 
 void
diff --git a/hw/xnest/Keyboard.c b/hw/xnest/Keyboard.c
index 1e00c73b4a..1e47f408ba 100644
--- a/hw/xnest/Keyboard.c
+++ b/hw/xnest/Keyboard.c
@@ -125,26 +125,9 @@ xnestKeyboardProc(DeviceIntPtr pDev, int onoff)
     switch (onoff) {
     case DEVICE_INIT:
         XDisplayKeycodes(xnestDisplay, &min_keycode, &max_keycode);
-#ifdef _XSERVER64
-        {
-            KeySym64 *keymap64;
-            int len;
-
-            keymap64 = XGetKeyboardMapping(xnestDisplay,
-                                           min_keycode,
-                                           max_keycode - min_keycode + 1,
-                                           &mapWidth);
-            len = (max_keycode - min_keycode + 1) * mapWidth;
-            keymap = xallocarray(len, sizeof(KeySym));
-            for (i = 0; i < len; ++i)
-                keymap[i] = keymap64[i];
-            XFree(keymap64);
-        }
-#else
         keymap = XGetKeyboardMapping(xnestDisplay,
                                      min_keycode,
                                      max_keycode - min_keycode + 1, &mapWidth);
-#endif
 
         memset(modmap, 0, sizeof(modmap));
         modifier_keymap = XGetModifierMapping(xnestDisplay);
diff --git a/hw/xnest/Xnest.h b/hw/xnest/Xnest.h
index 37ea6e532f..075848a344 100644
--- a/hw/xnest/Xnest.h
+++ b/hw/xnest/Xnest.h
@@ -28,63 +28,8 @@ from the X Consortium.
 
 */
 
-/*
-** Machines with a 64 bit library interface and a 32 bit server require
-** name changes to protect the guilty.
-*/
-#ifdef _XSERVER64
-#define _XSERVER64_tmp
-#undef _XSERVER64
-typedef unsigned long XID64;
-typedef unsigned long Mask64;
-typedef unsigned long Atom64;
-typedef unsigned long VisualID64;
-typedef unsigned long Time64;
-
-#define XID     XID64
-#define Mask    Mask64
-#define Atom    Atom64
-#define VisualID VisualID64
-#define Time    Time64
-typedef XID Window64;
-typedef XID Drawable64;
-typedef XID Font64;
-typedef XID Pixmap64;
-typedef XID Cursor64;
-typedef XID Colormap64;
-typedef XID GContext64;
-typedef XID KeySym64;
-
-#define Window          Window64
-#define Drawable        Drawable64
-#define Font            Font64
-#define Pixmap          Pixmap64
-#define Cursor          Cursor64
-#define Colormap        Colormap64
-#define GContext        GContext64
-#define KeySym          KeySym64
-#endif  /*_XSERVER64*/
-
 #define GC XlibGC
 #include <X11/Xlib.h>
 #include <X11/Xutil.h>
 #include <X11/extensions/shape.h>
 #undef GC
-
-#ifdef _XSERVER64_tmp
-#define _XSERVER64
-#undef _XSERVER64_tmp
-#undef XID
-#undef Mask
-#undef Atom
-#undef VisualID
-#undef Time
-#undef Window
-#undef Drawable
-#undef Font
-#undef Pixmap
-#undef Cursor
-#undef Colormap
-#undef GContext
-#undef KeySym
-#endif /*_XSERVER64_tmp*/
-- 
GitLab


From 01822ffaf1bfaa139e297bdf15eae7c6238df5a3 Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Thu, 15 Feb 2024 19:39:49 +0100
Subject: [PATCH 09/15] Xnest: canonicalize includes: <X11/Xdefs.h>

For cleaner code, make sure every source needing something from Xdefs.h
does explicitly include it (not relying on indirect including)

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/Args.c     | 2 ++
 hw/xnest/Args.h     | 2 ++
 hw/xnest/Color.c    | 2 ++
 hw/xnest/Color.h    | 2 ++
 hw/xnest/Cursor.c   | 2 ++
 hw/xnest/Events.c   | 2 ++
 hw/xnest/Font.c     | 6 ++++--
 hw/xnest/GC.c       | 2 ++
 hw/xnest/GCOps.c    | 4 +++-
 hw/xnest/Init.c     | 3 ++-
 hw/xnest/Init.h     | 2 ++
 hw/xnest/Keyboard.c | 2 ++
 hw/xnest/Pixmap.c   | 2 ++
 hw/xnest/Screen.c   | 2 ++
 hw/xnest/Screen.h   | 2 ++
 hw/xnest/Window.c   | 2 ++
 hw/xnest/XNCursor.h | 2 ++
 hw/xnest/XNFont.h   | 2 ++
 hw/xnest/XNGC.h     | 2 ++
 hw/xnest/XNPixmap.h | 2 ++
 hw/xnest/XNWindow.h | 2 ++
 21 files changed, 45 insertions(+), 4 deletions(-)

diff --git a/hw/xnest/Args.c b/hw/xnest/Args.c
index 729bf4023e..bdc8d20c9f 100644
--- a/hw/xnest/Args.c
+++ b/hw/xnest/Args.c
@@ -15,7 +15,9 @@ is" without express or implied warranty.
 #include <dix-config.h>
 
 #include <X11/X.h>
+#include <X11/Xdefs.h>
 #include <X11/Xproto.h>
+
 #include "screenint.h"
 #include "input.h"
 #include "misc.h"
diff --git a/hw/xnest/Args.h b/hw/xnest/Args.h
index 225418d22e..cce503cb2c 100644
--- a/hw/xnest/Args.h
+++ b/hw/xnest/Args.h
@@ -15,6 +15,8 @@ is" without express or implied warranty.
 #ifndef XNESTARGS_H
 #define XNESTARGS_H
 
+#include <X11/Xdefs.h>
+
 extern char *xnestDisplayName;
 extern Bool xnestSynchronize;
 extern Bool xnestFullGeneration;
diff --git a/hw/xnest/Color.c b/hw/xnest/Color.c
index c323e7110b..0db6e9d554 100644
--- a/hw/xnest/Color.c
+++ b/hw/xnest/Color.c
@@ -15,7 +15,9 @@ is" without express or implied warranty.
 #include <dix-config.h>
 
 #include <X11/X.h>
+#include <X11/Xdefs.h>
 #include <X11/Xproto.h>
+
 #include "scrnintstr.h"
 #include "window.h"
 #include "windowstr.h"
diff --git a/hw/xnest/Color.h b/hw/xnest/Color.h
index 2c4e0be2a1..480b35cbbf 100644
--- a/hw/xnest/Color.h
+++ b/hw/xnest/Color.h
@@ -15,6 +15,8 @@ is" without express or implied warranty.
 #ifndef XNESTCOLOR_H
 #define XNESTCOLOR_H
 
+#include <X11/Xdefs.h>
+
 #define DUMB_WINDOW_MANAGERS
 
 #define MAXCMAPS 1
diff --git a/hw/xnest/Cursor.c b/hw/xnest/Cursor.c
index 8404c91f2f..b49b4af44a 100644
--- a/hw/xnest/Cursor.c
+++ b/hw/xnest/Cursor.c
@@ -15,7 +15,9 @@ is" without express or implied warranty.
 #include <dix-config.h>
 
 #include <X11/X.h>
+#include <X11/Xdefs.h>
 #include <X11/Xproto.h>
+
 #include "screenint.h"
 #include "input.h"
 #include "misc.h"
diff --git a/hw/xnest/Events.c b/hw/xnest/Events.c
index 505be3d264..25aa5fd79a 100644
--- a/hw/xnest/Events.c
+++ b/hw/xnest/Events.c
@@ -15,7 +15,9 @@ is" without express or implied warranty.
 #include <dix-config.h>
 
 #include <X11/X.h>
+#include <X11/Xdefs.h>
 #include <X11/Xproto.h>
+
 #include "screenint.h"
 #include "input.h"
 #include "misc.h"
diff --git a/hw/xnest/Font.c b/hw/xnest/Font.c
index cb5ba0fd9e..9167158771 100644
--- a/hw/xnest/Font.c
+++ b/hw/xnest/Font.c
@@ -16,11 +16,13 @@ is" without express or implied warranty.
 
 #include <X11/X.h>
 #include <X11/Xatom.h>
+#include <X11/Xdefs.h>
 #include <X11/Xproto.h>
-#include "misc.h"
-#include "regionstr.h"
 #include <X11/fonts/font.h>
 #include <X11/fonts/fontstruct.h>
+
+#include "misc.h"
+#include "regionstr.h"
 #include "dixfontstr.h"
 #include "scrnintstr.h"
 
diff --git a/hw/xnest/GC.c b/hw/xnest/GC.c
index 41c0ffd579..fb6f5c84eb 100644
--- a/hw/xnest/GC.c
+++ b/hw/xnest/GC.c
@@ -15,7 +15,9 @@ is" without express or implied warranty.
 #include <dix-config.h>
 
 #include <X11/X.h>
+#include <X11/Xdefs.h>
 #include <X11/Xproto.h>
+
 #include "gcstruct.h"
 #include "windowstr.h"
 #include "pixmapstr.h"
diff --git a/hw/xnest/GCOps.c b/hw/xnest/GCOps.c
index 06dfd380c2..145a605bb6 100644
--- a/hw/xnest/GCOps.c
+++ b/hw/xnest/GCOps.c
@@ -15,9 +15,11 @@ is" without express or implied warranty.
 #include <dix-config.h>
 
 #include <X11/X.h>
+#include <X11/Xdefs.h>
 #include <X11/Xproto.h>
-#include "regionstr.h"
 #include <X11/fonts/fontstruct.h>
+
+#include "regionstr.h"
 #include "gcstruct.h"
 #include "scrnintstr.h"
 #include "windowstr.h"
diff --git a/hw/xnest/Init.c b/hw/xnest/Init.c
index 18841a2740..1027c140f8 100644
--- a/hw/xnest/Init.c
+++ b/hw/xnest/Init.c
@@ -15,7 +15,9 @@ is" without express or implied warranty.
 #include <dix-config.h>
 
 #include <X11/X.h>
+#include <X11/Xdefs.h>
 #include <X11/Xproto.h>
+#include <X11/fonts/fontstruct.h>
 
 #include "dix/screenint_priv.h"
 
@@ -26,7 +28,6 @@ is" without express or implied warranty.
 #include "windowstr.h"
 #include "servermd.h"
 #include "mi.h"
-#include <X11/fonts/fontstruct.h>
 #include "dixfontstr.h"
 
 #include "Xnest.h"
diff --git a/hw/xnest/Init.h b/hw/xnest/Init.h
index 7c0291ebfa..0dc1439043 100644
--- a/hw/xnest/Init.h
+++ b/hw/xnest/Init.h
@@ -15,6 +15,8 @@ is" without express or implied warranty.
 #ifndef XNESTINIT_H
 #define XNESTINIT_H
 
+#include <X11/Xdefs.h>
+
 extern Bool xnestDoFullGeneration;
 
 #endif                          /* XNESTINIT_H */
diff --git a/hw/xnest/Keyboard.c b/hw/xnest/Keyboard.c
index 1e47f408ba..81138676dd 100644
--- a/hw/xnest/Keyboard.c
+++ b/hw/xnest/Keyboard.c
@@ -19,8 +19,10 @@ is" without express or implied warranty.
 #endif
 
 #include <X11/X.h>
+#include <X11/Xdefs.h>
 #include <X11/Xproto.h>
 #include <X11/keysym.h>
+
 #include "screenint.h"
 #include "inputstr.h"
 #include "misc.h"
diff --git a/hw/xnest/Pixmap.c b/hw/xnest/Pixmap.c
index ce20c8a72b..2010bfa26e 100644
--- a/hw/xnest/Pixmap.c
+++ b/hw/xnest/Pixmap.c
@@ -15,7 +15,9 @@ is" without express or implied warranty.
 #include <dix-config.h>
 
 #include <X11/X.h>
+#include <X11/Xdefs.h>
 #include <X11/Xproto.h>
+
 #include "regionstr.h"
 #include "pixmapstr.h"
 #include "scrnintstr.h"
diff --git a/hw/xnest/Screen.c b/hw/xnest/Screen.c
index f12e78c6c9..cb0bd30608 100644
--- a/hw/xnest/Screen.c
+++ b/hw/xnest/Screen.c
@@ -15,7 +15,9 @@ is" without express or implied warranty.
 #include <dix-config.h>
 
 #include <X11/X.h>
+#include <X11/Xdefs.h>
 #include <X11/Xproto.h>
+
 #include "scrnintstr.h"
 #include "dix.h"
 #include "mi.h"
diff --git a/hw/xnest/Screen.h b/hw/xnest/Screen.h
index 17c514af7c..4ab73c41b1 100644
--- a/hw/xnest/Screen.h
+++ b/hw/xnest/Screen.h
@@ -15,6 +15,8 @@ is" without express or implied warranty.
 #ifndef XNESTSCREEN_H
 #define XNESTSCREEN_H
 
+#include <X11/Xdefs.h>
+
 extern Window xnestDefaultWindows[MAXSCREENS];
 extern Window xnestScreenSaverWindows[MAXSCREENS];
 
diff --git a/hw/xnest/Window.c b/hw/xnest/Window.c
index 88c4e20d41..f1fe01025c 100644
--- a/hw/xnest/Window.c
+++ b/hw/xnest/Window.c
@@ -15,7 +15,9 @@ is" without express or implied warranty.
 #include <dix-config.h>
 
 #include <X11/X.h>
+#include <X11/Xdefs.h>
 #include <X11/Xproto.h>
+
 #include "gcstruct.h"
 #include "window.h"
 #include "windowstr.h"
diff --git a/hw/xnest/XNCursor.h b/hw/xnest/XNCursor.h
index 1a3c6f44e6..2036ad5130 100644
--- a/hw/xnest/XNCursor.h
+++ b/hw/xnest/XNCursor.h
@@ -15,6 +15,8 @@ is" without express or implied warranty.
 #ifndef XNESTCURSOR_H
 #define XNESTCURSOR_H
 
+#include <X11/Xdefs.h>
+
 #include "mipointrst.h"
 
 typedef struct {
diff --git a/hw/xnest/XNFont.h b/hw/xnest/XNFont.h
index a210b1790b..1c10da1ea5 100644
--- a/hw/xnest/XNFont.h
+++ b/hw/xnest/XNFont.h
@@ -15,6 +15,8 @@ is" without express or implied warranty.
 #ifndef XNESTFONT_H
 #define XNESTFONT_H
 
+#include <X11/Xdefs.h>
+
 typedef struct {
     XFontStruct *font_struct;
 } xnestPrivFont;
diff --git a/hw/xnest/XNGC.h b/hw/xnest/XNGC.h
index 974173e50b..6a222d0735 100644
--- a/hw/xnest/XNGC.h
+++ b/hw/xnest/XNGC.h
@@ -15,6 +15,8 @@ is" without express or implied warranty.
 #ifndef XNESTGC_H
 #define XNESTGC_H
 
+#include <X11/Xdefs.h>
+
 /* This file uses the GC definition form Xlib.h as XlibGC. */
 
 typedef struct {
diff --git a/hw/xnest/XNPixmap.h b/hw/xnest/XNPixmap.h
index b7b10e9073..0bd8214a57 100644
--- a/hw/xnest/XNPixmap.h
+++ b/hw/xnest/XNPixmap.h
@@ -15,6 +15,8 @@ is" without express or implied warranty.
 #ifndef XNESTPIXMAP_H
 #define XNESTPIXMAP_H
 
+#include <X11/Xdefs.h>
+
 extern DevPrivateKeyRec xnestPixmapPrivateKeyRec;
 
 #define xnestPixmapPrivateKey (&xnestPixmapPrivateKeyRec)
diff --git a/hw/xnest/XNWindow.h b/hw/xnest/XNWindow.h
index 6320ede5eb..59dba01c03 100644
--- a/hw/xnest/XNWindow.h
+++ b/hw/xnest/XNWindow.h
@@ -15,6 +15,8 @@ is" without express or implied warranty.
 #ifndef XNESTWINDOW_H
 #define XNESTWINDOW_H
 
+#include <X11/Xdefs.h>
+
 typedef struct {
     Window window;
     Window parent;
-- 
GitLab


From f0e3f29b22106b2e70c401724605e082aeeb80e9 Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Fri, 16 Feb 2024 17:25:29 +0100
Subject: [PATCH 10/15] fix name clash on 'GC' between Xlib and Xserver

Both xlib as well as the Xserver use the same identifier "GC" for
different types. While on xlib it's just the numerical ID of a GC,
the xserver defines a struct for it by the same name. This is this
ugly and needs ridiculous hacks for Xserver code that needs xlib.

Easy to solve by just renaming the GC typedef to GCRec (consistent
with how we're naming other structs) and replacing GC* by GCPtr.

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 dix/dispatch.c                         | 44 +++++++++++++-------------
 dix/dixfonts.c                         | 10 +++---
 dix/dixutils.c                         |  2 +-
 dix/gc.c                               | 10 +++---
 dix/privates.c                         |  2 +-
 hw/xfree86/common/xf86VGAarbiter.c     |  4 +--
 hw/xfree86/common/xf86VGAarbiterPriv.h |  4 +--
 include/closestr.h                     |  4 +--
 include/gcstruct.h                     |  2 +-
 mi/miglblt.c                           |  4 +--
 miext/damage/damage.c                  |  4 +--
 11 files changed, 45 insertions(+), 45 deletions(-)

diff --git a/dix/dispatch.c b/dix/dispatch.c
index e88e8de1db..56c854495f 100644
--- a/dix/dispatch.c
+++ b/dix/dispatch.c
@@ -1547,7 +1547,7 @@ int
 ProcCreateGC(ClientPtr client)
 {
     int error, rc;
-    GC *pGC;
+    GCPtr pGC;
     DrawablePtr pDraw;
     unsigned len;
 
@@ -1564,7 +1564,7 @@ ProcCreateGC(ClientPtr client)
     len = client->req_len - bytes_to_int32(sizeof(xCreateGCReq));
     if (len != Ones(stuff->mask))
         return BadLength;
-    pGC = (GC *) CreateGC(pDraw, stuff->mask, (XID *) &stuff[1], &error,
+    pGC = (GCPtr) CreateGC(pDraw, stuff->mask, (XID *) &stuff[1], &error,
                           stuff->gc, client);
     if (error != Success)
         return error;
@@ -1576,7 +1576,7 @@ ProcCreateGC(ClientPtr client)
 int
 ProcChangeGC(ClientPtr client)
 {
-    GC *pGC;
+    GCPtr pGC;
     int result;
     unsigned len;
 
@@ -1597,8 +1597,8 @@ ProcChangeGC(ClientPtr client)
 int
 ProcCopyGC(ClientPtr client)
 {
-    GC *dstGC;
-    GC *pGC;
+    GCPtr dstGC;
+    GCPtr pGC;
     int result;
 
     REQUEST(xCopyGCReq);
@@ -1622,7 +1622,7 @@ ProcCopyGC(ClientPtr client)
 int
 ProcSetDashes(ClientPtr client)
 {
-    GC *pGC;
+    GCPtr pGC;
     int result;
 
     REQUEST(xSetDashesReq);
@@ -1648,7 +1648,7 @@ int
 ProcSetClipRectangles(ClientPtr client)
 {
     int nr, result;
-    GC *pGC;
+    GCPtr pGC;
 
     REQUEST(xSetClipRectanglesReq);
 
@@ -1673,7 +1673,7 @@ ProcSetClipRectangles(ClientPtr client)
 int
 ProcFreeGC(ClientPtr client)
 {
-    GC *pGC;
+    GCPtr pGC;
     int rc;
 
     REQUEST(xResourceReq);
@@ -1763,7 +1763,7 @@ ProcCopyArea(ClientPtr client)
 {
     DrawablePtr pDst;
     DrawablePtr pSrc;
-    GC *pGC;
+    GCPtr pGC;
 
     REQUEST(xCopyAreaReq);
     RegionPtr pRgn;
@@ -1801,7 +1801,7 @@ int
 ProcCopyPlane(ClientPtr client)
 {
     DrawablePtr psrcDraw, pdstDraw;
-    GC *pGC;
+    GCPtr pGC;
 
     REQUEST(xCopyPlaneReq);
     RegionPtr pRgn;
@@ -1847,7 +1847,7 @@ int
 ProcPolyPoint(ClientPtr client)
 {
     int npoint;
-    GC *pGC;
+    GCPtr pGC;
     DrawablePtr pDraw;
 
     REQUEST(xPolyPointReq);
@@ -1870,7 +1870,7 @@ int
 ProcPolyLine(ClientPtr client)
 {
     int npoint;
-    GC *pGC;
+    GCPtr pGC;
     DrawablePtr pDraw;
 
     REQUEST(xPolyLineReq);
@@ -1893,7 +1893,7 @@ int
 ProcPolySegment(ClientPtr client)
 {
     int nsegs;
-    GC *pGC;
+    GCPtr pGC;
     DrawablePtr pDraw;
 
     REQUEST(xPolySegmentReq);
@@ -1913,7 +1913,7 @@ int
 ProcPolyRectangle(ClientPtr client)
 {
     int nrects;
-    GC *pGC;
+    GCPtr pGC;
     DrawablePtr pDraw;
 
     REQUEST(xPolyRectangleReq);
@@ -1934,7 +1934,7 @@ int
 ProcPolyArc(ClientPtr client)
 {
     int narcs;
-    GC *pGC;
+    GCPtr pGC;
     DrawablePtr pDraw;
 
     REQUEST(xPolyArcReq);
@@ -1954,7 +1954,7 @@ int
 ProcFillPoly(ClientPtr client)
 {
     int things;
-    GC *pGC;
+    GCPtr pGC;
     DrawablePtr pDraw;
 
     REQUEST(xFillPolyReq);
@@ -1984,7 +1984,7 @@ int
 ProcPolyFillRectangle(ClientPtr client)
 {
     int things;
-    GC *pGC;
+    GCPtr pGC;
     DrawablePtr pDraw;
 
     REQUEST(xPolyFillRectangleReq);
@@ -2006,7 +2006,7 @@ int
 ProcPolyFillArc(ClientPtr client)
 {
     int narcs;
-    GC *pGC;
+    GCPtr pGC;
     DrawablePtr pDraw;
 
     REQUEST(xPolyFillArcReq);
@@ -2079,7 +2079,7 @@ ReformatImage(char *base, int nbytes, int bpp, int order)
 int
 ProcPutImage(ClientPtr client)
 {
-    GC *pGC;
+    GCPtr pGC;
     DrawablePtr pDraw;
     long length;                /* length of scanline server padded */
     long lengthProto;           /* length of scanline protocol padded */
@@ -2350,7 +2350,7 @@ ProcPolyText(ClientPtr client)
 
     REQUEST(xPolyTextReq);
     DrawablePtr pDraw;
-    GC *pGC;
+    GCPtr pGC;
 
     REQUEST_AT_LEAST_SIZE(xPolyTextReq);
     VALIDATE_DRAWABLE_AND_GC(stuff->drawable, pDraw, DixWriteAccess);
@@ -2374,7 +2374,7 @@ ProcImageText8(ClientPtr client)
 {
     int err;
     DrawablePtr pDraw;
-    GC *pGC;
+    GCPtr pGC;
 
     REQUEST(xImageTextReq);
 
@@ -2400,7 +2400,7 @@ ProcImageText16(ClientPtr client)
 {
     int err;
     DrawablePtr pDraw;
-    GC *pGC;
+    GCPtr pGC;
 
     REQUEST(xImageTextReq);
 
diff --git a/dix/dixfonts.c b/dix/dixfonts.c
index 9608e4b1fb..ca95145f6e 100644
--- a/dix/dixfonts.c
+++ b/dix/dixfonts.c
@@ -1098,7 +1098,7 @@ doPolyText(ClientPtr client, PTclosurePtr c)
     int err = Success, lgerr;   /* err is in X error, not font error, space */
     enum { NEVER_SLEPT, START_SLEEP, SLEEPING } client_state = NEVER_SLEPT;
     FontPathElementPtr fpe;
-    GC *origGC = NULL;
+    GCPtr origGC = NULL;
     int itemSize = c->reqType == X_PolyText8 ? 1 : 2;
 
     if (client->clientGone) {
@@ -1208,7 +1208,7 @@ doPolyText(ClientPtr client, PTclosurePtr c)
             if (lgerr == Suspended) {
                 if (!ClientIsAsleep(client)) {
                     int len;
-                    GC *pGC;
+                    GCPtr pGC;
                     PTclosurePtr new_closure;
 
                     /*  We're putting the client to sleep.  We need to do a few things
@@ -1349,7 +1349,7 @@ doPolyText(ClientPtr client, PTclosurePtr c)
 }
 
 int
-PolyText(ClientPtr client, DrawablePtr pDraw, GC * pGC, unsigned char *pElt,
+PolyText(ClientPtr client, DrawablePtr pDraw, GCPtr pGC, unsigned char *pElt,
          unsigned char *endReq, int xorg, int yorg, int reqType, XID did)
 {
     PTclosureRec local_closure;
@@ -1404,7 +1404,7 @@ doImageText(ClientPtr client, ITclosurePtr c)
     lgerr = LoadGlyphs(client, c->pGC->font, c->nChars, itemSize, c->data);
     if (lgerr == Suspended) {
         if (!ClientIsAsleep(client)) {
-            GC *pGC;
+            GCPtr pGC;
             unsigned char *data;
             ITclosurePtr new_closure;
             ITclosurePtr old_closure;
@@ -1495,7 +1495,7 @@ doImageText(ClientPtr client, ITclosurePtr c)
 }
 
 int
-ImageText(ClientPtr client, DrawablePtr pDraw, GC * pGC, int nChars,
+ImageText(ClientPtr client, DrawablePtr pDraw, GCPtr pGC, int nChars,
           unsigned char *data, int xorg, int yorg, int reqType, XID did)
 {
     ITclosureRec local_closure;
diff --git a/dix/dixutils.c b/dix/dixutils.c
index a11c82e9f6..db8f0283f1 100644
--- a/dix/dixutils.c
+++ b/dix/dixutils.c
@@ -243,7 +243,7 @@ int
 dixLookupFontable(FontPtr *pFont, XID id, ClientPtr client, Mask access)
 {
     int rc;
-    GC *pGC;
+    GCPtr pGC;
 
     client->errorValue = id;    /* EITHER font or gc */
     rc = dixLookupResourceByType((void **) pFont, id, RT_FONT, client,
diff --git a/dix/gc.c b/dix/gc.c
index 0e75e8765a..0433ac3959 100644
--- a/dix/gc.c
+++ b/dix/gc.c
@@ -72,7 +72,7 @@ static Bool CreateDefaultTile(GCPtr pGC);
 static unsigned char DefaultDash[2] = { 4, 4 };
 
 void
-ValidateGC(DrawablePtr pDraw, GC * pGC)
+ValidateGC(DrawablePtr pDraw, GCPtr pGC)
 {
     (*pGC->funcs->ValidateGC) (pGC, pGC->stateChanges, pDraw);
     pGC->stateChanges = 0;
@@ -120,7 +120,7 @@ ValidateGC(DrawablePtr pDraw, GC * pGC)
     _var = (_type)pUnion->ptr; pUnion++; }
 
 int
-ChangeGC(ClientPtr client, GC * pGC, BITS32 mask, ChangeGCValPtr pUnion)
+ChangeGC(ClientPtr client, GCPtr pGC, BITS32 mask, ChangeGCValPtr pUnion)
 {
     BITS32 index2;
     int error = 0;
@@ -428,7 +428,7 @@ static const struct {
 };
 
 int
-ChangeGCXIDs(ClientPtr client, GC * pGC, BITS32 mask, CARD32 *pC32)
+ChangeGCXIDs(ClientPtr client, GCPtr pGC, BITS32 mask, CARD32 *pC32)
 {
     ChangeGCVal vals[GCLastBit + 1];
     int i;
@@ -465,7 +465,7 @@ NewGCObject(ScreenPtr pScreen, int depth)
 {
     GCPtr pGC;
 
-    pGC = dixAllocateScreenObjectWithPrivates(pScreen, GC, PRIVATE_GC);
+    pGC = dixAllocateScreenObjectWithPrivates(pScreen, GCRec, PRIVATE_GC);
     if (!pGC) {
         return (GCPtr) NULL;
     }
@@ -614,7 +614,7 @@ CreateDefaultTile(GCPtr pGC)
 }
 
 int
-CopyGC(GC * pgcSrc, GC * pgcDst, BITS32 mask)
+CopyGC(GCPtr pgcSrc, GCPtr pgcDst, BITS32 mask)
 {
     BITS32 index2;
     BITS32 maskQ;
diff --git a/dix/privates.c b/dix/privates.c
index 3df8455316..eb55dc6d58 100644
--- a/dix/privates.c
+++ b/dix/privates.c
@@ -567,7 +567,7 @@ static const int offsets[] = {
     -1,                         /* RT_NONE */
     offsetof(WindowRec, devPrivates),   /* RT_WINDOW */
     offsetof(PixmapRec, devPrivates),   /* RT_PIXMAP */
-    offsetof(GC, devPrivates),  /* RT_GC */
+    offsetof(GCRec, devPrivates),  /* RT_GC */
     -1,                         /* RT_FONT */
     offsetof(CursorRec, devPrivates),   /* RT_CURSOR */
     offsetof(ColormapRec, devPrivates), /* RT_COLORMAP */
diff --git a/hw/xfree86/common/xf86VGAarbiter.c b/hw/xfree86/common/xf86VGAarbiter.c
index 9db8d044f0..77ec330b28 100644
--- a/hw/xfree86/common/xf86VGAarbiter.c
+++ b/hw/xfree86/common/xf86VGAarbiter.c
@@ -609,7 +609,7 @@ VGAarbiterDestroyClip(GCPtr pGC)
 /* GC Ops */
 static void
 VGAarbiterFillSpans(DrawablePtr pDraw,
-                    GC * pGC,
+                    GCPtr pGC,
                     int nInit,
                     DDXPointPtr pptInit, int *pwidthInit, int fSorted)
 {
@@ -658,7 +658,7 @@ VGAarbiterPutImage(DrawablePtr pDraw,
 static RegionPtr
 VGAarbiterCopyArea(DrawablePtr pSrc,
                    DrawablePtr pDst,
-                   GC * pGC,
+                   GCPtr pGC,
                    int srcx, int srcy,
                    int width, int height, int dstx, int dsty)
 {
diff --git a/hw/xfree86/common/xf86VGAarbiterPriv.h b/hw/xfree86/common/xf86VGAarbiterPriv.h
index 03db55700a..573afd8d9c 100644
--- a/hw/xfree86/common/xf86VGAarbiterPriv.h
+++ b/hw/xfree86/common/xf86VGAarbiterPriv.h
@@ -202,7 +202,7 @@ static void VGAarbiterDestroyClip(GCPtr pGC);
 static void VGAarbiterCopyClip(GCPtr pgcDst, GCPtr pgcSrc);
 
 /* GC ops */
-static void VGAarbiterFillSpans(DrawablePtr pDraw, GC * pGC, int nInit,
+static void VGAarbiterFillSpans(DrawablePtr pDraw, GCPtr pGC, int nInit,
                                 DDXPointPtr pptInit, int *pwidthInit,
                                 int fSorted);
 static void VGAarbiterSetSpans(DrawablePtr pDraw, GCPtr pGC, char *pcharsrc,
@@ -212,7 +212,7 @@ static void VGAarbiterPutImage(DrawablePtr pDraw, GCPtr pGC, int depth, int x,
                                int y, int w, int h, int leftPad, int format,
                                char *pImage);
 static RegionPtr VGAarbiterCopyArea(DrawablePtr pSrc, DrawablePtr pDst,
-                                    GC * pGC, int srcx, int srcy, int width,
+                                    GCPtr pGC, int srcx, int srcy, int width,
                                     int height, int dstx, int dsty);
 static RegionPtr VGAarbiterCopyPlane(DrawablePtr pSrc, DrawablePtr pDst,
                                      GCPtr pGC, int srcx, int srcy, int width,
diff --git a/include/closestr.h b/include/closestr.h
index 60e6f09bc8..c4a981b460 100644
--- a/include/closestr.h
+++ b/include/closestr.h
@@ -99,7 +99,7 @@ typedef struct _LFclosure {
 typedef struct _PTclosure {
     ClientPtr client;
     DrawablePtr pDraw;
-    GC *pGC;
+    GCPtr pGC;
     unsigned char *pElt;
     unsigned char *endReq;
     unsigned char *data;
@@ -115,7 +115,7 @@ typedef struct _PTclosure {
 typedef struct _ITclosure {
     ClientPtr client;
     DrawablePtr pDraw;
-    GC *pGC;
+    GCPtr pGC;
     BYTE nChars;
     unsigned char *data;
     int xorg;
diff --git a/include/gcstruct.h b/include/gcstruct.h
index cb1b566553..0450ffa746 100644
--- a/include/gcstruct.h
+++ b/include/gcstruct.h
@@ -279,6 +279,6 @@ typedef struct _GC {
     const GCOps *ops;
     PrivateRec *devPrivates;
     RegionPtr pCompositeClip;
-} GC;
+} GCRec;
 
 #endif                          /* GCSTRUCT_H */
diff --git a/mi/miglblt.c b/mi/miglblt.c
index 169d44ffcd..10dadbc239 100644
--- a/mi/miglblt.c
+++ b/mi/miglblt.c
@@ -81,7 +81,7 @@ with the sample server.
 */
 
 void
-miPolyGlyphBlt(DrawablePtr pDrawable, GC * pGC, int x, int y, unsigned int nglyph, CharInfoPtr * ppci,  /* array of character info */
+miPolyGlyphBlt(DrawablePtr pDrawable, GCPtr pGC, int x, int y, unsigned int nglyph, CharInfoPtr * ppci,  /* array of character info */
                void *pglyphBase       /* start of array of glyphs */
     )
 {
@@ -182,7 +182,7 @@ miPolyGlyphBlt(DrawablePtr pDrawable, GC * pGC, int x, int y, unsigned int nglyp
 }
 
 void
-miImageGlyphBlt(DrawablePtr pDrawable, GC * pGC, int x, int y, unsigned int nglyph, CharInfoPtr * ppci, /* array of character info */
+miImageGlyphBlt(DrawablePtr pDrawable, GCPtr pGC, int x, int y, unsigned int nglyph, CharInfoPtr * ppci, /* array of character info */
                 void *pglyphBase      /* start of array of glyphs */
     )
 {
diff --git a/miext/damage/damage.c b/miext/damage/damage.c
index 344d90d344..ced992f13b 100644
--- a/miext/damage/damage.c
+++ b/miext/damage/damage.c
@@ -634,7 +634,7 @@ damageAddTraps(PicturePtr pPicture,
 
 static void
 damageFillSpans(DrawablePtr pDrawable,
-                GC * pGC, int npt, DDXPointPtr ppt, int *pwidth, int fSorted)
+                GCPtr pGC, int npt, DDXPointPtr ppt, int *pwidth, int fSorted)
 {
     DAMAGE_GC_OP_PROLOGUE(pGC, pDrawable);
 
@@ -753,7 +753,7 @@ damagePutImage(DrawablePtr pDrawable,
 static RegionPtr
 damageCopyArea(DrawablePtr pSrc,
                DrawablePtr pDst,
-               GC * pGC,
+               GCPtr pGC,
                int srcx, int srcy, int width, int height, int dstx, int dsty)
 {
     RegionPtr ret;
-- 
GitLab


From 881421e6fbe084bf5a2235ee5b6a0a9acaea5f9a Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Fri, 16 Feb 2024 17:07:45 +0100
Subject: [PATCH 11/15] Xnest: drop hackish Xnest.h

Now that Xserver's GC struct has been renamed not to conflict with Xlib
anymore, we can drop the ridiculous include hacks and drop Xnest.h

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/Args.c     |  2 --
 hw/xnest/Color.c    |  2 --
 hw/xnest/Cursor.c   |  2 --
 hw/xnest/Display.c  |  4 +---
 hw/xnest/Display.h  |  5 ++++-
 hw/xnest/Events.c   |  3 ---
 hw/xnest/Font.c     |  2 --
 hw/xnest/GC.c       |  2 --
 hw/xnest/GCOps.c    |  2 --
 hw/xnest/Handlers.c |  2 --
 hw/xnest/Init.c     |  2 --
 hw/xnest/Keyboard.c |  2 --
 hw/xnest/Pixmap.c   |  2 --
 hw/xnest/Pointer.c  |  2 --
 hw/xnest/Screen.c   |  2 --
 hw/xnest/Visual.c   |  2 +-
 hw/xnest/Window.c   |  4 +---
 hw/xnest/XNGC.h     |  2 +-
 hw/xnest/Xnest.h    | 35 -----------------------------------
 19 files changed, 8 insertions(+), 71 deletions(-)
 delete mode 100644 hw/xnest/Xnest.h

diff --git a/hw/xnest/Args.c b/hw/xnest/Args.c
index bdc8d20c9f..e5b769a8a2 100644
--- a/hw/xnest/Args.c
+++ b/hw/xnest/Args.c
@@ -24,8 +24,6 @@ is" without express or implied warranty.
 #include "scrnintstr.h"
 #include "servermd.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "Args.h"
 
diff --git a/hw/xnest/Color.c b/hw/xnest/Color.c
index 0db6e9d554..624c6669c1 100644
--- a/hw/xnest/Color.c
+++ b/hw/xnest/Color.c
@@ -24,8 +24,6 @@ is" without express or implied warranty.
 #include "colormapst.h"
 #include "resource.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "Screen.h"
 #include "Color.h"
diff --git a/hw/xnest/Cursor.c b/hw/xnest/Cursor.c
index b49b4af44a..446b49c367 100644
--- a/hw/xnest/Cursor.c
+++ b/hw/xnest/Cursor.c
@@ -27,8 +27,6 @@ is" without express or implied warranty.
 #include "servermd.h"
 #include "mipointrst.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "Screen.h"
 #include "XNCursor.h"
diff --git a/hw/xnest/Display.c b/hw/xnest/Display.c
index a92305baec..efe5c13807 100644
--- a/hw/xnest/Display.c
+++ b/hw/xnest/Display.c
@@ -25,8 +25,6 @@ is" without express or implied warranty.
 #include "scrnintstr.h"
 #include "servermd.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "Init.h"
 #include "Args.h"
@@ -49,7 +47,7 @@ Pixel xnestWhitePixel;
 Drawable xnestDefaultDrawables[MAXDEPTH + 1];
 Pixmap xnestIconBitmap;
 Pixmap xnestScreenSaverPixmap;
-XlibGC xnestBitmapGC;
+GC xnestBitmapGC;
 unsigned long xnestEventMask;
 
 static int _X_NORETURN
diff --git a/hw/xnest/Display.h b/hw/xnest/Display.h
index 4e9dbf4630..a9f6b1ba74 100644
--- a/hw/xnest/Display.h
+++ b/hw/xnest/Display.h
@@ -15,6 +15,9 @@ is" without express or implied warranty.
 #ifndef XNESTCOMMON_H
 #define XNESTCOMMON_H
 
+#include <X11/Xlib.h>
+#include <X11/Xutil.h>
+
 #define UNDEFINED -1
 
 #define MAXDEPTH 32
@@ -35,7 +38,7 @@ extern Pixel xnestWhitePixel;
 extern Drawable xnestDefaultDrawables[MAXDEPTH + 1];
 extern Pixmap xnestIconBitmap;
 extern Pixmap xnestScreenSaverPixmap;
-extern XlibGC xnestBitmapGC;
+extern GC xnestBitmapGC;
 extern unsigned long xnestEventMask;
 
 void xnestOpenDisplay(int argc, char *argv[]);
diff --git a/hw/xnest/Events.c b/hw/xnest/Events.c
index 25aa5fd79a..6fe53b9b1e 100644
--- a/hw/xnest/Events.c
+++ b/hw/xnest/Events.c
@@ -26,11 +26,8 @@ is" without express or implied warranty.
 #include "servermd.h"
 #include "inputstr.h"
 #include "inpututils.h"
-
 #include "mi.h"
 
-#include "Xnest.h"
-
 #include "Args.h"
 #include "Color.h"
 #include "Display.h"
diff --git a/hw/xnest/Font.c b/hw/xnest/Font.c
index 9167158771..bd3c6efe3b 100644
--- a/hw/xnest/Font.c
+++ b/hw/xnest/Font.c
@@ -26,8 +26,6 @@ is" without express or implied warranty.
 #include "dixfontstr.h"
 #include "scrnintstr.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "XNFont.h"
 
diff --git a/hw/xnest/GC.c b/hw/xnest/GC.c
index fb6f5c84eb..098308647b 100644
--- a/hw/xnest/GC.c
+++ b/hw/xnest/GC.c
@@ -26,8 +26,6 @@ is" without express or implied warranty.
 #include "mistruct.h"
 #include "region.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "XNGC.h"
 #include "GCOps.h"
diff --git a/hw/xnest/GCOps.c b/hw/xnest/GCOps.c
index 145a605bb6..398a634f25 100644
--- a/hw/xnest/GCOps.c
+++ b/hw/xnest/GCOps.c
@@ -27,8 +27,6 @@ is" without express or implied warranty.
 #include "region.h"
 #include "servermd.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "Screen.h"
 #include "XNGC.h"
diff --git a/hw/xnest/Handlers.c b/hw/xnest/Handlers.c
index 7e51333816..f7e6a08734 100644
--- a/hw/xnest/Handlers.c
+++ b/hw/xnest/Handlers.c
@@ -23,8 +23,6 @@ is" without express or implied warranty.
 #include "windowstr.h"
 #include "servermd.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "Events.h"
 #include "Handlers.h"
diff --git a/hw/xnest/Init.c b/hw/xnest/Init.c
index 1027c140f8..04d6f583e4 100644
--- a/hw/xnest/Init.c
+++ b/hw/xnest/Init.c
@@ -30,8 +30,6 @@ is" without express or implied warranty.
 #include "mi.h"
 #include "dixfontstr.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "Screen.h"
 #include "Pointer.h"
diff --git a/hw/xnest/Keyboard.c b/hw/xnest/Keyboard.c
index 81138676dd..fe8f750ad4 100644
--- a/hw/xnest/Keyboard.c
+++ b/hw/xnest/Keyboard.c
@@ -29,8 +29,6 @@ is" without express or implied warranty.
 #include "scrnintstr.h"
 #include "servermd.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "Screen.h"
 #include "Keyboard.h"
diff --git a/hw/xnest/Pixmap.c b/hw/xnest/Pixmap.c
index 2010bfa26e..c78c981024 100644
--- a/hw/xnest/Pixmap.c
+++ b/hw/xnest/Pixmap.c
@@ -26,8 +26,6 @@ is" without express or implied warranty.
 #include "privates.h"
 #include "mi.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "Screen.h"
 #include "XNPixmap.h"
diff --git a/hw/xnest/Pointer.c b/hw/xnest/Pointer.c
index 671de15739..c813a65210 100644
--- a/hw/xnest/Pointer.c
+++ b/hw/xnest/Pointer.c
@@ -24,8 +24,6 @@ is" without express or implied warranty.
 #include "servermd.h"
 #include "mipointer.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "Screen.h"
 #include "Pointer.h"
diff --git a/hw/xnest/Screen.c b/hw/xnest/Screen.c
index cb0bd30608..277d7b54eb 100644
--- a/hw/xnest/Screen.c
+++ b/hw/xnest/Screen.c
@@ -25,8 +25,6 @@ is" without express or implied warranty.
 #include "colormapst.h"
 #include "resource.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "Screen.h"
 #include "XNGC.h"
diff --git a/hw/xnest/Visual.c b/hw/xnest/Visual.c
index f2c1707f46..983a2ca04b 100644
--- a/hw/xnest/Visual.c
+++ b/hw/xnest/Visual.c
@@ -16,10 +16,10 @@ is" without express or implied warranty.
 
 #include <X11/X.h>
 #include <X11/Xproto.h>
+
 #include "scrnintstr.h"
 #include "dix.h"
 #include "mi.h"
-#include "Xnest.h"
 
 #include "Display.h"
 #include "Visual.h"
diff --git a/hw/xnest/Window.c b/hw/xnest/Window.c
index f1fe01025c..9cb262b29d 100644
--- a/hw/xnest/Window.c
+++ b/hw/xnest/Window.c
@@ -17,6 +17,7 @@ is" without express or implied warranty.
 #include <X11/X.h>
 #include <X11/Xdefs.h>
 #include <X11/Xproto.h>
+#include <X11/extensions/shape.h>
 
 #include "gcstruct.h"
 #include "window.h"
@@ -25,11 +26,8 @@ is" without express or implied warranty.
 #include "colormapst.h"
 #include "scrnintstr.h"
 #include "region.h"
-
 #include "mi.h"
 
-#include "Xnest.h"
-
 #include "Display.h"
 #include "Screen.h"
 #include "XNGC.h"
diff --git a/hw/xnest/XNGC.h b/hw/xnest/XNGC.h
index 6a222d0735..dbd51ff9a2 100644
--- a/hw/xnest/XNGC.h
+++ b/hw/xnest/XNGC.h
@@ -20,7 +20,7 @@ is" without express or implied warranty.
 /* This file uses the GC definition form Xlib.h as XlibGC. */
 
 typedef struct {
-    XlibGC gc;
+    GC gc;
 } xnestPrivGC;
 
 extern DevPrivateKeyRec xnestGCPrivateKeyRec;
diff --git a/hw/xnest/Xnest.h b/hw/xnest/Xnest.h
deleted file mode 100644
index 075848a344..0000000000
--- a/hw/xnest/Xnest.h
+++ /dev/null
@@ -1,35 +0,0 @@
-/*
-
-Copyright (c) 1995  X Consortium
-
-Permission is hereby granted, free of charge, to any person obtaining
-a copy of this software and associated documentation files (the
-"Software"), to deal in the Software without restriction, including
-without limitation the rights to use, copy, modify, merge, publish,
-distribute, sublicense, and/or sell copies of the Software, and to
-permit persons to whom the Software is furnished to do so, subject to
-the following conditions:
-
-The above copyright notice and this permission notice shall be included
-in all copies or substantial portions of the Software.
-
-THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
-OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
-MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
-IN NO EVENT SHALL THE X CONSORTIUM BE LIABLE FOR ANY CLAIM, DAMAGES OR
-OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
-ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
-OTHER DEALINGS IN THE SOFTWARE.
-
-Except as contained in this notice, the name of the X Consortium shall
-not be used in advertising or otherwise to promote the sale, use or
-other dealings in this Software without prior written authorization
-from the X Consortium.
-
-*/
-
-#define GC XlibGC
-#include <X11/Xlib.h>
-#include <X11/Xutil.h>
-#include <X11/extensions/shape.h>
-#undef GC
-- 
GitLab


From c1c8f389a6b9e2f5e01f73bbb92f659d4b6929d4 Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Thu, 15 Feb 2024 19:56:08 +0100
Subject: [PATCH 12/15] Xnest: cleanup X.h includes

It's cleaner to include explicitly instead of relying on indirect includes,
thus adding a few more on X.h.

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/Args.h   | 1 +
 hw/xnest/Color.h  | 1 +
 hw/xnest/Screen.h | 1 +
 hw/xnest/Visual.h | 2 ++
 4 files changed, 5 insertions(+)

diff --git a/hw/xnest/Args.h b/hw/xnest/Args.h
index cce503cb2c..2ae2984b4e 100644
--- a/hw/xnest/Args.h
+++ b/hw/xnest/Args.h
@@ -15,6 +15,7 @@ is" without express or implied warranty.
 #ifndef XNESTARGS_H
 #define XNESTARGS_H
 
+#include <X11/X.h>
 #include <X11/Xdefs.h>
 
 extern char *xnestDisplayName;
diff --git a/hw/xnest/Color.h b/hw/xnest/Color.h
index 480b35cbbf..23f17540df 100644
--- a/hw/xnest/Color.h
+++ b/hw/xnest/Color.h
@@ -15,6 +15,7 @@ is" without express or implied warranty.
 #ifndef XNESTCOLOR_H
 #define XNESTCOLOR_H
 
+#include <X11/X.h>
 #include <X11/Xdefs.h>
 
 #define DUMB_WINDOW_MANAGERS
diff --git a/hw/xnest/Screen.h b/hw/xnest/Screen.h
index 4ab73c41b1..d06338f5aa 100644
--- a/hw/xnest/Screen.h
+++ b/hw/xnest/Screen.h
@@ -15,6 +15,7 @@ is" without express or implied warranty.
 #ifndef XNESTSCREEN_H
 #define XNESTSCREEN_H
 
+#include <X11/X.h>
 #include <X11/Xdefs.h>
 
 extern Window xnestDefaultWindows[MAXSCREENS];
diff --git a/hw/xnest/Visual.h b/hw/xnest/Visual.h
index c3ae8a19f4..12f19d9ab7 100644
--- a/hw/xnest/Visual.h
+++ b/hw/xnest/Visual.h
@@ -15,6 +15,8 @@ is" without express or implied warranty.
 #ifndef XNESTVISUAL_H
 #define XNESTVISUAL_H
 
+#include <X11/X.h>
+
 Visual *xnestVisual(VisualPtr pVisual);
 Visual *xnestVisualFromID(ScreenPtr pScreen, VisualID visual);
 Colormap xnestDefaultVisualColormap(Visual * visual);
-- 
GitLab


From 32c86c5a68688d708bfed7fd477e0f5c8e4ba186 Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Wed, 28 Feb 2024 13:04:02 +0100
Subject: [PATCH 13/15] xnest: drop superfluous xnestCursorScreenKey define

We can just write &xnestCursorScreenKeyRec instead, which makes the code
a bit more clear.

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/Cursor.c   | 4 ++--
 hw/xnest/Screen.c   | 2 +-
 hw/xnest/XNCursor.h | 2 --
 3 files changed, 3 insertions(+), 5 deletions(-)

diff --git a/hw/xnest/Cursor.c b/hw/xnest/Cursor.c
index 446b49c367..8979736e4e 100644
--- a/hw/xnest/Cursor.c
+++ b/hw/xnest/Cursor.c
@@ -154,7 +154,7 @@ xnestDeviceCursorInitialize(DeviceIntPtr pDev, ScreenPtr pScreen)
     xnestCursorFuncPtr pScreenPriv;
 
     pScreenPriv = (xnestCursorFuncPtr)
-        dixLookupPrivate(&pScreen->devPrivates, xnestCursorScreenKey);
+        dixLookupPrivate(&pScreen->devPrivates, &xnestCursorScreenKeyRec);
 
     return pScreenPriv->spriteFuncs->DeviceCursorInitialize(pDev, pScreen);
 }
@@ -165,7 +165,7 @@ xnestDeviceCursorCleanup(DeviceIntPtr pDev, ScreenPtr pScreen)
     xnestCursorFuncPtr pScreenPriv;
 
     pScreenPriv = (xnestCursorFuncPtr)
-        dixLookupPrivate(&pScreen->devPrivates, xnestCursorScreenKey);
+        dixLookupPrivate(&pScreen->devPrivates, &xnestCursorScreenKeyRec);
 
     pScreenPriv->spriteFuncs->DeviceCursorCleanup(pDev, pScreen);
 }
diff --git a/hw/xnest/Screen.c b/hw/xnest/Screen.c
index 277d7b54eb..e1647af622 100644
--- a/hw/xnest/Screen.c
+++ b/hw/xnest/Screen.c
@@ -310,7 +310,7 @@ xnestOpenScreen(ScreenPtr pScreen, int argc, char *argv[])
     miDCInitialize(pScreen, &xnestPointerCursorFuncs);  /* init SW rendering */
     PointPriv = dixLookupPrivate(&pScreen->devPrivates, miPointerScreenKey);
     xnestCursorFuncs.spriteFuncs = PointPriv->spriteFuncs;
-    dixSetPrivate(&pScreen->devPrivates, xnestCursorScreenKey,
+    dixSetPrivate(&pScreen->devPrivates, &xnestCursorScreenKeyRec,
                   &xnestCursorFuncs);
     PointPriv->spriteFuncs = &xnestPointerSpriteFuncs;
 
diff --git a/hw/xnest/XNCursor.h b/hw/xnest/XNCursor.h
index 2036ad5130..c684de1631 100644
--- a/hw/xnest/XNCursor.h
+++ b/hw/xnest/XNCursor.h
@@ -24,8 +24,6 @@ typedef struct {
 } xnestCursorFuncRec, *xnestCursorFuncPtr;
 
 extern DevPrivateKeyRec xnestCursorScreenKeyRec;
-
-#define xnestCursorScreenKey (&xnestCursorScreenKeyRec)
 extern xnestCursorFuncRec xnestCursorFuncs;
 
 typedef struct {
-- 
GitLab


From e6319d1f3c4fb2218cd5687ed1bf3638b67e81bd Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Wed, 28 Feb 2024 13:11:57 +0100
Subject: [PATCH 14/15] xnest: fix naming of xnestCursorScreenKeyRec

It's naming is a bit unprecise: it actually is used for storing
xnestCursorFuncPtr inside a Screen. Thus rename it to
xnestScreenCursorFuncKeyRec to make it bit more clear.

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/Cursor.c   | 4 ++--
 hw/xnest/Screen.c   | 6 +++---
 hw/xnest/XNCursor.h | 4 +++-
 3 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/hw/xnest/Cursor.c b/hw/xnest/Cursor.c
index 8979736e4e..95f6042ba3 100644
--- a/hw/xnest/Cursor.c
+++ b/hw/xnest/Cursor.c
@@ -154,7 +154,7 @@ xnestDeviceCursorInitialize(DeviceIntPtr pDev, ScreenPtr pScreen)
     xnestCursorFuncPtr pScreenPriv;
 
     pScreenPriv = (xnestCursorFuncPtr)
-        dixLookupPrivate(&pScreen->devPrivates, &xnestCursorScreenKeyRec);
+        dixLookupPrivate(&pScreen->devPrivates, &xnestScreenCursorFuncKeyRec);
 
     return pScreenPriv->spriteFuncs->DeviceCursorInitialize(pDev, pScreen);
 }
@@ -165,7 +165,7 @@ xnestDeviceCursorCleanup(DeviceIntPtr pDev, ScreenPtr pScreen)
     xnestCursorFuncPtr pScreenPriv;
 
     pScreenPriv = (xnestCursorFuncPtr)
-        dixLookupPrivate(&pScreen->devPrivates, &xnestCursorScreenKeyRec);
+        dixLookupPrivate(&pScreen->devPrivates, &xnestScreenCursorFuncKeyRec);
 
     pScreenPriv->spriteFuncs->DeviceCursorCleanup(pDev, pScreen);
 }
diff --git a/hw/xnest/Screen.c b/hw/xnest/Screen.c
index e1647af622..ed09d15e53 100644
--- a/hw/xnest/Screen.c
+++ b/hw/xnest/Screen.c
@@ -42,7 +42,7 @@ is" without express or implied warranty.
 
 Window xnestDefaultWindows[MAXSCREENS];
 Window xnestScreenSaverWindows[MAXSCREENS];
-DevPrivateKeyRec xnestCursorScreenKeyRec;
+DevPrivateKeyRec xnestScreenCursorFuncKeyRec;
 
 ScreenPtr
 xnestScreen(Window window)
@@ -153,7 +153,7 @@ xnestOpenScreen(ScreenPtr pScreen, int argc, char *argv[])
         (&xnestColormapPrivateKeyRec, PRIVATE_COLORMAP,
          sizeof(xnestPrivColormap)))
         return FALSE;
-    if (!dixRegisterPrivateKey(&xnestCursorScreenKeyRec, PRIVATE_SCREEN, 0))
+    if (!dixRegisterPrivateKey(&xnestScreenCursorFuncKeyRec, PRIVATE_SCREEN, 0))
         return FALSE;
 
     visuals = xallocarray(xnestNumVisuals, sizeof(VisualRec));
@@ -310,7 +310,7 @@ xnestOpenScreen(ScreenPtr pScreen, int argc, char *argv[])
     miDCInitialize(pScreen, &xnestPointerCursorFuncs);  /* init SW rendering */
     PointPriv = dixLookupPrivate(&pScreen->devPrivates, miPointerScreenKey);
     xnestCursorFuncs.spriteFuncs = PointPriv->spriteFuncs;
-    dixSetPrivate(&pScreen->devPrivates, &xnestCursorScreenKeyRec,
+    dixSetPrivate(&pScreen->devPrivates, &xnestScreenCursorFuncKeyRec,
                   &xnestCursorFuncs);
     PointPriv->spriteFuncs = &xnestPointerSpriteFuncs;
 
diff --git a/hw/xnest/XNCursor.h b/hw/xnest/XNCursor.h
index c684de1631..46a34e3338 100644
--- a/hw/xnest/XNCursor.h
+++ b/hw/xnest/XNCursor.h
@@ -23,7 +23,9 @@ typedef struct {
     miPointerSpriteFuncPtr spriteFuncs;
 } xnestCursorFuncRec, *xnestCursorFuncPtr;
 
-extern DevPrivateKeyRec xnestCursorScreenKeyRec;
+// stores xnestCursorFuncRec in screen
+extern DevPrivateKeyRec xnestScreenCursorFuncKeyRec;
+
 extern xnestCursorFuncRec xnestCursorFuncs;
 
 typedef struct {
-- 
GitLab


From 8f6492c7c870ba9c42ef8484c7ccac8b5edef3c5 Mon Sep 17 00:00:00 2001
From: "Enrico Weigelt, metux IT consult" <info@metux.net>
Date: Wed, 28 Feb 2024 15:40:37 +0100
Subject: [PATCH 15/15] xnest: use own dev-privates key for per-screen cursor

Since it's storing an locally defined (ddx-internal) struct, it's better
not to abuse some globally defined key for this.

It just happened to work before, since CursorScreenKey is only used by DDX
(and there's only one DDX per executable) and they currently (!) have the
same size (pointer) - but that's a fragile programming style, so clean it up.

Signed-off-by: Enrico Weigelt, metux IT consult <info@metux.net>
---
 hw/xnest/Cursor.c   | 1 -
 hw/xnest/Screen.c   | 5 +++++
 hw/xnest/XNCursor.h | 9 +++++++--
 3 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/hw/xnest/Cursor.c b/hw/xnest/Cursor.c
index 95f6042ba3..b26302219d 100644
--- a/hw/xnest/Cursor.c
+++ b/hw/xnest/Cursor.c
@@ -21,7 +21,6 @@ is" without express or implied warranty.
 #include "screenint.h"
 #include "input.h"
 #include "misc.h"
-#include "cursor.h"
 #include "cursorstr.h"
 #include "scrnintstr.h"
 #include "servermd.h"
diff --git a/hw/xnest/Screen.c b/hw/xnest/Screen.c
index ed09d15e53..891e3a8ab5 100644
--- a/hw/xnest/Screen.c
+++ b/hw/xnest/Screen.c
@@ -43,6 +43,7 @@ is" without express or implied warranty.
 Window xnestDefaultWindows[MAXSCREENS];
 Window xnestScreenSaverWindows[MAXSCREENS];
 DevPrivateKeyRec xnestScreenCursorFuncKeyRec;
+DevScreenPrivateKeyRec xnestScreenCursorPrivKeyRec;
 
 ScreenPtr
 xnestScreen(Window window)
@@ -156,6 +157,10 @@ xnestOpenScreen(ScreenPtr pScreen, int argc, char *argv[])
     if (!dixRegisterPrivateKey(&xnestScreenCursorFuncKeyRec, PRIVATE_SCREEN, 0))
         return FALSE;
 
+    if (!dixRegisterScreenPrivateKey(&xnestScreenCursorPrivKeyRec, pScreen,
+                                     PRIVATE_CURSOR, 0))
+        return FALSE;
+
     visuals = xallocarray(xnestNumVisuals, sizeof(VisualRec));
     numVisuals = 0;
 
diff --git a/hw/xnest/XNCursor.h b/hw/xnest/XNCursor.h
index 46a34e3338..727f209896 100644
--- a/hw/xnest/XNCursor.h
+++ b/hw/xnest/XNCursor.h
@@ -32,11 +32,16 @@ typedef struct {
     Cursor cursor;
 } xnestPrivCursor;
 
+// stores xnestPrivCursor per screen's cursor
+extern DevScreenPrivateKeyRec xnestScreenCursorPrivKeyRec;
+
 #define xnestGetCursorPriv(pCursor, pScreen) ((xnestPrivCursor *) \
-    dixLookupScreenPrivate(&(pCursor)->devPrivates, CursorScreenKey, pScreen))
+    dixLookupScreenPrivate(&(pCursor)->devPrivates, \
+                           &xnestScreenCursorPrivKeyRec, pScreen))
 
 #define xnestSetCursorPriv(pCursor, pScreen, v) \
-    dixSetScreenPrivate(&(pCursor)->devPrivates, CursorScreenKey, pScreen, v)
+    dixSetScreenPrivate(&(pCursor)->devPrivates, \
+                        &xnestScreenCursorPrivKeyRec, pScreen, v)
 
 #define xnestCursor(pCursor, pScreen) \
   (xnestGetCursorPriv(pCursor, pScreen)->cursor)
-- 
GitLab

