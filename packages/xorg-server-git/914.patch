From e6185d1e0c8a5181a226915bb6701463012291c5 Mon Sep 17 00:00:00 2001
From: Konstantin <ria.freelander@gmail.com>
Date: Thu, 23 Jun 2022 16:11:33 +0300
Subject: [PATCH 1/4] glamor: add glvnd_vendor private

---
 glamor/glamor.c      | 16 ++++++++++++++++
 glamor/glamor.h      |  6 ++++++
 glamor/glamor_priv.h |  2 ++
 3 files changed, 24 insertions(+)

diff --git a/glamor/glamor.c b/glamor/glamor.c
index 9dcef5fac..6c16d48a4 100644
--- a/glamor/glamor.c
+++ b/glamor/glamor.c
@@ -947,6 +947,22 @@ glamor_fini(ScreenPtr screen)
     /* Do nothing currently. */
 }
 
+void
+glamor_set_glvnd_vendor(ScreenPtr screen, const char* vendor_name)
+{
+    glamor_screen_private *glamor_priv = glamor_get_screen_private(screen);
+
+    glamor_priv->glvnd_vendor = vendor_name;
+}
+
+const char*
+glamor_get_glvnd_vendor(ScreenPtr screen)
+{
+    glamor_screen_private *glamor_priv = glamor_get_screen_private(screen);
+
+    return glamor_priv->glvnd_vendor;
+}
+
 void
 glamor_enable_dri3(ScreenPtr screen)
 {
diff --git a/glamor/glamor.h b/glamor/glamor.h
index 31157471d..a0b3783d9 100644
--- a/glamor/glamor.h
+++ b/glamor/glamor.h
@@ -120,6 +120,12 @@ extern _X_EXPORT void glamor_clear_pixmap(PixmapPtr pixmap);
 
 extern _X_EXPORT void glamor_block_handler(ScreenPtr screen);
 
+/* This function should be called after glamor_init,
+ * but before adding a glamor GLX provider */
+extern _X_EXPORT void glamor_set_glvnd_vendor(ScreenPtr screen,
+                                              const char* vendor);
+extern _X_EXPORT const char* glamor_get_glvnd_vendor(ScreenPtr screen);
+
 extern _X_EXPORT PixmapPtr glamor_create_pixmap(ScreenPtr screen, int w, int h,
                                                 int depth, unsigned int usage);
 extern _X_EXPORT Bool glamor_destroy_pixmap(PixmapPtr pixmap);
diff --git a/glamor/glamor_priv.h b/glamor/glamor_priv.h
index 028a6d374..5875b280b 100644
--- a/glamor/glamor_priv.h
+++ b/glamor/glamor_priv.h
@@ -309,6 +309,8 @@ typedef struct glamor_screen_private {
     int flags;
     ScreenPtr screen;
     int dri3_enabled;
+    /* glvnd vendor */
+    const char* glvnd_vendor;
 
     Bool suppress_gl_out_of_memory_logging;
     Bool logged_any_fbo_allocation_failure;
-- 
GitLab


From 477752d65b12d1993263096c82a18c9748b6e870 Mon Sep 17 00:00:00 2001
From: Adam Jackson <ajax@redhat.com>
Date: Wed, 26 Aug 2020 18:22:22 -0400
Subject: [PATCH 2/4] glamor: Lift the GLX EGL backend from Xwayland

This code is almost entirely ddx-agnostic already, and I'd like to use
it from the other EGL glamor consumers. Which, right now that's just
Xorg, but soon it'll be Xephyr too.
---
 .../glamor_glx_provider.c                     | 19 ++++++++++---------
 .../glamor_glx_provider.h                     |  4 ++--
 glamor/meson.build                            |  5 ++++-
 hw/xwayland/meson.build                       |  4 ----
 hw/xwayland/xwayland-glamor.c                 |  2 +-
 5 files changed, 17 insertions(+), 17 deletions(-)
 rename hw/xwayland/xwayland-glx.c => glamor/glamor_glx_provider.c (97%)
 rename hw/xwayland/xwayland-glx.h => glamor/glamor_glx_provider.h (94%)

diff --git a/hw/xwayland/xwayland-glx.c b/glamor/glamor_glx_provider.c
similarity index 97%
rename from hw/xwayland/xwayland-glx.c
rename to glamor/glamor_glx_provider.c
index a3e85fc2f..ffc641b1b 100644
--- a/hw/xwayland/xwayland-glx.c
+++ b/glamor/glamor_glx_provider.c
@@ -30,21 +30,18 @@
  * can do, which often does not include things like multisample visuals.
  */
 
-#include <xwayland-config.h>
+#include <dix-config.h>
 
 #define MESA_EGL_NO_X11_HEADERS
 #define EGL_NO_X11
-// #include <EGL/egl.h>
 #include <epoxy/egl.h>
 #include "glxserver.h"
 #include "glxutil.h"
 #include "compint.h"
 #include <X11/extensions/composite.h>
-#include "glamor_context.h"
+#include "glamor_priv.h"
 #include "glamor.h"
 
-#include "xwayland-screen.h"
-
 /* Can't get these from <GL/glx.h> since it pulls in client headers */
 #define GLX_RGBA_BIT		0x00000001
 #define GLX_WINDOW_BIT		0x00000001
@@ -364,12 +361,16 @@ static __GLXscreen *
 egl_screen_probe(ScreenPtr pScreen)
 {
     struct egl_screen *screen;
-    struct xwl_screen *xwl_screen = xwl_screen_get(pScreen);
+    glamor_screen_private *glamor_screen;
     __GLXscreen *base;
 
     if (enableIndirectGLX)
         return NULL; /* not implemented */
 
+    glamor_screen = glamor_get_screen_private(pScreen);
+    if (!glamor_screen)
+        return NULL;
+
     if (!(screen = calloc(1, sizeof *screen)))
         return NULL;
 
@@ -378,7 +379,7 @@ egl_screen_probe(ScreenPtr pScreen)
     base->createDrawable = egl_create_glx_drawable;
     /* base.swapInterval = NULL; */
 
-    screen->display = xwl_screen->glamor_ctx->display;
+    screen->display = glamor_screen->ctx.display;
 
     __glXInitExtensionEnableBits(screen->base.glx_enable_bits);
     __glXEnableExtension(base->glx_enable_bits, "GLX_ARB_context_flush_control");
@@ -402,8 +403,8 @@ egl_screen_probe(ScreenPtr pScreen)
         return NULL;
     }
 
-    if (!screen->base.glvnd && xwl_screen->glvnd_vendor)
-        screen->base.glvnd = strdup(xwl_screen->glvnd_vendor);
+    if (!screen->base.glvnd && glamor_screen->glvnd_vendor)
+        screen->base.glvnd = strdup(glamor_screen->glvnd_vendor);
 
     if (!screen->base.glvnd)
         screen->base.glvnd = strdup("mesa");
diff --git a/hw/xwayland/xwayland-glx.h b/glamor/glamor_glx_provider.h
similarity index 94%
rename from hw/xwayland/xwayland-glx.h
rename to glamor/glamor_glx_provider.h
index 62c9fb7ce..b0db90e47 100644
--- a/hw/xwayland/xwayland-glx.h
+++ b/glamor/glamor_glx_provider.h
@@ -27,11 +27,11 @@
 #ifndef XWAYLAND_GLX_H
 #define XWAYLAND_GLX_H
 
-#include <xwayland-config.h>
+#include <dix-config.h>
 
 #ifdef GLXEXT
 #include "glx_extinit.h"
-extern __GLXprovider glamor_provider;
+extern _X_EXPORT __GLXprovider glamor_provider;
 #endif
 
 #endif /* XWAYLAND_GLX_H */
diff --git a/glamor/meson.build b/glamor/meson.build
index 4a3f6241a..d4cb1859a 100644
--- a/glamor/meson.build
+++ b/glamor/meson.build
@@ -33,6 +33,9 @@ srcs_glamor = [
     'glamor_sync.c',
 ]
 
+if build_glx
+    srcs_glamor += 'glamor_glx_provider.c'
+endif
 if build_xv
     srcs_glamor += 'glamor_xv.c'
 endif
@@ -41,7 +44,7 @@ epoxy_dep = dependency('epoxy')
 
 glamor = static_library('glamor',
     srcs_glamor,
-    include_directories: inc,
+    include_directories: [inc, glx_inc],
     dependencies: [
         common_dep,
         epoxy_dep,
diff --git a/hw/xwayland/meson.build b/hw/xwayland/meson.build
index 37c39497c..ca4fbcc98 100644
--- a/hw/xwayland/meson.build
+++ b/hw/xwayland/meson.build
@@ -7,7 +7,6 @@ srcs = [
     'xwayland-drm-lease.h',
     'xwayland-drm-lease.c',
     'xwayland-glamor.h',
-    'xwayland-glx.h',
     'xwayland-pixmap.c',
     'xwayland-pixmap.h',
     'xwayland-present.h',
@@ -87,9 +86,6 @@ xwayland_glamor = []
 eglstream_srcs = []
 if build_glamor
     srcs += 'xwayland-glamor.c'
-    if build_glx
-        srcs += 'xwayland-glx.c'
-    endif
     if gbm_dep.found()
         srcs += 'xwayland-glamor-gbm.c'
     endif
diff --git a/hw/xwayland/xwayland-glamor.c b/hw/xwayland/xwayland-glamor.c
index 24620605d..345ea89e5 100644
--- a/hw/xwayland/xwayland-glamor.c
+++ b/hw/xwayland/xwayland-glamor.c
@@ -31,6 +31,7 @@
 
 #include <glamor.h>
 #include <glamor_context.h>
+#include <glamor_glx_provider.h>
 #ifdef GLXEXT
 #include "glx_extinit.h"
 #endif
@@ -40,7 +41,6 @@
 #include <drm_fourcc.h>
 
 #include "xwayland-glamor.h"
-#include "xwayland-glx.h"
 #include "xwayland-screen.h"
 #include "xwayland-window.h"
 
-- 
GitLab


From d94118e0d4fba671ef8e708fed70ef06d5d5b126 Mon Sep 17 00:00:00 2001
From: Adam Jackson <ajax@redhat.com>
Date: Fri, 25 Feb 2022 13:41:41 -0500
Subject: [PATCH 3/4] glamor/glxprov: Stop exposing non-db(-capable) configs

---
 glamor/glamor_glx_provider.c | 35 +++++++++++++++--------------------
 1 file changed, 15 insertions(+), 20 deletions(-)

diff --git a/glamor/glamor_glx_provider.c b/glamor/glamor_glx_provider.c
index ffc641b1b..62530a29e 100644
--- a/glamor/glamor_glx_provider.c
+++ b/glamor/glamor_glx_provider.c
@@ -142,8 +142,7 @@ egl_create_glx_drawable(ClientPtr client, __GLXscreen *screen,
 static struct egl_config *
 translate_eglconfig(struct egl_screen *screen, EGLConfig hc,
                     struct egl_config *chain, Bool direct_color,
-                    Bool double_buffer, Bool duplicate_for_composite,
-                    Bool srgb_only)
+                    Bool duplicate_for_composite, Bool srgb_only)
 {
     EGLint value;
     struct egl_config *c = calloc(1, sizeof *c);
@@ -191,10 +190,8 @@ translate_eglconfig(struct egl_screen *screen, EGLConfig hc,
     else
         c->base.visualType = GLX_TRUE_COLOR;
 
-    if (double_buffer)
-        c->base.doubleBufferMode = GL_TRUE;
-    else
-        c->base.doubleBufferMode = GL_FALSE;
+    /* We choose not to implement front-buffer-only configs */
+    c->base.doubleBufferMode = GL_TRUE;
 
     /* direct-mapped state */
 #define GET(attr, slot) \
@@ -320,7 +317,7 @@ translate_eglconfig(struct egl_screen *screen, EGLConfig hc,
 static __GLXconfig *
 egl_mirror_configs(ScreenPtr pScreen, struct egl_screen *screen)
 {
-    int i, j, k, nconfigs;
+    int i, j, nconfigs;
     struct egl_config *c = NULL;
     EGLConfig *host_configs = NULL;
     bool can_srgb = epoxy_has_gl_extension("GL_ARB_framebuffer_sRGB") ||
@@ -336,22 +333,20 @@ egl_mirror_configs(ScreenPtr pScreen, struct egl_screen *screen)
     /* We walk the EGL configs backwards to make building the
      * ->next chain easier.
      */
-    for (i = nconfigs - 1; i > 0; i--)
-        for (j = 0; j < 3; j++) /* direct_color */
-            for (k = 0; k < 2; k++) /* double_buffer */ {
-                if (can_srgb)
-                    c = translate_eglconfig(screen, host_configs[i], c,
-                                            /* direct_color */ j == 1,
-                                            /* double_buffer */ k > 0,
-                                            /* duplicate_for_composite */ j == 0,
-                                            /* srgb_only */ true);
-
+    for (i = nconfigs - 1; i > 0; i--) {
+        for (j = 0; j < 3; j++) { /* direct_color */
+            if (can_srgb)
                 c = translate_eglconfig(screen, host_configs[i], c,
                                         /* direct_color */ j == 1,
-                                        /* double_buffer */ k > 0,
                                         /* duplicate_for_composite */ j == 0,
-                                        /* srgb_only */ false);
-            }
+                                        /* srgb_only */ true);
+
+            c = translate_eglconfig(screen, host_configs[i], c,
+                                    /* direct_color */ j == 1,
+                                    /* duplicate_for_composite */ j == 0,
+                                    /* srgb_only */ false);
+        }
+    }
 
     screen->configs = host_configs;
     return c ? &c->base : NULL;
-- 
GitLab


From 877c67dfff001dceaa134eb06f6aa10872751e27 Mon Sep 17 00:00:00 2001
From: Konstantin <ria.freelander@gmail.com>
Date: Thu, 23 Jun 2022 16:27:58 +0300
Subject: [PATCH 4/4] glamor: correctly set glvnd vendor

---
 glamor/glamor_egl.c               | 10 ++++++++++
 hw/xfree86/glamor_egl/meson.build |  2 +-
 hw/xwayland/xwayland-glamor.c     |  1 +
 3 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/glamor/glamor_egl.c b/glamor/glamor_egl.c
index 60d0df893..1a79a824a 100644
--- a/glamor/glamor_egl.c
+++ b/glamor/glamor_egl.c
@@ -46,6 +46,7 @@
 
 #include "glamor.h"
 #include "glamor_priv.h"
+#include "glamor_glx_provider.h"
 #include "dri3.h"
 
 struct glamor_egl_screen_private {
@@ -860,6 +861,7 @@ glamor_egl_screen_init(ScreenPtr screen, struct glamor_context *glamor_ctx)
 #ifdef DRI3
     glamor_screen_private *glamor_priv = glamor_get_screen_private(screen);
 #endif
+    const char* gbm_backend_name;
 
     glamor_egl->saved_close_screen = screen->CloseScreen;
     screen->CloseScreen = glamor_egl_close_screen;
@@ -872,6 +874,10 @@ glamor_egl_screen_init(ScreenPtr screen, struct glamor_context *glamor_ctx)
 
     glamor_ctx->make_current = glamor_egl_make_current;
 
+    gbm_backend_name = gbm_device_get_backend_name(glamor_egl->gbm);
+    /* Mesa uses "drm" as backend name, in that case, just do nothing */
+    if (gbm_backend_name && strcmp(gbm_backend_name, "drm") != 0)
+        glamor_set_glvnd_vendor(screen, gbm_backend_name);
 #ifdef DRI3
     /* Tell the core that we have the interfaces for import/export
      * of pixmaps.
@@ -895,6 +901,10 @@ glamor_egl_screen_init(ScreenPtr screen, struct glamor_context *glamor_ctx)
         }
     }
 #endif
+#ifdef GLXEXT
+    GlxPushProvider(&glamor_provider);
+    xorgGlxCreateVendor();
+#endif
 }
 
 static void glamor_egl_cleanup(struct glamor_egl_screen_private *glamor_egl)
diff --git a/hw/xfree86/glamor_egl/meson.build b/hw/xfree86/glamor_egl/meson.build
index 7eae05812..dd1cafcd9 100644
--- a/hw/xfree86/glamor_egl/meson.build
+++ b/hw/xfree86/glamor_egl/meson.build
@@ -15,7 +15,7 @@ shared_module(
         dependency('libdrm', version: '>= 2.4.46'),
         gbm_dep,
     ],
-    link_with: glamor,
+    link_with: [glamor, libxserver_glx],
 
     install: true,
     install_dir: module_dir,
diff --git a/hw/xwayland/xwayland-glamor.c b/hw/xwayland/xwayland-glamor.c
index 345ea89e5..238145ae5 100644
--- a/hw/xwayland/xwayland-glamor.c
+++ b/hw/xwayland/xwayland-glamor.c
@@ -72,6 +72,7 @@ glamor_egl_screen_init(ScreenPtr screen, struct glamor_context *glamor_ctx)
 {
     struct xwl_screen *xwl_screen = xwl_screen_get(screen);
 
+    glamor_set_glvnd_vendor(screen, xwl_screen->glvnd_vendor);
     glamor_enable_dri3(screen);
     glamor_ctx->ctx = xwl_screen->egl_context;
     glamor_ctx->display = xwl_screen->egl_display;
-- 
GitLab

