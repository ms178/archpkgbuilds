From ea2b80d6c21fd5ca4b6419c61d4c70254ada6d20 Mon Sep 17 00:00:00 2001
From: Austin Shafer <ashafer@nvidia.com>
Date: Thu, 16 Dec 2021 13:19:00 -0500
Subject: [PATCH 1/2] Add Gitlab CI support for dri3 1.3

---
 .gitlab-ci.yml                    |  2 +-
 .gitlab-ci/cross-prereqs-build.sh |  4 ++--
 .gitlab-ci/debian-install.sh      | 14 ++++++++++++++
 3 files changed, 17 insertions(+), 3 deletions(-)

diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml
index 22769a047b..e468f852ef 100644
--- a/.gitlab-ci.yml
+++ b/.gitlab-ci.yml
@@ -19,7 +19,7 @@ variables:
     FDO_UPSTREAM_REPO: xorg/xserver
     FDO_DISTRIBUTION_VERSION: bullseye-slim
     FDO_DISTRIBUTION_EXEC: 'env FDO_CI_CONCURRENT=${FDO_CI_CONCURRENT} bash .gitlab-ci/debian-install.sh'
-    FDO_DISTRIBUTION_TAG: "2022-11-24-new-wayland-protocols"
+    FDO_DISTRIBUTION_TAG: "2023-01-25-DRI3-1.3"
 
 include:
   - project: 'freedesktop/ci-templates'
diff --git a/.gitlab-ci/cross-prereqs-build.sh b/.gitlab-ci/cross-prereqs-build.sh
index c3502e9320..d1b19bb82d 100755
--- a/.gitlab-ci/cross-prereqs-build.sh
+++ b/.gitlab-ci/cross-prereqs-build.sh
@@ -49,9 +49,9 @@ build 'https://gitlab.freedesktop.org/pixman/pixman.git' 'pixman-0.38.4'
 build 'https://gitlab.freedesktop.org/xorg/lib/pthread-stubs.git' '0.4'
 # we can't use the xorgproto pkgconfig files from /usr/share/pkgconfig, because
 # these would add -I/usr/include to CFLAGS, which breaks cross-compilation
-build 'https://gitlab.freedesktop.org/xorg/proto/xorgproto.git' 'xorgproto-2021.4.99.2' '--datadir=/lib'
+build 'https://gitlab.freedesktop.org/xorg/proto/xorgproto.git' 'xorgproto-2022.2' '--datadir=/lib'
 build 'https://gitlab.freedesktop.org/xorg/lib/libXau.git' 'libXau-1.0.9'
-build 'https://gitlab.freedesktop.org/xorg/proto/xcbproto.git' 'xcb-proto-1.14.1'
+build 'https://gitlab.freedesktop.org/xorg/proto/xcbproto.git' 'xcb-proto-1.15.1'
 build 'https://gitlab.freedesktop.org/xorg/lib/libxcb.git' 'libxcb-1.14'
 build 'https://gitlab.freedesktop.org/xorg/lib/libxtrans.git' 'xtrans-1.4.0'
 # the default value of keysymdefdir is taken from the includedir variable for
diff --git a/.gitlab-ci/debian-install.sh b/.gitlab-ci/debian-install.sh
index 5fca4c625e..371dc4c14a 100644
--- a/.gitlab-ci/debian-install.sh
+++ b/.gitlab-ci/debian-install.sh
@@ -158,6 +158,20 @@ cd piglit
 git checkout 265896c86f90cb72e8f218ba6a3617fca8b9a1e3
 cd ..
 
+git clone https://gitlab.freedesktop.org/xorg/proto/xcbproto --depth=1 --branch=xcb-proto-1.15.1
+pushd xcbproto
+./autogen.sh
+make -j${FDO_CI_CONCURRENT:-4} install
+popd
+rm -rf xcbproto
+
+git clone https://gitlab.freedesktop.org/xorg/lib/libxcb --depth=1 --branch=libxcb-1.15
+pushd libxcb
+./autogen.sh
+make -j${FDO_CI_CONCURRENT:-4} install
+popd
+rm -rf libxcb
+
 git clone https://gitlab.freedesktop.org/xorg/test/xts
 cd xts
 git checkout dbbfa96c036e596346147081cbceda136e7c86c1
-- 
GitLab


From c15f7c57fdd8c5dcc63864c1d91ae2e99b84b876 Mon Sep 17 00:00:00 2001
From: Austin Shafer <ashafer@nvidia.com>
Date: Wed, 1 Dec 2021 10:30:18 -0500
Subject: [PATCH 2/2] DRI3: Add support for DRI3 v1.3

This add the DRI3SetDRMDeviceInUse request, and implements it. This
request is only used in Xwayland, and is a hint to notify us
what device to return modifiers for.
---
 dri3/dri3.h                             |  5 ++++
 dri3/dri3_priv.h                        |  5 ++++
 dri3/dri3_request.c                     | 18 ++++++++++++
 dri3/dri3_screen.c                      | 16 +++++++++++
 glamor/glamor_egl.c                     |  2 ++
 hw/xwayland/xwayland-glamor-eglstream.c |  1 +
 hw/xwayland/xwayland-glamor-gbm.c       |  1 +
 hw/xwayland/xwayland-glamor.c           | 38 ++++++++++++++++++++++---
 hw/xwayland/xwayland-glamor.h           |  1 +
 hw/xwayland/xwayland-present.c          |  2 +-
 hw/xwayland/xwayland-present.h          | 11 +++++++
 meson.build                             |  2 +-
 12 files changed, 96 insertions(+), 6 deletions(-)

diff --git a/dri3/dri3.h b/dri3/dri3.h
index 02d3b03eec..d1fd6a7f23 100644
--- a/dri3/dri3.h
+++ b/dri3/dri3.h
@@ -84,6 +84,10 @@ typedef int (*dri3_get_drawable_modifiers_proc) (DrawablePtr draw,
                                                  uint32_t *num_modifiers,
                                                  uint64_t **modifiers);
 
+typedef int (*dri3_set_drm_device_in_use_proc) (WindowPtr window,
+                                                uint32_t drmMajor,
+                                                uint32_t drmMinor);
+
 typedef struct dri3_screen_info {
     uint32_t                    version;
 
@@ -100,6 +104,7 @@ typedef struct dri3_screen_info {
     dri3_get_formats_proc       get_formats;
     dri3_get_modifiers_proc     get_modifiers;
     dri3_get_drawable_modifiers_proc get_drawable_modifiers;
+    dri3_set_drm_device_in_use_proc set_drm_device_in_use;
 
 } dri3_screen_info_rec, *dri3_screen_info_ptr;
 
diff --git a/dri3/dri3_priv.h b/dri3/dri3_priv.h
index f319d17702..7e1d919af2 100644
--- a/dri3/dri3_priv.h
+++ b/dri3/dri3_priv.h
@@ -102,4 +102,9 @@ dri3_get_supported_modifiers(ScreenPtr screen, DrawablePtr drawable,
                              CARD32 *num_screen_modifiers,
                              CARD64 **screen_modifiers);
 
+int
+dri3_set_drm_device_in_use(WindowPtr window,
+                           CARD32 drmMajor,
+                           CARD32 drmMinor);
+
 #endif /* _DRI3PRIV_H_ */
diff --git a/dri3/dri3_request.c b/dri3/dri3_request.c
index 6871689308..89fac109e6 100644
--- a/dri3/dri3_request.c
+++ b/dri3/dri3_request.c
@@ -554,6 +554,23 @@ proc_dri3_buffers_from_pixmap(ClientPtr client)
     return Success;
 }
 
+static int
+proc_dri3_set_drm_device_in_use(ClientPtr client)
+{
+    REQUEST(xDRI3SetDRMDeviceInUseReq);
+    WindowPtr window;
+    int status;
+
+    REQUEST_SIZE_MATCH(xDRI3SetDRMDeviceInUseReq);
+
+    status = dixLookupWindow(&window, stuff->window, client,
+                             DixGetAttrAccess);
+    if (status != Success)
+        return status;
+
+    return dri3_set_drm_device_in_use(window, stuff->drmMajor, stuff->drmMinor);
+}
+
 int (*proc_dri3_vector[DRI3NumberRequests]) (ClientPtr) = {
     proc_dri3_query_version,            /* 0 */
     proc_dri3_open,                     /* 1 */
@@ -564,6 +581,7 @@ int (*proc_dri3_vector[DRI3NumberRequests]) (ClientPtr) = {
     proc_dri3_get_supported_modifiers,  /* 6 */
     proc_dri3_pixmap_from_buffers,      /* 7 */
     proc_dri3_buffers_from_pixmap,      /* 8 */
+    proc_dri3_set_drm_device_in_use,    /* 9 */
 };
 
 int
diff --git a/dri3/dri3_screen.c b/dri3/dri3_screen.c
index bc96e5339c..37b9385652 100644
--- a/dri3/dri3_screen.c
+++ b/dri3/dri3_screen.c
@@ -272,3 +272,19 @@ dri3_get_supported_modifiers(ScreenPtr screen, DrawablePtr drawable,
 
     return Success;
 }
+
+int
+dri3_set_drm_device_in_use(WindowPtr window,
+                           CARD32 drmMajor,
+                           CARD32 drmMinor)
+{
+    dri3_screen_priv_ptr        ds = dri3_screen_priv(window->drawable.pScreen);
+    const dri3_screen_info_rec *info = ds->info;
+
+    if (info->set_drm_device_in_use &&
+        !info->set_drm_device_in_use(window, drmMajor, drmMinor)) {
+        return BadWindow;
+    }
+
+    return Success;
+}
diff --git a/glamor/glamor_egl.c b/glamor/glamor_egl.c
index c35b10d832..b7c1002bda 100644
--- a/glamor/glamor_egl.c
+++ b/glamor/glamor_egl.c
@@ -875,6 +875,8 @@ static const dri3_screen_info_rec glamor_dri3_info = {
     .get_formats = glamor_get_formats,
     .get_modifiers = glamor_get_modifiers,
     .get_drawable_modifiers = glamor_get_drawable_modifiers,
+    /* this is only needed in xwayland */
+    .set_drm_device_in_use = NULL,
 };
 #endif /* DRI3 */
 
diff --git a/hw/xwayland/xwayland-glamor-eglstream.c b/hw/xwayland/xwayland-glamor-eglstream.c
index c911ed987f..dd8eeadf44 100644
--- a/hw/xwayland/xwayland-glamor-eglstream.c
+++ b/hw/xwayland/xwayland-glamor-eglstream.c
@@ -933,6 +933,7 @@ static const dri3_screen_info_rec xwl_dri3_info = {
     .get_formats = xwl_glamor_get_formats,
     .get_modifiers = xwl_glamor_get_modifiers,
     .get_drawable_modifiers = xwl_glamor_get_drawable_modifiers,
+    .set_drm_device_in_use = xwl_set_drm_device_in_use,
 };
 
 static Bool
diff --git a/hw/xwayland/xwayland-glamor-gbm.c b/hw/xwayland/xwayland-glamor-gbm.c
index 205d2feb30..4bf29a4260 100644
--- a/hw/xwayland/xwayland-glamor-gbm.c
+++ b/hw/xwayland/xwayland-glamor-gbm.c
@@ -717,6 +717,7 @@ static const dri3_screen_info_rec xwl_dri3_info = {
     .get_formats = xwl_glamor_get_formats,
     .get_modifiers = xwl_glamor_get_modifiers,
     .get_drawable_modifiers = xwl_glamor_get_drawable_modifiers,
+    .set_drm_device_in_use = xwl_set_drm_device_in_use,
 };
 
 static const char *
diff --git a/hw/xwayland/xwayland-glamor.c b/hw/xwayland/xwayland-glamor.c
index 6c7784efbf..241957d95e 100644
--- a/hw/xwayland/xwayland-glamor.c
+++ b/hw/xwayland/xwayland-glamor.c
@@ -43,9 +43,17 @@
 #include "xwayland-glx.h"
 #include "xwayland-screen.h"
 #include "xwayland-window.h"
+#include "xwayland-present.h"
 
 #include <sys/mman.h>
 
+#include <xf86drm.h>
+#include <sys/types.h>
+#include <sys/stat.h>
+#if defined(__linux__)
+#include <sys/sysmacros.h>
+#endif
+
 static void
 glamor_egl_make_current(struct glamor_context *glamor_ctx)
 {
@@ -368,6 +376,7 @@ xwl_glamor_get_drawable_modifiers(DrawablePtr drawable, uint32_t format,
 {
     struct xwl_screen *xwl_screen = xwl_screen_get(drawable->pScreen);
     struct xwl_window *xwl_window;
+    struct xwl_present_window *xwl_present_window;
     dev_t main_dev;
 
     *num_modifiers = 0;
@@ -381,16 +390,37 @@ xwl_glamor_get_drawable_modifiers(DrawablePtr drawable, uint32_t format,
         return FALSE;
 
     xwl_window = xwl_window_from_window((WindowPtr)drawable);
+    xwl_present_window = xwl_present_window_get_priv((WindowPtr)drawable);
 
     /* couldn't find drawable for window */
-    if (!xwl_window)
+    if (!xwl_window || !xwl_present_window)
         return FALSE;
 
-    main_dev = xwl_screen_get_main_dev(xwl_screen);
+    /*
+     * If we have a drm device specified by the client, query the mods for
+     * that device. Otherwise get the modifiers for the default device for
+     * this window.
+     */
+    if (xwl_present_window->drm_dev_in_use_set) {
+        return xwl_get_modifiers_for_device(&xwl_window->feedback, xwl_present_window->drm_dev_in_use,
+                                            format, num_modifiers, modifiers);
+    } else {
+        main_dev = xwl_screen_get_main_dev(xwl_screen);
 
-    return xwl_get_modifiers_for_device(&xwl_window->feedback, main_dev,
-                                        format, num_modifiers, modifiers);
+        return xwl_get_modifiers_for_device(&xwl_window->feedback, main_dev,
+                                            format, num_modifiers, modifiers);
+    }
+}
 
+Bool
+xwl_set_drm_device_in_use(WindowPtr window, uint32_t drmMajor, uint32_t drmMinor)
+{
+    struct xwl_present_window *xwl_present_window = xwl_present_window_get_priv(window);
+
+    xwl_present_window->drm_dev_in_use = makedev(drmMajor, drmMinor);
+    xwl_present_window->drm_dev_in_use_set = 1;
+
+    return TRUE;
 }
 
 static void
diff --git a/hw/xwayland/xwayland-glamor.h b/hw/xwayland/xwayland-glamor.h
index ed9ec40de5..1e13fd12c6 100644
--- a/hw/xwayland/xwayland-glamor.h
+++ b/hw/xwayland/xwayland-glamor.h
@@ -136,6 +136,7 @@ Bool xwl_glamor_get_formats(ScreenPtr screen,
                             CARD32 *num_formats, CARD32 **formats);
 Bool xwl_glamor_get_modifiers(ScreenPtr screen, uint32_t format,
                               uint32_t *num_modifiers, uint64_t **modifiers);
+Bool xwl_set_drm_device_in_use(WindowPtr window, uint32_t drmMajor, uint32_t drmMinor);
 Bool xwl_glamor_get_drawable_modifiers(DrawablePtr drawable, uint32_t format,
                                        uint32_t *num_modifiers, uint64_t **modifiers);
 Bool xwl_glamor_check_flip(PixmapPtr pixmap);
diff --git a/hw/xwayland/xwayland-present.c b/hw/xwayland/xwayland-present.c
index 2c0e1a05cc..d96c60d715 100644
--- a/hw/xwayland/xwayland-present.c
+++ b/hw/xwayland/xwayland-present.c
@@ -56,7 +56,7 @@ xwl_present_window_priv(WindowPtr window)
                          &xwl_present_window_private_key);
 }
 
-static struct xwl_present_window *
+struct xwl_present_window *
 xwl_present_window_get_priv(WindowPtr window)
 {
     struct xwl_present_window *xwl_present_window = xwl_present_window_priv(window);
diff --git a/hw/xwayland/xwayland-present.h b/hw/xwayland/xwayland-present.h
index ab7f04a3b8..3a9eb8f46b 100644
--- a/hw/xwayland/xwayland-present.h
+++ b/hw/xwayland/xwayland-present.h
@@ -53,6 +53,16 @@ struct xwl_present_window {
     struct xorg_list idle_queue;
 
     present_vblank_ptr flip_active;
+    /*
+     * Clients may notify us which DRM device they are using through
+     * DRI3SetDRMDeviceInUse so that we can return format/modifier info
+     * to them.
+     *
+     * We track this here since the xwl_window may be destroyed when the
+     * window is unmapped.
+     */
+    dev_t drm_dev_in_use;
+    int drm_dev_in_use_set;
 };
 
 struct xwl_present_event {
@@ -61,6 +71,7 @@ struct xwl_present_event {
     PixmapPtr pixmap;
 };
 
+struct xwl_present_window *xwl_present_window_get_priv(WindowPtr window);
 void xwl_present_reset_timer(struct xwl_present_window *xwl_present_window);
 void xwl_present_frame_callback(struct xwl_present_window *xwl_present_window);
 Bool xwl_present_init(ScreenPtr screen);
diff --git a/meson.build b/meson.build
index 01e22b6a92..45362e3201 100644
--- a/meson.build
+++ b/meson.build
@@ -88,7 +88,7 @@ scrnsaverproto_dep = dependency('scrnsaverproto', version: '>= 1.1', fallback: [
 resourceproto_dep = dependency('resourceproto', version: '>= 1.2.0', fallback: ['xorgproto', 'ext_xorgproto'])
 xf86driproto_dep = dependency('xf86driproto', version: '>= 2.1.0', fallback: ['xorgproto', 'ext_xorgproto'], required: get_option('dri1') == 'true')
 dri2proto_dep = dependency('dri2proto', version: '>= 2.8', fallback: ['xorgproto', 'ext_xorgproto'], required: get_option('dri2') == 'true')
-dri3proto_dep = dependency('dri3proto', version: '>= 1.2', fallback: ['xorgproto', 'ext_xorgproto'], required: get_option('dri3') == 'true')
+dri3proto_dep = dependency('dri3proto', version: '>= 1.3', fallback: ['xorgproto', 'ext_xorgproto'], required: get_option('dri3') == 'true')
 xineramaproto_dep = dependency('xineramaproto', fallback: ['xorgproto', 'ext_xorgproto'])
 xf86bigfontproto_dep = dependency('xf86bigfontproto', version: '>= 1.2.0', fallback: ['xorgproto', 'ext_xorgproto'], required: get_option('xf86bigfont'))
 xf86vidmodeproto_dep = dependency('xf86vidmodeproto', version: '>= 2.2.99.1', fallback: ['xorgproto', 'ext_xorgproto'])
-- 
GitLab

