# Maintainer: CachyOS
pkgbase=gstreamer
pkgname=(
  gstreamer
  gst-plugins-base-libs
  gst-plugins-base
  gst-plugins-bad-libs
  gst-plugins-bad
  gst-plugins-ugly
  gst-libav
  gst-plugin-va
)
pkgver=1.26.5
pkgrel=5.4
pkgdesc="Multimedia graph framework (CachyOS optimized)"
url="https://gstreamer.freedesktop.org/"
arch=(x86_64)
license=(LGPL-2.1-or-later)
makedepends=(
  # Core dependencies
  meson
  glib2-devel
  gobject-introspection
  orc
  rust # Re-added for Rust plugin support
  # Plugin dependencies
  a52dec
  alsa-lib
  aom
  bzip2
  cairo
  cdparanoia
  faac
  faad2
  ffmpeg
  flac
  glib2
  gsm
  iso-codes
  json-glib
  lame
  lcms2
  libass
  libbs2b
  libcap
  libcdio
  libdca
  libde265
  libdrm
  libdv
  libdvdnav
  libdvdread
  libelf
  libgudev
  libjpeg-turbo
  libmpeg2
  libnice
  libogg
  libpng
  libpulse
  libsndfile
  libsrtp
  libtheora
  libunwind
  libusb
  libva
  libvorbis
  libvpx
  libwebp
  libx11
  libxcb
  libxext
  libxi
  libxv
  mesa
  nettle
  openjpeg2
  opus
  pango
  svt-av1
  taglib
  twolame
  v4l-utils
  wavpack
  wayland
  x264
  x265
  zlib
)
source=(
  "git+https://gitlab.freedesktop.org/gstreamer/gstreamer.git?signed#tag=$pkgver"
  0001-HACK-meson-Disable-broken-tests.patch
  0002-zbar-tests-Handle-symbol-bytes-as-not-null-terminate.patch
)
b2sums=('c0ef93fe00d68ded5865883e0875ab4ce0b6e67c3abbb001ee60200b579e6ef6000b96'
        'a6d48e69e374f38fa82eb683c59f93cae6e0a53bd7ad9cca9d07c07696b388272f07d5f3f13129148c3257acfff7027d67bd94cd0f4263d6e72b8c790d2af65'
        'fe677cc8f73cc0f00008fea1c94626d0dcbe427402f79347deda25ac04c6f709eed6af20c05d6d4035f44392a9f9213d1183aa278b0d9b47176716cd6b7a1c53')

prepare() {
  cd gstreamer
  # Apply patches for test suite stability
  git apply -3 ../0001-HACK-meson-Disable-broken-tests.patch
  git apply -3 ../0002-zbar-tests-Handle-symbol-bytes-as-not-null-terminate.patch
}

build() {
  # Standard lean build. PGO has been removed as requested.
  local meson_options=(
    -D benchmarks=disabled
    -D examples=disabled
    -D glib_debug=disabled
    -D gpl=enabled
    -D gst-devtools:debug_viewer=disabled
    -D gst-examples=disabled
    # The exact, correct list of gst-plugins-bad features to disable
    -D gst-plugins-bad:aja=disabled
    -D gst-plugins-bad:amfcodec=disabled
    -D gst-plugins-bad:androidmedia=disabled
    -D gst-plugins-bad:cuda-nvmm=disabled
    -D gst-plugins-bad:directfb=disabled
    -D gst-plugins-bad:directshow=disabled
    -D gst-plugins-bad:flite=disabled
    -D gst-plugins-bad:gs=disabled
    -D gst-plugins-bad:iqa=disabled
    -D gst-plugins-bad:isac=disabled
    -D gst-plugins-bad:lcevcdecoder=disabled
    -D gst-plugins-bad:lcevcencoder=disabled
    -D gst-plugins-bad:magicleap=disabled
    -D gst-plugins-bad:mfx_api=oneVPL
    -D gst-plugins-bad:nvcomp=disabled
    -D gst-plugins-bad:nvdswrapper=disabled
    -D gst-plugins-bad:openni2=disabled
    -D gst-plugins-bad:opensles=disabled
    -D gst-plugins-bad:qt6d3d11=disabled
    -D gst-plugins-bad:svtjpegxs=disabled
    -D gst-plugins-bad:tinyalsa=disabled
    -D gst-plugins-bad:voaacenc=disabled
    -D gst-plugins-bad:voamrwbenc=disabled
    -D gst-plugins-bad:wasapi2=disabled
    -D gst-plugins-bad:wasapi=disabled
    # Other subproject options
    -D gst-plugins-base:libvisual=disabled
    -D gst-plugins-base:tremor=disabled
    -D gst-plugins-good:rpicamsrc=disabled
    -D gst-plugins-ugly:sidplay=disabled
    -D gstreamer:dbghelp=disabled
    # Global options
    -D libnice=disabled
    -D orc-source=system
    -D package-name="CachyOS GStreamer ${pkgver}-${pkgrel}"
    -D package-origin="https://www.cachyos.org/"
    -D tests=disabled
    -D vaapi=enabled
  )
  # https://gitlab.freedesktop.org/gstreamer/gstreamer/-/issues/3197
  export GI_SCANNER_DISABLE_CACHE=1

  # Cargo sub-build: Use debug and LTO
  export CARGO_PROFILE_RELEASE_DEBUG=0 CARGO_PROFILE_RELEASE_STRIP=true
  export CARGO_PROFILE_RELEASE_LTO=true CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1

  arch-meson gstreamer build "${meson_options[@]}"
  meson compile -C build
}

check() {
  echo "Tests are disabled for this build."
}

# Robust installer:
# - Expands globs safely using compgen (no brittle [[ pattern hacks])
# - Skips non-existing files without error (features may be toggled)
_install() {
  local pat p
  for pat in "${files[@]}"; do
    mapfile -t _matches < <(compgen -G "$pat") || true
    if ((${#_matches[@]} == 0)); then
      printf 'note: skipping missing %s\n' "$pat"
      continue
    fi
    for p in "${_matches[@]}"; do
      mkdir -p "$pkgdir/${p%/*}"
      mv -v "$p" "$pkgdir/${p%/*}/"
    done
  done
}

package_gstreamer() {
  pkgdesc+=" - core"
  depends=(
    gcc-libs
    glib2
    glibc
    libcap
    libelf
    libunwind
  )
  install=gstreamer.install

  meson install -C build --destdir "$srcdir/root"

  cd "$srcdir/root"
  local files=(
    # Core libs and helpers
    usr/lib/libgst{reamer,base,check,controller,net}-1.0.so*
    usr/lib/gstreamer-1.0/gst-{completion,ptp}-helper
    usr/lib/gstreamer-1.0/gst-plugin-scanner
    usr/lib/gstreamer-1.0/libgstcoreelements.so
    usr/lib/gstreamer-1.0/libgstcoretracers.so

    # pkg-config metadata for core libs
    usr/lib/pkgconfig/gstreamer-1.0.pc
    usr/lib/pkgconfig/gstreamer-base-1.0.pc
    usr/lib/pkgconfig/gstreamer-check-1.0.pc
    usr/lib/pkgconfig/gstreamer-controller-1.0.pc
    usr/lib/pkgconfig/gstreamer-net-1.0.pc

    # Core headers
    usr/include/gstreamer-1.0/gst/*.h
    usr/include/gstreamer-1.0/gst/base
    usr/include/gstreamer-1.0/gst/controller
    usr/include/gstreamer-1.0/gst/net
    usr/lib/gstreamer-1.0/include

    # Locale and tools
    usr/share/locale/*/LC_MESSAGES/gstreamer-1.0.mo
    usr/bin/gst-{inspect,launch,stats,typefind}-1.0
    usr/share/man/man1/gst-{inspect,launch,stats,typefind}-1.0.1
  )
  _install
}

package_gst-plugins-base-libs() {
  pkgdesc+=" - base"
  depends=(
    "gstreamer=$pkgver-$pkgrel"
    glib2
    glibc
    graphene
    libglvnd
    libjpeg-turbo
    libpng
    libx11
    libxv
    mesa
    orc
    wayland
    zlib
  )

  cd "$srcdir/root"
  local files=(
    # Base libs
    usr/lib/libgst{allocators,app,audio,fft,gl,pbutils,riff,rtp,rtsp,sdp,tag,video}-1.0.so*

    # Base runtime modules
    usr/lib/gstreamer-1.0/libgstadder.so
    usr/lib/gstreamer-1.0/libgstapp.so
    usr/lib/gstreamer-1.0/libgstaudioconvert.so
    usr/lib/gstreamer-1.0/libgstaudiomixer.so
    usr/lib/gstreamer-1.0/libgstaudiorate.so
    usr/lib/gstreamer-1.0/libgstaudioresample.so
    usr/lib/gstreamer-1.0/libgstaudiotestsrc.so
    usr/lib/gstreamer-1.0/libgstcompositor.so
    usr/lib/gstreamer-1.0/libgstencoding.so
    usr/lib/gstreamer-1.0/libgstgio.so
    usr/lib/gstreamer-1.0/libgstopengl.so
    usr/lib/gstreamer-1.0/libgstplayback.so
    usr/lib/gstreamer-1.0/libgstsubparse.so
    usr/lib/gstreamer-1.0/libgsttcp.so
    usr/lib/gstreamer-1.0/libgsttypefindfunctions.so
    usr/lib/gstreamer-1.0/libgstvideoconvertscale.so
    usr/lib/gstreamer-1.0/libgstvideorate.so
    usr/lib/gstreamer-1.0/libgstvideotestsrc.so
    usr/lib/gstreamer-1.0/libgstvolume.so
    usr/lib/gstreamer-1.0/libgstximagesink.so
    usr/lib/gstreamer-1.0/libgstxvimagesink.so

    # Tools and locales
    usr/share/locale/*/LC_MESSAGES/gst-plugins-base-1.0.mo
    usr/bin/gst-{device-monitor,discoverer,play}-1.0
    usr/share/man/man1/gst-{device-monitor,discoverer,play}-1.0.1

    # pkg-config metadata for base libs
    usr/lib/pkgconfig/gstreamer-allocators-1.0.pc
    usr/lib/pkgconfig/gstreamer-app-1.0.pc
    usr/lib/pkgconfig/gstreamer-audio-1.0.pc
    usr/lib/pkgconfig/gstreamer-fft-1.0.pc
    usr/lib/pkgconfig/gstreamer-gl-1.0.pc
    usr/lib/pkgconfig/gstreamer-pbutils-1.0.pc
    usr/lib/pkgconfig/gstreamer-riff-1.0.pc
    usr/lib/pkgconfig/gstreamer-rtp-1.0.pc
    usr/lib/pkgconfig/gstreamer-rtsp-1.0.pc
    usr/lib/pkgconfig/gstreamer-sdp-1.0.pc
    usr/lib/pkgconfig/gstreamer-tag-1.0.pc
    usr/lib/pkgconfig/gstreamer-video-1.0.pc

    # Headers for base libs
    usr/include/gstreamer-1.0/gst/allocators
    usr/include/gstreamer-1.0/gst/app
    usr/include/gstreamer-1.0/gst/audio
    usr/include/gstreamer-1.0/gst/fft
    usr/include/gstreamer-1.0/gst/gl
    usr/include/gstreamer-1.0/gst/pbutils
    usr/include/gstreamer-1.0/gst/riff
    usr/include/gstreamer-1.0/gst/rtp
    usr/include/gstreamer-1.0/gst/rtsp
    usr/include/gstreamer-1.0/gst/sdp
    usr/include/gstreamer-1.0/gst/tag
    usr/include/gstreamer-1.0/gst/video
  )
  _install
}

package_gst-plugins-base() {
  pkgdesc+=" - base plugins"
  depends=(
    "gst-plugins-base-libs=$pkgver-$pkgrel"
    "gstreamer=$pkgver-$pkgrel"
    alsa-lib
    cairo
    cdparanoia
    glib2
    glibc
    libogg
    libtheora
    libvorbis
    opus
    pango
  )

  cd "$srcdir/root"
  local files=(
    usr/lib/gstreamer-1.0/libgstalsa.so
    usr/lib/gstreamer-1.0/libgstcdparanoia.so
    usr/lib/gstreamer-1.0/libgstogg.so
    usr/lib/gstreamer-1.0/libgstopus.so
    usr/lib/gstreamer-1.0/libgstpango.so
    usr/lib/gstreamer-1.0/libgsttheora.so
    usr/lib/gstreamer-1.0/libgstvorbis.so
  )
  _install
}

package_gst-plugins-bad-libs() {
  pkgdesc+=" - bad"
  depends=(
    "gst-plugins-base-libs=$pkgver-$pkgrel"
    "gstreamer=$pkgver-$pkgrel"
    gcc-libs
    glib2
    glibc
    libdrm
    libglvnd
    libgudev
    libnice
    libusb
    libva
    libx11
    libxcb
    mesa
    orc
    wayland
    zlib
  )

  cd "$srcdir/root"
  local files=(
    # Bad libs (webrtcnice disabled via -D libnice=disabled)
    usr/lib/libgst{adaptivedemux,badaudio,basecamerabinsrc,codecparsers,codecs,insertbin,mpegts,player,sctp,va,vulkan,wayland,webrtc}-1.0.so*

    # Bad runtime modules
    usr/lib/gstreamer-1.0/libgstaccurip.so
    usr/lib/gstreamer-1.0/libgstaudiofxbad.so
    usr/lib/gstreamer-1.0/libgstautoconvert.so
    usr/lib/gstreamer-1.0/libgstbayer.so
    usr/lib/gstreamer-1.0/libgstbluez.so
    usr/lib/gstreamer-1.0/libgstcamerabin.so
    usr/lib/gstreamer-1.0/libgstdebugutilsbad.so
    usr/lib/gstreamer-1.0/libgstdvb.so
    usr/lib/gstreamer-1.0/libgstfbdevsink.so
    usr/lib/gstreamer-1.0/libgstinterlace.so
    usr/lib/gstreamer-1.0/libgstkms.so
    usr/lib/gstreamer-1.0/libgstmpegtsdemux.so
    usr/lib/gstreamer-1.0/libgstmpegtsmux.so
    usr/lib/gstreamer-1.0/libgstmxf.so
    usr/lib/gstreamer-1.0/libgstsdpelem.so
    usr/lib/gstreamer-1.0/libgstshm.so
    usr/lib/gstreamer-1.0/libgstv4l2codecs.so
    usr/lib/gstreamer-1.0/libgstvideofiltersbad.so
    usr/lib/gstreamer-1.0/libgstvideoparsersbad.so
    usr/lib/gstreamer-1.0/libgstvulkan.so
    usr/lib/gstreamer-1.0/libgstwaylandsink.so

    usr/share/locale/*/LC_MESSAGES/gst-plugins-bad-1.0.mo

    # pkg-config metadata for bad libs (list only ones known to exist upstream)
    usr/lib/pkgconfig/gstreamer-bad-audio-1.0.pc
    usr/lib/pkgconfig/gstreamer-basecamerabinsrc-1.0.pc
    usr/lib/pkgconfig/gstreamer-codecparsers-1.0.pc
    usr/lib/pkgconfig/gstreamer-codecs-1.0.pc
    usr/lib/pkgconfig/gstreamer-insertbin-1.0.pc
    usr/lib/pkgconfig/gstreamer-mpegts-1.0.pc
    usr/lib/pkgconfig/gstreamer-player-1.0.pc
    usr/lib/pkgconfig/gstreamer-sctp-1.0.pc
    usr/lib/pkgconfig/gstreamer-va-1.0.pc
    usr/lib/pkgconfig/gstreamer-vulkan-1.0.pc
    usr/lib/pkgconfig/gstreamer-wayland-1.0.pc
    usr/lib/pkgconfig/gstreamer-webrtc-1.0.pc

    # Headers for bad libs
    usr/include/gstreamer-1.0/gst/adaptivedemux
    usr/include/gstreamer-1.0/gst/badaudio
    usr/include/gstreamer-1.0/gst/basecamerabinsrc
    usr/include/gstreamer-1.0/gst/codecparsers
    usr/include/gstreamer-1.0/gst/codecs
    usr/include/gstreamer-1.0/gst/insertbin
    usr/include/gstreamer-1.0/gst/mpegts
    usr/include/gstreamer-1.0/gst/player
    usr/include/gstreamer-1.0/gst/sctp
    usr/include/gstreamer-1.0/gst/va
    usr/include/gstreamer-1.0/gst/vulkan
    usr/include/gstreamer-1.0/gst/wayland
    usr/include/gstreamer-1.0/gst/webrtc
  )
  _install
}

package_gst-plugins-bad() {
  pkgdesc+=" - bad plugins"
  depends=(
    "gst-plugins-bad-libs=$pkgver-$pkgrel"
    "gst-plugins-base-libs=$pkgver-$pkgrel"
    "gstreamer=$pkgver-$pkgrel"
    aom
    bzip2
    faac
    faad2
    gsm
    lcms2
    libass
    libbs2b
    libdca
    libde265
    libdvdnav
    libdvdread
    libnice
    libsndfile
    libsrtp
    libwebp
    nettle
    openjpeg2
    opus
    orc
    svt-av1
    x265
  )

  cd "$srcdir/root"
  local files=(
    usr/lib/gstreamer-1.0/libgstaom.so
    usr/lib/gstreamer-1.0/libgstassrender.so
    usr/lib/gstreamer-1.0/libgstbs2b.so
    usr/lib/gstreamer-1.0/libgstbz2.so
    usr/lib/gstreamer-1.0/libgstclosedcaption.so
    usr/lib/gstreamer-1.0/libgstcurl.so
    usr/lib/gstreamer-1.0/libgstdash.so
    usr/lib/gstreamer-1.0/libgstde265.so
    usr/lib/gstreamer-1.0/libgstdtls.so
    usr/lib/gstreamer-1.0/libgstdtsdec.so
    usr/lib/gstreamer-1.0/libgstfaac.so
    usr/lib/gstreamer-1.0/libgstfaad.so
    usr/lib/gstreamer-1.0/libgstgsm.so
    usr/lib/gstreamer-1.0/libgsthls.so
    usr/lib/gstreamer-1.0/libgstmpeg2enc.so
    usr/lib/gstreamer-1.0/libgstopusparse.so
    usr/lib/gstreamer-1.0/libgstsndfile.so
    usr/lib/gstreamer-1.0/libgstsrtp.so
    usr/lib/gstreamer-1.0/libgstsvtav1.so
    usr/lib/gstreamer-1.0/libgstwebp.so
    usr/lib/gstreamer-1.0/libgstwebrtc.so
    usr/lib/gstreamer-1.0/libgstx265.so
  )
  _install
}

package_gst-plugins-ugly() {
  pkgdesc+=" - ugly plugins"
  depends=(
    "gst-plugins-base-libs=$pkgver-$pkgrel"
    "gstreamer=$pkgver-$pkgrel"
    a52dec
    glib2
    glibc
    libcdio
    libdvdread
    libmpeg2
    orc
    x264
  )

  cd "$srcdir/root"
  local files=(
    usr/lib/gstreamer-1.0/libgsta52dec.so
    usr/lib/gstreamer-1.0/libgstasf.so
    usr/lib/gstreamer-1.0/libgstcdio.so
    usr/lib/gstreamer-1.0/libgstdvdread.so
    usr/lib/gstreamer-1.0/libgstdvdsub.so
    usr/lib/gstreamer-1.0/libgstmpeg2dec.so
    usr/lib/gstreamer-1.0/libgstrealmedia.so
    usr/lib/gstreamer-1.0/libgstx264.so
    usr/share/gstreamer-1.0/presets/GstX264Enc.prs
    usr/share/locale/*/LC_MESSAGES/gst-plugins-ugly-1.0.mo
  )
  _install
}

package_gst-libav() {
  pkgdesc+=" - libav plugin"
  depends=(
    "gst-plugins-base-libs=$pkgver-$pkgrel"
    "gstreamer=$pkgver-$pkgrel"
    ffmpeg
    glib2
    glibc
  )
  provides=("gst-ffmpeg=$pkgver-$pkgrel")

  cd "$srcdir/root"
  local files=(
    usr/lib/gstreamer-1.0/libgstlibav.so
  )
  _install
}

package_gst-plugin-va() {
  pkgdesc+=" - va plugin"
  depends=(
    "gst-plugins-bad-libs=$pkgver-$pkgrel"
    "gst-plugins-base-libs=$pkgver-$pkgrel"
    "gstreamer=$pkgver-$pkgrel"
    glib2
    glibc
    libgudev
    libva
  )

  cd "$srcdir/root"
  local files=(
    usr/lib/gstreamer-1.0/libgstva.so
  )
  _install
}
