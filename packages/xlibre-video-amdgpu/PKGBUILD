# Maintainer: CachyOS Package Maintainer
_basename="xf86-video-amdgpu"
pkgname="xlibre-xf86-video-amdgpu"
pkgver=23.0.0.5
pkgrel=3.1
pkgdesc="XLibre amdgpu video driver (optimized for AMD GPUs)"
arch=('x86_64')
url="https://github.com/X11Libre/${_basename}"
license=('MIT')
depends=('glibc' 'libdrm-git' 'mesa' 'systemd-libs')
makedepends=('systemd' 'xlibre-xserver-devel' 'xorgproto-git' 'X-ABI-VIDEODRV_VERSION=28.0'
             'clang' 'llvm' 'lld')
provides=("${_basename}")
conflicts=("${_basename}" 'xorg-server<1.20.0' 'X-ABI-VIDEODRV_VERSION<28' 'X-ABI-VIDEODRV_VERSION>=29')
groups=('xlibre-drivers')
source=("${url}/archive/refs/tags/xlibre-${_basename}-${pkgver}.tar.gz" ms178-1.patch)
b2sums=('fc3f52269c45e7590a4c830f5e1eceef6555b411b6552d09df65f2471e9443c52a29d590f86fd628c444a7b9e24bcac6bd56cbded62308aa004fc9d5b87e33c5')

_configure_opts=(
  --prefix=/usr
  --enable-glamor
)

prepare() {
  cd "${srcdir}/${_basename}-${pkgname}-${pkgver}"
  echo "==> [amdgpu-ddx] Applying patch: ms178-1.patch"
  patch -Np1 -i "${srcdir}/ms178-1.patch"
  local srcroot=$(find . -maxdepth 2 -type f \( -name "configure.ac" -o -name "configure.in" \) -exec dirname {} \; | head -1)
  [[ -z "$srcroot" ]] && { echo "ERROR: configure.ac not found"; return 1; }
  srcroot=$(realpath "$srcroot")
  echo "$srcroot" > "$srcdir/.srcroot"
}

build() {
  export CC=clang
  export CXX=clang++

  local srcroot=$(cat "$srcdir/.srcroot")
  cd "$srcroot"

  # Strip problematic hardening flags that hurt performance
  local U_CFLAGS="${CFLAGS/-fno-plt}"
  local U_CXXFLAGS="${CXXFLAGS/-fno-plt}"
  local U_LDFLAGS="${LDFLAGS/-Wl,-z,now}"

  export CFLAGS="$U_CFLAGS"
  export CXXFLAGS="$U_CXXFLAGS"
  export LDFLAGS="$U_LDFLAGS"

  autoreconf -vfi
  ./configure "${_configure_opts[@]}"
  make
}

package() {
  local srcroot=$(cat "$srcdir/.srcroot")
  cd "$srcroot"
  make DESTDIR="$pkgdir" install
  install -vDm644 "COPYING" "$pkgdir/usr/share/licenses/$pkgname/COPYING"
}
