pkgbase=openrazer
pkgname=('python-openrazer' 'openrazer-daemon' 'openrazer-driver-dkms' 'openrazer-meta')
pkgver=3.11.0
pkgrel=3.1
pkgdesc="Open source driver and user-space daemon for Razer peripherals"
arch=('any')
url="https://github.com/openrazer/openrazer"
license=('GPL2')
makedepends=('python-setuptools')
source=("https://github.com/openrazer/openrazer/releases/download/v$pkgver/openrazer-$pkgver.tar.xz")
sha256sums=('387b4a0bcc196ebbb3694b79d90abee19351774a1162d8250880b69d8b1a3023')

prepare() {
  cd "$pkgbase-$pkgver"

  if [ "$(command -v python3)" != "/usr/bin/python3" ]; then
    echo "ERROR: python3 must point to /usr/bin/python3, currently: $(command -v python3)"
    echo "Build in a clean chroot or adjust PATH to prioritize /usr/bin"
    return 1
  fi

  # CachyOS: Optimize DKMS kernel module compilation (executed at install time on user system)
  if [ -f driver/dkms.conf ]; then
    sed -i '/^MAKE\[0\]/d' driver/dkms.conf
    cat >> driver/dkms.conf << 'EOF'
MAKE[0]="make -j$(nproc) CFLAGS_MODULE='-O3 -march=native -mtune=native' all"
EOF
  fi
}

_python_optimize() {
  local site_packages
  site_packages=$(python -c "import sysconfig; print(sysconfig.get_path('purelib'))" 2>/dev/null) || return 0

  local target_dirs=()
  for dir in "$@"; do
    [ -d "$dir" ] && target_dirs+=("$dir")
  done

  [ ${#target_dirs[@]} -eq 0 ] && return 0

  PYTHONHASHSEED=0 python -m compileall -j 0 -q -s "$pkgdir" "${target_dirs[@]}" 2>/dev/null || true
  PYTHONHASHSEED=0 python -OO -m compileall -j 0 -q -s "$pkgdir" "${target_dirs[@]}" 2>/dev/null || true
}

package_python-openrazer() {
  pkgdesc="Python library for accessing the Razer daemon"
  depends=('openrazer-daemon' 'python-numpy')

  cd "$pkgbase-$pkgver"
  make DESTDIR="$pkgdir" python_library_install

  local site_packages
  site_packages=$(python -c "import sysconfig; print(sysconfig.get_path('purelib'))")
  _python_optimize "${pkgdir}/usr/share" "${pkgdir}${site_packages}"
}

package_openrazer-daemon() {
  pkgdesc="Userspace daemon providing DBus service for Razer devices"
  depends=('openrazer-driver-dkms' 'gtk3' 'python-dbus' 'python-gobject'
           'python-setproctitle' 'python-daemonize' 'python-notify2'
           'python-pyudev' 'xautomation')
  install=openrazer-daemon.install

  cd "$pkgbase-$pkgver"
  make DESTDIR="$pkgdir" daemon_install

  local site_packages
  site_packages=$(python -c "import sysconfig; print(sysconfig.get_path('purelib'))")
  _python_optimize "${pkgdir}/usr/share" "${pkgdir}${site_packages}"
}

package_openrazer-driver-dkms() {
  pkgdesc="Kernel driver for Razer devices (DKMS)"
  depends=('dkms' 'udev')
  install=openrazer-driver-dkms.install

  cd "$pkgbase-$pkgver"
  make DESTDIR="$pkgdir" setup_dkms udev_install
}

package_openrazer-meta() {
  pkgdesc="Meta package for openrazer (driver, daemon, Python library)"
  depends=('openrazer-driver-dkms' 'openrazer-daemon' 'python-openrazer')
  optdepends=('polychromatic: GUI frontend'
              'razergenie: Qt frontend'
              'razercommander: GTK frontend')
}
