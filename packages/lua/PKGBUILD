# Maintainer: Anatol Pomozov <anatol.pomozov@gmail.com>
# Maintainer: Caleb Maclennan <caleb@alerque.com>
# Contributor: Sébastien Luttringer <seblu@archlinux.org>
# Contributor: Juergen Hoetzel <juergen@archlinux.org>
# Contributor: Damir Perisa <damir.perisa@bluewin.ch>

pkgname=lua
pkgver=5.5.0
_majorver=${pkgver%.*}
pkgrel=2.2
pkgdesc='Powerful lightweight programming language designed for extending applications (CS-PGO optimized)'
arch=('x86_64')
url='https://www.lua.org/'
depends=('readline')
makedepends=('clang' 'llvm' 'lld')
license=('MIT')
options=('!emptydirs')
source=(https://www.lua.org/ftp/lua-$pkgver.tar.gz
        liblua.so.patch
        paths.patch
        lua.pc
        license-from-upstream)
sha256sums=('57ccc32bbbd005cab75bcc52444052535af691789dba2b9016d5c50640d68b3d'
            '644fba6f3e03c4d0c394d241149fc558da79d0114e7816c2a597097304249cb7'
            '6bb84383498a96514d4c7deb79fd45bf484fa5e3253a1574a3311ee0bb7c24fa'
            'ca9252633e782b8f85d6a94ea4f6babd4fe30bd759085b373160b1878e36ff78'
            '142fb08b41a807b192b4b2c166696a1830a1c97967e5099ad0e579bf500e1da4')

# ══════════════════════════════════════════════════════════════════════════════
# Custom LLVM Toolchain Configuration (optional override)
# ══════════════════════════════════════════════════════════════════════════════
: "${_LLVM_DIR:=/usr/bin}"

prepare() {
  patch -d lua-$pkgver -p1 -i ../liblua.so.patch
  patch -d lua-$pkgver -p1 -i ../paths.patch

  # Create separate build directories for each stage
  cp -r lua-$pkgver lua-pgo-gen
  cp -r lua-$pkgver lua-cspgo-gen
  cp -r lua-$pkgver lua-optimized
  cp -r lua-$pkgver lua++-pgo-gen
  cp -r lua-$pkgver lua++-cspgo-gen
  cp -r lua-$pkgver lua++-optimized

  sed "s/%VER%/$_majorver/g;s/%REL%/$pkgver/g" lua.pc > lua-optimized/lua.pc
  sed "s/%VER%/$_majorver/g;s/%REL%/$pkgver/g;s/-llua/-llua++/g" lua.pc > lua++-optimized/lua++.pc

  # Clean stale profile data
  rm -rf "$srcdir"/*-profiles
}

_run_workload() {
  local lua_bin="$1"
  local lua_src="$2"

  [[ -x "$lua_bin" ]] || return 1

  msg2 "  Running Lua workloads..."

  # Run built-in tests if available
  if [[ -d "$lua_src/testes" ]]; then
    cd "$lua_src/testes"
    for test in *.lua; do
      [[ -f "$test" ]] || continue
      "$lua_bin" "$test" &>/dev/null || true
    done
    cd "$srcdir"
  fi

  # Synthetic workloads for comprehensive profiling
  "$lua_bin" -e '
    -- String operations
    local s = ""
    for i = 1, 10000 do s = s .. tostring(i) end

    -- Table operations
    local t = {}
    for i = 1, 50000 do t[i] = i * 2 end
    for i = 1, 50000 do t[i] = t[i] + 1 end

    -- Math operations
    local sum = 0
    for i = 1, 100000 do sum = sum + math.sin(i) * math.cos(i) end

    -- Function calls (recursive)
    local function fib(n)
      if n < 2 then return n end
      return fib(n-1) + fib(n-2)
    end
    for i = 1, 25 do fib(i) end

    -- Coroutines
    local function producer()
      for i = 1, 1000 do coroutine.yield(i) end
    end
    local co = coroutine.create(producer)
    while coroutine.status(co) ~= "dead" do
      coroutine.resume(co)
    end

    -- Pattern matching
    local text = string.rep("hello world lua programming ", 1000)
    for _ = 1, 100 do
      string.gsub(text, "lua", "LUA")
      string.match(text, "(%w+)%s+(%w+)")
    end

    -- Table sorting
    local data = {}
    for i = 1, 10000 do data[i] = math.random(100000) end
    table.sort(data)

    -- Metatables
    local mt = {
      __add = function(a, b) return setmetatable({val = a.val + b.val}, mt) end,
      __mul = function(a, b) return setmetatable({val = a.val * b.val}, mt) end
    }
    local x = setmetatable({val = 1}, mt)
    for i = 1, 5000 do
      x = x + setmetatable({val = i}, mt)
    end
  ' || true

  # Compile Lua files with luac
  local luac_bin="${lua_bin}c"
  if [[ -x "$luac_bin" && -d "$lua_src/testes" ]]; then
    msg2 "  Running luac workload..."
    for f in "$lua_src"/testes/*.lua; do
      [[ -f "$f" ]] || continue
      "$luac_bin" -o /dev/null "$f" &>/dev/null || true
    done
  fi
}

build() {
  # ════════════════════════════════════════════════════════════════════════════
  # Setup LLVM Toolchain
  # ════════════════════════════════════════════════════════════════════════════
  local _llvm_bin="${_LLVM_DIR}"

  local _clang="${_llvm_bin}/clang"
  local _clangxx="${_llvm_bin}/clang++"
  local _llvm_profdata="${_llvm_bin}/llvm-profdata"

  # Verify tools exist
  for _tool in "$_clang" "$_clangxx" "$_llvm_profdata"; do
    if [[ ! -x "$_tool" ]]; then
      error "Required tool not found: $_tool"
      return 1
    fi
  done

  msg2 "LLVM Toolchain from: ${_llvm_bin}"
  msg2 "  clang:         $("$_clang" --version | head -1)"
  msg2 "  llvm-profdata: $("$_llvm_profdata" --version | head -1)"

  # ════════════════════════════════════════════════════════════════════════════
  # Setup directories
  # ════════════════════════════════════════════════════════════════════════════
  local _pgo_dir="$srcdir/pgo-profiles"
  local _cspgo_dir="$srcdir/cspgo-profiles"
  local _pgo_pp_dir="$srcdir/pgo-pp-profiles"
  local _cspgo_pp_dir="$srcdir/cspgo-pp-profiles"
  mkdir -p "$_pgo_dir" "$_cspgo_dir" "$_pgo_pp_dir" "$_cspgo_pp_dir"

  local _lld_flags="-fuse-ld=lld"

  # ════════════════════════════════════════════════════════════════════════════
  # STAGE 1: Lua (C) - PGO Instrumentation
  # ════════════════════════════════════════════════════════════════════════════
  msg2 "Stage 1/6: Building Lua (C) with PGO instrumentation..."

  local _pgo_gen="-fprofile-generate=${_pgo_dir}"

  cd "$srcdir/lua-pgo-gen"
  make clean &>/dev/null || true
  make PLAT=linux \
    CC="$_clang" \
    MYCFLAGS="${CFLAGS} -fPIC ${_pgo_gen}" \
    MYLDFLAGS="${LDFLAGS} ${_pgo_gen} ${_lld_flags}" \
    linux

  _run_workload "$srcdir/lua-pgo-gen/src/lua" "$srcdir/lua-pgo-gen"

  local _pgo_profdata="$_pgo_dir/pgo.profdata"
  find "$_pgo_dir" -maxdepth 1 -type f -name '*.profraw' \
    | "$_llvm_profdata" merge -output="$_pgo_profdata" -input-files=-

  [[ -s "$_pgo_profdata" ]] || { error "PGO profile generation failed"; return 1; }
  msg2 "  PGO profile: $(du -h "$_pgo_profdata" | cut -f1)"

  # ════════════════════════════════════════════════════════════════════════════
  # STAGE 2: Lua (C) - CS-PGO Instrumentation
  # ════════════════════════════════════════════════════════════════════════════
  msg2 "Stage 2/6: Building Lua (C) with CS-PGO instrumentation..."

  local _cspgo_gen="-fprofile-use=${_pgo_profdata} -fcs-profile-generate=${_cspgo_dir}"

  cd "$srcdir/lua-cspgo-gen"
  make clean &>/dev/null || true
  make PLAT=linux \
    CC="$_clang" \
    MYCFLAGS="${CFLAGS} -fPIC ${_cspgo_gen}" \
    MYLDFLAGS="${LDFLAGS} ${_cspgo_gen} ${_lld_flags}" \
    linux

  _run_workload "$srcdir/lua-cspgo-gen/src/lua" "$srcdir/lua-cspgo-gen"

  local _cspgo_profdata="$_cspgo_dir/cspgo.profdata"
  find "$_cspgo_dir" -maxdepth 1 -type f -name '*.profraw' \
    | "$_llvm_profdata" merge -output="$_cspgo_profdata" "$_pgo_profdata" -input-files=-

  [[ -s "$_cspgo_profdata" ]] || { error "CS-PGO profile generation failed"; return 1; }
  msg2 "  CS-PGO profile: $(du -h "$_cspgo_profdata" | cut -f1)"

  # ════════════════════════════════════════════════════════════════════════════
  # STAGE 3: Lua (C) - Final Optimized Build
  # ════════════════════════════════════════════════════════════════════════════
  msg2 "Stage 3/6: Building final optimized Lua (C)..."

  local _pgo_use="-fprofile-use=${_cspgo_profdata}"

  cd "$srcdir/lua-optimized"
  make clean &>/dev/null || true
  make PLAT=linux \
    CC="$_clang" \
    MYCFLAGS="${CFLAGS} -fPIC ${_pgo_use}" \
    MYLDFLAGS="${LDFLAGS} ${_pgo_use} ${_lld_flags}" \
    linux

  # ════════════════════════════════════════════════════════════════════════════
  # STAGE 4: Lua++ (C++) - PGO Instrumentation
  # ════════════════════════════════════════════════════════════════════════════
  msg2 "Stage 4/6: Building Lua++ (C++) with PGO instrumentation..."

  local _pgo_pp_gen="-fprofile-generate=${_pgo_pp_dir}"

  cd "$srcdir/lua++-pgo-gen"
  make clean &>/dev/null || true
  make PLAT=linux \
    CC="$_clangxx" \
    LUA_A="liblua++.a" \
    LUA_SO="liblua++.so" \
    MYCFLAGS="${CXXFLAGS} -fPIC ${_pgo_pp_gen}" \
    MYLDFLAGS="${LDFLAGS} ${_pgo_pp_gen} ${_lld_flags}" \
    linux

  _run_workload "$srcdir/lua++-pgo-gen/src/lua" "$srcdir/lua++-pgo-gen"

  local _pgo_pp_profdata="$_pgo_pp_dir/pgo.profdata"
  find "$_pgo_pp_dir" -maxdepth 1 -type f -name '*.profraw' \
    | "$_llvm_profdata" merge -output="$_pgo_pp_profdata" -input-files=-

  [[ -s "$_pgo_pp_profdata" ]] || { error "Lua++ PGO profile generation failed"; return 1; }
  msg2 "  Lua++ PGO profile: $(du -h "$_pgo_pp_profdata" | cut -f1)"

  # ════════════════════════════════════════════════════════════════════════════
  # STAGE 5: Lua++ (C++) - CS-PGO Instrumentation
  # ════════════════════════════════════════════════════════════════════════════
  msg2 "Stage 5/6: Building Lua++ (C++) with CS-PGO instrumentation..."

  local _cspgo_pp_gen="-fprofile-use=${_pgo_pp_profdata} -fcs-profile-generate=${_cspgo_pp_dir}"

  cd "$srcdir/lua++-cspgo-gen"
  make clean &>/dev/null || true
  make PLAT=linux \
    CC="$_clangxx" \
    LUA_A="liblua++.a" \
    LUA_SO="liblua++.so" \
    MYCFLAGS="${CXXFLAGS} -fPIC ${_cspgo_pp_gen}" \
    MYLDFLAGS="${LDFLAGS} ${_cspgo_pp_gen} ${_lld_flags}" \
    linux

  _run_workload "$srcdir/lua++-cspgo-gen/src/lua" "$srcdir/lua++-cspgo-gen"

  local _cspgo_pp_profdata="$_cspgo_pp_dir/cspgo.profdata"
  find "$_cspgo_pp_dir" -maxdepth 1 -type f -name '*.profraw' \
    | "$_llvm_profdata" merge -output="$_cspgo_pp_profdata" "$_pgo_pp_profdata" -input-files=-

  [[ -s "$_cspgo_pp_profdata" ]] || { error "Lua++ CS-PGO profile generation failed"; return 1; }
  msg2 "  Lua++ CS-PGO profile: $(du -h "$_cspgo_pp_profdata" | cut -f1)"

  # ════════════════════════════════════════════════════════════════════════════
  # STAGE 6: Lua++ (C++) - Final Optimized Build
  # ════════════════════════════════════════════════════════════════════════════
  msg2 "Stage 6/6: Building final optimized Lua++ (C++)..."

  local _pgo_pp_use="-fprofile-use=${_cspgo_pp_profdata}"

  cd "$srcdir/lua++-optimized"
  make clean &>/dev/null || true
  make PLAT=linux \
    CC="$_clangxx" \
    LUA_A="liblua++.a" \
    LUA_SO="liblua++.so" \
    MYCFLAGS="${CXXFLAGS} -fPIC ${_pgo_pp_use}" \
    MYLDFLAGS="${LDFLAGS} ${_pgo_pp_use} ${_lld_flags}" \
    linux

  msg "Build complete: CS-PGO optimized"
}

check() {
  msg2 "Running Lua test suite..."
  cd "$srcdir/lua-optimized"

  if [[ -d testes ]]; then
    cd testes
    ../src/lua -e "_U=true" all.lua || warning "Some tests failed"
    cd ..
  fi

  # Basic sanity check
  ./src/lua -v
  ./src/lua -e "print('Lua is working!')"
}

package() {
  cd "$srcdir/lua-optimized"

  make \
    TO_LIB="liblua.so liblua.so.$_majorver liblua.so.$pkgver" \
    INSTALL_DATA='cp -d' \
    INSTALL_TOP="$pkgdir"/usr \
    INSTALL_MAN="$pkgdir"/usr/share/man/man1 \
    install

  ln -sf /usr/bin/lua "$pkgdir"/usr/bin/lua$_majorver
  ln -sf /usr/bin/luac "$pkgdir"/usr/bin/luac$_majorver
  ln -sf /usr/lib/liblua.so.$pkgver "$pkgdir"/usr/lib/liblua$_majorver.so

  install -Dm644 lua.pc "$pkgdir"/usr/lib/pkgconfig/lua55.pc
  ln -sf lua55.pc "$pkgdir"/usr/lib/pkgconfig/lua.pc
  ln -sf lua55.pc "$pkgdir"/usr/lib/pkgconfig/lua5.5.pc
  ln -sf lua55.pc "$pkgdir"/usr/lib/pkgconfig/lua-5.5.pc

  install -d "$pkgdir"/usr/share/doc/$pkgname
  install -m644 doc/*.{png,css,html} "$pkgdir"/usr/share/doc/$pkgname
  install -Dm644 ../license-from-upstream "$pkgdir"/usr/share/licenses/$pkgname/LICENSE

  # Install Lua++ (C++ version)
  cd "$srcdir/lua++-optimized"
  make \
    TO_LIB="liblua++.so liblua++.so.$_majorver liblua++.so.$pkgver" \
    INSTALL_BIN=null INSTALL_INC=null INSTALL_MAN=../null \
    INSTALL_DATA='cp -d' \
    INSTALL_TOP="$pkgdir"/usr \
    install

  ln -sf /usr/lib/liblua++.so.$pkgver "$pkgdir"/usr/lib/liblua++$_majorver.so

  install -Dm644 lua++.pc "$pkgdir"/usr/lib/pkgconfig/lua++55.pc
  ln -sf lua++55.pc "$pkgdir"/usr/lib/pkgconfig/lua++.pc
  ln -sf lua++55.pc "$pkgdir"/usr/lib/pkgconfig/lua++5.5.pc
  ln -sf lua++55.pc "$pkgdir"/usr/lib/pkgconfig/lua++-5.5.pc
}
