pkgname=spirv-tools-git
pkgver=2026.1.rc1
pkgrel=1
epoch=1
pkgdesc='API and commands for processing SPIR-V modules'
url='https://github.com/KhronosGroup/SPIRV-Tools'
arch=(x86_64)
license=(custom)
groups=(vulkan-devel)
depends=(glibc gcc-libs sh)
makedepends=(cmake python git spirv-headers-git clang llvm lld glslang)
conflicts=(spirv-tools)
provides=(spirv-tools)

source=(
  'git+https://github.com/KhronosGroup/SPIRV-Tools'
  'git+https://github.com/google/googletest.git'
  'git+https://github.com/google/effcee.git'
  'git+https://github.com/google/re2.git'
  'git+https://github.com/abseil/abseil-cpp.git'
)
sha1sums=('SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP')

run_training_workload() {
    local build_dir="$1"
    local bin="$build_dir/tools"

    # Find the correct binary location
    [[ -x "$bin/spirv-as" ]] || bin="$build_dir"
    [[ -x "$bin/spirv-as" ]] || bin="$build_dir/bin"

    echo ":: Running SPIRV-Tools training workload"
    echo "   Binary directory: $bin"

    # Verify core tools exist
    for exe in spirv-as spirv-opt spirv-val spirv-dis; do
        if [[ ! -x "$bin/$exe" ]]; then
            echo "!! $exe missing at $bin/$exe, skipping workload"
            return 0
        fi
    done

    local wd="$srcdir/workload"
    rm -rf "$wd"
    mkdir -p "$wd/glsl" "$wd/spv"

    # ── 1. Create shader templates ─────────────────────────────────────────
    cat > "$wd/t.vert" << 'VERT'
#version 460 core
layout(location=0) in vec3 p;
layout(push_constant) uniform PC { mat4 mvp; } pc;
void main(){ gl_Position = pc.mvp * vec4(p,1); }
VERT

    cat > "$wd/t.frag" << 'FRAG'
#version 460 core
layout(location=0) out vec4 c;
void main(){ c = vec4(@R@,@G@,@B@,1); }
FRAG

    cat > "$wd/t.comp" << 'COMP'
#version 460 core
layout(local_size_x=@LS@) in;
layout(binding=0) buffer B { float d[]; } b;
void main(){ b.d[gl_GlobalInvocationID.x] *= 2.0; }
COMP

    # ── 2. Generate shader variants ────────────────────────────────────────
    for i in {0..99}; do
        cp "$wd/t.vert" "$wd/glsl/v${i}.vert"

        sed -e "s/@R@/0.$((i % 9))/" \
            -e "s/@G@/0.$((i % 7))/" \
            -e "s/@B@/0.$((i % 5))/" \
            "$wd/t.frag" > "$wd/glsl/f${i}.frag"

        sed "s/@LS@/$((16 + i % 96))/" "$wd/t.comp" > "$wd/glsl/c${i}.comp"
    done

    # ── 3. Compile GLSL → SPIR-V ───────────────────────────────────────────
    if command -v glslangValidator &>/dev/null; then
        echo "   Compiling GLSL shaders..."

        local shader
        for shader in "$wd/glsl"/*.vert "$wd/glsl"/*.frag "$wd/glsl"/*.comp; do
            [[ -f "$shader" ]] || continue
            glslangValidator -q --target-env vulkan1.3 "$shader" \
                -o "${shader}.spv" 2>/dev/null || true
        done
    else
        echo "!! glslangValidator missing – GLSL step skipped"
    fi

    # ── 4. Hand-written SPIR-V assembly ────────────────────────────────────
    cat > "$wd/min.asm" << 'ASM'
; SPIR-V
               OpCapability Shader
               OpMemoryModel Logical GLSL450
               OpEntryPoint GLCompute %main "main"
               OpExecutionMode %main LocalSize 32 1 1
       %void = OpTypeVoid
    %fn_void = OpTypeFunction %void
       %main = OpFunction %void None %fn_void
      %entry = OpLabel
               OpReturn
               OpFunctionEnd
ASM

    "$bin/spirv-as" "$wd/min.asm" -o "$wd/spv/min.spv"

    # Create additional assembly variants
    for i in {1..20}; do
        cat > "$wd/asm_${i}.asm" << ASM
; SPIR-V
               OpCapability Shader
               OpMemoryModel Logical GLSL450
               OpEntryPoint GLCompute %main "main"
               OpExecutionMode %main LocalSize $((8 + i * 4)) 1 1
       %void = OpTypeVoid
    %fn_void = OpTypeFunction %void
       %main = OpFunction %void None %fn_void
      %entry = OpLabel
               OpReturn
               OpFunctionEnd
ASM
        "$bin/spirv-as" "$wd/asm_${i}.asm" -o "$wd/spv/asm_${i}.spv" 2>/dev/null || true
    done

    # ── 5. Collect all SPIR-V files ────────────────────────────────────────
    find "$wd" -name '*.spv' -exec cp {} "$wd/spv/" \; 2>/dev/null || true

    echo "   Generated $(find "$wd/spv" -name '*.spv' | wc -l) SPIR-V files"

    # ── 6. Round-trip: disassemble → assemble ──────────────────────────────
    echo "   Running disassemble/assemble round-trip..."

    local spv_file
    for spv_file in "$wd/spv"/*.spv; do
        [[ -f "$spv_file" ]] || continue
        local base="${spv_file%.spv}"

        "$bin/spirv-dis" "$spv_file" -o "${base}.asm" 2>/dev/null || true

        if [[ -f "${base}.asm" ]]; then
            "$bin/spirv-as" "${base}.asm" -o "${base}.rt.spv" 2>/dev/null || true
        fi
    done

    # ── 7. Validation (FIX: process ONE file at a time) ───────────────────
    echo "   Validating SPIR-V modules..."

    for spv_file in "$wd/spv"/*.spv; do
        [[ -f "$spv_file" ]] || continue
        "$bin/spirv-val" "$spv_file" 2>/dev/null || true
    done

    # ── 8. Optimization sweeps ─────────────────────────────────────────────
    echo "   Running optimization passes..."

    local opt_flags=(
        "-O"
        "-Os"
        "--inline-entry-points-exhaustive"
        "--eliminate-dead-code-aggressive"
        "--scalar-replacement=256"
        "--loop-unroll"
        "--convert-relaxed-to-half"
        "--combine-access-chains"
        "--compact-ids"
        "--eliminate-dead-branches"
        "--merge-return"
        "--simplify-instructions"
        "--ssa-rewrite"
        "--strength-reduction"
    )

    for opt in "${opt_flags[@]}"; do
        local opt_suffix="${opt//[^a-zA-Z0-9]/_}"

        for spv_file in "$wd/spv"/*.spv; do
            [[ -f "$spv_file" ]] || continue
            [[ "$spv_file" == *"_opt_"* ]] && continue  # Skip already-optimized

            local out_file="${spv_file%.spv}_opt_${opt_suffix}.spv"
            "$bin/spirv-opt" "$opt" "$spv_file" -o "$out_file" 2>/dev/null || true
        done
    done

    # ── 9. Multi-stage optimization pipeline ───────────────────────────────
    echo "   Running multi-stage optimization pipeline..."

    for spv_file in "$wd/spv"/*.spv; do
        [[ -f "$spv_file" ]] || continue
        [[ "$spv_file" == *"_stage"* ]] && continue
        [[ "$spv_file" == *"_opt_"* ]] && continue

        local base="${spv_file%.spv}"

        # Stage 1: strip debug
        "$bin/spirv-opt" --strip-debug "$spv_file" -o "${base}_stage1.spv" 2>/dev/null || continue

        # Stage 2: -O
        "$bin/spirv-opt" -O "${base}_stage1.spv" -o "${base}_stage2.spv" 2>/dev/null || continue

        # Stage 3: -Os
        "$bin/spirv-opt" -Os "${base}_stage2.spv" -o "${base}_stage3.spv" 2>/dev/null || continue

        # Stage 4: compact-ids
        "$bin/spirv-opt" --compact-ids "${base}_stage3.spv" -o "${base}_stage4.spv" 2>/dev/null || true
    done

    # ── 10. Disassemble final outputs ──────────────────────────────────────
    echo "   Disassembling optimized outputs..."

    for spv_file in "$wd/spv"/*_stage4.spv; do
        [[ -f "$spv_file" ]] || continue
        "$bin/spirv-dis" "$spv_file" -o "${spv_file%.spv}.txt" 2>/dev/null || true
    done

    # ── 11. Generate CFGs if spirv-cfg exists ──────────────────────────────
    if [[ -x "$bin/spirv-cfg" ]]; then
        echo "   Generating control flow graphs..."

        for spv_file in "$wd/spv"/*_stage4.spv; do
            [[ -f "$spv_file" ]] || continue
            "$bin/spirv-cfg" "$spv_file" -o "${spv_file%.spv}.dot" 2>/dev/null || true
        done
    fi

    # ── 12. Additional validation pass on optimized files ──────────────────
    echo "   Final validation pass..."

    for spv_file in "$wd/spv"/*_stage4.spv; do
        [[ -f "$spv_file" ]] || continue
        "$bin/spirv-val" "$spv_file" 2>/dev/null || true
    done

    # Cleanup
    rm -rf "$wd"
    echo ":: Training workload completed"
}

##############################################################################
#  prepare
##############################################################################
prepare() {
    cd "$srcdir/SPIRV-Tools"

    # Setup external dependencies
    mkdir -p external
    cd external

    ln -sfn "$srcdir/googletest" googletest
    ln -sfn "$srcdir/abseil-cpp" abseil_cpp
    ln -sfn "$srcdir/effcee" effcee
    ln -sfn "$srcdir/re2" re2
}

##############################################################################
#  pkgver
##############################################################################
pkgver() {
    git -C "$srcdir/SPIRV-Tools" describe --tags --match 'v*.*' --abbrev=10 |
        sed 's/^v//; s/-/+/; s/-/./'
}

##############################################################################
#  build – Three-stage PGO pipeline
##############################################################################
build() {
    # Force Clang toolchain
    export CC=clang
    export CXX=clang++
    export AR=llvm-ar
    export NM=llvm-nm
    export RANLIB=llvm-ranlib

    # Save original flags
    local ORIG_CFLAGS="${CFLAGS:-}"
    local ORIG_CXXFLAGS="${CXXFLAGS:-}"
    local ORIG_LDFLAGS="${LDFLAGS:-}"

    # PGO directories
    local pgo_raw_dir="$srcdir/pgo_raw"
    local pgo_cs_dir="$srcdir/pgo_cs"

    rm -rf "$srcdir/_build" "$srcdir/_build_pgo1" "$srcdir/_build_pgo2"
    rm -rf "$pgo_raw_dir" "$pgo_cs_dir"
    mkdir -p "$pgo_raw_dir" "$pgo_cs_dir"

    # Instrumentation flags
    local INSTR_FLAGS="-g3 -fno-omit-frame-pointer"
    INSTR_FLAGS+=" -Xclang -mllvm -Xclang -vp-counters-per-site=150"
    INSTR_FLAGS+=" -Xclang -mllvm -Xclang -runtime-counter-relocation"
    INSTR_FLAGS+=" -Xclang -mllvm -Xclang -enable-value-profiling"

    # Common CMake options
    local cmake_opts=(
        -DCMAKE_INSTALL_PREFIX=/usr
        -DCMAKE_INSTALL_LIBDIR=lib
        -DSPIRV-Headers_SOURCE_DIR=/usr
        -DBUILD_SHARED_LIBS=ON
        -DSPIRV_TOOLS_BUILD_STATIC=OFF
        -DSPIRV_WERROR=OFF
        -Wno-dev
    )

    ############################################################################
    # Stage 1: Standard PGO Instrumentation
    ############################################################################
    msg2 "==> Stage 1: PGO instrumentation build"

    export CFLAGS="${ORIG_CFLAGS} ${INSTR_FLAGS} -fprofile-generate=${pgo_raw_dir}"
    export CXXFLAGS="${ORIG_CXXFLAGS} ${INSTR_FLAGS} -fprofile-generate=${pgo_raw_dir}"
    export LDFLAGS="${ORIG_LDFLAGS} -fprofile-generate=${pgo_raw_dir} -fuse-ld=lld"

    cmake -S "$srcdir/SPIRV-Tools" -B "$srcdir/_build_pgo1" \
        -DCMAKE_BUILD_TYPE=Release \
        "${cmake_opts[@]}"

    cmake --build "$srcdir/_build_pgo1" -j"$(nproc)"

    msg2 "==> Stage 1: Running training workload"
    run_training_workload "$srcdir/_build_pgo1" || true

    # Run tests for additional coverage
    cmake --build "$srcdir/_build_pgo1" --target test || true

    msg2 "==> Stage 1: Merging profiles"
    llvm-profdata merge -output="$srcdir/standard.profdata" "$pgo_raw_dir"/*.profraw

    ############################################################################
    # Stage 2: Context-Sensitive PGO
    ############################################################################
    msg2 "==> Stage 2: Context-sensitive PGO build"

    export CFLAGS="${ORIG_CFLAGS} ${INSTR_FLAGS} -fprofile-use=${srcdir}/standard.profdata -fcs-profile-generate=${pgo_cs_dir}"
    export CXXFLAGS="${ORIG_CXXFLAGS} ${INSTR_FLAGS} -fprofile-use=${srcdir}/standard.profdata -fcs-profile-generate=${pgo_cs_dir}"
    export LDFLAGS="${ORIG_LDFLAGS} -fprofile-use=${srcdir}/standard.profdata -fcs-profile-generate=${pgo_cs_dir} -fuse-ld=lld"

    cmake -S "$srcdir/SPIRV-Tools" -B "$srcdir/_build_pgo2" \
        -DCMAKE_BUILD_TYPE=Release \
        "${cmake_opts[@]}"

    cmake --build "$srcdir/_build_pgo2" -j"$(nproc)"

    msg2 "==> Stage 2: Running training workload"
    run_training_workload "$srcdir/_build_pgo2" || true

    cmake --build "$srcdir/_build_pgo2" --target test || true

    msg2 "==> Stage 2: Merging profiles"
    llvm-profdata merge -output="$srcdir/merged.profdata" \
        "$srcdir/standard.profdata" \
        "$pgo_cs_dir"/*.profraw

    ############################################################################
    # Stage 3: Final PGO-Optimized Build
    ############################################################################
    msg2 "==> Stage 3: Final optimized build"

    export CFLAGS="${ORIG_CFLAGS} -fprofile-use=${srcdir}/merged.profdata"
    export CXXFLAGS="${ORIG_CXXFLAGS} -fprofile-use=${srcdir}/merged.profdata"
    export LDFLAGS="${ORIG_LDFLAGS} -fprofile-use=${srcdir}/merged.profdata -fuse-ld=lld"

    cmake -S "$srcdir/SPIRV-Tools" -B "$srcdir/_build" \
        -DCMAKE_BUILD_TYPE=Release \
        "${cmake_opts[@]}"

    cmake --build "$srcdir/_build" -j"$(nproc)"

    msg2 "==> Build complete"
}

##############################################################################
#  check
##############################################################################
check() {
    cmake --build "$srcdir/_build" --target test || true
}

##############################################################################
#  package
##############################################################################
package() {
    DESTDIR="$pkgdir" cmake --install "$srcdir/_build"

    install -Dm644 "$srcdir/SPIRV-Tools/LICENSE" \
        "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}
