# Maintainer: CachyOS Toolchain Team
# GCC toolchain build order: linux-api-headers -> glibc -> binutils -> gcc -> glibc -> binutils -> gcc

pkgbase=gcc
pkgname=(
  gcc
  gcc-fortran
  gcc-objc
  gcc-libs
  lib32-gcc-libs
  libasan
  libatomic
  libgcc
  libgccjit
  libgfortran
  libgomp
  libitm
  liblsan
  libobjc
  libquadmath
  libstdc++
  libtsan
  libubsan
  lto-dump
)
pkgver=15.2.1+r604+g0b99615a8aef
_commit=a3e15ca3c1f0e3e5dc2dbb11c8e7fcd6de41a3f3
pkgrel=3.1
pkgdesc='The GNU Compiler Collection'
arch=(x86_64)
url='https://gcc.gnu.org'
license=(GPL-3.0-with-GCC-exception GFDL-1.3-or-later)

makedepends=(
  binutils
  git
  lib32-glibc
  lib32-gcc-libs
  libisl
  libmpc
  python
  zstd
)
checkdepends=(
  dejagnu
  expect
  inetutils
  python-pytest
  tcl
)
options=(!emptydirs !lto)

_basever=${pkgver%%+*}
_libdir=usr/lib/gcc/$CHOST/${_basever}

source=(
  "git+https://sourceware.org/git/gcc.git#commit=$_commit"
  c89
  c99
  clearlinux.patch
)
sha256sums=(
  'SKIP'
  'de48736f6e4153f03d0a5d38ceb6c6fdb7f054e8f47ddd6af0a3dbf14f27b931'
  '2513c6d9984dd0a2058557bf00f06d8d5181734e41dcfe07be7ed86f2959622a'
  'c86372c207d174c0918d4aedf1cb79f7fc093649eb1ad8d9450dccc46849d308'
)

#######################################################################
# helper                                                              #
#######################################################################
_patch() {
  printf '\033[1;33m==> Applying patch: %s\033[0m\n' "$1"
  patch -d "$srcdir/gcc" --forward --strip=1 --input="$srcdir/$1"
}

#######################################################################
# prepare                                                             #
#######################################################################
prepare() {
  cd "$srcdir/gcc"

  # Do not run fixincludes (we ship pristine headers)
  sed -i 's@\./fixinc\.sh@-c true@' gcc/Makefile.in

  # Arch/CachyOS installs x86_64 libraries to /lib, not /lib64
  sed -i '/m64=/s/lib64/lib/' gcc/config/i386/t-linux64

  # Apply downstream patch set
  _patch clearlinux.patch

  # Create out-of-tree build dirs
  mkdir -p "$srcdir"/{gcc-build,libgccjit-build}
}

#######################################################################
# build                                                               #
#######################################################################
build() {
  local _confflags=(
    --prefix=/usr
    --libdir=/usr/lib
    --libexecdir=/usr/lib
    --mandir=/usr/share/man
    --infodir=/usr/share/info
    --with-bugurl=https://github.com/CachyOS/CachyOS-PKGBUILDS/issues
    --with-build-config=bootstrap-lto
    --with-linker-hash-style=gnu
    --with-system-zlib
    --with-zstd
    --with-isl
    --enable-__cxa_atexit
    --enable-cet=auto
    --disable-checking
    --enable-clocale=gnu
    --enable-default-pie
    --enable-default-ssp
    --enable-gnu-indirect-function
    --enable-gnu-unique-object
    --disable-libstdcxx-backtrace
    --enable-link-serialization=1
    --enable-linker-build-id
    --enable-lto
    --enable-multilib
    --enable-plugin
    --enable-shared
    --enable-threads=posix
    --disable-libssp
    --disable-libstdcxx-pch
    --disable-werror
  )

  ###################################################################
  # Core compiler (bootstrap + PGO/LTO)                              #
  ###################################################################
  cd "$srcdir/gcc-build"

  # Remove problematic flag forcibly injected by makepkg.conf
  local _base_cflags=${CFLAGS/-Werror=format-security/}
  local _base_cxxflags=${CXXFLAGS/-Werror=format-security/}

  # Keep target libs optimized for this system
  local _target_cflags
  local _target_cxxflags
  _target_cflags="$(printf '%s' "$_base_cflags" | sed -E 's/-march=[^ ]+//g; s/-mtune=[^ ]+//g') -march=native -mtune=native"
  _target_cxxflags="$(printf '%s' "$_base_cxxflags" | sed -E 's/-march=[^ ]+//g; s/-mtune=[^ ]+//g') -march=native -mtune=native"

  export CFLAGS="$_base_cflags -march=native -mtune=native -fno-semantic-interposition"
  export CXXFLAGS="$_base_cxxflags -march=native -mtune=native -fno-semantic-interposition"

  "$srcdir/gcc/configure" \
    --build="$CHOST" \
    --host="$CHOST" \
    --target="$CHOST" \
    --enable-languages=c,c++,fortran,objc,obj-c++,lto \
    --enable-bootstrap \
    "${_confflags[@]}"

  # *FLAGS handling – see FS#71777
  make -O \
    STAGE1_CFLAGS="-O3 -march=native -mtune=native" \
    STAGE1_CXXFLAGS="-O3 -march=native -mtune=native" \
    BOOT_CFLAGS="$CFLAGS" \
    BOOT_CXXFLAGS="$CXXFLAGS" \
    BOOT_LDFLAGS="$LDFLAGS" \
    CFLAGS_FOR_TARGET="$_target_cflags" \
    CXXFLAGS_FOR_TARGET="$_target_cxxflags" \
    LDFLAGS_FOR_TARGET="$LDFLAGS" \
    profiledbootstrap

  ###################################################################
  # libgccjit (built separately to avoid --enable-host-shared on all)#
  ###################################################################
  cd "$srcdir/libgccjit-build"

  "$srcdir/gcc/configure" \
    --enable-languages=jit \
    --disable-bootstrap \
    --enable-host-shared \
    "${_confflags[@]}"

  make -O \
    STAGE1_CFLAGS="-O3 -march=native -mtune=native" \
    STAGE1_CXXFLAGS="-O3 -march=native -mtune=native" \
    BOOT_CFLAGS="$CFLAGS" \
    BOOT_CXXFLAGS="$CXXFLAGS" \
    BOOT_LDFLAGS="$LDFLAGS" \
    LDFLAGS_FOR_TARGET="$LDFLAGS" \
    all-gcc

  # Provide built jit library to main tree
  cp -a gcc/libgccjit.so* ../gcc-build/gcc/
}

#######################################################################
# check                                                               #
#######################################################################
#check() {
#  cd "$srcdir/gcc-build"
#  make -O -k check || true
#  "$srcdir/gcc/contrib/test_summary"
#}

#######################################################################
# Split packages                                                      #
#######################################################################
package_gcc() {
  pkgdesc='The GNU Compiler Collection – C and C++ front-ends'
  depends=("gcc-libs=$pkgver-$pkgrel" "binutils>=2.28" libmpc zstd libisl.so)
  groups=(base-devel)
  optdepends=('lib32-gcc-libs: for generating code for 32-bit ABI')
  provides=(gcc-multilib)
  replaces=(gcc-multilib)
  options=(!emptydirs staticlibs)

  cd "$srcdir/gcc-build"

  # core compiler binaries and helpers
  make -C gcc DESTDIR="$pkgdir" \
    install-driver install-cpp install-gcc-ar \
    c++.install-common install-headers install-plugin install-lto-wrapper

  install -Dt "$pkgdir/usr/bin"  -m755 gcc/gcov{,-tool}
  install -Dt "$pkgdir/$_libdir" -m755 gcc/{cc1,cc1plus,collect2,lto1}

  # runtime libs (static + headers)
  make -C "$CHOST/libgcc"    DESTDIR="$pkgdir" install
  make -C "$CHOST/32/libgcc" DESTDIR="$pkgdir" install
  rm -f "$pkgdir"/usr/lib{,32}/libgcc_s.so*

  make -C "$CHOST/libstdc++-v3/src"       DESTDIR="$pkgdir" install
  make -C "$CHOST/libstdc++-v3/include"   DESTDIR="$pkgdir" install
  make -C "$CHOST/libstdc++-v3/libsupc++" DESTDIR="$pkgdir" install
  make -C "$CHOST/libstdc++-v3/python"    DESTDIR="$pkgdir" install
  make -C "$CHOST/libatomic"             DESTDIR="$pkgdir" install

  make -C "$CHOST/32/libstdc++-v3/src"       DESTDIR="$pkgdir" install
  make -C "$CHOST/32/libstdc++-v3/include"   DESTDIR="$pkgdir" install
  make -C "$CHOST/32/libstdc++-v3/libsupc++" DESTDIR="$pkgdir" install
  make -C "$CHOST/32/libatomic"             DESTDIR="$pkgdir" install

  make DESTDIR="$pkgdir" install-libcc1

  # move GDB auto-load python helper
  shopt -s nullglob
  for _py in "$pkgdir"/usr/lib/libstdc++.so.6*-gdb.py; do
    install -d "$pkgdir/usr/share/gdb/auto-load/usr/lib"
    mv "$_py" "$pkgdir/usr/share/gdb/auto-load/usr/lib/"
  done
  shopt -u nullglob

  rm -f "$pkgdir"/usr/lib{,32}/libstdc++.so*
  rm -f "$pkgdir"/usr/lib{,32}/libatomic.so*

  # fixincludes, mkheaders, LTO plugin
  make DESTDIR="$pkgdir" install-fixincludes
  make -C gcc DESTDIR="$pkgdir" install-mkheaders

  make -C lto-plugin DESTDIR="$pkgdir" install
  install -d "$pkgdir/usr/lib/bfd-plugins"
  ln -s "/$_libdir/liblto_plugin.so" "$pkgdir/usr/lib/bfd-plugins/"

  # headers from ancillary runtime libs
  make -C "$CHOST/libgomp"       DESTDIR="$pkgdir" install-nodist_toolexeclibHEADERS
  make -C "$CHOST/libitm"        DESTDIR="$pkgdir" install-nodist_toolexeclibHEADERS
  make -C "$CHOST/libquadmath"   DESTDIR="$pkgdir" install-nodist_libsubincludeHEADERS
  make -C "$CHOST/libsanitizer"  DESTDIR="$pkgdir" install-nodist_sanincludeHEADERS
  make -C "$CHOST/libsanitizer/asan" DESTDIR="$pkgdir" install-nodist_toolexeclibHEADERS
  make -C "$CHOST/libsanitizer/tsan" DESTDIR="$pkgdir" install-nodist_toolexeclibHEADERS
  make -C "$CHOST/libsanitizer/lsan" DESTDIR="$pkgdir" install-nodist_toolexeclibHEADERS

  make -C "$CHOST/32/libgomp"      DESTDIR="$pkgdir" install-nodist_toolexeclibHEADERS
  make -C "$CHOST/32/libitm"       DESTDIR="$pkgdir" install-nodist_toolexeclibHEADERS
  make -C "$CHOST/32/libquadmath"  DESTDIR="$pkgdir" install-nodist_libsubincludeHEADERS
  make -C "$CHOST/32/libsanitizer" DESTDIR="$pkgdir" install-nodist_sanincludeHEADERS
  make -C "$CHOST/32/libsanitizer/asan" DESTDIR="$pkgdir" install-nodist_toolexeclibHEADERS

  # docs & localisation
  make -C gcc    DESTDIR="$pkgdir" install-man install-info
  rm -f "$pkgdir"/usr/share/man/man1/{gfortran,lto-dump}.1
  rm -f "$pkgdir"/usr/share/info/{gfortran,lto}.info*

  make -C libcpp DESTDIR="$pkgdir" install
  make -C gcc    DESTDIR="$pkgdir" install-po

  # symlinks & POSIX wrappers
  ln -s gcc "$pkgdir/usr/bin/cc"

  for binary in {c++,g++,gcc,gcc-ar,gcc-nm,gcc-ranlib}; do
    ln -s /usr/bin/$binary "$pkgdir"/usr/bin/x86_64-linux-gnu-$binary
  done

  install -Dm755 "$srcdir/c89" "$pkgdir/usr/bin/c89"
  install -Dm755 "$srcdir/c99" "$pkgdir/usr/bin/c99"

  # remove multilib duplicates provided by lib32-gcc-libs
  rm -f "$pkgdir/usr/lib32/lib"{stdc++,gcc_s}".so"

  # byte-compile python helper modules
  python    -m compileall "$pkgdir/usr/share/gcc-${_basever}"
  python -O -m compileall "$pkgdir/usr/share/gcc-${_basever}"

  # Runtime Library Exception
  install -d "$pkgdir/usr/share/licenses/gcc"
  ln -s /usr/share/licenses/libgcc/RUNTIME.LIBRARY.EXCEPTION \
        "$pkgdir/usr/share/licenses/gcc/"
}

package_gcc-fortran() {
  pkgdesc='Fortran front-end for GCC'
  depends=("gcc=$pkgver-$pkgrel" libgfortran libisl.so)
  provides=($pkgname-multilib)
  replaces=($pkgname-multilib)

  cd "$srcdir/gcc-build"

  make -C "$CHOST/libgfortran" DESTDIR="$pkgdir" install-cafexeclibLTLIBRARIES \
    install-{toolexeclibDATA,nodist_fincludeHEADERS,gfor_cHEADERS}
  make -C "$CHOST/32/libgfortran" DESTDIR="$pkgdir" install-cafexeclibLTLIBRARIES \
    install-{toolexeclibDATA,nodist_fincludeHEADERS,gfor_cHEADERS}
  make -C "$CHOST/libgomp" DESTDIR="$pkgdir" install-nodist_fincludeHEADERS
  make -C gcc DESTDIR="$pkgdir" fortran.install-{common,man,info}
  install -Dm755 gcc/f951 "$pkgdir/$_libdir/f951"

  ln -s gfortran "$pkgdir/usr/bin/f95"

  install -d "$pkgdir/usr/share/licenses/$pkgname/"
  ln -s /usr/share/licenses/libgcc/RUNTIME.LIBRARY.EXCEPTION \
    "$pkgdir/usr/share/licenses/$pkgname/"
}

package_gcc-objc() {
  pkgdesc='Objective-C front-end for GCC'
  depends=("gcc=$pkgver-$pkgrel" libobjc libisl.so)
  provides=($pkgname-multilib)
  replaces=($pkgname-multilib)

  cd "$srcdir/gcc-build"

  make DESTDIR="$pkgdir" -C "$CHOST/libobjc" install-headers
  install -dm755 "$pkgdir/$_libdir"
  install -m755 gcc/cc1obj{,plus} "$pkgdir/$_libdir/"

  install -d "$pkgdir/usr/share/licenses/$pkgname/"
  ln -s /usr/share/licenses/libgcc/RUNTIME.LIBRARY.EXCEPTION \
    "$pkgdir/usr/share/licenses/$pkgname/"
}

package_gcc-libs() {
  pkgdesc='Runtime libraries shipped by GCC'
  depends=(
    glibc
    libasan
    libatomic
    libgfortran
    libgcc
    libgomp
    liblsan
    libobjc
    libquadmath
    libstdc++
    libtsan
    libubsan
  )
  provides=($pkgname-multilib)
}

package_lib32-gcc-libs() {
  pkgdesc='32-bit runtime libraries shipped by GCC'
  depends=(lib32-glibc)
  provides=(
    libasan.so
    libatomic.so
    libgcc_s.so
    libgfortran.so
    libgomp.so
    libitm.so
    liblsan.so
    libobjc.so
    libquadmath.so
    libstdc++.so
    libubsan.so
  )
  groups=(multilib-devel)
  options=(!emptydirs)

  cd "$srcdir/gcc-build"

  make -C "$CHOST/32/libgcc" DESTDIR="$pkgdir" install-shared
  rm -f "$pkgdir/$_libdir/32/libgcc_eh.a"

  for lib in libatomic \
             libgfortran \
             libgomp \
             libitm \
             libquadmath \
             libsanitizer/{a,l,ub}san \
             libstdc++-v3/src; do
    make -C "$CHOST/32/$lib" DESTDIR="$pkgdir" install-toolexeclibLTLIBRARIES
  done

  make -C "$CHOST/32/libobjc" DESTDIR="$pkgdir" install-libs

  # remove files provided by gcc-libs
  rm -rf "$pkgdir"/usr/lib

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/lib32-gcc-libs/RUNTIME.LIBRARY.EXCEPTION"
}

package_libasan() {
  pkgdesc='Address Sanitizer runtime library shipped by GCC'
  depends=(glibc)
  provides=(libasan.so)

  cd "$srcdir/gcc-build"
  make -C "$CHOST/libsanitizer/asan" DESTDIR="$pkgdir" install-toolexeclibLTLIBRARIES

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/libasan/RUNTIME.LIBRARY.EXCEPTION"
}

package_libatomic() {
  pkgdesc='GNU Atomic library shipped by GCC'
  depends=(glibc)
  provides=(libatomic.so)

  cd "$srcdir/gcc-build"
  make -C "$CHOST/libatomic" DESTDIR="$pkgdir" install-toolexeclibLTLIBRARIES

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/libatomic/RUNTIME.LIBRARY.EXCEPTION"
}

package_libgcc() {
  pkgdesc='Low-level runtime library shipped by GCC'
  depends=(glibc)
  provides=(libgcc_s.so)

  cd "$srcdir/gcc-build"
  make -C "$CHOST/libgcc" DESTDIR="$pkgdir" install-shared
  rm -f "$pkgdir/$_libdir/libgcc_eh.a"

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/libgcc/RUNTIME.LIBRARY.EXCEPTION"
}

package_libgccjit() {
  pkgdesc='Just-In-Time Compilation with GCC backend'
  depends=("gcc=$pkgver-$pkgrel" libisl.so)
  provides=(libgccjit.so)

  cd "$srcdir/gcc-build"
  make -C gcc DESTDIR="$pkgdir" jit.install-common jit.install-info

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/libgccjit/RUNTIME.LIBRARY.EXCEPTION"
}

package_libgfortran() {
  pkgdesc='Fortran runtime libraries shipped by GCC'
  depends=(glibc)
  provides=(libgfortran.so)

  cd "$srcdir/gcc-build"
  make -C "$CHOST/libgfortran" DESTDIR="$pkgdir" install-toolexeclibLTLIBRARIES

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/libgfortran/RUNTIME.LIBRARY.EXCEPTION"
}

package_libgomp() {
  pkgdesc='OpenMP library shipped by GCC'
  depends=(glibc)
  provides=(libgomp.so)

  cd "$srcdir/gcc-build"
  make -C "$CHOST/libgomp" DESTDIR="$pkgdir" install-toolexeclibLTLIBRARIES
  make -C "$CHOST/libgomp" DESTDIR="$pkgdir" install-info

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/libgomp/RUNTIME.LIBRARY.EXCEPTION"
}

package_libitm() {
  pkgdesc='GNU Transactional Memory library shipped by GCC'
  depends=(glibc)
  provides=(libitm.so)

  cd "$srcdir/gcc-build"
  make -C "$CHOST/libitm" DESTDIR="$pkgdir" install-toolexeclibLTLIBRARIES
  make -C "$CHOST/libitm" DESTDIR="$pkgdir" install-info

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/libitm/RUNTIME.LIBRARY.EXCEPTION"
}

package_liblsan() {
  pkgdesc='Leak Sanitizer runtime library shipped by GCC'
  depends=(glibc)
  provides=(liblsan.so)

  cd "$srcdir/gcc-build"
  make -C "$CHOST/libsanitizer/lsan" DESTDIR="$pkgdir" install-toolexeclibLTLIBRARIES

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/liblsan/RUNTIME.LIBRARY.EXCEPTION"
}

package_libobjc() {
  pkgdesc='Objective-C runtime libraries shipped by GCC'
  depends=(glibc)
  provides=(libobjc.so)

  cd "$srcdir/gcc-build"
  make -C "$CHOST/libobjc" DESTDIR="$pkgdir" install-libs

  rm -rf "$pkgdir"/usr/lib32/

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/libobjc/RUNTIME.LIBRARY.EXCEPTION"
}

package_libquadmath() {
  pkgdesc='GCC __float128 library'
  depends=(glibc)
  provides=(libquadmath.so)

  cd "$srcdir/gcc-build"
  make -C "$CHOST/libquadmath" DESTDIR="$pkgdir" install-toolexeclibLTLIBRARIES
  make -C "$CHOST/libquadmath" DESTDIR="$pkgdir" install-info

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/libquadmath/RUNTIME.LIBRARY.EXCEPTION"
}

package_libstdc++() {
  pkgdesc='C++ runtime libraries shipped by GCC'
  depends=(glibc)
  provides=(libstdc++.so)

  cd "$srcdir/gcc-build"
  make -C "$CHOST/libstdc++-v3/src" DESTDIR="$pkgdir" install-toolexeclibLTLIBRARIES
  make -C "$CHOST/libstdc++-v3/po"  DESTDIR="$pkgdir" install

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/libstdc++/RUNTIME.LIBRARY.EXCEPTION"
}

package_libtsan() {
  pkgdesc='Thread Sanitizer runtime library shipped by GCC'
  depends=(glibc)
  provides=(libtsan.so)

  cd "$srcdir/gcc-build"
  make -C "$CHOST/libsanitizer/tsan" DESTDIR="$pkgdir" install-toolexeclibLTLIBRARIES

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/libtsan/RUNTIME.LIBRARY.EXCEPTION"
}

package_libubsan() {
  pkgdesc='Undefined Behavior Sanitizer runtime library shipped by GCC'
  depends=(glibc)
  provides=(libubsan.so)

  cd "$srcdir/gcc-build"
  make -C "$CHOST/libsanitizer/ubsan" DESTDIR="$pkgdir" install-toolexeclibLTLIBRARIES

  install -Dm644 "$srcdir/gcc/COPYING.RUNTIME" \
    "$pkgdir/usr/share/licenses/libubsan/RUNTIME.LIBRARY.EXCEPTION"
}

package_lto-dump() {
  pkgdesc='Dump link-time-optimisation object files'
  depends=("gcc=$pkgver-$pkgrel" libisl.so)

  cd "$srcdir/gcc-build"
  make -C gcc DESTDIR="$pkgdir" lto.install-{common,man,info}

  install -d "$pkgdir/usr/share/licenses/lto-dump"
  ln -s /usr/share/licenses/libgcc/RUNTIME.LIBRARY.EXCEPTION \
        "$pkgdir/usr/share/licenses/lto-dump/"
}
