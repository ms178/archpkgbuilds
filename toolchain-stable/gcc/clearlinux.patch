From 7f474628160ead5430290516b0d2c36a1d5de28f Mon Sep 17 00:00:00 2001
From: Francisco Boni Neto <boboniboni@gmail.com>
Date: Tue, 31 May 2022 05:09:54 -0300
Subject: [PATCH 1/8] optimize

---
 gcc/opts.cc | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/gcc/opts.cc b/gcc/opts.cc
index c9badd241..8c468dbe3 100644
--- a/gcc/opts.cc
+++ b/gcc/opts.cc
@@ -721,7 +721,8 @@ default_options_optimization (struct gcc_options *opts,
 	case OPT_O:
 	  if (*opt->arg == '\0')
 	    {
-	      opts->x_optimize = 1;
+	      if (opts->x_optimize == 0)
+		opts->x_optimize = 1;
 	      opts->x_optimize_size = 0;
 	      opts->x_optimize_fast = 0;
 	      opts->x_optimize_debug = 0;
@@ -734,7 +735,12 @@ default_options_optimization (struct gcc_options *opts,
 			       "integer, %<g%>, %<s%>, %<z%> or %<fast%>");
 	      else
 		{
-		  opts->x_optimize = optimize_val;
+		  /* Keep higher opts value */
+		  if (optimize_val > opts->x_optimize)
+		    opts->x_optimize = optimize_val;
+		  /* But honors 0 opts  */
+		  if (optimize_val == 0)
+		    opts->x_optimize = optimize_val;
 		  if ((unsigned int) opts->x_optimize > 255)
 		    opts->x_optimize = 255;
 		  opts->x_optimize_size = 0;
--
2.36.0

From 3646952013763b947588dcdd2178cdd3fa011142 Mon Sep 17 00:00:00 2001
From: Francisco Boni Neto <boboniboni@gmail.com>
Date: Tue, 31 May 2022 05:10:08 -0300
Subject: [PATCH 2/8] vectorize

---
 gcc/opts.cc | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gcc/opts.cc b/gcc/opts.cc
index 8c468dbe3..3916edfb9 100644
--- a/gcc/opts.cc
+++ b/gcc/opts.cc
@@ -644,7 +644,7 @@ static const struct default_options default_options_table[] =
     { OPT_LEVELS_2_PLUS, OPT_ftree_tail_merge, NULL, 1 },
     { OPT_LEVELS_2_PLUS, OPT_ftree_vrp, NULL, 1 },
     { OPT_LEVELS_2_PLUS, OPT_fvect_cost_model_, NULL,
-      VECT_COST_MODEL_VERY_CHEAP },
+      VECT_COST_MODEL_CHEAP },
     { OPT_LEVELS_2_PLUS, OPT_finline_functions, NULL, 1 },
     { OPT_LEVELS_2_PLUS, OPT_ftree_loop_distribute_patterns, NULL, 1 },

--
2.36.0

From bb2c518aed08a2cf8bd1651ecdc35bd39400325e Mon Sep 17 00:00:00 2001
From: Francisco Boni Neto <boboniboni@gmail.com>
Date: Tue, 31 May 2022 05:10:21 -0300
Subject: [PATCH 3/8] gomp relax

---
 libgomp/config/linux/wait.h | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/libgomp/config/linux/wait.h b/libgomp/config/linux/wait.h
index 0ba9db5a4..a0837a1b0 100644
--- a/libgomp/config/linux/wait.h
+++ b/libgomp/config/linux/wait.h
@@ -57,7 +57,10 @@ static inline int do_spin (int *addr, int val)
     if (__builtin_expect (__atomic_load_n (addr, MEMMODEL_RELAXED) != val, 0))
       return 0;
     else
-      cpu_relax ();
+      if (i < count/2)
+	       __asm__ __volatile__("nop\nnop\nnop\n": : :"memory");
+      else
+	      cpu_relax ();
   return 1;
 }

--
2.36.0

From a3391e36d742e0ca280f8e116cecc9150969da6d Mon Sep 17 00:00:00 2001
From: Francisco Boni Neto <boboniboni@gmail.com>
Date: Tue, 31 May 2022 05:10:48 -0300
Subject: [PATCH 5/8] arch native override

---
 gcc/config/i386/driver-i386.cc | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/gcc/config/i386/driver-i386.cc b/gcc/config/i386/driver-i386.cc
index 9e0ae0b2b..00bd280aa 100644
--- a/gcc/config/i386/driver-i386.cc
+++ b/gcc/config/i386/driver-i386.cc
@@ -404,6 +404,9 @@ const char *host_detect_local_cpu (int argc, const char **argv)
   if (argc < 2)
     return NULL;

+  if (getenv("GCC_ARCH_NATIVE_OVERRIDE"))
+    return concat ("-m", argv[0], "=", getenv("GCC_ARCH_NATIVE_OVERRIDE"), options, NULL);
+
   arch = !strcmp (argv[0], "arch");

   if (!arch && strcmp (argv[0], "tune"))
--
2.36.0

From 695c5acee409d49dd9ff6986223568322da03f4c Mon Sep 17 00:00:00 2001
From: William Douglas <william.douglas@intel.com>
Date: Tue, 5 Apr 2022 10:12:58 -0700
Subject: [PATCH 6/8] Ignore -Werror if ${GCC_IGNORE_WERROR} envvar set

-Werror should be set only by developers, not consumers of a project's
source code.  By providing this environment variable, the package build
system can signal that -Werror should never be used without the need to
patch each individual package build system.
---
 gcc/opts.cc | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/gcc/opts.cc b/gcc/opts.cc
index 3916edfb9..577461a81 100644
--- a/gcc/opts.cc
+++ b/gcc/opts.cc
@@ -2695,7 +2695,10 @@ common_handle_option (struct gcc_options *opts,
       break;

     case OPT_Werror:
-      dc->warning_as_error_requested = value;
+      if (getenv("GCC_IGNORE_WERROR"))
+	dc->warning_as_error_requested = false;
+      else
+	dc->warning_as_error_requested = value;
       break;

     case OPT_Werror_:
--
2.36.0

From b8ea3290b3173a0c7499d9170af76724cc140eec Mon Sep 17 00:00:00 2001
From: Francisco Boni Neto <boboniboni@gmail.com>
Date: Tue, 31 May 2022 05:11:31 -0300
Subject: [PATCH 8/8] tune inline

---
 gcc/params.opt | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/gcc/params.opt b/gcc/params.opt
index b88e13720..866ae1388 100644
--- a/gcc/params.opt
+++ b/gcc/params.opt
@@ -226,7 +226,7 @@ Common Joined UInteger Var(param_inline_min_speedup) Init(30) Optimization Integ
 The minimal estimated speedup allowing inliner to ignore inline-insns-single and inline-insns-auto.

 -param=inline-unit-growth=
-Common Joined UInteger Var(param_inline_unit_growth) Init(40) Optimization Param
+Common Joined UInteger Var(param_inline_unit_growth) Init(80) Optimization Param
 How much can given compilation unit grow because of the inlining (in percent).

 -param=integer-share-limit=
--
2.36.0

From ecb8284b8bec4f9e025d21177efbe13f64f6f11b Mon Sep 17 00:00:00 2001
From: "H.J. Lu" <hjl.tools@gmail.com>
Date: Tue, 26 Apr 2022 11:08:55 -0700
Subject: [PATCH] x86: Always generate branch hint

For -mtune-ctrl=branch_prediction_hints, always generate branch hint for
conditional branches.

gcc/

	* config/i386/i386.cc (ix86_print_operand): Always generate
	branch hint for conditional branches.

gcc/testsuite/

	* gcc.target/i386/branch-hint-1.c: New test.
---
 gcc/config/i386/i386.cc                       | 26 +++++--------------
 gcc/testsuite/gcc.target/i386/branch-hint-1.c | 16 ++++++++++++
 2 files changed, 23 insertions(+), 19 deletions(-)
 create mode 100644 gcc/testsuite/gcc.target/i386/branch-hint-1.c

diff --git a/gcc/config/i386/i386.cc b/gcc/config/i386/i386.cc
index 52040da8c47f..8246576f7b82 100644
--- a/gcc/config/i386/i386.cc
+++ b/gcc/config/i386/i386.cc
@@ -13555,25 +13555,13 @@ ix86_print_operand (FILE *file, rtx x, int code)
 		int pred_val = profile_probability::from_reg_br_prob_note
 				 (XINT (x, 0)).to_reg_br_prob_base ();

-		if (pred_val < REG_BR_PROB_BASE * 45 / 100
-		    || pred_val > REG_BR_PROB_BASE * 55 / 100)
-		  {
-		    bool taken = pred_val > REG_BR_PROB_BASE / 2;
-		    bool cputaken
-		      = final_forward_branch_p (current_output_insn) == 0;
-
-		    /* Emit hints only in the case default branch prediction
-		       heuristics would fail.  */
-		    if (taken != cputaken)
-		      {
-			/* We use 3e (DS) prefix for taken branches and
-			   2e (CS) prefix for not taken branches.  */
-			if (taken)
-			  fputs ("ds ; ", file);
-			else
-			  fputs ("cs ; ", file);
-		      }
-		  }
+		bool taken = pred_val > REG_BR_PROB_BASE / 2;
+		/* We use 3e (DS) prefix for taken branches and
+		   2e (CS) prefix for not taken branches.  */
+		if (taken)
+		  fputs ("ds ; ", file);
+		else
+		  fputs ("cs ; ", file);
 	      }
 	    return;
 	  }
diff --git a/gcc/testsuite/gcc.target/i386/branch-hint-1.c b/gcc/testsuite/gcc.target/i386/branch-hint-1.c
new file mode 100644
index 000000000000..03dd83b05af0
--- /dev/null
+++ b/gcc/testsuite/gcc.target/i386/branch-hint-1.c
@@ -0,0 +1,16 @@
+/* { dg-do compile } */
+/* { dg-options "-O2 -dp -mtune-ctrl=branch_prediction_hints" } */
+
+int
+main (int argc, char** argv)
+{
+  if (argc == 1)
+    return 1;
+
+  if (argc == 2)
+    return 2;
+
+  return 3;
+}
+
+/* { dg-final { scan-assembler-not "\tj\[a-z\]\+\[ \\t\]+.* \\*jcc" } } */
--- gcc-12.1.0/libcpp/files.cc~	2022-05-06 07:30:59.000000000 +0000
+++ gcc-12.1.0/libcpp/files.cc	2022-11-06 23:44:15.532615214 +0000
@@ -402,6 +402,7 @@
 #endif
 	 )
 	{
+#if 0
 	  char * canonical_path = maybe_shorter_path (path);
 	  if (canonical_path)
 	    {
@@ -410,6 +411,7 @@
 	      free (path);
 	      path = canonical_path;
 	    }
+#endif
 	}

       hv = htab_hash_string (path);
